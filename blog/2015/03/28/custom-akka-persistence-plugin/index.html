
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Create your own Akka.NET persistence plugin - Simple Solutions</title>
	<meta name="author" content="Bartosz Sypytkowski">

	
	<meta name="description" content="Create Your Own Akka.NET Persistence Plugin Subject of this post is one of the Akka.NET plugins, Akka.Persistence. It&rsquo;s major task is to give &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Simple Solutions" type="application/atom+xml">
	
	<link rel="canonical" href="http://bartoszsypytkowski.com/blog/2015/03/28/custom-akka-persistence-plugin/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	

<script type="text/javascript">
      var disqus_shortname = 'bartoszsypytkowski';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://bartoszsypytkowski.com/blog/2015/03/28/custom-akka-persistence-plugin/';
        var disqus_url = 'http://bartoszsypytkowski.com/blog/2015/03/28/custom-akka-persistence-plugin/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-47294845-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><h1 id="profile-name"><a href="/">Bartosz Sypytkowski</a></h1>
<div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("b.sypytkowski@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:b.sypytkowski@gmail.com" title="Email">Email</a>
		
		
		
		
			<a class="twitter" href="http://twitter.com/horusiath" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/horusiath" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Create Your Own Akka.NET Persistence Plugin</h1>
	<div class="entry-content" itemprop="articleBody"><p>Subject of this post is one of the Akka.NET plugins, Akka.Persistence. It&rsquo;s major task is to give your actors an ability to store their internal state and recover it from the persistent storage after actor is created or underlying actor system crashes. While the rules driving the whole persistence mechanism deserves a separate article, for purposes of this post I&rsquo;ll cover only topic of event journals and snapshot stores.</p>

<h3>Introduction</h3>

<p>If you&rsquo;re already familiar with the idea of Eventsourcing, you probably know everything what&rsquo;s needed by now. If not, here is a simplified model &ndash; statefull actors don&rsquo;t store their state directly, but in form of the events. Event is a single <strong>immutable</strong> fact informing about a change made in time over actor&rsquo;s state. Later, when any form of the recovery is needed, actor&rsquo;s state is recreated by sending to it a series of persisted events, from which it can rebuild itself. Storage responsible for persisting those events is called <strong>Event Journal</strong> . In Akka.Persistence by default it works only in memory which does not make it a truly persistent one.</p>

<p>Since a possible stream of events to be replayed on actor may require a long time to full recovery, it&rsquo;s internal state may be serialized at any point of time and stored separately. In this case by default actor will first try to get the latest intermediate state (a snapshot) and then recover only from those events, which have been stored from that point in time onward. Store used to persist those snapshots is called a <strong>Snapshot Store</strong> and in Akka.NET by default it uses a local file system as a persistence layer.</p>

<p>Akka.Persistence plugin is designed in modular fashion and allows you to create your own plugins and integrate them with any underlying persistence provider.</p>

<h3>Journal</h3>

<p>Just like most of the other entities in Akka, journals and snapshot stores are actors. To create your own journal, you could derive from either <code>AsyncWriteJournal</code> or <code>SyncWriteJournal</code>. Difference between these two is that first one returns a Task continuation from all of it&rsquo;s operations (reads, writes and deletions &ndash; as said earlier journals don&rsquo;t perform updates), while the second only from reads, expecting writes and deletions to be completed in synchronous manner. For this example I&rsquo;m going to use sync journal implementation.</p>

<p>Lets start from the following state of our class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">MyJournal</span> <span class="p">:</span> <span class="n">SyncWriteJournal</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">Ack</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>
</span><span class='line'>        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ConcurrentDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">ISet</span><span class="p">&lt;</span><span class="n">IPersistentRepresentation</span><span class="p">&gt;&gt;</span> <span class="n">_eventStreams</span> <span class="p">=</span>
</span><span class='line'>          <span class="k">new</span> <span class="n">ConcurrentDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">ISet</span><span class="p">&lt;</span><span class="n">IPersistentRepresentation</span><span class="p">&gt;&gt;();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Task</span> <span class="nf">ReplayMessagesAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">long</span> <span class="k">from</span><span class="p">,</span> <span class="kt">long</span> <span class="n">to</span><span class="p">,</span> <span class="kt">long</span> <span class="n">max</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">IPersistentRepresentation</span><span class="p">&gt;</span> <span class="n">replay</span><span class="p">)</span> <span class="p">...</span>
</span><span class='line'>  <span class="n">Task</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;</span> <span class="n">ReadHighestSequenceNrAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">long</span> <span class="k">from</span><span class="p">)</span> <span class="p">...</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">WriteMessages</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IPersistentRepresentation</span><span class="p">&gt;</span> <span class="n">messages</span><span class="p">)</span> <span class="p">...</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">DeleteMessagesTo</span><span class="p">(</span><span class="kt">string</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">long</span> <span class="n">to</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isPermanent</span><span class="p">)</span> <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For this example all persistent actors events are stored in memory. Journal is able to recognize, which event stream refers to specific actor thanks to <strong>PersistenceId</strong> &ndash; an unique identifier for each <code>PersistentActor</code> which may identify it&rsquo;s state across many actor incarnations. Each event inside the stream has it&rsquo;s own <strong>Sequence number</strong> &ndash; an unique number in scope of event stream. It&rsquo;s always increasing monotonically for every separate persistent actor.</p>

<p>This is how <code>WriteMessages</code> method may look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">WriteMessages</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IPersistentRepresentation</span><span class="p">&gt;</span> <span class="n">messages</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">message</span> <span class="k">in</span> <span class="n">messages</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="n">_eventStreams</span><span class="p">.</span><span class="n">GetOrAdd</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">PersistenceId</span><span class="p">,</span>
</span><span class='line'>            <span class="k">new</span> <span class="n">SortedSet</span><span class="p">&lt;</span><span class="n">IPersistentRepresentation</span><span class="p">&gt;(</span><span class="n">PersistentComparer</span><span class="p">.</span><span class="n">Instance</span><span class="p">));</span>
</span><span class='line'>        <span class="n">list</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a straightforward operation of finding an event stream for each message persistence id (or creating a new one if it was not found) and appending a message to it.  <code>PersistentComparer</code> is simply a <code>IComparer</code> used to order messages by their sequence number. <code>IPersistentRepresentation</code> wraps user-defined event and contain all data necessary for the persistence plugin to perform it&rsquo;s magic.</p>

<p>To be able to replay stored messages, now we must define a <code>ReplayMessagesAsync</code> logic:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">override</span> <span class="n">Task</span> <span class="nf">ReplayMessagesAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">long</span> <span class="k">from</span><span class="p">,</span> <span class="kt">long</span> <span class="n">to</span><span class="p">,</span>
</span><span class='line'>  <span class="kt">long</span> <span class="n">max</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">IPersistentRepresentation</span><span class="p">&gt;</span> <span class="n">replay</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">dispatcher</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="n">System</span><span class="p">.</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">DefaultGlobalDispatcher</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">promise</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="n">dispatcher</span><span class="p">.</span><span class="n">Schedule</span><span class="p">(()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">try</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Replay</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="k">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">replay</span><span class="p">);</span>
</span><span class='line'>            <span class="n">promise</span><span class="p">.</span><span class="n">SetResult</span><span class="p">(</span><span class="n">Ack</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">promise</span><span class="p">.</span><span class="n">SetException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">promise</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because this method is already prepared to work in asynchronous manner &ndash; which is the most probable solution for third party providers integration nowadays &ndash; here we delegate this work through our system&rsquo;s dispatcher. Because API of the underlying dispatcher may work in various ways (Akka is not bound to TPL), it&rsquo;s <code>Schedule</code> method doesn&rsquo;t expose any task to be returned. Here I&rsquo;ve introduced a little trick using <code>TaskCompletionSource</code> to create similar behavior.</p>

<p>The <code>Replay</code> method itself is pretty straightforward:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">void</span> <span class="nf">Replay</span><span class="p">(</span><span class="kt">string</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">long</span> <span class="k">from</span><span class="p">,</span> <span class="kt">long</span> <span class="n">to</span><span class="p">,</span>
</span><span class='line'>  <span class="kt">long</span> <span class="n">max</span><span class="p">,</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">IPersistentRepresentation</span><span class="p">&gt;</span> <span class="n">replay</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">ISet</span><span class="p">&lt;</span><span class="n">IPersistentRepresentation</span><span class="p">&gt;</span> <span class="n">eventStream</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">_eventStreams</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="k">out</span> <span class="n">eventStream</span><span class="p">))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="n">eventStream</span> <span class="k">as</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IPersistentRepresentation</span><span class="p">&gt;;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">from</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="n">s</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">SequenceNr</span> <span class="p">&gt;=</span> <span class="k">from</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">to</span> <span class="p">&lt;</span> <span class="kt">int</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">)</span> <span class="n">s</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">SequenceNr</span> <span class="p">&lt;=</span> <span class="n">to</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="p">&lt;</span> <span class="n">eventStream</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span> <span class="n">s</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Take</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">max</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">persistent</span> <span class="k">in</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">replay</span><span class="p">(</span><span class="n">persistent</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&rsquo;s worth to notice here is that, from/to <strong>sequence number range provided is expected to be inclusive</strong> from both sides.</p>

<p>Next in line is <code>ReadHighestSequenceNrAsync</code> &ndash; it&rsquo;s used to receive the highest sequence number for current event stream associated with a particular persistent actor. While in your solution you may find appropriate to use some async API or dispatcher task delegation described above, I&rsquo;ve used a simple synchronous solution here:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">override</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">long</span><span class="p">&gt;</span> <span class="n">ReadHighestSequenceNrAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">long</span> <span class="k">from</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">ISet</span><span class="p">&lt;</span><span class="n">IPersistentRepresentation</span><span class="p">&gt;</span> <span class="n">eventStream</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">_eventStreams</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="k">out</span> <span class="n">eventStream</span><span class="p">))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">last</span> <span class="p">=</span> <span class="n">eventStream</span><span class="p">.</span><span class="n">LastOrDefault</span><span class="p">();</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">seqNr</span> <span class="p">=</span> <span class="n">last</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="m">0L</span> <span class="p">:</span> <span class="n">last</span><span class="p">.</span><span class="n">SequenceNr</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="p">(</span><span class="n">seqNr</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="p">(</span><span class="m">0L</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last method remaining is message deletion. While this is not a usual way of working i.e. in event sourcing model (it introduces a data loss), it&rsquo;s still a viable option.</p>

<p>Akka.Persistance recognizes two types of deletion:</p>

<ul>
<li>Logical, when messages are marked as deleted (<code>IPersistentRepresentation.IsDeleted</code> flag) but still resides in event journal.</li>
<li>Physical, when messages are physically removed from the journal and cannot be restored.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">DeleteMessagesTo</span><span class="p">(</span><span class="kt">string</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">long</span> <span class="n">to</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isPermanent</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">ISet</span><span class="p">&lt;</span><span class="n">IPersistentRepresentation</span><span class="p">&gt;</span> <span class="n">eventStream</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">_eventStreams</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="k">out</span> <span class="n">eventStream</span><span class="p">))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">message</span> <span class="k">in</span> <span class="n">eventStream</span><span class="p">.</span><span class="n">ToArray</span><span class="p">())</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">SequenceNr</span> <span class="p">&lt;=</span> <span class="n">to</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="n">eventStream</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span><span class="p">(!</span><span class="n">isPermanent</span><span class="p">)</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                  <span class="c1">// copy message with IsDeleted flag set</span>
</span><span class='line'>                    <span class="kt">var</span> <span class="n">copy</span> <span class="p">=</span> <span class="n">message</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">SequenceNr</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">message</span><span class="p">.</span><span class="n">PersistenceId</span><span class="p">,</span> <span class="n">isDeleted</span><span class="p">:</span> <span class="k">true</span><span class="p">,</span> <span class="n">sender</span><span class="p">:</span> <span class="n">message</span><span class="p">.</span><span class="n">Sender</span><span class="p">);</span>
</span><span class='line'>                    <span class="n">eventStream</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">copy</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">// messages are already stored by their sequence number order</span>
</span><span class='line'>            <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Test specification fulfillment</h4>

<p>When your custom persistence plugin is ready, it&rsquo;s good to check if it&rsquo;s behavior is a valid one from the Akka.Persistence perspective. In order to do this, you may get an existing test suite in form of a <code>Akka.Persistence.TestKit</code> available as a NuGet package &ndash; it&rsquo;s a set of tests used to check if your custom persistence plugin fulfills expected journal (and snaphot store) behavior. It used Akka.NET TestKit along with xUnit in order to run.</p>

<p>The only thing needed is your own spec class inheriting from <code>JournalSpec</code> with configuration set to use your plugin as a default one. The same configuration set may be used to inject your persistence provider to real working actor system.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">MyJournalSpec</span> <span class="p">:</span> <span class="n">JournalSpec</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Config</span> <span class="n">SpecConfig</span> <span class="p">=</span>
</span><span class='line'>      <span class="n">ConfigurationFactory</span><span class="p">.</span><span class="n">ParseString</span><span class="p">(</span><span class="s">@&quot;</span>
</span><span class='line'><span class="s">        akka.persistence {</span>
</span><span class='line'><span class="s">            publish-plugin-commands = on</span>
</span><span class='line'><span class="s">            journal {</span>
</span><span class='line'><span class="s">                plugin = &quot;&quot;akka.persistence.journal.my&quot;&quot;</span>
</span><span class='line'><span class="s">                my {</span>
</span><span class='line'><span class="s">                    class = &quot;&quot;MyModule.MyJournal, MyModule&quot;&quot;</span>
</span><span class='line'><span class="s">                    plugin-dispatcher = &quot;&quot;akka.actor.default-dispatcher&quot;&quot;</span>
</span><span class='line'><span class="s">                }</span>
</span><span class='line'><span class="s">            }</span>
</span><span class='line'><span class="s">        }</span>
</span><span class='line'><span class="s">    &quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">MyJournalSpec</span><span class="p">()</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">SpecConfig</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Snapshot store</h3>

<p>Custom snapshot store implementation seems to be an easier task. Here I&rsquo;m going to use again the store based on in-memory snapshots, which still is not a valid persistence layer, but works good for training purposes.</p>

<p>Actor state snapshots are identified by two entities: <code>SnapshotMetadata</code> and <code>Snapshot</code> itself. First covers the data necessary to correctly place snapshot instance in the lifetime of a specific persistent actor, while the second one is a wrapper over actor&rsquo;s state itself.</p>

<p>For purposes of this in-memory plugin, I&rsquo;ll wrap both of them with single object defined like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SnapshotBucket</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">readonly</span> <span class="n">SnapshotMetadata</span> <span class="n">Metadata</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">readonly</span> <span class="n">Snapshot</span> <span class="n">Snapshot</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">SnapshotBucket</span><span class="p">(</span><span class="n">SnapshotMetadata</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">Snapshot</span> <span class="n">snapshot</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Metadata</span> <span class="p">=</span> <span class="n">metadata</span><span class="p">;</span>
</span><span class='line'>        <span class="n">Snapshot</span> <span class="p">=</span> <span class="n">snapshot</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This way we may describe the snapshot store in the following manner:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">MySnapshotStore</span> <span class="p">:</span> <span class="n">SnapshotStore</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">Ack</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">LinkedList</span><span class="p">&lt;</span><span class="n">SnapshotMetadata</span><span class="p">&gt;</span> <span class="n">_saving</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="p">&lt;</span><span class="n">SnapshotMetadata</span><span class="p">&gt;();</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SnapshotBucket</span><span class="p">&gt;</span> <span class="n">_buckets</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SnapshotBucket</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Task</span><span class="p">&lt;</span><span class="n">SelectedSnapshot</span><span class="p">&gt;</span> <span class="n">LoadAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">pid</span><span class="p">,</span> <span class="n">SnapshotSelectionCriteria</span> <span class="n">criteria</span><span class="p">)</span> <span class="p">...</span>
</span><span class='line'>  <span class="n">Task</span> <span class="nf">SaveAsync</span><span class="p">(</span><span class="n">SnapshotMetadata</span> <span class="n">metadata</span><span class="p">,</span> <span class="kt">object</span> <span class="n">snapshot</span><span class="p">)</span> <span class="p">...</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">Saved</span><span class="p">(</span><span class="n">SnapshotMetadata</span> <span class="n">metadata</span><span class="p">)</span> <span class="p">...</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">Delete</span><span class="p">(</span><span class="n">SnapshotMetadata</span> <span class="n">metadata</span><span class="p">)</span> <span class="p">...</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">Delete</span><span class="p">(</span><span class="kt">string</span> <span class="n">pid</span><span class="p">,</span> <span class="n">SnapshotSelectionCriteria</span> <span class="n">criteria</span><span class="p">)</span> <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To begin with, lets abstract dispatcher behavior described before. Remember, this is only a trick &ndash; nothing stands on your way to simply use <code>Task.Run</code> or delegating work to child actors. In real life scenario you&rsquo;d probably use built in async behavior of underlying provider.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Dispatch</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">fn</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">dispatcher</span> <span class="p">=</span> <span class="n">Context</span><span class="p">.</span><span class="n">System</span><span class="p">.</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">DefaultGlobalDispatcher</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">promise</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TaskCompletionSource</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="n">dispatcher</span><span class="p">.</span><span class="n">Schedule</span><span class="p">(()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">try</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">fn</span><span class="p">();</span>
</span><span class='line'>            <span class="n">promise</span><span class="p">.</span><span class="n">SetResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">promise</span><span class="p">.</span><span class="n">SetException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">promise</span><span class="p">.</span><span class="n">Task</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, lets take a saving operation. In case of snapshot stores it&rsquo;s divided into two separate methods:</p>

<ul>
<li><strong>SaveAsync</strong> asynchronous operation of saving the snapshot, returning the Task continuation.</li>
<li><strong>Saved</strong> called only after message has been successfully saved.</li>
</ul>


<p>They may be combined to i.e. introduce a log for actually saving, but not yet saved snapshots, as I&rsquo;ve presented below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">protected</span> <span class="k">override</span> <span class="n">Task</span> <span class="nf">SaveAsync</span><span class="p">(</span><span class="n">SnapshotMetadata</span> <span class="n">metadata</span><span class="p">,</span> <span class="kt">object</span> <span class="n">snapshot</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">Dispatch</span><span class="p">(()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">bucket</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SnapshotBucket</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="k">new</span> <span class="n">Snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">));</span>
</span><span class='line'>        <span class="n">_saving</span><span class="p">.</span><span class="n">AddLast</span><span class="p">(</span><span class="n">metadata</span><span class="p">);</span>
</span><span class='line'>        <span class="n">_buckets</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">bucket</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">Ack</span><span class="p">;</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Saved</span><span class="p">(</span><span class="n">SnapshotMetadata</span> <span class="n">metadata</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">_saving</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">metadata</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When it comes to loading a snapshots, snapshot store is expected to return only one snapshot being the latest one from the provided range. Just like any other range in persistence plugin, this one is expected to have inclusive boundaries.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">protected</span> <span class="k">override</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">SelectedSnapshot</span><span class="p">&gt;</span> <span class="n">LoadAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">pid</span><span class="p">,</span> <span class="n">SnapshotSelectionCriteria</span> <span class="n">criteria</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">Dispatch</span><span class="p">(()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">limited</span> <span class="p">=</span> <span class="n">_buckets</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">bucket</span> <span class="p">=&gt;</span> <span class="n">bucket</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">PersistenceId</span> <span class="p">==</span> <span class="n">pid</span>
</span><span class='line'>        <span class="p">&amp;&amp;</span> <span class="n">bucket</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">SequenceNr</span> <span class="p">&lt;=</span> <span class="n">criteria</span><span class="p">.</span><span class="n">MaxSequenceNr</span>
</span><span class='line'>        <span class="p">&amp;&amp;</span> <span class="n">bucket</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">Timestamp</span> <span class="p">&lt;=</span> <span class="n">criteria</span><span class="p">.</span><span class="n">MaxTimeStamp</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">latest</span> <span class="p">=</span> <span class="n">limited</span><span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">bucket</span> <span class="p">=&gt;</span> <span class="n">bucket</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">).</span><span class="n">Last</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">SelectedSnapshot</span><span class="p">(</span><span class="n">latest</span><span class="p">.</span><span class="n">Metadata</span><span class="p">,</span> <span class="n">latest</span><span class="p">.</span><span class="n">Snapshot</span><span class="p">.</span><span class="n">Data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last behavior is message deletion, represented in this case by two methods &ndash; one used for single snapshot and one able to operate on specific range.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Delete</span><span class="p">(</span><span class="n">SnapshotMetadata</span> <span class="n">metadata</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">found</span> <span class="p">=</span> <span class="n">_buckets</span><span class="p">.</span><span class="n">SingleOrDefault</span><span class="p">(</span><span class="n">bucket</span> <span class="p">=&gt;</span> <span class="n">bucket</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">metadata</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_buckets</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">found</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Delete</span><span class="p">(</span><span class="kt">string</span> <span class="n">pid</span><span class="p">,</span> <span class="n">SnapshotSelectionCriteria</span> <span class="n">criteria</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">_buckets</span><span class="p">.</span><span class="n">RemoveAll</span><span class="p">(</span><span class="n">bucket</span> <span class="p">=&gt;</span>
</span><span class='line'>      <span class="n">bucket</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">PersistenceId</span> <span class="p">==</span> <span class="n">pid</span>
</span><span class='line'>        <span class="p">&amp;&amp;</span> <span class="n">bucket</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">SequenceNr</span> <span class="p">&lt;=</span> <span class="n">criteria</span><span class="p">.</span><span class="n">MaxSequenceNr</span>
</span><span class='line'>        <span class="p">&amp;&amp;</span> <span class="n">bucket</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">Timestamp</span> <span class="p">&lt;=</span> <span class="n">criteria</span><span class="p">.</span><span class="n">MaxTimeStamp</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Test specification fulfillment</h4>

<p>Just like in the case of journal spec, you may verify your actor behavior simply by creating custom spec. While you may see a minimal configuration string below, nothing stands on your way to extend it with your custom settings.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">MySnapshotStoreSpec</span> <span class="p">:</span> <span class="n">SnapshotStoreSpec</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Config</span> <span class="n">SpecConfig</span> <span class="p">=</span>
</span><span class='line'>      <span class="n">ConfigurationFactory</span><span class="p">.</span><span class="n">ParseString</span><span class="p">(</span><span class="s">@&quot;</span>
</span><span class='line'><span class="s">        akka.persistence.snapshot-store {</span>
</span><span class='line'><span class="s">            plugin = &quot;&quot;akka.persistence.snapshot-store.my&quot;&quot;</span>
</span><span class='line'><span class="s">            my {</span>
</span><span class='line'><span class="s">                class = &quot;&quot;TestPersistencePlugin.MySnapshotStore, TestPersistencePlugin&quot;&quot;</span>
</span><span class='line'><span class="s">                plugin-dispatcher = &quot;&quot;akka.persistence.dispatchers.default-plugin-dispatcher&quot;&quot;</span>
</span><span class='line'><span class="s">            }</span>
</span><span class='line'><span class="s">        }</span>
</span><span class='line'><span class="s">    &quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">MySnapshotStoreSpec</span><span class="p">()</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">SpecConfig</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Metadata</span> <span class="p">=</span> <span class="n">WriteSnapshots</span><span class="p">().</span><span class="n">ToList</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Another difference from event journal spec is that fore most test cases snapshot store spec requires an existing collection of snapshots metadata to work. They are initialized in constructor in the code above.</p>

<h3>Final notes</h3>

<ol>
<li>Examples, I&rsquo;ve presented, work on predefined constructs &ndash; they derive directly from <code>SnapshotStore</code> and <code>SyncWriteJournal</code>. However it&rsquo;s not necessary, as you may promote any actor type to work as snapshot store or event journal as long as they expose necessary behavior and are able to respond on required set of persistence messages.</li>
<li>While persistence stores specs may be used to verify your implementations, remember that they don&rsquo;t ensure things such as data races etc.</li>
<li>Remember that Akka.Persistence is still in <em>Prerelease</em> version. Therefore some breaking changes may occur in incoming versions.</li>
</ol>

</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2015

    Bartosz Sypytkowski


Design based on: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
</body>
</html>
