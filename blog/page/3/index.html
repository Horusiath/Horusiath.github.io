
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Simple Solutions</title>
	<meta name="author" content="Bartosz Sypytkowski">

	
	<meta name="description" content="Dec 30th, 2012 javascript, programowanie Comments node.js - Renderowanie Layoutów Z Wykorzystaniem doT.js Stało się. Po wielu podejściach skłoniłem &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Simple Solutions" type="application/atom+xml">
	
	<link rel="canonical" href="http://bartoszsypytkowski.com/blog/page/3/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	

<script type="text/javascript">
      var disqus_shortname = 'bartoszsypytkowski';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-47294845-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><h1 id="profile-name"><a href="/">Bartosz Sypytkowski</a></h1>
<div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("b.sypytkowski@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:b.sypytkowski@gmail.com" title="Email">Email</a>
		
		
		
			<a class="google" href="https://plus.google.com/b.sypytkowski@gmail.com" rel="author" title="Google+">Google+</a>
		
		
			<a class="twitter" href="http://twitter.com/horusiath" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/horusiath" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2012-12-30T10:09:00+01:00" data-updated="true" itemprop="datePublished">Dec 30<span>th</span>, 2012</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/programowanie/'>programowanie</a>


</div>
		
			<span class="comments"><a href="/blog/2012/12/30/nodejs-renderowanie-layoutow-z/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2012/12/30/nodejs-renderowanie-layoutow-z/" itemprop="url">node.js - Renderowanie Layoutów Z Wykorzystaniem doT.js</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Stało się. Po wielu podejściach skłoniłem się do <a href="http://nodejs.org/">node.js</a> i postanowiłem napisać w nim swoją pierwszą aplikację z prawdziwego zdarzenia. O moich motywach i wątpliwościach, jakie towarzyszyły wykorzystaniu javascriptu do tworzenia logiki po stronie serwera opowiem innym razem. W tym poście postaram się skupić na innym zagadnieniu.</p>

<p>Po dość długim rekonesansie związanym z technologiami używanymi w node.js zdecydowałem się, że moja aplikacja zostanie oparta o bibliotekę <a href="http://expressjs.com/">express.js</a>. Jest to chyba najpopularniejszy framework w tym środowisku (ideowo czerpiący z Sinatry znanej wśród programistów Ruby&#8217;ego), którego głównymi zaletami są niewielki narzut obliczeniowy, łatwość konfiguracji, duża ilość zewnętrznych rozszerzeń oraz spora społeczność. W tym momencie należało również dokonać kilku dość istotnych wyborów. Ten, którego dotyczy mój wpis, dotyczył wyboru silnika renderującego. Z początku myślałem o najprostszym rozwiązaniu tzn. serwowaniu statycznych stron html. Jednakże takie rozwiązanie sprawia pewne problemy, z czego najbardziej upierdliwym jest chyba brak layoutów (ponieważ duża część widoków jest współdzielona, zmiana jednego z takich fragmentów wymagała by synchronizacji we wszystkich pozostałych stronach). Stąd postawiłem kilka warunków, jakie powinien spełniać silnik dla mojej aplikacji:</p>

<ul>
<li>Musi wspierać layouty/partiale</li>
<li>Musi być szybki (ideałem byłaby prekompilacja, ale cache&#8217;owanie widoków też jest ok)</li>
<li>Powinien zapewniać przynajmniej podstawową logikę w wykorzystywanych szablonach tzn. wyrażenia warunkowe i pętle.</li>
</ul>


<p>Nie uwzględniam tutaj problemu generowania dynamicznych widoków dla każdego użytkownika, ponieważ uważam, że tak specyficzna logika powinna być renderowana po stronie klienta (klient sam zajmuje się wyświetlaniem tego, to jest właściwe tylko dla niego &ndash; brzmi logicznie, prawda?). Po długich przygodach wybór padł ostatecznie na <a href="http://olado.github.com/doT/">doT.js</a>. Jest on obecnie uważany za jeden z najszybszych istniejących silników renderujących dla node.js (co potwierdzają benchmarki).</p>

<p>Niestety dłuższe zabawy wykazały, że ciężko jest wykorzystać domyślne API doT.js do renderowania widoków w expressie. Z tego powodu postanowiłem stworzyć własne rozwiązanie. Zacząłem od wydzielenia logiki odpowiedzialnej za rendering do osobnego modułu <strong>renderer.js</strong><em> </em>umiejscowionego w głównym katalogu aplikacji. Początkowa definicja wyglądała następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span> <span class="c1">// operowanie na ścieżkach systemowych</span>
</span><span class='line'><span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>     <span class="c1">// I/O na plikach</span>
</span><span class='line'><span class="nx">defaultLayout</span><span class="p">,</span>          <span class="c1">// domyślna nazwa layoutu</span>
</span><span class='line'><span class="nx">extension</span><span class="p">,</span>              <span class="c1">// domyślne rozszerzenie plików-szablonów</span>
</span><span class='line'><span class="nx">viewsPath</span><span class="p">,</span>              <span class="c1">// ścieżka, gdzie składowane są widoki</span>
</span><span class='line'><span class="nx">cacheViews</span><span class="p">,</span>             <span class="c1">// flaga, czy cache&#39;ować kompilowane widoki</span>
</span><span class='line'><span class="nx">compiledViewsCache</span><span class="p">;</span>     <span class="c1">// cache na skompilowane widoki</span>
</span></code></pre></td></tr></table></div></figure>


<p>Następnym krokiem jest funkcja inicjalizująca:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">setup</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">){</span>
</span><span class='line'>  <span class="nx">extension</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">extension</span> <span class="o">||</span> <span class="s1">&#39;html&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">defaultLayout</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">layout</span> <span class="o">||</span> <span class="s1">&#39;layout&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">viewsPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">path</span> <span class="o">||</span> <span class="s1">&#39;views&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">cacheViews</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">cacheViews</span> <span class="o">||</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">compiledViewsCache</span> <span class="o">=</span> <span class="nx">cacheViews</span> <span class="o">?</span> <span class="p">{}</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Określiliśmy w niej kilka opcji, które wykorzystywane będą podczas renderowania:</p>

<ul>
<li>extension &ndash; nazwa rozszerzenia wykorzystywanego przez kompilowane szablony (domyślnie: html)</li>
<li>defaultLayout &ndash; nazwa pliku layoutu (domyślnie: layout). Należy tutaj zaznaczyć, że w moim rozwiązaniu istnieje tylko 1 plik główny, nie istnieje domyślna obsługa zagnieżdżania widoków, mimo że wciąż jest taka możliwość.</li>
<li>viewsPath &ndash; scieżka względna do katalogu z widokami (domyślnie: /views).</li>
<li>cacheViews &ndash; czy skompilowany widok powinien zostać cache&#8217;owany? (domyślnie: tak)</li>
</ul>


<p>Teraz nadchodzi magia. Tworzymy funkcję, której zadaniem będzie wyrenderowanie podanego nam widoku:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">viewname</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">layout</span><span class="p">){</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">layoutPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">viewsPath</span><span class="p">,</span> <span class="p">(</span><span class="nx">layout</span> <span class="o">||</span> <span class="nx">defaultLayout</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">extension</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">viewPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">viewsPath</span><span class="p">,</span> <span class="nx">viewname</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">extension</span><span class="p">);</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">var</span> <span class="nx">c</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// czy dany widok został znaleziony w cache</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">cacheViews</span> <span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span> <span class="k">typeof</span> <span class="p">(</span><span class="nx">c</span><span class="o">=</span><span class="nx">compiledViewsCache</span><span class="p">[</span><span class="nx">viewPath</span><span class="p">])</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">c</span><span class="p">(</span><span class="nx">model</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// asynchroniczne odczytanie widoku</span>
</span><span class='line'>      <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">viewPath</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">viewData</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="c1">// błąd przy pobraniu pliku z widokiem</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>              <span class="c1">// asynchroniczne odczytanie layoutu</span>
</span><span class='line'>              <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">layoutPath</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">layoutData</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
</span><span class='line'>                      <span class="c1">// błąd przy pobraniu layoutu</span>
</span><span class='line'>                  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>                      <span class="c1">// skompiluj layout z widokiem</span>
</span><span class='line'>                      <span class="kd">var</span> <span class="nx">compiled</span> <span class="o">=</span> <span class="nx">dot</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span>
</span><span class='line'>                          <span class="nx">layoutData</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
</span><span class='line'>                          <span class="kc">undefined</span><span class="p">,</span>
</span><span class='line'>                          <span class="p">{</span> <span class="nx">content</span><span class="o">:</span> <span class="nx">viewData</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>                      <span class="p">);</span>
</span><span class='line'>                      <span class="k">if</span><span class="p">(</span><span class="nx">cacheViews</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                          <span class="c1">// dodaj widok do cache</span>
</span><span class='line'>                          <span class="nx">compiledViewsCache</span><span class="p">[</span><span class="nx">viewPath</span><span class="p">]</span> <span class="o">=</span> <span class="nx">compiled</span><span class="p">;</span>
</span><span class='line'>                      <span class="p">}</span>
</span><span class='line'>                      <span class="c1">// wyświetl wyrenderowany widok</span>
</span><span class='line'>                      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">compiled</span><span class="p">(</span><span class="nx">model</span><span class="p">));</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>              <span class="p">});</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Funkcja ta przyjmuje 4 parametry: obiekt express.response, nazwę widoku, model, z którym widok powinien być skompilowany, oraz nazwę layoutu (jeżeli domyślny nam nie odpowiada). Dwa ostatnie parametry są opcjonalne. Wewnątrz funkcji wykonujemy następujące operacje:</p>

<ol>
<li>Jeżeli dany widok został zcache&#8217;owany, odczytujemy go z cache i kompilujemy z podanym modelem. Warto tutaj nadmienić, że cache nie służy nam do zachowywania gotowego htmla, a jedynie skompilowanej funkcji szablonu, która generuje ten html na podstawie otrzymanego modelu. W tym wypadku zyskujemy na czasie, jaki należałoby poświęcić na odczytanie i skompilowanie szablonów zawartych w plikach.</li>
<li>Jeżeli widok nie był zcache&#8217;owany, odczytujemy kolejno plik szablonu z widokiem oraz layoutem (obie operacje odczytania pliku wykonywane są asynchronicznie), następie kompilujemy sam szablon, aby na koniec na jego podstawie wygenerować wynikowy html oraz wysłać odpowiedź.</li>
</ol>


<p>Aby moduł można uznać za gotowy, wystarczy udostępnić funkcje <em>setup</em> oraz <em>render</em> (dodając te funkcje do zmiennej <em>exports</em>).</p>

<p>Konfiguracja tego modułu w aplikacji może wyglądać następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">express</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">renderer</span><span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./renderer&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">app</span>  <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nx">renderer</span><span class="p">.</span><span class="nx">setup</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">extension</span><span class="o">:</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">layout</span><span class="o">:</span> <span class="s1">&#39;layout&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">viewsPath</span><span class="o">:</span> <span class="s1">&#39;/views&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">cacheViews</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// dodanie do obiektu express.response funkcjonalności naszego modułu</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">viewname</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">layout</span><span class="p">){</span>
</span><span class='line'>  <span class="nx">renderer</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">viewname</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span><span class="nx">layout</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Trzeba dodać, że obiekt app.response służący do rozszerzenia domyślnych funkcjonalności obiektu response, jest dostępny w express.js od wersji 3.x.</p>

<p>Przykładowy plik <strong>layout.html</strong> może wyglądać następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">html</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">html</span> <span class="nx">lang</span><span class="o">=</span><span class="s2">&quot;pl&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;</span>
</span><span class='line'>          <span class="p">{</span> <span class="p">{</span><span class="o">=</span><span class="nx">it</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span> <span class="p">}</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="err">/title&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">meta</span> <span class="nx">charset</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">/head&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="p">{</span> <span class="p">{</span><span class="err">#</span><span class="nx">def</span><span class="p">.</span><span class="nx">content</span><span class="p">}</span> <span class="p">}</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">/body&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Zdefiniowaliśmy w nim 2 zmienne:</p>

<ul>
<li><em>def.content </em>&ndash; zmienna czasu kompilacji, w tym miejscu wstawiona zostanie zawartość pliku konkretnego widoku.</li>
<li><em>it.title</em> &ndash; zmienna właściwa dla danego modelu, zostanie. Domyślnie w doT.js <strong>it</strong> oznacza model przekazany do widoku, natomiast <em>title</em> to nazwa właściwości dostępnej w ramach modelu.</li>
</ul>


<p>Licząc, że widok zawarty jest w pliku <strong>home.html</strong> teraz wystarczy wywołać nasz widok w następujący sposób:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="p">{</span><span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Strona główna&#39;</span><span class="p">};</span>
</span><span class='line'>  <span class="nx">res</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">);</span>    <span class="c1">// nasza customowa metoda</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2012-09-09T15:16:00+02:00" data-updated="true" itemprop="datePublished">Sep 9<span>th</span>, 2012</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/wzorce-projektowe/'>wzorce projektowe</a>


</div>
		
			<span class="comments"><a href="/blog/2012/09/09/javascript-porady-i-uwagi/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2012/09/09/javascript-porady-i-uwagi/" itemprop="url">Javascript - Porady I Uwagi</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Ostatnimi czasy poświęciłem kilka chwil na refleksje związane z kodem JavaScriptu, z jakim przyszło mi się spotykać w pracy i na uczelni. Zauważyłem, że wiele osób skupia się na logice serwerowej, trzymając się wielu kanonów określających jak powinno się pisać czysty i rozwijalny kod. Z drugiej strony jednocześnie traktują one skrypty JS po macoszemu, jako coś przez co trzeba jakoś przebrnąć.</p>

<p>Nie ma co ukrywać, że utrzymanie przejrzystości i rozszerzalności modułów w JavaScriptcie jest o wiele trudniejsze niż w standardowych językach wykonywanych po stronie serwera. Dlatego właśnie uważam, że tym bardziej wymagają one uwagi i wkładu w zachowanie jakości. Poniżej przedstawię kilka uwag/wskazówek dla programistów, którzy chcieliby poprawić jakość pisanego kodu.</p>

<h2>1. Zapoznaj się z <a href="http://google-styleguide.googlecode.com/svn/trunk/javascriptguide.xml">Google Style Guide</a></h2>

<p>Myślę, że to powinien być pierwszy krok dla każdego programisty frontendowego (i nie tylko). W każdym języku istnieją pewne konwencje i złote rady i JS nie jest tu żadnym wyjątkiem. Poradnik Google&#8217;a to nic innego jak zbiór powszechnie wypracowanych, przemyślanych zasad, którymi warto kierować się w trakcie pisania aplikacji WWW. Część z moich dalszych uwag będzie też rozwinięciem punktów z tego podręcznika.</p>

<h2>2. Zamykaj skrypty we własnych zakresach (scopes)</h2>

<p>Ten punkt dotyczy częstej sytuacji w której tworząc skrypty do aplikacji często definiujemy wiele zmiennych i funkcji globalnych o tymczasowym zastosowaniu. Tworzy to całą masę śmieciowego kodu, który jest dostępny w innych częściach aplikacji i w przyszłości może poskutkować zmniejszeniem czytelności, kłopotami z dalszą rozwijalnością kodu i zwiększeniem ryzyka powstawania błędów.</p>

<p>Rozwiązaniem tego problemu jest posłużenie się wzorcem funkcji natychmiastowych (wykonywanych natychmiast po ich zdefiniowaniu). Poniżej zaprezentowałem przykład obrazujący to rozwiązanie:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">someVariable</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// reszta kodu</span>
</span><span class='line'><span class="p">})(</span><span class="nb">window</span><span class="p">,</span> <span class="nx">$</span><span class="p">);</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Utworzyliśmy w ten sposób odrębny zakres (<em>scope</em>), w którym wykonywane są funkcje skryptu. Oznacza to m.in., że zadeklarowana w przykładzie zmienna <em>someVariable</em> nie będzie widoczna przez inne skrypty spoza tego zakresu. Wpis <em>&lsquo;use strict&rsquo;</em> jest pomijany przez starsze przeglądarki, zaś w nowszych sprawia, że pisany kod będzie znacznie bardziej restrykcyjnie traktowany przez kompilator, przez co łatwiej można w nim wyłapać błędy i niejasności. Więcej na ten temat można przeczytać <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Functions_and_function_scope/Strict_mode?redirectlocale=en-US&amp;amp;redirectslug=JavaScript%2FStrict_mode">tutaj</a>.</p>

<p>Można się zatem zapytać, po co w argumentach funkcji umieszczone są redefinicje zmiennych <em>window </em>i<em> jQuery</em>? Odpowiedź jest prosta: przejrzystość. Podając jawnie globalne typy z innych bibliotek i zmiennych środowiskowych możemy w mgnieniu oka określić powiązania pomiędzy naszym skryptem, a zewnętrznymi modułami.</p>

<h2>3. Organizuj zmienne globalne w modułach/przestrzeniach nazw</h2>

<p>Kolejnym krokiem w stronę dobrej organizacji kodu jest wykorzystanie powszechnie stosowanej w językach <em>server-side</em> opcji cięcia kodu w moduły i przestrzenie nazw. Może się to wydawać mało zrozumiałe, ponieważ JavaScript nie definiuje jawnie takich konstrukcji językowych. Jednakże możliwości tego języka są praktycznie nieograniczone, co daje nam możliwość rozwiązania tego problemu w inny sposób.</p>

<p>Pierwsza propozycja przedstawiona jest poniżej. Osobiście nie polecam jej, jednakże w przypadku, gdy mamy niewiele modułów w naszej aplikacji, może się okazać wystarczająca.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">MyModule</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">MyModule</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">MyModule</span> <span class="o">||</span> <span class="p">{});</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">MySubModule</span> <span class="o">=</span> <span class="p">(</span><span class="nx">MyModule</span><span class="p">.</span><span class="nx">MySubModule</span> <span class="o">=</span> <span class="nx">MyModule</span><span class="p">.</span><span class="nx">MySubModule</span> <span class="o">||</span> <span class="p">{});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Jest to prosta konstrukcja językowa wydobywająca moduł (reprezentowany w praktyce przez obiekt) z tzw. korzenia (<em>root</em> &ndash; w tym wypadku zmienna <em>window</em>) lub tworząca go w przypadku, gdy dany moduł nie został jeszcze utworzony. Zwrócony obiekt służy następnie jako uchwyt dla pozostałych definiowanych przez nas funkcji i zmiennych.</p>

<p>Innym rozwiązaniem jest stworzenie predefiniowanej metody pozwalającej wydobywać/tworzyć moduły na zawołanie, wraz z zachowaniem ich hierarchii. Ten prosty wzorzec, nazywany jak nie ciężko się domyślić przestrzenią nazw (<em>namespace</em>), może być sprowadzony do postaci pojedyńczej funkcji:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">root</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">root</span> <span class="o">||</span> <span class="nb">window</span><span class="p">;</span>    <span class="c1">// jeżeli nie podaliśmy korzenia, korzystamy z obiektu okna</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">modules</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">modules</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="nx">modules</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span><span class='line'>        <span class="nx">parent</span><span class="p">[</span><span class="nx">module</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">parent</span><span class="p">[</span><span class="nx">module</span><span class="p">]</span> <span class="o">||</span> <span class="p">{});</span>
</span><span class='line'>        <span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">module</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">parent</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Tak zdefiniowana funkcja pozwala nam pobierać lub tworzyć hierarchie modułów na żądanie. Przykładowe użycie może wyglądać następująco: <code>var regexes = namespace(&lsquo;System.Text.RegularExpressions&rsquo;);</code></p>

<h2>4. Komunikuj się poprzez obiekty</h2>

<p>Jest to dość wieloznaczne stwierdzenie, w praktyce jednak chodzi o prostą ideę: wykorzystanie proxy w komunikacji z zewnętrznymi serwisami, a nawet między różnymi modułami. Jest to wygodny sposób zachowanie luźnych powiązań.</p>

<p>W ramach przykładu załóżmy, że wykorzystujemy obiekt pośredniczący w obsłudze żądań ajaxowych z różnych modułów naszej aplikacji. Niestety z jakiegoś powodu biblioteka jQuery, z której korzystaliśmy do obsługi tych wywołań, generuje błędy lub posiada zbyt ubogie funkcje. Dzięki wykorzystaniu proxy możemy ją zamienić na inną (lub napisać własną) bez potrzeby przepisywania kodu we wszystkich miejscach, które do tej pory wykorzystywały ją do komunikacji.</p>

<p>Kolejną wynikającą z tego zaletą jest możliwość przeprowadzania testów jednostkowych dla skryptów klienckich. Nie ma przecież żadnych przeciwwskazań, aby stworzyć mocki, które będziemy mogli podstawiać w miejsce obiektu komunikatora.</p>

<p>Innym zastosowaniem takiego rozwiązania jest możliwość reagowania na nadchodzące wiadomości w bardziej wyrafinowany sposób. Zastanówcie się, jak do tej pory reagowaliście, jeżeli w odpowiedzi na wasze żądanie na serwer zamiast upragnionego JSONa dostawaliście stringa zawierającego stronę z błędem? Oczywiście należałoby jakoś powiadomić użytkownika o wystąpieniu błędu lub wywołać odpowiednią reakcję systemu. To z kolei wiąże się z koniecznością każdorazowego sprawdzenia, czy zwrócona wiadomość jest prawidłowa. Wykorzystując interfejs pośredniczący moglibyśmy odpowiednio reagować na takie sytuacje <strong>zanim </strong>wiadomość zostanie przekazana dalej do oczekujących na nią elementów, a nawet za pomocą wzorca Publish/Subscribe tworzyć listy obiektów oczekujących i reagujących na konkretne rodzaje komunikatów.</p>

<h2>5. Dokumentuj skrypty</h2>

<p>Może to zabrzmi dziwnie, ale taka jest prawda. Kiedy rozwijasz duże aplikacje, bardzo możliwe że na przestrzeni miesięcy będziesz musiał wrócić do dawno nie oglądanego kodu lub twoja praca zostanie odziedziczona przez innego programistę, który nie ma zielonego pojęcia o tym co i jak działa. Z tego powodu w momencie, gdy skrypty nie są okraszone stosownymi komentarzami, ilość WTFów/min. znacznie wzrasta. Nie powinniśmy się przejmować wzrostem rozmiaru plików JS, ponieważ niemal każdy minifier załatwi ten problem za nas. Warto przyjąć sobie jakiś konkretny format pisania komentarzy, a w tej dziedzinie standardem wydaje się <a href="http://en.wikipedia.org/wiki/JSDoc">JSDoc</a>.</p>

<h2>6. Minimalizuj skrypty</h2>

<p>Kolejna sprawa, która powinna być dość oczywista w praktyce, często jest jednak pomijana. Minimalizowanie skryptów oraz styli pozwala nawet kilkukrotnie zmniejszyć rozmiar wymaganych do pobrania plików. Jak wiadomo im mniejszy rozmiar, tym mniej danych trzeba przesłać przez sieć i tym szybciej dana strona zostanie załadowana. Ma to znaczenie zwłaszcza dla użytkowników korzystających z urządzeń mobilnych, które często są wykorzystywane w otwartych obszarach np. miejskich hot-spotach, gdzie udźwig łącza stanowi pewien problem.</p>

<p>Innym dobrym pomysłem jest łączenie wielu plików ze skryptami do jednego pliku. Znowu wynika to z faktu, że większa ilość plików wymaga wygenerowanie przez przeglądarkę większej ilości zapytań. W przypadku gdy przeglądarka klienta lub serwer hostujący nie obsługują protokołu <a href="https://sites.google.com/a/chromium.org/dev/spdy/spdy-whitepaper">SPDY</a>, oznacza to, że każdy żądany zasób będzie wymagał ustanowienia nowego połączenia TCP, co jest dość kosztowne i negatywnie przekłada się na czas transmisji, zwłaszcza na dużych dystansach między klientem a serwerem. Z tego powodu wskazane jest zarówno łączenie jak i minimalizacja skryptów i stylów w środowisku produkcyjnym.</p>

<h2>7. Testuj skrypty</h2>

<p>Nie jest chyba dla nikogo niespodzianką, że w życiu programisty dużą część czasu poświęca się nie tylko na pisaniu kodu, ale również na sprawdzeniu jego poprawności. Aby zautomatyzować ten proces, powstało wiele frameworków umożliwiających przeprowadzanie szybkich testów. Ponieważ w dzisiejszych aplikacjach webowych coraz większa część logiki zaczyna być wykonywana po stronie klienta, dobrą praktyką jest przygotowywanie testów również dla skryptów JS. Zalet tego podejścia jest sporo, warto wymienić chociaż kilka z nich:</p>

<ul>
<li>Przeprowadzanie testów jednostkowych wymusza budowanie modularnych aplikacji opartych o luźne powiązania między obiektami. Jest to bardzo dobra metodyka programowania i pomaga poprawić czytelność oraz jakość pisanego kodu.</li>
<li>Od kiedy JavaScript umożliwia nam zdalne wywoływanie zdarzeń związanych z akcjami użytkownika, możliwe jest również przynajmniej częściowe zautomatyzowanie testów wymagających podejmowania działań po stronie klienta.</li>
<li>W przypadku scalania i minimalizacji skryptów (zwłaszcza tych wykorzystujących niezminimalizowane biblioteki zewnętrzne do developingu i zminimalizowane w środowisku produkcyjnym) nigdy nie możemy mieć 100% pewności, że nasz scalony/zminimalizowany skrypt będzie dalej działał dokładnie tak jak sprawdzaliśmy.</li>
</ul>


<p>Środowisk do testów javascriptowych jest dość sporo. Osobiście mogę polecić <a href="http://pivotal.github.com/jasmine/">Jasmine</a>, framework bazujący na rozwiązaniach znanych dla programistów Ruby z RSpeca. Jest łatwy do nauki i wprowadzenia w naszej aplikacji, a jednocześnie daje nam dużą swobodę w tworzeniu własnych rozwiązań.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2012-08-24T08:17:00+02:00" data-updated="true" itemprop="datePublished">Aug 24<span>th</span>, 2012</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/eksploracja-danych/'>eksploracja danych</a>, <a class='category' href='/blog/categories/programowanie/'>programowanie</a>


</div>
		
			<span class="comments"><a href="/blog/2012/08/24/nlp-stemming-i-lematyzacja/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2012/08/24/nlp-stemming-i-lematyzacja/" itemprop="url">[NLP] Stemming I Lematyzacja</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Zagłębiając się coraz dalej w NLP (<em>ang. Natural Language Processing</em>) &ndash; dziedzinę znaną również jako przetwarzanie języka naturalnego &ndash; natrafiłem na dość powszechny problem, którego rozwiązaniem pragnę się podzielić w tym artykule. Zacznijmy jednak od ogólnego przedstawienia problemu: załóżmy, że w życiu każdego programisty zdarzają się chwilę, w których musi on stworzyć aplikację zdolną poradzić sobie z analizą standardowego tekstu tzn. takiego, który domyślnie nie był sformatowany w sposób umożliwiający zastosowanie prostych wzorców w celu wyciągnięcia rzeczowych informacji. O ile dla większości ludzi zadanie to powinno być banalne, gdyż wystarczy nam zwykłe czytanie tekstu ze zrozumieniem, o tyle istniejące programy komputerowe mają niezwykłe problemy z jego rozwiązaniem. To właśnie tutaj z pomocą przychodzą pojęcia takie jak lematyzacja i stemming.</p>

<p><strong>Stemming </strong>&ndash; bazując na definicji z angielskiej wikipedii jest to proces polegający na wydobyciu z wybranego wyrazu tzw. rdzenia, a więc tej jego części, która jest odporna na odmiany przez przyimki, rodzaje itp.</p>

<p><strong>Lematyzacja </strong>&ndash; pojęcie to jest bardzo podobne do powyższego, a oznacza sprowadzenie grupy wyrazów stanowiących odmianę danego zwrotu do wspólnej postaci, umożliwiającej traktowanie ich wszystkich jako te samo słowo.</p>

<p>Ponieważ problem ten jest dość stary i dobrze znany, w ciągu ostatnich dziesięcioleci powstało kilka znanych algorytmów służących jego rozwiązaniu. Dwa z najbardziej znanych to algorytm Portera (1979 r.) oraz algorytm Lancaster (1990 r.). Celem moich rozważań będzie zaimplementowanie drugiego z nich.</p>

<p>Główne działanie algorytmu opiera się na słowniku zawierającym definicje par {zakończenie &ndash; podmieniany ciąg znaków} modyfikowanych wyrazów. Ponieważ słownik taki jest ciężki w skonstruowaniu postanowiłem dodać gotową listę definicji dla języka angielskiego zaczerpniętą z kodu źródłowego biblioteki NLTK (Natural Language Toolkit) napisanej w Pythonie. Listę tą znaleźć można na końcu tego artykułu.</p>

<p>Warto zwrócić uwagę na format zapisu definicji. Są one opisane w postaci pojedynczego słowa. Podciągi występujących w nim znaków stanowią kolejno:</p>

<ol>
<li>Odwrócony zapis końcówki słowa (obowiązkowy) &ndash; umożliwia określenie, czy dana reguła powinna być stosowana dla modyfikowanego wyrazu.</li>
<li>Znacznik nienaruszalności (opcjonalny, symbol: &lsquo;<strong>*&rsquo;</strong>) &ndash; oznacza to, że reguła powinna być zastosowana tylko wtedy, kiedy słowo nie zostało zmienione przez jakiekolwiek poprzednie reguły.</li>
<li>Liczba usuwanych znaków (obowiązkowa) &ndash; określa, ile liter z końca wyrazu powinno zostać usunięte podczas modyfikacji.</li>
<li>Podstawiany ciąg znaków (opcjonalny) &ndash; nowa końcówka doklejana do słowa po usunięciu poprzedniej.</li>
<li>Flaga kontynuacji (obowiązkowa, symbol: &lsquo;<strong>></strong>&rsquo; [true] lub &lsquo;<strong>.</strong>&rsquo; [false]) &ndash; określa czy po zastosowaniu tej reguły do wyrazu dopuszczalne są jakiekolwiek dalsze modyfikacje.</li>
</ol>


<p>Aby ułatwić sobie pracę, stwórzmy strukturę przechowującą informację o tak zdefiniownej regule (w mojej implementacji nazwałem ją <strong><em>StemRule</em></strong>). Kolejne punkty opisanej powyżej definicji reprezentowane będą przez następujące pola/właściwości: 1 &ndash; <em>WordEnd </em>(string), 2 &ndash; <em>Intact </em>(bool), 3 &ndash; <em>RemoveTotal </em>(int), 4 &ndash; <em>AppendString </em>(string), 5 &ndash; <em>IsContinous </em>(bool).</p>

<p>Parsowanie, realizowane w konstruktorze klasy, opiera się o wyciągnięcie odpowiednich grup przy pomocy wyrażeń regularnych a następnie wstawieniu ich wartości do odpowiadających pól.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="nf">StemRule</span><span class="p">(</span><span class="kt">string</span> <span class="n">rule</span><span class="p">){</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">RuleValdiator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Regex</span><span class="p">(</span><span class="s">@&quot;^([a-z]+)(\*?)(\d)([a-z]*)([&gt;\.]?)$&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">match</span> <span class="p">=</span> <span class="n">RuleValdiator</span><span class="p">.</span><span class="n">Match</span><span class="p">(</span><span class="n">rule</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(!</span><span class="n">match</span><span class="p">.</span><span class="n">Success</span><span class="p">)</span>
</span><span class='line'>      <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">&quot;Provided rule could not be parsed&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">var</span> <span class="n">chars</span> <span class="p">=</span> <span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">.</span><span class="n">ToCharArray</span><span class="p">();</span>
</span><span class='line'>  <span class="n">Array</span><span class="p">.</span><span class="n">Reverse</span><span class="p">(</span><span class="n">chars</span><span class="p">);</span>
</span><span class='line'>  <span class="n">WordEnd</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">string</span><span class="p">(</span><span class="n">chars</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Intact</span> <span class="p">=</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>  <span class="n">RemoveTotal</span> <span class="p">=</span> <span class="kt">int</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">3</span><span class="p">].</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>  <span class="n">AppendString</span> <span class="p">=</span> <span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">4</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'>  <span class="n">IsContinous</span> <span class="p">=</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">5</span><span class="p">].</span><span class="n">Value</span> <span class="p">!=</span> <span class="s">&quot;.&quot;</span><span class="p">)</span> <span class="p">||</span> <span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">5</span><span class="p">].</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;&gt;&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Dysponując tak przygotowanymi regułami możemy przejść do konstrukcji właściwego stemmera. Aby szybciej wydobywać odpowiednie reguły dla danego słowa, umieścimy je w czymś w rodzaju hashmapy, gdzie hashem będzie ostatnia litera końcówki wyszukiwanego słowa, zaś &ldquo;koszyk&rdquo; będzie stanowił listę obiektów <code>StemRule</code> ze stosownymi końcówkami.</p>

<p>Ostatecznie tworzenie słownika wyglądać będzie następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">StemRule</span><span class="p">&gt;&gt;</span> <span class="n">ParseRules</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">rules</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">dictionary</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">StemRule</span><span class="p">&gt;&gt;();</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">rules</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">rule</span> <span class="p">=</span> <span class="n">rules</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">firstLetter</span> <span class="p">=</span> <span class="n">rule</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">dictionary</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">firstLetter</span><span class="p">))</span>
</span><span class='line'>          <span class="n">dictionary</span><span class="p">[</span><span class="n">firstLetter</span><span class="p">].</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">StemRule</span><span class="p">(</span><span class="n">rule</span><span class="p">));</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">dictionary</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">firstLetter</span><span class="p">,</span>
</span><span class='line'>              <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">StemRule</span><span class="p">&gt;(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="k">new</span> <span class="n">StemRule</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span> <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">dictionary</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Przetwarzaniem zajmować się będzie metoda Stem. Kolejność akcji wykonywanych przez algorytm wyglądać będzie następująco:</p>

<ol>
<li>Sprowadzamy wszystkie słowa do zapisu lower case.</li>
<li>W głównej pętli:

<ol>
<li>Znajdujemy pozycję ostatniej litery w słowie i sprawdzamy czy jest ona jednym z kluczy w naszym słowniku reguł. Jeżeli nie, kończymy pracę algorytmu.</li>
<li>Pobieramy &ldquo;kubełek&rdquo; z regułami ze słownika na podstawie klucza (ostatniej litery).</li>
<li>W pętli wewnętrznej dla każdego kubełka:

<ol>
<li>Sprawdzamy, czy końcówka zapisana w regule znajduje się na końcu modyfikowanego słowa. Jeżeli nie, przechodzimy do kolejnej reguły.</li>
<li>Sprawdzamy czy reguła miała ustawioną flagę nienaruszalności: jeżeli tak, sprawdzamy czy słowo przez nas przetwarzane nie zostało zmienione przez poprzednie reguły. Jeżeli zostało, pomijamy działanie tej reguły.</li>
<li>Modyfikujemy słowo na podstawie danych z reguły.</li>
<li>Oznaczamy słowo jako zmodyfikowane.</li>
<li>Dodatkowo jeżeli reguła miała ustawioną flagę kontynuacji, wychodzimy z wewnętrznej pętli i kontynuujemy działanie algorytmu.</li>
</ol>
</li>
</ol>
</li>
</ol>


<p>Implementacja algorytmu może wyglądać następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="kt">string</span> <span class="nf">Stem</span><span class="p">(</span><span class="kt">string</span> <span class="n">token</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">lowered</span> <span class="p">=</span> <span class="n">token</span><span class="p">.</span><span class="n">ToLower</span><span class="p">();</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">proceed</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">while</span> <span class="p">(</span><span class="n">proceed</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// find position of last alphabetic letter in stemmed word</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">lastLetterPosition</span> <span class="p">=</span> <span class="n">LastLetterPosition</span><span class="p">(</span><span class="n">lowered</span><span class="p">);</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">original</span> <span class="p">=</span> <span class="n">lowered</span> <span class="p">=</span> <span class="n">lowered</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">lastLetterPosition</span> <span class="p">+</span> <span class="m">1</span><span class="p">);</span>
</span><span class='line'>      <span class="c1">// stemm the word only when it has last letter and it&#39;s matching to any stemm rule</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">lastLetterPosition</span> <span class="p">&lt;</span> <span class="m">0</span>
</span><span class='line'>          <span class="p">||</span> <span class="p">!</span><span class="n">_ruleDictionary</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">lowered</span><span class="p">[</span><span class="n">lastLetterPosition</span><span class="p">]))</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">proceed</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">var</span> <span class="n">applied</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>          <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">rule</span> <span class="k">in</span> <span class="n">_ruleDictionary</span><span class="p">[</span><span class="n">lowered</span><span class="p">[</span><span class="n">lastLetterPosition</span><span class="p">]])</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="c1">// proceed if word ends with matched rule&#39;s endingString</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">lowered</span><span class="p">.</span><span class="n">EndsWith</span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">WordEnd</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">&amp;&amp;</span> <span class="n">IsStemmingAcceptable</span><span class="p">(</span><span class="n">lowered</span><span class="p">,</span> <span class="n">rule</span><span class="p">.</span><span class="n">RemoveTotal</span><span class="p">))</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(!</span><span class="n">rule</span><span class="p">.</span><span class="n">Intact</span> <span class="p">||</span> <span class="n">lowered</span> <span class="p">==</span> <span class="n">original</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">{</span>
</span><span class='line'>                      <span class="n">lowered</span> <span class="p">=</span> <span class="n">ApplyRule</span><span class="p">(</span><span class="n">lowered</span><span class="p">,</span> <span class="n">rule</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">applied</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>                      <span class="k">if</span> <span class="p">(!</span><span class="n">rule</span><span class="p">.</span><span class="n">IsContinous</span><span class="p">)</span> <span class="n">proceed</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="c1">// if no more rules apply, stop stemming</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(!</span><span class="n">applied</span><span class="p">)</span> <span class="n">proceed</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">lowered</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Na koniec zestaw kilku metod wykorzystywanych przez powyższą implementację:</p>

<p>Pobieranie pozycji ostatniej litery w ciągu:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">LastLetterPosition</span><span class="p">(</span><span class="kt">string</span> <span class="n">word</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">word</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">--)</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="kt">char</span><span class="p">.</span><span class="n">IsLetter</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sprawdzenie, czy słowo może zostać poddane przetwarzaniu &ndash; metoda ta jest potrzebna od kiedy nie możemy przetwarzać słów jednosylabowych, niezależnie od podanych wcześniej reguł (przykład: bez tego warunku reguła usuwająca końcówkę <em>-ing</em> sprawiłaby, że wyrazy takie jak <em>sing </em>stałyby się całkowicie nieczytelne):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsStemmingAcceptable</span><span class="p">(</span><span class="kt">string</span> <span class="n">word</span><span class="p">,</span> <span class="kt">int</span> <span class="n">removeTotal</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">const</span> <span class="kt">string</span> <span class="n">vowels</span> <span class="p">=</span> <span class="s">&quot;aeiouy&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// if word start with a vowel, it have to be at least 2 letters long</span>
</span><span class='line'>  <span class="c1">// else it have to be at least 3 letters and contains at least one vowel</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">vowels</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="m">0</span><span class="p">])</span>
</span><span class='line'>             <span class="p">?</span> <span class="n">word</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">removeTotal</span> <span class="p">&gt;=</span> <span class="m">2</span>
</span><span class='line'>             <span class="p">:</span> <span class="n">word</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">removeTotal</span> <span class="p">&gt;=</span> <span class="m">3</span>
</span><span class='line'>               <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">vowels</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="m">1</span><span class="p">])</span> <span class="p">||</span> <span class="n">vowels</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="m">2</span><span class="p">]));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Aplikowanie danej reguły do słowa &ndash; dość prosta sprawa, usuwamy z końca słowa liczbę znaków podanych w regule oraz podstawiamy ewentualną końcówkę, jeżeli została ona zdefiniowana w regule:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ApplyRule</span><span class="p">(</span><span class="kt">string</span> <span class="n">word</span><span class="p">,</span> <span class="n">StemRule</span> <span class="n">rule</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Concat</span><span class="p">(</span>
</span><span class='line'>      <span class="n">word</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">word</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">rule</span><span class="p">.</span><span class="n">RemoveTotal</span><span class="p">),</span>
</span><span class='line'>      <span class="n">rule</span><span class="p">.</span><span class="n">AppendString</span> <span class="p">??</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><details><summary>Lista definicji</summary></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="s">&quot;ai*2.&quot;</span><span class="p">,</span>     <span class="c1">// -ia &gt; - if intact</span>
</span><span class='line'><span class="s">&quot;a*1.&quot;</span><span class="p">,</span>      <span class="c1">// -a &gt; - if intact</span>
</span><span class='line'><span class="s">&quot;bb1.&quot;</span><span class="p">,</span>      <span class="c1">// -bb &gt; -b</span>
</span><span class='line'><span class="s">&quot;city3s.&quot;</span><span class="p">,</span>   <span class="c1">// -ytic &gt; -ys</span>
</span><span class='line'><span class="s">&quot;ci2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -ic &gt; -</span>
</span><span class='line'><span class="s">&quot;cn1t&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -nc &gt; -nt</span>
</span><span class='line'><span class="s">&quot;dd1.&quot;</span><span class="p">,</span>      <span class="c1">// -dd &gt; -d</span>
</span><span class='line'><span class="s">&quot;dei3y&gt;&quot;</span><span class="p">,</span>    <span class="c1">// -ied &gt; -y</span>
</span><span class='line'><span class="s">&quot;deec2ss.&quot;</span><span class="p">,</span>  <span class="c1">// -ceed &gt;&quot;, -cess</span>
</span><span class='line'><span class="s">&quot;dee1.&quot;</span><span class="p">,</span>     <span class="c1">// -eed &gt; -ee</span>
</span><span class='line'><span class="s">&quot;de2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -ed &gt; -</span>
</span><span class='line'><span class="s">&quot;dooh4&gt;&quot;</span><span class="p">,</span>    <span class="c1">// -hood &gt; -</span>
</span><span class='line'><span class="s">&quot;e1&gt;&quot;</span><span class="p">,</span>       <span class="c1">// -e &gt; -</span>
</span><span class='line'><span class="s">&quot;feil1v.&quot;</span><span class="p">,</span>   <span class="c1">// -lief &gt; -liev</span>
</span><span class='line'><span class="s">&quot;fi2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -if &gt; -</span>
</span><span class='line'><span class="s">&quot;gni3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ing &gt; -</span>
</span><span class='line'><span class="s">&quot;gai3y.&quot;</span><span class="p">,</span>    <span class="c1">// -iag &gt; -y</span>
</span><span class='line'><span class="s">&quot;ga2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -ag &gt; -</span>
</span><span class='line'><span class="s">&quot;gg1.&quot;</span><span class="p">,</span>      <span class="c1">// -gg &gt; -g</span>
</span><span class='line'><span class="s">&quot;ht*2.&quot;</span><span class="p">,</span>     <span class="c1">// -th &gt; -   if intact</span>
</span><span class='line'><span class="s">&quot;hsiug5ct.&quot;</span><span class="p">,</span> <span class="c1">// -guish &gt; -ct</span>
</span><span class='line'><span class="s">&quot;hsi3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ish &gt; -</span>
</span><span class='line'><span class="s">&quot;i*1.&quot;</span><span class="p">,</span>      <span class="c1">// -i &gt; -    if intact</span>
</span><span class='line'><span class="s">&quot;i1y&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -i &gt; -y</span>
</span><span class='line'><span class="s">&quot;ji1d.&quot;</span><span class="p">,</span>     <span class="c1">// -ij &gt; -id   --  see nois4j&gt; &amp; vis3j&gt;</span>
</span><span class='line'><span class="s">&quot;juf1s.&quot;</span><span class="p">,</span>    <span class="c1">// -fuj &gt; -fus</span>
</span><span class='line'><span class="s">&quot;ju1d.&quot;</span><span class="p">,</span>     <span class="c1">// -uj &gt; -ud</span>
</span><span class='line'><span class="s">&quot;jo1d.&quot;</span><span class="p">,</span>     <span class="c1">// -oj &gt; -od</span>
</span><span class='line'><span class="s">&quot;jeh1r.&quot;</span><span class="p">,</span>    <span class="c1">// -hej &gt; -her</span>
</span><span class='line'><span class="s">&quot;jrev1t.&quot;</span><span class="p">,</span>   <span class="c1">// -verj &gt; -vert</span>
</span><span class='line'><span class="s">&quot;jsim2t.&quot;</span><span class="p">,</span>   <span class="c1">// -misj &gt; -mit</span>
</span><span class='line'><span class="s">&quot;jn1d.&quot;</span><span class="p">,</span>     <span class="c1">// -nj &gt; -nd</span>
</span><span class='line'><span class="s">&quot;j1s.&quot;</span><span class="p">,</span>      <span class="c1">// -j &gt; -s</span>
</span><span class='line'><span class="s">&quot;lbaifi6.&quot;</span><span class="p">,</span>  <span class="c1">// -ifiabl &gt; -</span>
</span><span class='line'><span class="s">&quot;lbai4y.&quot;</span><span class="p">,</span>   <span class="c1">// -iabl &gt; -y</span>
</span><span class='line'><span class="s">&quot;lba3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -abl &gt; -</span>
</span><span class='line'><span class="s">&quot;lbi3.&quot;</span><span class="p">,</span>     <span class="c1">// -ibl &gt; -</span>
</span><span class='line'><span class="s">&quot;lib2l&gt;&quot;</span><span class="p">,</span>    <span class="c1">// -bil &gt; -bl</span>
</span><span class='line'><span class="s">&quot;lc1.&quot;</span><span class="p">,</span>      <span class="c1">// -cl &gt; c</span>
</span><span class='line'><span class="s">&quot;lufi4y.&quot;</span><span class="p">,</span>   <span class="c1">// -iful &gt; -y</span>
</span><span class='line'><span class="s">&quot;luf3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ful &gt; -</span>
</span><span class='line'><span class="s">&quot;lu2.&quot;</span><span class="p">,</span>      <span class="c1">// -ul &gt; -</span>
</span><span class='line'><span class="s">&quot;lai3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ial &gt; -</span>
</span><span class='line'><span class="s">&quot;lau3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ual &gt; -</span>
</span><span class='line'><span class="s">&quot;la2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -al &gt; -</span>
</span><span class='line'><span class="s">&quot;ll1.&quot;</span><span class="p">,</span>      <span class="c1">// -ll &gt; -l</span>
</span><span class='line'><span class="s">&quot;mui3.&quot;</span><span class="p">,</span>     <span class="c1">// -ium &gt; -</span>
</span><span class='line'><span class="s">&quot;mu*2.&quot;</span><span class="p">,</span>     <span class="c1">// -um &gt; -   if intact</span>
</span><span class='line'><span class="s">&quot;msi3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ism &gt; -</span>
</span><span class='line'><span class="s">&quot;mm1.&quot;</span><span class="p">,</span>      <span class="c1">// -mm &gt; -m</span>
</span><span class='line'><span class="s">&quot;nois4j&gt;&quot;</span><span class="p">,</span>   <span class="c1">// -sion &gt; -j</span>
</span><span class='line'><span class="s">&quot;noix4ct.&quot;</span><span class="p">,</span>  <span class="c1">// -xion &gt; -ct</span>
</span><span class='line'><span class="s">&quot;noi3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ion &gt; -</span>
</span><span class='line'><span class="s">&quot;nai3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ian &gt; -</span>
</span><span class='line'><span class="s">&quot;na2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -an &gt; -</span>
</span><span class='line'><span class="s">&quot;nee0.&quot;</span><span class="p">,</span>     <span class="c1">// protect  -een</span>
</span><span class='line'><span class="s">&quot;ne2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -en &gt; -</span>
</span><span class='line'><span class="s">&quot;nn1.&quot;</span><span class="p">,</span>      <span class="c1">// -nn &gt; -n</span>
</span><span class='line'><span class="s">&quot;pihs4&gt;&quot;</span><span class="p">,</span>    <span class="c1">// -ship &gt; -</span>
</span><span class='line'><span class="s">&quot;pp1.&quot;</span><span class="p">,</span>      <span class="c1">// -pp &gt; -p</span>
</span><span class='line'><span class="s">&quot;re2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -er &gt; -</span>
</span><span class='line'><span class="s">&quot;rae0.&quot;</span><span class="p">,</span>     <span class="c1">// protect  -ear</span>
</span><span class='line'><span class="s">&quot;ra2.&quot;</span><span class="p">,</span>      <span class="c1">// -ar &gt; -</span>
</span><span class='line'><span class="s">&quot;ro2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -or &gt; -</span>
</span><span class='line'><span class="s">&quot;ru2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -ur &gt; -</span>
</span><span class='line'><span class="s">&quot;rr1.&quot;</span><span class="p">,</span>      <span class="c1">// -rr &gt; -r</span>
</span><span class='line'><span class="s">&quot;rt1&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -tr &gt; -t</span>
</span><span class='line'><span class="s">&quot;rei3y&gt;&quot;</span><span class="p">,</span>    <span class="c1">// -ier &gt; -y</span>
</span><span class='line'><span class="s">&quot;sei3y&gt;&quot;</span><span class="p">,</span>    <span class="c1">// -ies &gt; -y</span>
</span><span class='line'><span class="s">&quot;sis2.&quot;</span><span class="p">,</span>     <span class="c1">// -sis &gt; -s</span>
</span><span class='line'><span class="s">&quot;si2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -is &gt; -</span>
</span><span class='line'><span class="s">&quot;ssen4&gt;&quot;</span><span class="p">,</span>    <span class="c1">// -ness &gt; -</span>
</span><span class='line'><span class="s">&quot;ss0.&quot;</span><span class="p">,</span>      <span class="c1">// protect  -ss</span>
</span><span class='line'><span class="s">&quot;suo3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ous &gt; -</span>
</span><span class='line'><span class="s">&quot;su*2.&quot;</span><span class="p">,</span>     <span class="c1">// -us &gt; -   if intact</span>
</span><span class='line'><span class="s">&quot;s*1&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -s &gt; - if intact</span>
</span><span class='line'><span class="s">&quot;s0.&quot;</span><span class="p">,</span>       <span class="c1">// -s &gt; -s</span>
</span><span class='line'><span class="s">&quot;tacilp4y.&quot;</span><span class="p">,</span> <span class="c1">// -plicat &gt; -ply</span>
</span><span class='line'><span class="s">&quot;ta2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -at &gt; -</span>
</span><span class='line'><span class="s">&quot;tnem4&gt;&quot;</span><span class="p">,</span>    <span class="c1">// -ment &gt; -</span>
</span><span class='line'><span class="s">&quot;tne3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ent &gt; -</span>
</span><span class='line'><span class="s">&quot;tna3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ant &gt; -</span>
</span><span class='line'><span class="s">&quot;tpir2b.&quot;</span><span class="p">,</span>   <span class="c1">// -ript &gt; -rib</span>
</span><span class='line'><span class="s">&quot;tpro2b.&quot;</span><span class="p">,</span>   <span class="c1">// -orpt &gt; -orb</span>
</span><span class='line'><span class="s">&quot;tcud1.&quot;</span><span class="p">,</span>    <span class="c1">// -duct &gt; -duc</span>
</span><span class='line'><span class="s">&quot;tpmus2.&quot;</span><span class="p">,</span>   <span class="c1">// -sumpt &gt; -sum</span>
</span><span class='line'><span class="s">&quot;tpec2iv.&quot;</span><span class="p">,</span>  <span class="c1">// -cept &gt; -ceiv</span>
</span><span class='line'><span class="s">&quot;tulo2v.&quot;</span><span class="p">,</span>   <span class="c1">// -olut &gt; -olv</span>
</span><span class='line'><span class="s">&quot;tsis0.&quot;</span><span class="p">,</span>    <span class="c1">// protect  -sist</span>
</span><span class='line'><span class="s">&quot;tsi3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ist &gt; -</span>
</span><span class='line'><span class="s">&quot;tt1.&quot;</span><span class="p">,</span>      <span class="c1">// -tt &gt; -t</span>
</span><span class='line'><span class="s">&quot;uqi3.&quot;</span><span class="p">,</span>     <span class="c1">// -iqu &gt; -</span>
</span><span class='line'><span class="s">&quot;ugo1.&quot;</span><span class="p">,</span>     <span class="c1">// -ogu &gt; -og</span>
</span><span class='line'><span class="s">&quot;vis3j&gt;&quot;</span><span class="p">,</span>    <span class="c1">// -siv &gt; -j</span>
</span><span class='line'><span class="s">&quot;vie0.&quot;</span><span class="p">,</span>     <span class="c1">// protect  -eiv</span>
</span><span class='line'><span class="s">&quot;vi2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -iv &gt; -</span>
</span><span class='line'><span class="s">&quot;ylb1&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -bly &gt; -bl</span>
</span><span class='line'><span class="s">&quot;yli3y&gt;&quot;</span><span class="p">,</span>    <span class="c1">// -ily &gt; -y</span>
</span><span class='line'><span class="s">&quot;ylp0.&quot;</span><span class="p">,</span>     <span class="c1">// protect  -ply</span>
</span><span class='line'><span class="s">&quot;yl2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -ly &gt; -</span>
</span><span class='line'><span class="s">&quot;ygo1.&quot;</span><span class="p">,</span>     <span class="c1">// -ogy &gt; -og</span>
</span><span class='line'><span class="s">&quot;yhp1.&quot;</span><span class="p">,</span>     <span class="c1">// -phy &gt; -ph</span>
</span><span class='line'><span class="s">&quot;ymo1.&quot;</span><span class="p">,</span>     <span class="c1">// -omy &gt; -om</span>
</span><span class='line'><span class="s">&quot;ypo1.&quot;</span><span class="p">,</span>     <span class="c1">// -opy &gt; -op</span>
</span><span class='line'><span class="s">&quot;yti3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ity &gt; -</span>
</span><span class='line'><span class="s">&quot;yte3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ety &gt; -</span>
</span><span class='line'><span class="s">&quot;ytl2.&quot;</span><span class="p">,</span>     <span class="c1">// -lty &gt; -l</span>
</span><span class='line'><span class="s">&quot;yrtsi5.&quot;</span><span class="p">,</span>   <span class="c1">// -istry &gt; -</span>
</span><span class='line'><span class="s">&quot;yra3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ary &gt; -</span>
</span><span class='line'><span class="s">&quot;yro3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -ory &gt; -</span>
</span><span class='line'><span class="s">&quot;yfi3.&quot;</span><span class="p">,</span>     <span class="c1">// -ify &gt; -</span>
</span><span class='line'><span class="s">&quot;ycn2t&gt;&quot;</span><span class="p">,</span>    <span class="c1">// -ncy &gt; -nt</span>
</span><span class='line'><span class="s">&quot;yca3&gt;&quot;</span><span class="p">,</span>     <span class="c1">// -acy &gt; -</span>
</span><span class='line'><span class="s">&quot;zi2&gt;&quot;</span><span class="p">,</span>      <span class="c1">// -iz &gt; -</span>
</span><span class='line'><span class="s">&quot;zy1s.&quot;</span>       <span class="c1">// -yz &gt; -ys</span>
</span></code></pre></td></tr></table></div></figure>


<p></details></p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2012-07-12T18:14:00+02:00" data-updated="true" itemprop="datePublished">Jul 12<span>th</span>, 2012</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/dot-net/'>.net</a>, <a class='category' href='/blog/categories/programowanie/'>programowanie</a>, <a class='category' href='/blog/categories/wzorce-projektowe/'>wzorce projektowe</a>


</div>
		
			<span class="comments"><a href="/blog/2012/07/12/jak-wybrac-stos-frameworkow-pod-projekt/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2012/07/12/jak-wybrac-stos-frameworkow-pod-projekt/" itemprop="url">Jak Wybrać Stos Frameworków Pod Projekt Webowy (.NET)</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>W życiu każdego web developera nadchodzi moment, kiedy należy się zdecydować na wybór platform i bibliotek wykorzystywanych w nowym projekcie. Nie ma w tym absolutnie nic złego, co więcej powinniśmy być zadowoleni, mając taką opcję. W aplikacjach biznesowych często jest on podejmowany &ndash; nie zawsze słusznie ani rozsądnie (przynajmniej z naszego punktu widzenia) &ndash; za nas, przez osoby trzecie. Tym bardziej warto doceniać sytuacje, w których mamy możliwość wygłoszenia swojej opinii.</p>

<p>W takim razie rodzi się kolejne pytanie: co wybrać? W tym wątku postaram się rozwinąć swoje obserwacje na temat niektórych rozwiązań i stworzyć drobny przekrój technologii wykorzystywanych przez programistów .NET do budowy aplikacji sieciowych.</p>

<h2>Hosting</h2>

<p>Pierwsza sprawa to miejsce, w którym stać będzie nasza aplikacja. Czy będzie to standardowy wykupiony hosting, własny serwer czy może zechcemy udać się w podróż <em>into the cloud?</em> Nie rozwodzę się tutaj nad wykorzystywanym typem serwera, ponieważ praktycznie każdy rozsądny hosting oferuje IIS co najmniej od wersji 7. Hosting aplikacji na innych serwerach jest bardzo ograniczony. Osobiście nie udało mi się znaleźć strony oferującej serwery typu Mono Apache. Nadzieją na przyszłość dla alternatyw IIS może być framework <a href="http://nancyfx.org/">Nancy</a> &ndash; jeżeli się upowszechni, być może pojawią się oferty hostingowe na innych obsługiwanych przez niego serwerach.</p>

<p>Kwestia hostingu aplikacji w chmurze to inna zabawa. Tutaj aplikacje .NETowe mają spore ograniczenie. W praktyce spotkałem tylko dwie chmury typu PaaS oferujące taki hosting: promowany przez Microsoft <a href="http://www.windowsazure.com/pl-pl/">Windows Azure</a> oraz oparty o chmurę Amazonu <a href="https://appharbor.com/">AppHarbor</a>.</p>

<p>Cechą AppHarbor jest prostota &ndash; chmura ta bierze na siebie wiele z rozwiązań sprawdzonych już w Heroku i moim zdaniem jest to absolutny strzał w dziesiątkę. AppHarbor oferuje bardzo tanie jak na chmurę rozwiązania (najmniejsza, pojedyncza, współdzielona instancja jest zawsze za darmo), do tego oferuje szereg znanych technologii, o które można rozszerzyć naszą aplikację &ndash; są to głównie istniejące już na Amazonie usługi, oferty baz danych, systemów kolejkowych i innych (co ważne dla osób chcących je wykorzystać do celów prywatnych, niemal wszystkie w dysponują wersją darmową). Do tego wszystkiego wystarczy zamontować zwykłą aplikację ASP.NET (nie potrzebne są żadne specyficzne projekty). Skalowanie wykonywane jest przez proste zwiększenie liczby instancji oraz wykupienie droższych ofert u zewnętrznych usługodawców.</p>

<p>W przypadku Windows Azure mamy do czynienia z kompletnie innym podejściem. Aplikacja umieszczona na Azure jest pisana z dedykacją dla tej chmury. Potrzebny jest do tego osobny projekt, konieczne jest również generowanie specjalnych paczek umieszczanych docelowo w chmurze. Do tego cała oferta jest znacznie droższa niż opisywany poprzednik, nie mamy również dostępu do tak szerokiego menu dodatkowych usług i są one z reguły kierowane specjalnie pod Azure (technologii tych nie zobaczymy nigdzie indziej). Jakie są więc zalety? Prawdopodobnie lepsze przystosowanie do aplikacji wymagających dużego skalowania i lepsze osiągi istniejących usług. Ostatecznie może to mieć znaczenie, zwłaszcza dla dużych aplikacji.</p>

<h2>Framework</h2>

<p>W tej sytuacji również wybór jest dość prosty. O Mono Rails nikt już nie pamięta (zresztą nie ma takiej potrzeby). W praktyce mamy parę rozwiązań:</p>

<ul>
<li><strong>ASP.NET Web Forms</strong> &ndash; stara technologia, która wywołuje dreszcze chyba u wszystkich, którzy mieli już okazję posmakować MVC. Istnieje garść bibliotek dla tej technologii, jednak osobiście nikomu bym jej nie polecił. Brak modularyzacji komponentów, praktyczny brak możliwości prowadzenia testów jednostkowych czy cała masa chybionych pomysłów (ViewState WTF?) powodują, że aplikacje pisane w Web Forms często są drogą przez mękę.</li>
<li><strong>ASP.NET MVC</strong> &ndash; nowsze spojrzenie, wyraźnie inspirowane Ruby on Rails (co widać coraz wyraźniej w każdej następnej wersji). W dodatku często wykorzystywane, sprawdzone i wspierane zarówno przez sam Microsoft, jak i wiele firm zewnętrznych. Rozwiązanie w sam raz dla tych, którzy chcą rozwiązań pewnych i szybkich w pisaniu, jednocześnie nie tracąc poczucia elastyczności.</li>
</ul>


<p>Ponieważ programowanie do dynamiczna dyscyplina, warto również zwrócić uwagę na dwa stosunkowo nowe, wybijające się rozwiązania:</p>

<ul>
<li><strong>ASP.NET MVC Web API</strong> &ndash; dostępne od nadchodzącej wersji ASP MVC 4. Jedną z jego zalet jest znaczne uproszczenie w tworzeniu serwerów API (o których wspominałem w jednym z wcześniejszych wpisów), przez co stanowi pewien kontrast wobec tradycyjnego ASP MVC, jest jednak w chwili obecnej rozwiązaniem bardziej na czasie.</li>
<li><strong>Nancy </strong>&ndash; framework inspirowany Sinatrą (kolejna platforma webowa na Ruby&#8217;ego). Cechy charakterystyczne to duża modularność (przydatna sprawa kiedy potrzebujemy przystosować środowisko specjalnie pod nasze potrzeby) oraz niewielki rozmiar. Rozwiązanie to jest jednak nowe (mniej sprawdzone do ASP). Stąd polecałbym go do mniejszych aplikacji oraz tam, gdzie rola serwera opiera się głównie na pośredniczeniu między klientem a bazą danych (patrz Server API).</li>
</ul>


<h2>Baza danych i ORM</h2>

<p>Temat jest dość szeroki, dlatego nie będę się skupiał na niuansach dotyczących wyboru między bazami relacyjnymi i nierelacyjnymi &ndash; po pierwsze jest to temat na osobny artykuł, po za tym uważam, że z tymi drugimi wciąż miałem za mało do czynienia.</p>

<p>W przypadku relacyjnych baz danych, przeważnie zostanie nam narzucone jakieś konkretne rozwiązanie. W momencie, gdy mamy dostęp do SqlServer, dalszy wybór nasuwa się praktycznie sam &ndash; <strong>Entity Framework</strong>. Polecam szczególnie przyjżeć się wersjom powyżej 4.0+. Widać (kolejną zresztą) inspirację Rubym (mam mianowicie na myśli świetny mechanizm migracji/kontroli wesji bazy danych ala Rake &ndash; szczególnie przydatny w sytuacji, kiedy członkowie zespołu mają mieć dostęp do własnych, niezależnych developerskich instancji bazy danych), jak również przejście na model POCO, co zwiększa elastyczność oraz daje mniejsze uzależnienie naszych modeli od konkretnej technologii.</p>

<p>W przypadku innych typów baz, EF nie zawsze musi się to okazać najlepszym rozwiązaniem. Wynika to z faktu, że ten ORM tworzony były z myślą o bazie Microsoftu i często po macoszemu traktuje (ignoruje) technologie nie wykorzystywane przez SqlServer, ale wciąż dostępne w jego alternatywach. W tej dziedzinie można zauważyć sporą konkurencję ze strony<strong> (Fluent) NHibernate</strong>. Do ciekawostek należy mechanizm <a href="http://nhforge.org/blogs/nhibernate/archive/2009/12/17/queryover-in-nh-3-0.aspx">QueryOver</a>, mniej uniwersalny i bardziej niskopoziomowy od LINQ, jednakże lepiej przystosowany do generowania zapytań SQL pod konkretną bazę.</p>

<p>Ostatecznie kiedy mowa o takich kobyłach jak EF czy NH, warto się zastanowić, czy naprawdę potrzebujemy czegoś tak wielkiego, czy może wystarczy nam mniejsze, prostsze rozwiązanie. W końcu nie każda aplikacja musi obsługiwać zaawansowane zapytania i dawać nam możliwość ingerencji w najdrobniejszy aspekt pracy z bazą danych. W takim wypadku powstało kilka MicroORMów, wśród których najpopularniejszym rozwiązaniem jest <a href="https://github.com/markrendle/Simple.Data/">Simple.Data</a>. Dynamicznie tworzone POCOsy, zapytania sterowane konwencją nazewniczą metod oraz wsparcie naprawdę dużej ilości baz danych &ndash; najpopularniejszych baz relacyjnych, dokumentowej bazy MongoDB i planowane wsparcie usług bazodanowych dostępnych na Azure &ndash; to mocne strony tego projektu. Coś w sam raz dla osób chcących skupić się na szybkim wykonaniu gotowego kodu do komunikacji z bazą z pominięciem wszystkich upierdliwych konfiguracji.</p>

<h2>Prezentacja danych</div></h2>

<p>Gdzie ma się znajdować logika odpowiedzialna za prezentację danych? W przypadku logiki umieszczonej po stronie serwera mamy do czynienia z dynamicznym generowaniem stron, a co za tym idzie, większym kosztem obliczeniowym po stronie serwera oraz z reguły większym rozmiarem przesyłanych odpowiedzi do klienta. Zaletą jest lepsza kontrola oraz dość rozbudowane możliwości większości komercyjnych kontrolek &ndash; przydatne zwłaszcza w rozwiązaniach typowo biznesowych. W tej dziedzinie znane są dwie marki:</p>

<ul>
<li><a href="http://www.telerik.com/products/aspnet-mvc.aspx">Telerik</a> MVC &ndash; całkiem dobra biblioteka dysponująca szerokimi możliwościami (bindowanie bezpośrednio do akcji po stronie serwera, usług WCF lub wywołań ajax), o całkiem sporych możliwościach własnego rozszerzania. Wadą mogą być pewne nieprzemyślane (z mojego punktu widzenia) decyzje np. duża różnica w obsłudze kolumn z danymi i komend oraz spore rozbieżności w kodzie generowanym przez wiązania ajaxowe i serwerowe.</li>
<li><a href="http://www.devexpress.com/Subscriptions/DXperience/WhatsNew2012v1/asp.xml">DevExpress</a>. Nie spotkałem jeszcze nikogo, kto po kontakcie z Telerikiem, wybrałby DevExpress. Naprawdę ciężko usłyszeć o tej bibliotece cokolwiek dobrego. Generowany HTML nie ma wiele wspólnego z logiką, w razie potrzeb ciężko jest rozszerzyć istniejące opcje, zaś samo wsparcie techniczne jest dalekie od ideału.</li>
</ul>


<p>W przypadku kontrolek renderowanych po stronie klienta mamy prawdziwe zatrzęsienie dostępnych rozwiązań. Od jQuery UI, przez rozmaite formy wykresów, gridów czy grafów. Ciężko objąć je wszystkie dlatego postanowiłem znów wybrać dwa ciekawe rozwiązania przyjazne zwłaszcza z punktu widzenia biznesu:</p>

<ul>
<li><a href="http://www.kendoui.com/web.aspx">KendoUI</a> &ndash; kolejna biblioteka od twórców Telerika, tym razem skupiona jednak w całości po stronie klienta. Dostarcza dużych możliwości, w tym integrację z urządzeniami mobilnymi, frameworkiem MVVM Knockout.js (promowanym przez Microsoft wraz z nadchodzącym wypuszeniem ASP MVC 4) oraz obsługą HTML5.</li>
<li><a href="http://www.sencha.com/products/extjs/">ExtJS</a> &ndash; duży framework oferujący bardzo rozbudowane możliwości kontroli logiki i prezentacji danych. Jego budowa jest bardziej &ldquo;obiektowa&rdquo; (w ujęciu tworzenia instancji klas/prototypów) niż KendoUI, jednak wydaje się również, że jest trudniejszy do opanowania od swojego konkurenta &ndash; poniekąd przez fakt, że wydaje się stanowić bardziej rozległe rozwiązanie.</li>
</ul>


<h2>Uzupełnienie</h2>

<p>Pisząc uzupełnienie mam na myśli szereg bibliotek, które nieraz ułatwiają pracę, ale ciężko je podpisać pod którąkolwiek z poprzednich kategorii. W praktyce chciałem utworzyć jeszcze jedną dziedzinę, stworzoną specjalnie z myślą o rozbudowanych aplikacjach klienckich (Single Page Applications i stos MVC po stronie przeglądarki), ale ich opis zaprezentowałem we wcześniejszych postach.</p>

<p>Jednym z najciekawszych spotkanych do tej pory projektów wydaje się być <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a>.To prawdziwe wybawienie dla osób, które nie chcą za każdym razem walczyć ze stylami i kompozycjami, a w pełni wystarczy im zbiór najbardziej popularnych rozwiązań podanych <em>out of the box</em>.</p>

<p>Osoby wykorzystujące API zewnętrznych portali (np. Facebook, Twitter) mogą być zaciekawione możliwościami oferowanymi przez <a href="http://andrewplummer.github.com/APIConnect/">Connect API</a>. Ta biblioteka javascriptowa pomaga zautomatyzować odwołania do zewnętrznych API, tworząc jednocześnie spójny interfejs dla tych usług.</p>

<p>Na zakończenie, mówiąc o automatyzacji, ciekawym rozwiązaniem jest C#-owa biblioteka <a href="https://github.com/AutoMapper/AutoMapper">AutoMapper</a>. Świetnie nadaje się w sytuacjach kiedy musimy dokonywać częstych mapowań pomiędzy obiektami (jak również dokonywać kompozycji obiektów czy spłaszczeń &ndash; <em>flattening</em>) i świetnie pozwala zautomatyzować cały ten proces.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2012-07-04T19:08:00+02:00" data-updated="true" itemprop="datePublished">Jul 4<span>th</span>, 2012</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/wcf/'>WCF</a>, <a class='category' href='/blog/categories/programowanie/'>programowanie</a>


</div>
		
			<span class="comments"><a href="/blog/2012/07/04/forwardowanie-i-streaming-duzych-plikow/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2012/07/04/forwardowanie-i-streaming-duzych-plikow/" itemprop="url">Forwardowanie I Streaming Dużych Plików Przez WCF</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>W trakcie tworzenia serwisów bazujących na ASP.NET niejednokrotnie zdarza się potrzeba przesyłania dużych plików przez sieć. W przypadku, gdy kontroler, aby przetransportować plik do przeglądarki, musi odwołać się do usługi sieciowej (w opisywanym przez mnie wypadku WCF) sprawy mogą się trochę skomplikować. Ponieważ nie chcielibyśmy, aby nasz serwer regularnie zapychał się buforując dużą ilość danych, dobrym rozwiązaniem byłoby utworzenie strumienia wzdłuż całego stosu komunikacyjnego. Przedstawia to rysunek poglądowy poniżej.</p>

<p><img border="0" src="http://3.bp.blogspot.com/-YNoTKRkDFdY/T_Rk7WLTmYI/AAAAAAAAAEo/x8aFQOc0siQ/s1600/flow.png" /></p>

<p>Stwórzmy zatem przykładowe rozwiązanie takiego problemu. W tym celu podzielimy go na dwa mniejsze podproblemy: strumieniowanie pliku przy pomocy Windows Communication Foundation oraz forwardowanie otrzymanego strumienia bezpośrednio do przeglądarki. Co istotne, w rozwiązaniu tym nie możemy pozwolić sobie na zbuforowanie pliku w którymkolwiek momencie strumieniowania.</p>

<h2>Streaming WCF</h2>

<p>Zacznijmy od zdefiniowania przykładowego interfejsu naszej usługi. Może on wyglądać następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[ServiceContract]</span>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IFileStreamer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [OperationContract]</span>
</span><span class='line'>    <span class="n">FileStreamResponse</span> <span class="nf">GetFile</span><span class="p">(</span><span class="n">FileStreamRequest</span> <span class="n">request</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Jak widzimy jedyną operacja wykonywaną przez naszą usługę jest pobranie obiektu klasy <em>FileStreamResponse</em>. Klasę taką możemy zdefiniować następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[MessageContract]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">FileStreamResponse</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [MessageHeader]</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">FileName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [MessageHeader]</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">ContentType</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [MessageHeader]</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">long</span> <span class="n">FileLength</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [MessageBodyMember]</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">Stream</span> <span class="n">Stream</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Warto zatrzymać się na chwilę w tym miejscu. Jak widzimy obiekt tej klasy nie jest zdefiniowany za pomocą standardowego atrybutu <em>[DataContract]</em>, lecz nieco rzadziej spotykanego <em>[MessageContract]. </em>Powodem takiego zachowania jest właściwość oznaczona parametrem <em>[MessageBodyMember]</em>. Jest to główna treść naszego obiektu, strumień. Reszta danych zdefiniowana zostanie w nagłówku wiadomości SOAP, w którą opakowane są wszystkie serializowane obiekty transportowane przez naszą usługę. Jest tak, ponieważ zgodnie z regułami narzucanymi przez WCF, jeżeli zwracany jest strumień, powinien on być jedynym elementem zawartym w ciele wiadomości. Więcej o message contractach można dowiedzieć się <a href="http://msdn.microsoft.com/en-us/library/ms730255.aspx">tutaj</a> oraz <a href="http://msdn.microsoft.com/en-us/library/ms733742.aspx">tutaj</a>.</p>

<p>Mimo że nasza usługa ma za zadanie strumieniować pliki, to w praktyce zwracany strumień jest klasy <em>Stream</em>. Dzieje się tak z dwóch powodów:</p>

<ol>
<li>Ponieważ klasa <em>FileStream</em> nie jest oznaczona atrybutem <em>Serializable</em>, nie może ona być zserializowana i przesłana przez sieć.</li>
<li>W praktyce serializer WCF zawsze będzie konwertował wszystkie wyjściowe strumienie do klasy <em>MessageBodyStream</em>. Jest to ważne, ze względu na fakt że klasa ta nie dysponuje takimi możliwościami jak większość innych strumieni &ndash; opiszę je w drugiej części artykułu &ndash; i będziemy musieli ominąć jej braki.</li>
</ol>


<p>W dalszej kolejności powinniśmy się przyjrzeć budowie obiektu przekazywanego jako parametr. W naszym przykładzie wygląda on następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[MessageContract]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">FileStreamRequest</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [MessageBodyMember]</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Jak widać jedyną zmienną przechowywaną przez nasz obiekt żądania jest pojedyncza liczba. Pytanie zatem brzmi: czy musimy budować osobny obiekt żądania na potrzeby tylko jednego prostego parametru? Odpowiedź brzmi: Tak. Dzieje się tak dlatego, że WCF wymaga od nas, aby w przypadku, gdy w operacji zwracane są obiekty oznaczone jako <em>[MessageContract]</em>, operacja ta może przyjmować za parametry jedynie inne obiekty oznaczone tym atrybutem i może w ten sposób przyjmować tylko jeden obiekt.</p>

<p>Przejdźmy teraz do zdefiniowania klasy służącej za implementację naszej usługi.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[ServiceBehavior(AddressFilterMode = AddressFilterMode.Any)]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">FileStreamer</span> <span class="p">:</span> <span class="n">IFileStreamer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">FileStreamResponse</span> <span class="nf">GetFile</span><span class="p">(</span><span class="n">FileStreamRequest</span> <span class="n">request</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// pobieramy ścieżkę do pliku</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">path</span> <span class="p">=</span> <span class="n">GetPathFor</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">filename</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">GetFileName</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">FileStreamResponse</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Stream</span> <span class="p">=</span> <span class="n">stream</span><span class="p">,</span>
</span><span class='line'>            <span class="n">FileLength</span> <span class="p">=</span> <span class="n">stream</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span>
</span><span class='line'>            <span class="n">FileName</span> <span class="p">=</span> <span class="n">filename</span><span class="p">,</span>
</span><span class='line'>            <span class="n">ContentType</span> <span class="p">=</span> <span class="s">&quot;application/zip&quot;</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ... dalsza implementacja </span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Na koniec musimy zdefiniować konfigurację usługi tak, aby mogła ona wykorzystywać strumieniowanie. W tym wypadku jesteśmy ograniczeni do wyboru jednego z czterech bindingów, które to umożliwiają:</p>

<ul>
<li>BasicHttpBinding</li>
<li>WebHttpBinding</li>
<li>NetTcpBinding</li>
<li>NetNamedPipeBinding</li>
</ul>


<p>Niezbędne jest również określenie maksymalnego rozmiaru danych przesyłanych w strumieniu oraz określenie kierunku strumienia &ndash; dla danych pobieranych z usługi jest to <em>StreamedResponse</em>. Dodatkowo warto określić kodowanie wiadomości (co pozwoli zmniejszyć jej rozmiar) oraz rozmiar bufora ramki (im większy jego rozmiar tym mniej &ldquo;rozdrobniona&rdquo; będzie nasza wiadomość, lecz jednocześnie więcej pamięci potrzebnej jest na obsługę bufora przez serwer). Domyślny rozmiar bufora w WCF wynosi 64KB.</p>

<p>W rezultacie przykładowa konfiguracja może wyglądać następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;services&gt;</span>
</span><span class='line'>  <span class="nt">&lt;service</span> <span class="na">name=</span><span class="s">&quot;&lt;namespace&gt;.FileStreamer&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;endpoint</span>
</span><span class='line'>      <span class="na">binding=</span><span class="s">&quot;basicHttpBinding&quot;</span>
</span><span class='line'>      <span class="na">address=</span><span class="s">&quot;http://localhost/&lt;webservice_address&gt;&quot;</span>
</span><span class='line'>      <span class="na">contract=</span><span class="s">&quot;&lt;namespace&gt;.IFileStreamer&quot;</span>
</span><span class='line'>      <span class="na">bindingConfiguration=</span><span class="s">&quot;streamedBasicHttpBinding&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/service&gt;</span>
</span><span class='line'><span class="nt">&lt;/services&gt;</span>
</span><span class='line'><span class="nt">&lt;bindings&gt;</span>
</span><span class='line'>  <span class="nt">&lt;basicHttpBinding&gt;</span>
</span><span class='line'>    <span class="nt">&lt;binding</span> <span class="na">name=</span><span class="s">&quot;streamedBasicHttpBinding&quot;</span>
</span><span class='line'>             <span class="na">transferMode=</span><span class="s">&quot;StreamedResponse&quot;</span>
</span><span class='line'>             <span class="na">messageEncoding=</span><span class="s">&quot;Mtom&quot;</span>
</span><span class='line'>             <span class="na">maxReceivedMessageSize=</span><span class="s">&quot;629145600&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="c">&lt;!-- maksymalny rozmiar pliku: 600MB --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/basicHttpBinding&gt;</span>
</span><span class='line'><span class="nt">&lt;/bindings&gt;&lt;/services&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Analogicznie do tego można utworzyć konfigurację kliencką. Można ją zdefiniować ręcznie albo posłużyć się opcją <em>Add Service Reference</em> z menu kontekstowego referencji w projekcie docelowym otwartym w Visual Studio lub używając narzędzia <em>svcutil </em>i wygenerować w ten sposób potrzebny plik proxy klienta i konfigurację.</p>

<h2>Forwardowanie po stronie ASP</h2>

<p>Zanim przejdziemy do pisania przykładowego kodu, należy zwrócić uwagę na kilka kwestii.</p>

<p>Tak jak opisałem wcześniej mimo, że transport pliku z operacji WCF odbywa się za pomocą strumienia, nie jest to jednak obiekt klasy <em>FileStream</em>, lecz <em>MessageBodyStream</em>. Nanosi to na nasze zadanie pewne trudności:</p>

<ul>
<li>Metoda <em>Read </em>strumienia tej klasy nie musi zwracać w wyniku ilości faktycznie odczytanych wierszy. Ponieważ strumień nie definiuje również żadnego odpowiednika flagi <em>EndOfStream</em>, musimy z góry znać długość strumienia, aby w odpowiednim momencie zakończyć odczytywanie danych.</li>
<li>Strumień ten nie implementuje właściwości <em>Length</em> (sic!), stąd też musieliśmy wcześniej zdefiniować message contract, w którym ustawiamy ręcznie tą długość jako jeden z parametrów przekazywanych w nagłówku wiadomości.</li>
<li>Przy próbie bezpośredniego zwrócenia tego strumienia przy przekazaniu go do metody <em>File </em>kontrolera, nastąpi próba zbuforowania całego pliku przez kontroler. Zgodnie z początkowym założeniem nie możemy do tego dopuścić. Z tego powodu powinniśmy własnoręcznie skonstruować odpowiedź dla przeglądarki.</li>
</ul>


<p>W rezultacie przykładowy kod akcji kontrolera może wyglądać następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">private</span> <span class="n">ActionResult</span> <span class="nf">GetFileStream</span><span class="p">(</span><span class="kt">long</span> <span class="n">id</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// fileStreamer - klient proxy do usługi WCF</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="n">fileStreamer</span><span class="p">.</span><span class="n">GetFile</span><span class="p">(</span><span class="k">new</span> <span class="n">FileStreamRequest</span> <span class="p">{</span> <span class="n">Id</span> <span class="p">=</span> <span class="n">versionId</span> <span class="p">});</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Stream</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">message</span><span class="p">.</span><span class="n">FileLength</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryReader</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Stream</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Response</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span><span class='line'>            <span class="n">Response</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="n">message</span><span class="p">.</span><span class="n">ContentType</span><span class="p">;</span>
</span><span class='line'>            <span class="n">Response</span><span class="p">.</span><span class="n">AddHeader</span><span class="p">(</span><span class="s">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">FileLength</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
</span><span class='line'>            <span class="n">Response</span><span class="p">.</span><span class="n">AddHeader</span><span class="p">(</span><span class="s">&quot;Content-Disposition&quot;</span><span class="p">,</span> <span class="s">&quot;attachment; filename=&quot;</span> <span class="p">+</span> <span class="n">message</span><span class="p">.</span><span class="n">FileName</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="kt">var</span> <span class="n">defaultBufferSize</span> <span class="p">=</span> <span class="m">1024</span><span class="p">*</span><span class="m">1024</span><span class="p">*</span><span class="m">64</span><span class="p">;</span>   <span class="c1">// 65KB</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">bytesRead</span> <span class="p">=</span> <span class="m">0L</span><span class="p">;</span>
</span><span class='line'>            <span class="k">do</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="kt">var</span> <span class="n">frame</span> <span class="p">=</span> <span class="p">(</span><span class="n">bytesRead</span> <span class="p">+</span> <span class="n">defaultBufferSize</span><span class="p">)</span> <span class="p">&lt;=</span> <span class="n">message</span><span class="p">.</span><span class="n">FileLength</span>
</span><span class='line'>                    <span class="p">?</span> <span class="n">defaultBufferSize</span>
</span><span class='line'>                    <span class="p">:</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">message</span><span class="p">.</span><span class="n">FileLength</span> <span class="p">-</span> <span class="n">bytesRead</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="kt">var</span> <span class="n">buffer</span> <span class="p">=</span> <span class="n">stream</span><span class="p">.</span><span class="n">ReadBytes</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
</span><span class='line'>                <span class="n">Response</span><span class="p">.</span><span class="n">BinaryWrite</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span><span class='line'>                <span class="n">Response</span><span class="p">.</span><span class="n">Flush</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">bytesRead</span> <span class="p">+=</span> <span class="n">frame</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span> <span class="n">bytesRead</span> <span class="p">&lt;</span> <span class="n">message</span><span class="p">.</span><span class="n">FileLength</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Response</span><span class="p">.</span><span class="n">End</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ostatnia rzecz warta odnotowania, to w zasadzie rada dla developerów. Niestety, aby sprawdzić działanie strumienia w praktyce, musimy uruchomić naszą aplikację na rzeczywistym serwerze IIS (można to ustawić we właściwościach projektu), ponieważ standardowy serwer developerski ASP nie udostępnia tej opcji.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2012-06-30T22:32:00+02:00" data-updated="true" itemprop="datePublished">Jun 30<span>th</span>, 2012</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/wzorce-projektowe/'>wzorce projektowe</a>


</div>
		
			<span class="comments"><a href="/blog/2012/06/30/api-servery-i-mvc-po-stronie-klienta/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2012/06/30/api-servery-i-mvc-po-stronie-klienta/" itemprop="url">API Servery I MVC Po Stronie Klienta</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Ostatnio zainteresował mnie trend coraz częściej widoczny w środowiskach web developerów, aby coraz większą część aplikacji webowych przenosić w stronę klienta. Sprawę potęguje fakt, że coraz więcej powstaje narzędzi ułatwiających te czynności, zaś duże firmy, takie jak Google, Twitter czy Facebook, promują przenoszenie kolejnych funkcjonalności do przeglądarki.</p>

<p>Zacznijmy od tego, jak wygląda &ldquo;tradycyjny&rdquo; model działania aplikacji WWW.</p>

<p>Serwer odbiera żądanie. Aby na nie odpowiedzieć, wykonuje wiele operacji takich jak mapowanie routingu, uwierzytelnianie, czy pobranie elementów z bazy. Po ich wykonaniu nadchodzi czas na proces przygotowania odpowiedzi. W obecnych czasach serwery nie serwują praktycznie żadnych statycznych stron HTML, zawartość jest przeważnie generowana dynamicznie i wypełniana na podstawie danych dla każdego żądania. Warto zauważyć, że tak wygenerowana strona może mieć dość spory rozmiar. W przypadku kolejnych żądań serwer powtarza wszystkie kroki, w wyniku zwracając kolejną stronę HTML, w większości przypadków bardzo podobną do poprzedniej (za sprawą wspólnego Layoutu oraz dołączanych skryptów i stylów).</p>

<p>To tradycyjne podejście ma kilka zalet:</p>

<ul>
<li>Ponieważ większość logiki związanej z prezentacją generowana jest w postaci HTML po stronie serwera, maszyna klienta nie musi borykać się z ciężkimi skryptami. Jest to pewien plus w przypadku słabych maszyn czy starych przeglądarek, źle radzących sobie z javascriptem.</li>
<li>Nie ma co ukrywać, że utrzymywanie kodu JS jest znacznie bardziej wymagające niż odpowiadającego mu kodu w innych językach wykorzystywanych po stronie serwera.</li>
<li>Niektóre roboty internetowe ignorują pewne fragmenty adresów url lub nie wykrywają tych adresów w miejscach innych niż linki. Dodatkowo indeksery mogą mieć problemy z przetwarzaniem treści innych niż strony HTML. Z tego powodu tradycyjnie serwowane strony są łatwe do rozpoznawania i indeksowania.</li>
</ul>


<p>Na czym więc polega w skrócie budowa oparta o &ldquo;ciężkiego&rdquo; klienta i serwer API. Chodzi mianowicie o zrzucenie z serwera odpowiedzialności za generowanie stron HTML (które mogą być w rzeczywistości ładowane dynamicznie). Ma on odpowiadać jedynie za przesyłanie szablonów stron HTML, skryptów czy stylów oraz (co najważniejsze) udostępniać API pozwalające sterować logiką za pomocą żądań HTTP i zwracające surowe informacje (przekazywane przeważnie w formacie JSON), których prezentacją zajmą się skrypty po stronie klienta.</p>

<p>Jakie zalety ma takie podejście?</p>

<ul>
<li>Zmniejszenie obciążenia serwera &ndash; jeżeli jesteśmy w stanie przesyłać niezbędne elementy prezentacji w postaci statycznych szablonów HTML, nasze serwery nie muszą ich generować w czasie rzeczywistym.</li>
<li>Zmniejszenie rozmiaru przesyłanych danych &ndash; od kiedy nie musimy za każdym razem serwować widoku całej strony, a jedynie skupić się na prostych szablonach oraz danych w formacie JSON (który powoduje znacząco mniejszy narzut niż HTML), wykorzystywane przez nas pasmo jest znacznie mniejsze. Jest to dobra wiadomość zarówno dla hosta, jak i dla wielu użytkowników, którzy coraz częściej przeglądają internet poza domem korzystając ze swoich smartfonów.</li>
<li>Dobra integracja z innymi usługami &ndash; od kiedy nasz serwer udostępnia informacje w formie API opartego o otwarte standardy, zarówno my jak i inni programiści możemy oprzeć na nim usługi inne niż standardowe strony WWW (jest to dobra wiadomość zwłaszcza dla twórców aplikacji na urządzenia mobilne).</li>
<li>Single Page Application jako aplikacja desktopowa &ndash; dzięki możliwościom najnowszych przeglądarek jesteśmy w stanie szybko wzbogacić naszą aplikację o możliwość pracy offline, nawet kiedy użytkownik nie ma dostępu do Internetu.</li>
</ul>


<p>Oczywiście nie każdemu odpowiadają te rozwiązania i często można słyszeć głosy sprzeciwu. Ale ponieważ Internet udostępnia pole do otwartej dyskusji, postaram się wysunąć kilka kontrargumentów na najczęściej spotykane zarzuty.</p>

<ul>
<li>Co ze starszymi przeglądarkami? &ndash; częste pytanie, głównie ze względu na to, że wiele bajerów dostępnych w nowych przeglądarkach może słabo lub wcale nie działać na starszych. Oczywiście takie rzeczy jak wolno działający javascript można optymalizować, jednakże kiedy dochodzi się do granic, może pojawić się potrzeba dodania popupa <em>&ldquo;Przestań przeglądać Internet za pomocą kartofla&rdquo;</em> dla tych kilku użytkowników, którzy jeszcze nie wiedzą, że istnieją przeglądarki inne niż IE.</li>
<li>Co ze słabszym sprzętem? &ndash; w dzisiejszych czasach praktycznie każdego stać na sprzęt spełniający wymagania większości stron działających na wydajnych przeglądarkach. Ta teza dotyczy również urządzeń mobilnych &ndash; większość smartfonów niewiele odstaje osiągami od desktopów sprzed kilku lat.</li>
<li>A co, jeżeli ktoś ma wyłączoną obsługę JavaScriptu? &ndash; zdziwiłem się, gdy zobaczyłem to jako dość częsty argument w dyskusjach. Dla osób które nie widzą w tu nic absurdalnego, proponuję jednak przeczytać znowu to pytanie ze zrozumieniem, aż do skutku.</li>
<li><em>&ldquo;It&rsquo;s fucking JavaScript&rdquo;</em> &ndash; tak, utrzymywanie dużej ilości kodu JS jest trudne, po przekroczeniu pewnego progu jestem w stanie przyznać, że to zadanie prawie niemożliwe. Na szczęście społeczność programistów JS jest dość pomysłowa i można znaleźć multum ułatwień pozwalających zachować prosty, czytelny i działający kod &ndash; począwszy od różnego typu platform, przez języki kompilowane do Javascriptu, a kończąc na frameworkach umożliwiających testy jednostkowe po stronie przeglądarki.</li>
</ul>


<p>Podsumowując, nowe podejście oparte na budowaniu aplikacji na zasadzie konstrukcji bogatych stron klienckich wspieranych przez serwery API może okazać się ciekawym i obiecującym rozwiązaniem. Zarówno dla twórców, poprzez zmniejszenie kosztów za pomocą odciążenia logiki serwerowej, jak i dla użytkowników, wzbogacając ich doświadczenia w korzystaniu ze stron oraz usprawniając pracę poza domem.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2012-05-26T14:57:00+02:00" data-updated="true" itemprop="datePublished">May 26<span>th</span>, 2012</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/dot-net/'>.net</a>, <a class='category' href='/blog/categories/programowanie/'>programowanie</a>


</div>
		
			<span class="comments"><a href="/blog/2012/05/26/linq-sortowanie-po-nazwie-wasciwosci/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2012/05/26/linq-sortowanie-po-nazwie-wasciwosci/" itemprop="url">LINQ - Sortowanie Po Nazwie Właściwości</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>LINQ to potężne narzędzie, które odpowiednio używane, może zaoszczędzić wiele czasu w pracy z różnymi typami kolekcji czy podczas generowania zapytań. Czasami jednak okazuje się, że potrzebujemy nieco rozszerzyć jego możliwości. Jednym z takich przypadków może okazać się sortowanie.</p>

<p>Owszem można powiedzieć, że w Linq dysponujemy metodami OrderBy oraz OrderByDescending, ale ograniczenie tych metod tkwi w fakcie, że wymagają przekazania parametru sortowania w postaci wyrażenia lamba. Co zrobić w momencie, gdy nie dysponujemy takim wyrażeniem (np. sortujemy według parametrów przekazanych po HTTP)?</p>

<p>Rozwiązaniem takiego przypadku jest konstrukcja własnego rozszerzenia interfejsu IQueryable, które może wyglądać następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">OrderByName</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">data</span><span class="p">,</span> <span class="kt">string</span> <span class="n">propertyName</span><span class="p">,</span> <span class="kt">bool</span> <span class="k">descending</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">res</span> <span class="p">=</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">var</span> <span class="n">orderName</span> <span class="p">=</span> <span class="k">descending</span> <span class="p">?</span> <span class="s">&quot;OrderByDescending&quot;</span> <span class="p">:</span> <span class="s">&quot;OrderBy&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">typeSrc</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">parameter</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Parameter</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="s">&quot;x&quot;</span><span class="p">);</span> <span class="c1">// (x)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">var</span> <span class="n">orderByProperty</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Property</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">propertyName</span><span class="p">);</span>   <span class="c1">// (x.property)</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">typeDst</span> <span class="p">=</span> <span class="n">orderByProperty</span><span class="p">.</span><span class="n">Type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">var</span> <span class="n">funcType</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;,&gt;).</span><span class="n">MakeGenericType</span><span class="p">(</span><span class="n">typeSrc</span><span class="p">,</span> <span class="n">typeDst</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">lambda</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">funcType</span><span class="p">,</span> <span class="n">orderByProperty</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>   <span class="c1">// (x=&gt;x.property)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Queryable</span><span class="p">).</span><span class="n">GetMethods</span><span class="p">().</span><span class="n">First</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span>
</span><span class='line'>      <span class="n">m</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">orderName</span>
</span><span class='line'>      <span class="c1">// musimy usunąć wersję OrderBy pobierającą element IComparer</span>
</span><span class='line'>      <span class="p">&amp;&amp;</span> <span class="n">m</span><span class="p">.</span><span class="n">GetParameters</span><span class="p">().</span><span class="n">Length</span> <span class="p">==</span> <span class="m">2</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="n">MakeGenericMethod</span><span class="p">(</span><span class="n">typeSrc</span><span class="p">,</span> <span class="n">typeDst</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">res</span> <span class="p">=</span> <span class="p">(</span><span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span><span class="n">result</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{</span> <span class="n">data</span><span class="p">,</span> <span class="n">lambda</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Powyższy kod umożlwia sortowanie po właściwości przekazanej w postaci nazwy oraz jednocześnie ustawienie kierunku sortowania.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2012-01-07T08:39:00+01:00" data-updated="true" itemprop="datePublished">Jan 7<span>th</span>, 2012</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/programowanie/'>programowanie</a>


</div>
		
			<span class="comments"><a href="/blog/2012/01/07/javascript-konwersja-string-liczba/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2012/01/07/javascript-konwersja-string-liczba/" itemprop="url">[Javascript] Konwersja String - Liczba?</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Wydawać by się mogło, że to proste zagadnienie. Praktyka jednak pokazuje, że wielu początkujących programistów javascriptowych ma problemy z właściwym jego rozwiązaniem. Częstą praktyką jest wykorzystywanie dwóch wbudowanych funkcji: <code>parseInt</code> i <code>parseFloat</code>. Przyjżyjmy się im więc:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nb">parseInt</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>      <span class="c1">// wynik: 2</span>
</span><span class='line'><span class="nb">parseInt</span><span class="p">(</span><span class="s2">&quot;2.2&quot;</span><span class="p">)</span>    <span class="c1">// ups, znowu mamy 2</span>
</span><span class='line'><span class="nb">parseInt</span><span class="p">(</span><span class="s2">&quot;2 koty&quot;</span><span class="p">)</span> <span class="c1">// kolejne zaskoczenie, wynik: 2</span>
</span><span class='line'><span class="nb">parseInt</span><span class="p">(</span><span class="s2">&quot;napis&quot;</span><span class="p">)</span>  <span class="c1">// nareszcie, wynik: NaN</span>
</span><span class='line'>
</span><span class='line'><span class="nb">parseFloat</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>    <span class="c1">// do przewidzenia, wynik: 2</span>
</span><span class='line'><span class="nb">parseFloat</span><span class="p">(</span><span class="s2">&quot;2.2&quot;</span><span class="p">)</span>  <span class="c1">// wszystko jasne, wynik: 2.2</span>
</span><span class='line'><span class="nb">parseFloat</span><span class="p">(</span><span class="s2">&quot;2.2 kota&quot;</span><span class="p">)</span> <span class="c1">// wynik: 2.2</span>
</span><span class='line'><span class="nb">parseFloat</span><span class="p">(</span><span class="s2">&quot;napis&quot;</span><span class="p">)</span>  <span class="c1">// nareszcie, wynik: NaN</span>
</span></code></pre></td></tr></table></div></figure>


<p>Jak widać nie zawsze znaczenie funkcji parsujących jest takie oczywiste jak mogłoby się wydawać. Owszem jesteśmy w stanie dokonać konwersji liczby przekazanej jako string do jej odpowiednika numerycznego. Kłopot polega na tym, że funkcje parsujące potrafią wydobyć liczbę z każdego łańcucha znaków zaczynającego się cyfrą.</p>

<p>W jaki sposób możemy sprawić, aby konwersji poddawały się tylko i wyłącznie stringi zawierające poprawnie zapisane liczby? Odpowiedź jest stosunkowo prosta:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">+</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>    <span class="c1">// wynik: 2</span>
</span><span class='line'><span class="o">+</span><span class="p">(</span><span class="s2">&quot;2.2&quot;</span><span class="p">)</span>  <span class="c1">// wynik: 2.2</span>
</span><span class='line'><span class="o">+</span><span class="p">(</span><span class="s2">&quot;2aa&quot;</span><span class="p">)</span>  <span class="c1">// wynik: NaN</span>
</span><span class='line'><span class="o">+</span><span class="p">(</span><span class="s2">&quot;.01&quot;</span><span class="p">)</span>  <span class="c1">// wynik: 0.01</span>
</span><span class='line'><span class="o">+</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>     <span class="c1">// wynik: 0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Niejawnie zachodzi tu w rzeczywistości konwersja: <code>Number(string)</code>. Jak widzimy metoda ta wciąż nie jest wolna od błędów, mimo to zapis taki jest prostszy i wciąż bardziej wiarygodny niż funkcje parsujące.</p>

<p>Ostatecznie, aby sprawdzić czy podana wartość jest faktycznie liczbą (wykluczając jednocześnie 2 ostatnie wyniki z powyższego przykładu), można skorzystać z wyrażenia regularnego: <code>/^\d+(.\d+)?$/.test(myNumber)</code>. Wyrażenie to zaakceptuje wszystkie liczby stało i zmiennoprzecinkowe. Odrzuci przy tym puste łańcuchy znaków, oraz wartości poprzedzone lub kończące sie białymi znakami. Jeżeli chcielibyśmy, aby i one przechodzimy przez test, wówczas modyfikujemy wyrażenie w następujący sposób: <code>/^\s<em>\d+(.\d+)?\s</em>$/.test(myNumber)</code></p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2011-11-24T23:07:00+01:00" data-updated="true" itemprop="datePublished">Nov 24<span>th</span>, 2011</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/wcf/'>WCF</a>, <a class='category' href='/blog/categories/programowanie/'>programowanie</a>


</div>
		
			<span class="comments"><a href="/blog/2011/11/24/wcf-wydobywanie-wiadomosci-w-postaci/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2011/11/24/wcf-wydobywanie-wiadomosci-w-postaci/" itemprop="url">[WCF] Wydobywanie Wiadomości W Postaci SOAP Po Stronie Klienta</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Windows Communication Foundation jest obecnie jednym z bardziej powszechnych (i moim zdaniem także jednym z najlepiej zaprojektowanych) frameworków do obsługi usług sieciowych (<em>Web Services</em>). Nie wdając się zbytnio w szczegóły działania takiej usługi, wystarczy nam wiedzieć, że aby zostać przekazana, każda wiadomość (reprezentowana po stronie .NETu przez obiekt odpowiedniej klasy) musi być zserializowana do postaci tzw. dokumentu, który w większości przypadków występuje pod postacią XML lub jego podzbiorem, SOAP.</p>

<p>Z reguły nie musimy dysponować wiedzą o tym, w jaki sposób nasza wiadomość zostaje reprezentowana za kulisami usługi. Niestety w życiu pojawiają się sytuacje, kiedy ta informacja może mieć dla nas istotne znaczenie. Przykładem takiej sytuacji mogą być narzędzia diagnostyczne, których zadaniem jest kontrola i monitorowanie działania usługi.</p>

<p>Sposobów na wydobycie wiadomości w jej &ldquo;surowej&rdquo; postaci, tzn. reprezentacji XML (lub SOAP, ponieważ zależy nam na w miarę czytelnej formie) jest kilka. Jednym z nich może być np. podpięcie się do modułu zajmującego się deserializacją dokumentu. Innym jest wykorzystanie wbudowanych w WCF opcji tracingu. W poniższym przykładzie przedstawię drugą opcję.</p>

<h2>Etap 1 &ndash; konfiguracja</h2>

<p>Ponieważ WCF jest środowiskiem, które umożliwia zdefiniowanie niemal wszystkiego za pomocą konfiguracji, warto skorzystać z tego rozwiązania, kiedy tylko mamy taką możliwość. O pozostałych sytuacjach tzn. kiedy sama konfiguracja to za mało, a dostarczone przez twórców frameworka &ldquo;klocki&rdquo; nam nie wystarczą opowiem w dalszej części wpisu.</p>

<p>Jak więc za pomocą konfiguracji ustawić naszego klienta, aby możliwy był nasłuch nadchodzących wiadomości? Po pierwsze należy zdefiniować taką opcję wewnątrz gałęzi system.service model. Ilustruje to następujący fragment:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>  <span class="nt">&lt;system.serviceModel&gt;</span>
</span><span class='line'>    <span class="nt">&lt;diagnostics&gt;</span>
</span><span class='line'>      <span class="nt">&lt;messageLogging</span>
</span><span class='line'>        <span class="na">logMalformedMessages=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>        <span class="na">logMessagesAtServiceLevel=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>        <span class="na">logEntireMessage=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>        <span class="na">logMessagesAtTransportLevel=</span><span class="s">&quot;true&quot;</span>
</span><span class='line'>        <span class="na">maxMessagesToLog=</span><span class="s">&quot;-1&quot;</span>
</span><span class='line'>        <span class="na">maxSizeOfMessageToLog=</span><span class="s">&quot;10000&quot;</span>
</span><span class='line'>        <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/diagnostics&gt;</span>
</span><span class='line'>    ...pozostała część konfiguracji
</span><span class='line'>  <span class="nt">&lt;/system.serviceModel&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>
Co znaczą następujące atrybuty?:</p>

<ul>
<li><strong><em>logMalformedMessages</em></strong> &ndash; oznacza, że poza normalnymi wiadomościami, logowane zostaną również te, których deserializacja była niemożliwa (np. z powodu uszkodzenia zawartości dokumentu). W takim wypadku dokument zostaje logowany &ldquo;na surowo&rdquo; tzn. do momentu, kiedy był on jeszcze czytelny dla aplikacji. Jeżeli zawartość była zaszyfrowana w momencie wystąpienia błędu, log również będzie zaszyfrowany.</li>
<li><strong><em>logMessagesAtServiceLevel</em></strong>, <strong><em>logMessagesAtTransportLevel</em></strong> &ndash; oznacza, czy wiadomości mają zostać logowane w momencie przejścia przez warstwę transportową, czy w chwili kiedy stają się dostępne dla usługi / konsumenta.</li>
<li><strong><em>logEntireMessage</em></strong> &ndash; domyślnie ustawione na false. Określa czy logowana jest cała treść wiadomości czy tylko jej nagłówek SOAP.</li>
<li><strong><em>maxMessagesToLog</em></strong> &ndash; określa limit wiadomości, które mogą być zalogowane. Pozwala nam uchronić się przed zasypaniem nadmierną ilością danych.</li>
<li><strong><em>maxSizeOfMessageToLog</em></strong> &ndash; określa maksymalny rozmiar logowanej wiadomości. W momencie kiedy zapisywana wiadomość jest za długa, zapisana zostaje ta część która zmieściła się w limicie, a reszta zostaje ucięta i nie podlega logowaniu.</li>
</ul>


<p>Oczywiście nie musimy określać wszystkich tych atrybutów, ponieważ nie zawsze zależy nam na tak wysokim poziomie szczegółowości logowanych informacji.</p>

<p>Kiedy określiliśmy zasady logowania wiadomości po stronie WCF, powiedzieliśmy naszej aplikacji jak ma wyglądać wiadomość, którą framework udostępnia do logowania. Teraz należy skonfigurować tracing, tzn. powiedzieć jakie typy wiadomości mają być logowane oraz jak ma przebiegać proces logowania (m.in. gdzie zapisujemy wiadomości). Oto wycinek przykładowej konfiguracji:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>  <span class="nt">&lt;system.diagnostics&gt;</span>
</span><span class='line'>    <span class="nt">&lt;sources&gt;</span>
</span><span class='line'>      <span class="nt">&lt;source</span> <span class="na">name=</span><span class="s">&quot;System.ServiceModel.MessageLogging&quot;</span>
</span><span class='line'>              <span class="na">switchValue=</span><span class="s">&quot;All&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;listeners&gt;</span>
</span><span class='line'>          <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">&quot;myListenerName&quot;</span>
</span><span class='line'>               <span class="na">type=</span><span class="s">&quot;assembly qualified name&quot;</span>
</span><span class='line'>               <span class="na">initializeData=</span><span class="s">&quot;my file path&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/listeners&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/source&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/sources&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/system.diagnostics&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Odrobina wyjaśnienia:</p>

<ul>
<li><strong>source</strong> &ndash; określa konfigurację obiektu, stanowiącego źródło nadchodzących logów. W przypadku, kiedy chcielibyśmy mieć możliwość późniejszego odwołania sie do tej instancji w kodzie aplikacji, należy zapamiętać nazwę stanowiącą identyfikator. Wartość switchValue określa jakiego typu wiadomości mają być logowane. Wyróżniamy:

<ul>
<li><strong><em>Off</em></strong> &ndash; wyłączona możliwość logowania.</li>
<li><strong><em>Critical</em></strong> &ndash; logowane są błędy krytyczne, które mogą powodować wyłączenie się aplikacji (np. wyczerpanie pamięci, przepełnienie stosu, zawieszenie systemu).</li>
<li><strong><em>Error</em></strong> &ndash; logowane są błędy, w tym te które mogą powodować nieprawidłowe działanie programu, które jednak nie spowodują zakończenia programu. Należą do nich chyba wszystkie niewyłapane wyjątki.&ndash; <strong><em>Warning</em></strong> &ndash; uprzedzenia programu o możliwości wystąpienia nieprawidłowości, które jednak nie będą miały większego wpływu na dalsze działanie aplikacji. Przykłady: nieprawidłowe logowanie, przekroczenie limitu czasu na wykonanie zadania.</li>
<li><strong><em>Information</em></strong> &ndash; logowanie ważniejszych elementów działającej aplikacji np. poprawne odczytanie konfiguracji lub stworzenie kanału pomiędzy usługą a konsumentem &ndash; dla przypomnienia, WCF wymaga stworzenia kanału komunikacyjnego, jakiekolwiek protokoły wykorzystujące komunikację bezpołączeniową (w tym UDP) nie są obsługiwane.</li>
<li><strong><em>Verbose</em></strong> &ndash; podobnie jak powyższe, jednak logowane są zdarzenia bardziej &ldquo;niskopoziomowe&rdquo; np. udane odczytanie nagłówka SOAP wiadomości.</li>
<li><strong><em>ActivityTracing</em></strong> &ndash; logowane są wszystkie formy komunikacji między klientem a usługą, zarówno na poziomie usługi jak i w warstwie transportowej.</li>
<li><strong><em>All</em></strong> &ndash; wszystkie powyższe.</li>
</ul>
</li>
<li><strong>listeners</strong> &ndash; jest to kolekcja obiektów zajmujących się logowaniem wiadomości nadchodzących ze źródła. Dodając kolejny obiekt należy podać jego identyfikator (używany potem do rozpoznania go w kolekcji), typ czyli nazwę kwalifikowaną (pełna nazwa klasy, łącznie z podaniem przestrzeni nazw, nazwy zestawu / assembly, opcjonalnie również numer wersji i token). Do tego możemy również podać atrybut initializeData, który może posłużyć przekazaniu informacji inicjalizujących obiekt, bądź wykorzystywanych przez stosowny konstruktor listenera. Dostępnych mamy kilka typów wbudowanych listenerów oferowanych przez platformę .NET:

<ul>
<li><strong><em>TextWriterTraceListener</em></strong> &ndash; wykorzystuje standardowy strumień tekstowy do logowania wiadomości. W konfiguracji możemy podać plik, do którego logowne będą informacje. W aplikacji możemy podać strumień, dla którego listener stworzy obiekt TextWritera, który będzie później wykorzystywany do logowania zdarzeń.</li>
<li><strong><em>XmlWriterTraceListener</em></strong> &ndash; tak jak powyższy, z tą różnicą że wykorzystywany wraper TextWritera jest zastąpiony XmlWriterem.</li>
<li><strong><em>ConsoleTraceListener</em></strong> &ndash; automatycznie ustawia strumień wyjściowy konsoli (Console.Out) na odbiorcę logowanych wiadomości. Wszystkie zdarzenia zostaną wyświetlone na konsoli.</li>
<li><strong><em>DefaultTraceListener</em></strong> &ndash; domyślnie używany tylko w trybie debug. Wysyła logowane wiadomości na okno Output środowiska Visual Studio.</li>
<li><strong><em>EventLogTraceListener</em></strong> &ndash; wykorzystuje mechanizm logów udostępniony bezpośrednio przez nasz system operacyjny.</li>
<li><strong><em>WebPageTraceListener</em></strong> &ndash; wykorzystywany do logowania informacji w kanałach udostępnianych przez ASP.NET framework.</li>
</ul>
</li>
</ul>


<p>Powyższa konfiguracja jest w stanie samodzielnie &ndash; bez jakiejkolwiek ingerencji w kodzie &ndash; poradzić sobie z postawionym przez nas zadaniem zapisywania wiadomości w postaci SOAP. Niestety w sytuacji, kiedy podane nam możliwości listenerów nie wystarczą, np. kiedy chcielibyśmy logować wiadomości bezpośrednio w polu teksowym naszej aplikacji desktopowej, jesteśmy zmuszeni do wzięcia spraw we własne ręce i napisania własnego trace listenera.</p>

<h2>Etap 2 &ndash; Logowanie wiadomości w polu tekstowym aplikacji</h2>

<p>Kod który musimy napisać jest dość krótki i treściwy. Całość składa się z dwóch kroków:</p>

<ol>
<li>Stworzenie własnej klasy dziedziczącej po trace listenerze, umożliwiającej logowanie wiadomości w kontrolce aplikacji.</li>
<li>Aktualizacja pliku konfiguracyjnego i podpięcie kontrolki do listenera.</li>
</ol>


<p>Implementacja klasy jest bardzo prosta, przykładowo może wyglądać tak:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">MyTraceListener</span> <span class="p">:</span> <span class="n">TraceListener</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">TextBoxBase</span> <span class="n">TextBox</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Write</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">TextBox</span><span class="p">==</span><span class="k">null</span><span class="p">)</span><span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="n">TextBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">+=</span> <span class="n">message</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">WriteLine</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">TextBox</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="n">TextBox</span><span class="p">.</span><span class="n">Text</span> <span class="p">+=</span> <span class="n">message</span> <span class="p">+</span> <span class="n">Environment</span><span class="p">.</span><span class="n">NewLine</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>W podstawowej wersji klasy wystarczy zdefiniować dwie metody abstrakcyjne. Dodatkowo stworzyliśmy właściwość typu TextBoxBase (ten przykład operuje na kontrolce z biblioteki Windows Forms), którą wykorzystamy za chwilę do podpięcia naszej kontrolki.</p>

<p>Jak więc należałoby podpiąć wybraną przez nas kontrolkę do listenera takiego, jak podany powyżej? W pierwszej kolejności powinniśmy stworzyć obiekt TraceSource, który jest odpowiednikiem węzła source podanego przez nas wcześniej w konfiguracji. Może być podany w postaci pola dostępnego wewnątrz naszej aplikacji:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="n">TraceSource</span> <span class="n">source</span> <span class="p">=</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">TraceSource</span><span class="p">(</span><span class="s">&quot;System.ServiceModel.MessageLogging&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>W konstruktorze podajemy taką samą nazwę, jak wartość atrybutu <strong>name</strong> w konfiguracji danego źródła. Następnie wyciągamy listenera i podpinamy do niego naszego textboxa.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="kt">var</span> <span class="n">listener</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="n">Listeners</span><span class="p">[</span><span class="s">&quot;listener_config_name&quot;</span><span class="p">]</span> <span class="k">as</span> <span class="n">MyTraceListener</span><span class="p">;</span>
</span><span class='line'><span class="n">listener</span><span class="p">.</span><span class="n">TextBox</span> <span class="p">=</span> <span class="n">myTextBox</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>To wszystko. Kod inicjalizujący można umieścić np. w konstruktorze głównego okna naszej aplikacji. Od teraz wiadomości (filtrowaneg wg. tego co określiliśmy w konfiguracji) będą wypisywane w jej polu tekstowym.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2011-11-17T20:57:00+01:00" data-updated="true" itemprop="datePublished">Nov 17<span>th</span>, 2011</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/programowanie/'>programowanie</a>


</div>
		
			<span class="comments"><a href="/blog/2011/11/17/javascript-jak-przetworzyc-query-string/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2011/11/17/javascript-jak-przetworzyc-query-string/" itemprop="url">[Javascript] Jak Przetworzyć Query String?</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>W środowisku programowania po stronie klienta nieraz zdarza się nam konieczność wydobycia informacji przekazywanych poprzez query string. Niestety rzadko kiedy taki czysty, nieprzetworzony ciąg znaków do czegokolwiek nam się przydaje. Tutaj z pomocą przychodzą różne pluginy (przykładem niech będzie <a href="https://github.com/cowboy/jquery-urlinternal">jquery urlinternal</a>). Jednakże nie zawsze musimy wytaczać przysłowiowe działo na komara i może sie okazać, że rozwiązanie naszych problemów może stanowić krótki kawałek kodu.</p>

<p>Przedstawmy więc jak taki kod mógłby wyglądać. W wersji podstawowej przedstawmy proste pobieranie par klucz-wartość i umieszczanie ich w postaci obiektu JSON:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">querystring</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">raw</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">raw</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="s1">&#39;{&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">parts</span><span class="p">){</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">num</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">||</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>            <span class="nx">result</span> <span class="o">+=</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">+</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&quot; : &#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">result</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">num</span> <span class="o">||</span> <span class="nx">num</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nx">num</span> <span class="o">:</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>                <span class="nx">result</span><span class="o">+=</span><span class="s1">&#39;, &#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nx">result</span><span class="o">+=</span><span class="s1">&#39;}&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Rozjaśnijmy nieco obraz sytuacji:</p>

<ul>
<li>linijka 3 &ndash; ponieważ window.location.search zaczyna querystring od znaku &lsquo;?&rsquo;, omijamy 1 znak, a resztę tniemy po znakach rodzielających kolejne pary klucz-wartość.</li>
<li>linijka 6 &ndash; każdą parę dzielimy osobno na klucz (index 0) i wartość (index1)</li>
<li>linijka 7 &ndash; sprawdzamy czy wartość jest liczbą. Robimy to najpierw próbując parsować ją do liczby całkowitej (<strong>Int</strong>), a w przypadku gdy to się nie powiedzie do liczby zmiennoprzecinkowej (<strong>Float</strong>). Jeżeli parsowana wartość nie jest liczbą funkcje parsujące zwracają stałą <strong>NaN</strong> (not a number), której logiczna wartość wynosi <strong>false</strong>.</li>
<li>linijka 9 &ndash; sprawdzamy czy sparsowana przez nas wartość jest liczbą, jeżeli tak &ndash; dodajemy ją do ciągu bez zmian, w przeciwnym razie doklejamy ją, uprzednio otaczając cudzysłowem (&ldquo;&rdquo;). W ten sposób będzie ona domyślnie odczytywana jako string.</li>
<li>linijka 10 &ndash; sprawdzamy, czy nasza para nie jest ostatnia &ndash; jeżeli jest, pomijamy ten krok, w przeciwnym razie dodajemy przycinek.</li>
<li>Ponieważ całość wyrażenia jest ręcznie składana do stringa, na koniec wywołujemy metodę JSON.parse, aby konwertować nasz string do prawdziwego obiektu JSON. Uwaga: starsze przeglądarki mogą nie oferować dostępu do obiektu JSON.</li>
</ul>


<p>Warto zauważyć, że funkcja ta nie wymaga dołączania biblioteki jQuery. Teraz możemy swobodnie pobierać wartości zapisane w query stringu, wykorzystując prosty dostęp do właściwości obiektu javascriptowego:</p>

<ol>
<li>W przypadku standardowych nazw klucza, można stosować konwencję: json.key</li>
<li>W momencie gdy klucz zbudowany był z niedozwolonych dla właściwości znaków (np. &ndash;, +, / itp.) możemy potraktować obiekt jak słownik: json[&ldquo;other-key-property&rdquo;]</li>
</ol>


<p>Co ważne, do utworzonego przez nas obiektu możemy dopisywać własne pary klucz-wartość wykorzystując standardową konwencję: <code>json.newkey = &ldquo;new value&rdquo;</code> oraz <code>json[&ldquo;new key&rdquo;] = number</code>.</p>

<h2>Rozszerzanie możliwości</h2>

<h3>Iterowanie po kluczach i wartościach</h3>

<p>Czasami zdarza sie konieczność wydobycia wszystkich kluczy lub wartości należących do danego przetworzonego przez nas obiektu querystring. W tym celu możemy dodać do naszego obiektu JSON następującą funkcję (cały czas przyjmujemy że <strong>json</strong> to nazwa zmiennej przechowującej obiekt zwrócony nam przez przedstawioną powyżej funkcję <code>querystring()</code>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">json</span><span class="p">.</span><span class="nx">values</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">json</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span><span class='line'>           <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">json</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;function&#39;</span><span class="p">){</span>
</span><span class='line'>             <span class="c1">// tak przekazujemy wartość właściwości</span>
</span><span class='line'>             <span class="nx">res</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">json</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
</span><span class='line'>             <span class="c1">// a tak nazwę klucza</span>
</span><span class='line'>             <span class="nx">res</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>W tym wypadku wykorzystujemy pętlę for do iterowania po wszystkich elementach składowych obiektu, dodatkowo filtrując je poprzez wykorzystanie wbudowanej funkcji hasOwnProperty w celu rozpoznania, czy dana składowa jest rzeczywiście dodaną przez nas właściwością, a następnie sprawdzając jednocześnie czy nie jest funkcją (ponieważ docelowo query string służy tylko przenoszeniu wartości).</p>

<h3>Powtórne przetworzenie do postaci querystring</h3>

<p>W momencie, gdy nasze operacje na słowniku/obiekcie querystring dojdą końca możemy chcieć przetworzyć go spowrotem do wartości początkowej, np. w celu ponownego umieszczenia go w adresie okna. Funkcjonalność tą możemy zrealizować poprzez następującą metodę:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">json</span><span class="p">.</span><span class="nx">toQuery</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">json</span><span class="p">){</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="nx">json</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span><span class='line'>              <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">json</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="nx">res</span><span class="o">+=</span> <span class="nx">i</span><span class="o">+</span><span class="s1">&#39;=&#39;</span><span class="o">+</span><span class="nx">json</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&amp;&#39;</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wykorzystując stworzoną poprzednio pętlę umożliwiającą iterację po właściwościach obiektu JSON dokonujemy sklejenia par klucz-wartość do jednolitej postaci stringa, który zbudowany jest tak samo jak bazowy query string wyciągany z naszej przeglądarki.</p>

<p>Notka dla osób korzystających z map routingu: jak można się domyślić powyższy przykład działa jedynie wtedy, gdy przekazywany przez nas query string zbudowany jest w standardowej konwencji. Z tego powodu wszelkie wartości przekazywane na potrzeby map routingu np. w konwencji <code>controller/action/parameter</code>nie zostaną przetworzone.</p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
        <a href="/blog/page/2/" class="prev">Prev</a>
    
    
        <a href="/blog/page/4/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2014

    Bartosz Sypytkowski


Design based on: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
</body>
</html>
