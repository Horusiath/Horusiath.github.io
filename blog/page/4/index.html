
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Simple Solutions</title>
	<meta name="author" content="Bartosz Sypytkowski">

	
	<meta name="description" content="Nov 2nd, 2011 asp, javascript Comments [Ajax] Post Tablicy Do Akcji Podczas pracy nad łączeniem wywołań ajaxowych z frameworkiem ASP MVC 3 natknąłem &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Simple Solutions" type="application/atom+xml">
	
	<link rel="canonical" href="http://bartoszsypytkowski.com/blog/page/4/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	

<script type="text/javascript">
      var disqus_shortname = 'bartoszsypytkowski';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-47294845-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><h1 id="profile-name"><a href="/">Bartosz Sypytkowski</a></h1>
<div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("b.sypytkowski@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:b.sypytkowski@gmail.com" title="Email">Email</a>
		
		
		
			<a class="google" href="https://plus.google.com/b.sypytkowski@gmail.com" rel="author" title="Google+">Google+</a>
		
		
			<a class="twitter" href="http://twitter.com/horusiath" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/horusiath" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2011-11-02T17:22:00+01:00" data-updated="true" itemprop="datePublished">Nov 2<span>nd</span>, 2011</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/asp/'>asp</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>


</div>
		
			<span class="comments"><a href="/blog/2011/11/02/ajax-post-tablicy-do-akcji/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2011/11/02/ajax-post-tablicy-do-akcji/" itemprop="url">[Ajax] Post Tablicy Do Akcji</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Podczas pracy nad łączeniem wywołań ajaxowych z frameworkiem ASP MVC 3 natknąłem się na dość interesujący problem &ndash; rozpatrzmy scenariusz, w którym mamy zamiar przekazać tablicę obiektów jakiegoś prostego typu (liczba, string) za pośrednictwem ajaxowego posta do jednej z akcji kontrolera. Taki przykład można zaprezentować w następujący sposób:</p>

<p>Client side:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">array</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">];</span>
</span><span class='line'><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;@Url.Action(&quot;AjaxPost&quot;)&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">data</span><span class="o">:</span> <span class="nx">array</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Server side:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[HttpPost]</span>
</span><span class='line'><span class="k">public</span> <span class="n">JsonResult</span> <span class="nf">AjaxPost</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">array</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">array</span> <span class="p">!=</span> <span class="k">null</span><span class="p">){</span>
</span><span class='line'>      <span class="c1">// to do</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>W praktyce takie coś nie przejdzie, domyślny binder nie jest w stanie zrozumieć argumentów przekazanych w powyższym kodzie javascriptu. Powodem jest linijka zwierająca opis parametru &ndash; data : array. Wydawać by się mogło, że zapis ten można naprawić parsując naszą tablicę do notacji JSON, jednakże standardowe mechanizmy również nie sprawdzają się w tej roli. Z tego powodu następujące zapisy będą błędne:</p>

<ul>
<li>wykorzystanie <code>JSON.stringify(array)</code> lub <code> JSON.stringify({ &lsquo;array&rsquo; : array})</code></li>
<li>wykorzystanie zewnętrznych bibliotek np. <code>$.parseJSON(array)</code>, <code>$.parseJSON({&lsquo;array&rsquo; : array})</code></li>
</ul>


<p>Rozwiązaniem tego problemu jest wykorzystanie funkcji z biblioteki jQuery o nazwie <a href="http://api.jquery.com/jQuery.param/">param</a>. Z jej wykorzystaniem nasza linijka powinna wyglądać następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">data</span><span class="o">:</span> <span class="nx">$</span><span class="p">.</span><span class="nx">param</span><span class="p">({</span><span class="s1">&#39;array&#39;</span> <span class="o">:</span> <span class="nx">array</span><span class="p">},</span> <span class="kc">true</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Umieszczenie tablicy w obiekcie JSON jest wymagane, w dodatku nazwa pola musi odpowiadać nazwie parametru przekazywanego do naszej metody po stronie serwera (w przeciwnym razie binder nie rozpozna, którą zmienną zmapować na dany parametr).</p>

<p>Można to oczywiście wykonać nie korzystając z gotowych bibliotek. W takim wypadku przekazywane przez nas parametry zapisane w postaci tekstu, w podanym przeze mnie przypadku, powinny mieć następującą postać: <code>array=one&amp;array=two&amp;array=three</code></p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2011-10-19T21:25:00+02:00" data-updated="true" itemprop="datePublished">Oct 19<span>th</span>, 2011</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/bazy-danych/'>bazy danych</a>, <a class='category' href='/blog/categories/kontrola-wersji/'>kontrola wersji</a>


</div>
		
			<span class="comments"><a href="/blog/2011/10/19/fluentmigrator-wersjonowanie-bazy/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2011/10/19/fluentmigrator-wersjonowanie-bazy/" itemprop="url">FluentMigrator - Wersjonowanie Bazy Danych</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>W dzisiejszym poście pokrótce postaram się opisać narzędzie, jakim jest FluentMigrator oraz dlaczego warto korzystać z niego podczas pisania projektów (zwłaszcza kiedy mowa o projektach zespołowych).</p>

<p>W sytuacjach kiedy zespół programistów tworzy aplikację wykorzystującą dostęp do wspólnej bazy danych, wszelkie zmiany wykonywane przez każdego z nich (np. dodawanie nowych tabel, kolumn czy zmiana nazw już istniejących) mogą powodować problemy w kompatybilności &ndash; zwłaszcza w przypadku wykorzysytwania modeli ORM. W tym celu warto się zabezpieczyć (a w dłuższej mierze czasu również znacząco przyspieszyć szybkość wprowadzanych zmian i aktualizacji systemu), korzystając z narzędzi umożliwiających wersjonowanie bazy danych w sposób &ndash; przynajmniej ideologicznie &ndash; podobny do tradycyjnych systemów kontroli wersji.</p>

<p>FluentMigrator (<a href="https://github.com/schambers/fluentmigrator/wiki">link</a>) jest właśnie takim narzędziem. Jednakże w przeciwieństwie do standardowych systemów kontroli wersji, gdzie zmiany są utrzymywane i aktualizowane za pomocą kilku prostych komend, tutaj czeka nas nieco więcej pracy.</p>

<h2>Migracje i Profile</h2>

<p>Podstawowym terminem występującym we fluent migratorze jest tzw. migracja. Reprezentuje ona pojedyńczy zestaw zmian (coś na kształt jednego <em>commitu</em> w systemach kontroli wersji). W rzeczywistości jest to klasa dziedzicząca po abstrakcyjnej klasie <strong>Migrator</strong> (lub którejś z jego pochodnych), w której wprowadzamy kod wykonujący interesujące nas zmiany. Aby wiązanie to było możliwe zobowiązani jesteśmy zaimplementować 2 metody:</p>

<ul>
<li><strong>Up</strong> &ndash; jest to metoda odpowiedzialna wprowadzenie zmian (<em>upgrade</em>) przed podniesieniem aktualnej wersji bazy danych.</li>
<li><strong>Down</strong> &ndash; metoda opozycyjna do Up, odpowiada za <em>downgrade</em> wersji naszej bazy. Jej zadaniem jest cofnięcie wszystkich zmian, które wykonaliśmy w Up&#8217;ie.</li>
</ul>


<p>W niektórych sytuacjach możliwe jest zautomatyzowanie tego procesu i automatyczne generowanie methody down na podstawie zmian wykonanych podczas Up. Drugą ważną sprawą związaną z migracjami jest atrybut <strong>MigrationAttribute</strong>. Pobiera on jeden parametr &ndash; liczbę typu long, która określa aktualny numer migracji. Umożliwia nam to wykonywanie up/down w sposób uporządkowany z zachowaniem odpowiednich współzależności między kolejnymi wersjami.</p>

<p>Innym ciekawym uzupełnieniem powyższych funkcjonalności jest atrybut <strong>Profile</strong>, który w pewien sposób kojarzy mi się z branchami znanymi z systemów kontroli wersji. Dodając profil do konkretnych migracji jesteśmy w stanie tworzyć alternatywne przebiegi migracji tzn. wykonywać tylko te upgrade&#8217;y, które znajdują się w ramach danego profilu.</p>

<h2>Fluent Interface</h2>

<p>Dalszym rozszerzeniem istniejących plusów jest zestaw interfejsów umożliwiających budowę tabel, ich uzupełnianie oraz wykonywanie stworzonych przez nas skryptów. Zaletą tego rozwiązania jest to, że nie wymaga ono od nas pisania skryptów Sql pod konkretną bazę danych, ponieważ jesteśmy w stanie wygenerować je za pośrednictwem fluent interface. Co do wad, jest ich kilka, dlatego też wszelkie wykonywane przez nas zmiany muszą być wykonywane z rozwagą i przy dobrym zrozumieniu możliwości posiadanego przez nas narzędzia:</p>

<ul>
<li>Fluent interface nie jest w stanie samodzielnie wygenerować elementów bazy specyficznych dla danego dialektu sql np. możemy wygenerować tabele dla baz MSSql oraz Oracle, jednak takie rzeczy jak sekwencje i triggery Oracle&#8217;a muszą być wykonane za pośrednictwem skryptów.</li>
<li>Fluent interface nie gwarantuje zgodności z EntityFramework ani innymi frameworkami ORM. Przykładem może być metoda <code>.AsInt32()</code>dostępna poprzez interface. Mimo nazwy, kolumna wygenerowana przez tą metodę może być typu <code>Number(10,0)</code>, co z kolei EF4 przekształci jako Int64, mimo że nie było to naszym celem.</li>
<li>Wykonywanie skryptów z użyciem właściwości <em>Execute</em> nie gwarantuje pomyślności, nawet w sytuacjach kiedy te skrypty wprowadzane ręcznie do bazy wykonywane są prawidłowo. Wynika to z faktu, że w komunikacji z bazą FluentInterface korzysta z istniejących bibliotek .dll, które pełnią w naszym projekcie rolę adaptera dla klienta bazy danych.</li>
</ul>


<p>Dobrym pomysłem może być podpięcie narzędzia migrate.exe (jego projekt jest dostępny na stronie projektu na githubie) do post-buildu naszego projektu. Robimy to wchodząc we właściwości (<em>Project&rArr;nazwa_projektu&rArr;Properties</em>), następnie klikamy zakładkę <em>Build Events</em> i w oknie <em>Post-build event command line</em> wywołujemy migrate.exe w właściwymi parametrami np.:<code>ścieżka_do_migrate/migrate.exe -a ścieżka_do_naszej_biblioteki/nazwa_biblioteki.dll -db typ_bazy_danych -c connection_string -profile Profil -version nr_versji</code>, gdzie:</p>

<ul>
<li><strong>a</strong> &ndash; określa fizyczną scieżkę pod którą możemy znaleźć skompilowaną bibliotekę zawierającą zdefiniowane przez nas migracje</li>
<li><strong>db</strong> &ndash; określa rodzaj bazy danych, jest wykorzystywana potem przez fabrykę FluentMigratora, która na podstawie przekazanego parametru próbuje stworzyć obiekt adaptera dla naszej bazy danych</li>
<li><strong>c</strong> &ndash; connectionString umożliwiający dostęp do naszej bazy danych.</li>
<li><strong>profile</strong> &ndash; (parametr opcjonalny) określa profil migracji, które mają zostać wykonane</li>
<li><strong>version</strong> &ndash; (parametr opcjonalny) określa wersję, do której ma zostać wykonany upgrade. Jeżeli przyjmuje wartość 0, oznacza to, że wykonane zostaną wszystkie migracje znalezione w danej bibliotece .dll.</li>
</ul>


<p>Rozwiązanie takie oferuje tą zaletę, że wymusza, aby w trakcie wykoniania buildu biblioteki, zostały wprowadzone zmiany do bazy. Jeżeli napisane przez nas migracje są nieprawidłowe lub nie zostały wprowadzone, projekt nie zostanie zbudowany.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2011-09-19T18:21:00+02:00" data-updated="true" itemprop="datePublished">Sep 19<span>th</span>, 2011</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/dot-net/'>.net</a>, <a class='category' href='/blog/categories/eksploracja-danych/'>eksploracja danych</a>, <a class='category' href='/blog/categories/programowanie/'>programowanie</a>


</div>
		
			<span class="comments"><a href="/blog/2011/09/19/c-prosta-implementacja-silnika-do/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2011/09/19/c-prosta-implementacja-silnika-do/" itemprop="url">[C#] Prosta Implementacja Silnika Do Wyszukiwania Pełnotekstowego</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>W dzisiejszym poście postaram się przedstawić jedno z możliwych rozwiązań problemu, jakim jest konieczność odnajdywania plików zawierających w sobie pewne poszukiwane przez nas frazy. Mowa tu oczywiście o problemach związanych z implementacją wyszukiwarki pełnotekstowej. Poniżej przedstawię sposób na jedną z prostszych jej implementacji.</p>

<h2>Wstęp</h2>

<p>Na wstępie warto zwrócić uwagę na podstawowy ciąg czynności, które powinny wystąpić, aby dany plik został zaindeksowany oraz aby późniejsze wyszukiwanie przebiegało szybciej i bardziej dokładnie. Na główne kroki składają się:</p>

<ul>
<li>Przetworzenie zawartości pliku &ndash; pierwszym krokiem jest zamiana tekstu na postać bardziej sformalizowaną (tzw. termy). W tym momencie następują czynności takie jak:

<ul>
<li>usunięcie znaków interpunkcyjnych i znaczników</li>
<li>usunięcie zbędnych słów (np. przyimków)</li>
<li>zamiana wielkich liter na małe</li>
<li>usunięcie niepotrzebnych końcówek w odmianach słów</li>
</ul>
</li>
<li>Zamiana sformatowanego tekstu na wektor &ndash; wektory są dobrą metodą reprezentacji słów w danym tekście. Kilka z najpopularniejszych sposobów zapisywania danych w wektorach:

<ul>
<li><strong>Binarny </strong>&ndash; w tym wypadku wektor zapisuje wartość binarną (prawda/fałsz) dla każdego opisywanego słowa. Słowa występujące w tekście są oznaczane jako prawda. Pozostałe nie występujące w pliku (lecz wciąż mające swoje miejsce w wektorze) oznaczone są jako fałsz. Wady:

<ul>
<li>mała dokładność informacji (wiemy wyłącznie o tym, czy dane słowo występuje w tekście)
Zalety:</li>
<li>szybka możliwość weryfikacji występowania danego słowa w tekście</li>
<li>taki sposób zapisu zajmuje najmniej miejsca w pamięci</li>
</ul>
</li>
<li><strong>&ldquo;Bag-of-words&rdquo;</strong> &ndash; taki sposób reprezentacji dokumentu (w swojej podstawowej wersji) zlicza ilość (częstotliwość) wystąpień danego słowa w tekście. Zamiast oznaczania słowa w postaci bitu określamy go przez liczbę wyrażającą jego liczność.Wady:

<ul>
<li>Wymaga zdecydowanie większej ilości pamięci niż zapis binarny przy takiej samej ilości zaindeksowanych dokumentów.
Zalety:</li>
<li>Pozwala wydobyć więcej informacji o dokumencie.</li>
<li>Umożliwia tworzenie podstawowego rankingu najlepiej pasujących dokumentów.</li>
</ul>
</li>
<li><strong>Pozycyjny </strong>&ndash; w takiej postaci zapisujemy nie tylko ilość wystąpień danego termu w dokumencie, ale również zapisujemy pozycje, w których dane termy zostały znalezione.Wady:

<ul>
<li>Wymaga największej ilości pamięci dla pojedynczego wektora.</li>
<li>Generowanie odpowiedzi na zapytanie dotyczące wyszukiwania może być czasochłonne.
Zalety:</li>
<li>Jest to najbardziej kompletny zapis, zwrócone wyniki mają największą dokładność.</li>
<li>Na podstawie danych zawartych w wektorze możliwe jest częściowe lub kompletne odtworzenie dokumentu.</li>
</ul>
</li>
</ul>
</li>
<li>Zapisanie wektora &ndash; wymagana tutaj jest struktura danych umożliwiająca szybki dostęp oraz będąca w stanie przechowywać duże ilości informacji (np. rozproszone struktury danych oparte o tablice haszujące lub skompresowane drzewa TRIE).</li>
</ul>


<p>Na potrzeby naszej implementacji postanowiłem przyjąć następujące założenia:</p>

<ol>
<li>Nie przywiązujemy większej uwagi do aspektów optymalizacji &ndash; chodzi tutaj o możliwie maksymalną prostotę wykonanego rozwiązania.</li>
<li>Skupiamy się na strukturach danych istniejących w bibliotece postawowej.</li>
<li>Reprezentacja binarna &ndash; powody: możliwość prostej i szybkiej implementacji.</li>
<li>Operujemy na z góry ustalonej (maksymalnej) liczbie słów.</li>
</ol>


<h2>Implementacja</h2>

<p>Do pierwszej części zadania stworzymy prostą listę przechowującą implementacje interfejsu <em>IFilter</em> (będzie on reprezentować pojedyńczą operację służącą przekształceniu tekstu-termu w kolejny tekst-term). Przetwarzanie tekstu będzie polegało na przekazaniu wyniku działania jednego filtru do następnego. Na nasze potrzeby interfejs będzie implementował tylko 1 metodę: <code>string Apply(string text);</code>. Kilka najprostszych filtrów to:</p>

<ol>
<li>Filtr redukujący wszystkie wielkie litery w tekście &ndash; tutaj wystarczy na parametrze wywołać metodę <em>ToLower()</em>.</li>
<li>Filtr usuwający znaki interpunkcyjne z tekstu</li>
<li>Znaki przeznaczone do usunięcia zostaną zapisane wewnątrz właściwości StopChars (może to być dowolny typ wyliczeniowy <em>char </em>&ndash; taki wymóg spełniają również zwykłe stringi).</li>
<li>Przykładowa implementacja metody Apply:</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="kt">string</span> <span class="nf">Apply</span><span class="p">(</span><span class="kt">string</span> <span class="n">text</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">text</span><span class="p">;</span>
</span><span class='line'>  <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">c</span> <span class="k">in</span> <span class="n">StopChars</span><span class="p">)</span>
</span><span class='line'>      <span class="n">result</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span>
</span><span class='line'>                           <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Filtr usuwający zbędne wyrazy:

<ul>
<li>Wyrazy przeznaczone do usunięcia będą znajdowały się wewnątrz właściwości StopWords (tutaj dowolny typ implementujący <code>IEnumerable<string></code>).</li>
<li>Przykładowa implementacja metody Apply:</li>
</ul>
</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="kt">string</span> <span class="nf">Apply</span><span class="p">(</span><span class="kt">string</span> <span class="n">text</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">text</span>
</span><span class='line'>        <span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span><span class="s">&quot; &quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">word</span> <span class="k">in</span> <span class="n">StopWords</span><span class="p">)</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">result</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">==</span> <span class="n">word</span><span class="p">)</span>
</span><span class='line'>                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Dla ułatwienia operację filtrowania wydzielimy do osobnej metody. Będzie ona używana zarówno podczas indeksowania plików, jak i ich wyszukiwania. Przykładowa implementacja:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">IFilter</span><span class="p">&gt;</span> <span class="n">Filters</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="kt">string</span> <span class="nf">Filter</span><span class="p">(</span><span class="kt">string</span> <span class="n">txt</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">txt</span><span class="p">;</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">filter</span> <span class="k">in</span> <span class="n">Filters</span><span class="p">)</span>
</span><span class='line'>        <span class="n">result</span> <span class="p">=</span> <span class="n">filter</span><span class="p">.</span><span class="n">Apply</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>W dalszej kolejności będziemy potrzebowali metody, która pozwoli nam zamienić tak przetworzony tekst na wektor bitowy. W tym celu utworzymy dwie pomocnicze właściwości:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">BitArray</span><span class="p">&gt;</span> <span class="n">Indexer</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">Words</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Zadaniem Indexera będzie gromadzenie par nazwa_pliku &ndash; wektor_pliku. Z kolei właściwość <em>Words</em> pozwoli nam przechować numery indeksów, pod którymi znalezione mogą być konkretne słowa. Sama metoda służąca zamianie tekstu na odpowiadający mu wektor może wyglądać następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">private</span> <span class="n">BitArray</span> <span class="nf">CreateVector</span><span class="p">(</span><span class="kt">string</span> <span class="n">filtered</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">vector</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BitArray</span><span class="p">(</span><span class="n">MAX_SIZE</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">splits</span> <span class="p">=</span> <span class="n">filtered</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span><span class="s">&quot; &quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">);</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">s</span> <span class="k">in</span> <span class="n">splits</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(!</span><span class="n">Words</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
</span><span class='line'>            <span class="n">Words</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>        <span class="n">vector</span><span class="p">[</span><span class="n">Words</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">vector</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>W tym przypadku MAX_SIZE jest zwyczajną stałą typu<em> int</em> określającą maksymalną liczbę obsługiwanych przez nas słów. Całość wygląda następująco:</p>

<ol>
<li>Dzielimy przekazany tekst na słowa.</li>
<li>Dla każdego słowa sprawdzamy, czy został mu nadany odpowiedni indeks w liście <em>Words</em>. Jeżeli nie, dodajemy go do listy. Ponieważ nowe elementy dodawane są na koniec listy, nie musimy się obawiać zmiany pozycji dotychczas zaindeksowanych słów.&lt;</li>
<li>Na koniec ustawiamy bit wystąpienia słowa na pozycji wskazanej przez słowa zaindeskowane w kroku 2.</li>
</ol>


<p>Cały cykl dodawania pliku do indeksu jest bardzo krótki i wygląda następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">AddToIndexer</span><span class="p">(</span><span class="kt">string</span> <span class="n">filename</span><span class="p">,</span> <span class="kt">string</span> <span class="n">content</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">filtered</span> <span class="p">=</span> <span class="n">Filter</span><span class="p">(</span><span class="n">content</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">vector</span> <span class="p">=</span> <span class="n">CreateVector</span><span class="p">(</span><span class="n">filtered</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Indexer</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">vector</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ostatnią rzeczą, bez której nasza praca nie miałaby sensu, jest implementacja metody odpowiedzialnej za wyszukiwanie zaindeksowanych plików wg. występujących w nich słów-termów. Poniższy kod odpowiada za znalezienie plików, w których występują wszystkie słowa kluczowe przekazane jako parametr (a więc będący odpowiednikiem logicznego AND):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">FindAnd</span><span class="p">(</span><span class="kt">string</span> <span class="n">text</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">splits</span> <span class="p">=</span> <span class="n">Filter</span><span class="p">(</span><span class="n">text</span><span class="p">).</span><span class="n">Split</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span><span class="s">&quot; &quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">);</span>
</span><span class='line'>    <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">BitArray</span><span class="p">&gt;&gt;</span> <span class="n">result</span> <span class="p">=</span>
</span><span class='line'>        <span class="k">new</span> <span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">BitArray</span><span class="p">&gt;[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">flag</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">split</span> <span class="k">in</span> <span class="n">splits</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="n">Words</span><span class="p">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="n">split</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span> <span class="p">||</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="n">MAX_SIZE</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(!</span><span class="n">flag</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">flag</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>            <span class="n">result</span> <span class="p">=</span> <span class="k">from</span> <span class="n">pair</span> <span class="k">in</span> <span class="n">Indexer</span>
</span><span class='line'>                     <span class="k">where</span> <span class="n">pair</span><span class="p">.</span><span class="n">Value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class='line'>                     <span class="k">select</span> <span class="n">pair</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">result</span> <span class="p">=</span> <span class="k">from</span> <span class="n">pair</span> <span class="k">in</span> <span class="n">result</span>
</span><span class='line'>                     <span class="k">where</span> <span class="n">pair</span><span class="p">.</span><span class="n">Value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class='line'>                     <span class="k">select</span> <span class="n">pair</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">from</span> <span class="n">pair</span> <span class="k">in</span> <span class="n">result</span> <span class="k">select</span> <span class="n">pair</span><span class="p">.</span><span class="n">Key</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Słowem wyjaśnienia:</p>

<ol>
<li>Na starcie przepuszczamy poszukiwany ciąg znaków przez nasze filtry, aby zamienić je na ich odpowiedniki w termach. Kolejnym krokiem jest ich podział na pojedyńcze słowa.</li>
<li>Dla każdego z poszukiwanych słów przechodzimy przez następujące kroki:

<ul>
<li>Sprawdzamy czy dane słowo zostało zaindeksowane (a więc czy możliwe jest jego znalezienie) &ndash; jeżeli nie przechodzimy do następnego cyklu pętli.</li>
<li>W przypadku, gdy dane słowo jest pierwszym, wg. którego przeszukujemy nasz indeks, celem przeszukiwań jest zmienna Indexer zawierająca pełną pulę dostępnych wyników. W innym przypadku (pętla wykonuje się dla kolejnych słów), dziedzina poszukiwań obejmuje tylko wyniki zdobyte w poprzedzającym cyklu.</li>
<li>Na koniec pozbywamy się niepotrzebnych już informacji o wektorach zwracając same nazwy plików.</li>
</ul>
</li>
</ol>


<p>Nie będę się zajmował tutaj wprowadzaniem odpowiednika logicznego OR (a więc metody wyszukującej pliki, w których pojawiło się co najmniej jedno z poszukiwanych słów), ponieważ jest to operacja prostsza &ndash; dzięki użyciu linku wystarczy złączyć wyniki dla każdego z pojedyńczych słów, a następnie usunąć powtarzające się wyniki (np. za pomocą metody <em>Distinct()</em>).</div></p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2011-09-19T18:09:00+02:00" data-updated="true" itemprop="datePublished">Sep 19<span>th</span>, 2011</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/dot-net/'>.net</a>, <a class='category' href='/blog/categories/wydajnosc/'>wydajność</a>


</div>
		
			<span class="comments"><a href="/blog/2011/09/19/programowanie-gpgpu-microsoftaccelerato_12/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2011/09/19/programowanie-gpgpu-microsoftaccelerato_12/" itemprop="url">Programowanie GPGPU - Microsoft.Accelerator V2</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Ostatnimi czasy postanowiłem zapoznać się z technikami programowania równoległego pod karty graficzne. Zacząłem poszukiwać rozwiązań, które bez konieczności poświęcania długich godzin na poznawanie nowych technologii pozwoliłyby mi wykorzystać potencjał drzemiący w GPU.</p>

<p>Niestety problemy pojawiły się już na starcie, kiedy okazało się, że moja karta graficzna nosi na sobie ślady epoki poprzedzającej pojawienie się CUDA. Ograniczony do standardowych operacji oferowanych przez OpenGL i DirectX zacząłem szukać bibliotek-nakładek na te środowiska. Wśród opublikowanych rozwiązań natknąłem się na 2 interesujące biblioteki:
&ndash; <a href="http://sourceforge.net/projects/cloo/">Cloo</a> &ndash; jest to.NET-owa nakładka na popularną w środowisku GPGPU bibliotekę OpenCL, umożliwiającą nam programowanie równoległe poprzez OpenGL.
&ndash; <a href="http://research.microsoft.com/en-us/projects/accelerator/">Microsoft.Accelerator v. 2</a> &ndash; ta biblioteka z kolei jest odpowiedzią Microsoftu na napływające trendy. Nie jest to jeszcze gotowy produkt, lecz wciąż jest rozwijany i może rokować spore nadzieje.</p>

<p>W tym poście postaram się opisać bibliotekę Microsoftu, pokrótce ją scharakteryzować (dla tych, których zanudzi czytanie dokumentacji na oficjalnej stronie) oraz jak przygotować projekt, aby móc wykorzystać jej potencjał.</p>

<h2>Czym jest Accelerator?</h2>

<p>Accelerator stanowi bibliotekę nałożoną na środowisko DirectX9, pozwalające nam za jego pomocą korzystać z karty graficznej do obliczeń nie związanych z grafiką (od wersji 2 biblioteki możliwe jest również przełączenie się na tradycyjny multiprocessing oferowany przez wielordzeniowe CPU).</p>

<p>W jaki sposób jest to wykonywane? Otóż wyobraźmy sobie, że zasadniczo programując Pixel i Vertex Shadery tworzymy tak naprawdę kod programu, którego celem jest operowanie na przekazanym mu zbiorze zmiennych. Microsoft.Accelerator wykorzystuje ten sposób myślenia o Pixel Shaderach definiując specjalne klasy tablic, które w trakcie przetwarzania są zamieniane przez środowisko do postaci tekstury, która jest poddawana obróbce. Operacje które możemy wykonywać na tych tablicach, są również zdefiniowane (właściwe metody przechowywane są w klasie statycznej <strong>ParallelArrays</strong>), aby następnie składane do postaci <em>pojedynczego</em> pixel shadera (w tym celu Accelerator stosuje znany z języków funkcyjnych mechanizm leniwej ewaluacji wyrażeń, w którym rezultat działania metod jest produkowany dopiero kiedy należy go zwrócić do dalszego przetwarzania, nie zaś kiedy wywołujemy daną metodę).</p>

<p>W odróżnieniu od Cloo udostępniony nam mechanizm gotowych operacji pozwala na skupienie się na osiągnięciu pożądanych wyników, bez ryzyka ugrzęźnięcia w źle napisanym kodzie.</p>

<h2>Jak zainstalować Accelerator w naszym projekcie?</h2>

<ol>
<li>Ściągamy pakiet ze strony podanej pod <a href="http://research.microsoft.com/en-us/downloads/e45cf1d7-fd3d-4e03-a219-c0f3fca9881e/">tym linkiem</a>, a następnie instalujemy go. Ścieżka instalacji to <code>C:\Program Files (x86)\Microsoft\Accelerator v2 </code>dla systemów 64-bitowych zainstalowanych na partycji C. W stworzonym folderze otrzymamy dokumentację oraz kilka przykładowych programów.</li>
<li>Jeżeli chcemy dołączyć bibliotekę do naszego projektu, to w otworzonym projekcie w Visual Studio dodajemy referencję do pliku <em>Microsoft.Accelerator.dll</em>, który możemy znaleźć w podfolderze <code>Accelerator v2/bin/Managed</code> .</li>
<li>Dodatkowo w folderze <em>bin</em> mogliśmy się natknąć na 2 foldery: x64 i x86. Należy dodać plik <em>Accelerator.dll</em> z odpowiedniego folderu (zależnie od naszego sprzętu) do folderu, w którym znajduje się nasza aplikacja. <strong>Uwaga</strong>: jeżeli nie dodamy tego pliku lub dodamy nie właściwą wersję, będziemy w stanie skompilować program, ale podczas jego działania wyrzucony zostanie stosowny wyjątek (<strong>BadImageFormatException</strong> w przypadku skopiowania biblioteki z niewłaściwego folderu lub <strong>DllNotFoundException</strong> w przypadku nie wykrycia biblioteki, którą należało skopiować).</li>
</ol>


<p>Po tym wszystkim możemy już swobodnie pracować. Polecam zapoznać się z przykładami dostępnymi w folderze z zainstalowanym Acceleratorem ;) .</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2011-08-16T23:18:00+02:00" data-updated="true" itemprop="datePublished">Aug 16<span>th</span>, 2011</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/javascript/'>javascript</a>, <a class='category' href='/blog/categories/programowanie/'>programowanie</a>


</div>
		
			<span class="comments"><a href="/blog/2011/08/16/prosta-scena-do-gry-przy-uzyciu-html5/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2011/08/16/prosta-scena-do-gry-przy-uzyciu-html5/" itemprop="url">Prosta Scena Do Gry Przy Użyciu Html5 I CoffeeScriptu</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>W dzisiejszym poście postaram się streścić (w postaci przykładu oczywiście ;) ) moje krótkie doznania związane z nauką Coffee Scriptu i jego zastosowaniu w aplikacjach tworzonych przy pomocy Visual Studio.</p>

<p>Zacznijmy od tego, czym jest CoffeeScript? Otóż jest to język skryptowy wysokiego poziomu (składnią przypominający Ruby&#8217;ego i po części Pythona), kompilowany bezpośrednio do JavaScriptu. Na jego plus dochodzi fakt, że nie odbiega on za daleko od samego .js, a przez to jest on wygodny do operowania zarówno na elementach strony jak i we współpracy z już istniejącymi bibliotekami .js (nie są przy tym wymagane żadne dodatkowe zabiegi). Dla osób, które o tym nie słyszały i nie miały wcześniej do czynienia polecam oficjalną stronę (link <a href="http://jashkenas.github.com/coffee-script/">tutaj</a>). Jest tam dokładny opis języka wraz z przykładami użycia i interaktywną konsolą, pokazującą na żywo jak wygląda napisany przez nas kod zaraz po skompilowaniu.</p>

<p>Jak zamontować Coffee Script w aplikacji pisanej w Visual Studio? Jest wiele rozwiązań, ja przedstawię dwa, które uznałem za najprostsze do zrozumienia i najbardziej sensowne:
&ndash; Używanie kompilatorów w czasie wykonania &ndash; jest to rozwiązanie dające sporą kontrolę i pewne pole do popisu, ale też bardziej obciążające maszynę. Istnieje wiele kompilatorów przygotowanych pod platformę .NET, osobiście mogę polecić <a href="https://github.com/abolibibelot/coffeescript-dotnet#readme">CoffeeScript.Net</a> (głównie ze względu na to, że z innymi kompilatorami nie miałem wiele do czynienia).
&ndash; Można też ściągnąć stosowny template do Visual Studio (ja korzystam z tych zawartych w <a href="http://www.mindscapehq.com/products/web-workbench">Mindscape Web Workbench</a>). Generują one kod na bierząco w trakcie jego pisania &ndash; jest do preferowana przeze mnie opcja, ponieważ na bierząco możemy sprawdzać, czy nie popełniamy błędów a nasz kod się kompiluje. W takim wypadku wystarczy dodać do strony standardowy skrypt js, a jako źródło podać ścieżkę do pliku .coffee i zmienić jej rozszerzenie na .js.</p>

<h2>Tworzymy obsługę sceny</h2>

<p>W tym punkcie zacznijmy od stworzenia klasy, której zadaniem będzie rysowanie obiektów na scenie (w tym celu należy uprzednio stworzyć odpowiedni canvas) i wypełnianiu jej tła.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">class</span> <span class="nx">Graphics</span>
</span><span class='line'>  <span class="nv">constructor: </span><span class="nf">(canvas) -&gt;</span>
</span><span class='line'>      <span class="nv">can = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@ctx = </span><span class="nx">can</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s">&quot;2d&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@w = </span><span class="nx">can</span><span class="p">.</span><span class="nx">width</span>
</span><span class='line'>      <span class="vi">@h = </span><span class="nx">can</span><span class="p">.</span><span class="nx">height</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">drawBack: </span><span class="nf">(r, g, b) -&gt;</span>
</span><span class='line'>       <span class="vi">@ctx.fillStyle = </span><span class="s">&quot;rgb(</span><span class="si">#{</span><span class="nx">r</span><span class="si">}</span><span class="s">,</span><span class="si">#{</span><span class="nx">g</span><span class="si">}</span><span class="s">,</span><span class="si">#{</span><span class="nx">b</span><span class="si">}</span><span class="s">)&quot;</span>
</span><span class='line'>       <span class="nx">@ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@w</span><span class="p">,</span> <span class="nx">@h</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">drawRect: </span><span class="nf">(p) -&gt;</span>
</span><span class='line'>      <span class="vi">@ctx.fillStyle = </span><span class="s">&quot;rgb(200, 200, 200)&quot;</span>
</span><span class='line'>      <span class="nx">@ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Słowo wyjasnienia:</p>

<ul>
<li><code>constructor</code> &ndash; jak łatwo się domyślić reprezentuje on konstruktor naszej klasy. Przekazujemy do niego nazwę identyfikatora elementu <strong>Canvas</strong>, który wykorzystamy do renderowania. Symbol <code>@ </code>jest w JavaScript&#8217;cie zamieniany bezpośrednio na <strong>this</strong>. (należy z tym uważać, zwłaszcza podczas zagłębiania @ w funkcjach przekazywanych jako parametry).</li>
<li><code>drawBack</code> &ndash; zamalowuje powierzchnię w tle kolorem o podanych w parametrach wartościach r, g, b. Wyrażenie <code>#{r}</code> (i podobne) są zamieniane na konkatencje (złączenie) całości wyrażenia do jednego stringa wraz z wypełnionymi wartościami zawartymi w zmiennej r.</li>
<li><code>drawRect</code> &ndash; odpowiada za narysowanie prostokąta o parametrach przekazanych przez tablicę (wybrałem tablicę ze względu na prostotę, można ją zastąpić na wiele sposobów). Jak można się domyślić indeksy 0, 1, 2, 3 tablicy odpowiadają kolejno 0 &ndash; odległość lewego górnego rogu od lewej krawędzi canvy, 1 &ndash; odległości lewego górnego rogu od górnej krawędzi canvy, 2 &ndash; szerokości prostokątu, 3 &ndash; wysokości prostokątu.</li>
</ul>


<p>Kiedy już rozumiemy jak będzie wykonywane renderowanie elementów na scenie, przejdźmy do dalszych operacji.</p>

<h2>Budowa animowanej sceny</h2>

<p>Kolejnym krokiem będzie stworzenie klasy odpowiedzialnej za obsługę zdarzeń oraz pętli gry. Sposoby konstrukcji samej pętli są różne, polecam zapoznać się z <a href="http://nokarma.org/2011/02/02/javascript-game-development-the-game-loop/index.html">tym wpisem</a>. Autor dobrze i wyczerpująco tłumaczy zasady konstrukcji pętli gry w JavaScript&#8217;cie.</p>

<p>Moje podejście postaram się wyjaśnić na poniższym kodzie:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="k">class</span> <span class="nx">Game</span>
</span><span class='line'>  <span class="nv">constructor: </span><span class="nf">(canvas) -&gt;</span>
</span><span class='line'>      <span class="vi">@w = </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span>
</span><span class='line'>      <span class="vi">@h = </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span>
</span><span class='line'>      <span class="vi">@g = </span><span class="k">new</span> <span class="nx">Graphics</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@fps = </span><span class="mi">50</span>
</span><span class='line'>      <span class="vi">@loop_id = </span><span class="kc">undefined</span>
</span><span class='line'>      <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s">&quot;keydown&quot;</span><span class="p">,</span> <span class="nx">@update</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">update: </span><span class="nf">(evt) -&gt;</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">evt</span><span class="o">?</span><span class="p">.</span><span class="nx">which</span> <span class="o">is</span> <span class="mi">38</span>        <span class="c1">#arrow down</span>
</span><span class='line'>       <span class="nx">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">5</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">if</span> <span class="nx">evt</span><span class="o">?</span><span class="p">.</span><span class="nx">which</span> <span class="o">is</span> <span class="mi">40</span>   <span class="c1">#arrow up</span>
</span><span class='line'>       <span class="nx">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">5</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">if</span> <span class="nx">evt</span><span class="o">?</span><span class="p">.</span><span class="nx">which</span> <span class="o">is</span> <span class="mi">37</span>   <span class="c1">#arrow left</span>
</span><span class='line'>       <span class="nx">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">5</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">if</span> <span class="nx">evt</span><span class="o">?</span><span class="p">.</span><span class="nx">which</span> <span class="o">is</span> <span class="mi">39</span>   <span class="c1">#arrow right</span>
</span><span class='line'>          <span class="nx">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">5</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">draw: </span><span class="nf">-&gt;</span>
</span><span class='line'>      <span class="nx">@g</span><span class="p">.</span><span class="nx">drawBack</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">@g</span><span class="p">.</span><span class="nx">drawRect</span><span class="p">(</span><span class="nx">p1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">startGame: </span><span class="nf">-&gt;</span>
</span><span class='line'>      <span class="nv">self = </span><span class="nx">@</span>
</span><span class='line'>      <span class="vi">@loop_id = </span><span class="nx">setInterval</span><span class="p">((()</span> <span class="nf">-&gt;</span>
</span><span class='line'>       <span class="nx">self</span><span class="p">.</span><span class="nx">draw</span><span class="p">()</span>
</span><span class='line'>       <span class="p">),</span> <span class="mi">1000</span> <span class="o">/</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fps</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">endGame: </span><span class="nf">-&gt;</span>
</span><span class='line'>      <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">@loop_id</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nieco wyjaśnień:
&ndash; <code>constructor</code> &ndash; tutaj jak widzimy jednocześnie definiujemy stworzony przez nas uprzednio obiekt klasy Graphics, ale też dodatkowo dodajemy definiujemy listener (methoda <strong>update</strong>), który będzie zajmował się obsługą klawiatury na potrzeby okna przeglądarki. Pola naszej klasy:
&ndash; <code>fps</code> &ndash; liczba cykli pętli / klatek na sekundę &ndash; jest to wartość orientacyjna, nasza przeglądarka wcale nie musi, a prawdopodobnie nawet nie będzie dotrzymywać zamierzonej przez nas wartości.
&ndash; <code>loop_id</code> &ndash; uchwyt do metody wykonującej pętlę, niezbędny jeżeli będziemy chcieli ją zatrzymać.
&ndash; <code>update</code> &ndash; prosta metoda obsługująca poruszanie naszego obiektu po planszy. Wartość p1[0] odpowiada ruchowi w poziomie, analogicznie p1[1] to ruch w pionie. wyrażenie <code>evt?.which</code> odpowiada zapisowi słownemu &ndash; sprawdź, czy obiekt <strong>evt</strong> istnieje, a jeżeli tak podaj wartość jego pola <strong>which</strong> (określa ono kod naciśniętego przycisku &ndash; znacznie więcej na ten temat można przeczytać <a href="http://unixpapa.com/js/key.html">tutaj</a>).
&ndash; <code>draw</code> &ndash; wywołujemy tutaj kolejno metody do wypełniania tła kolorem czarnym, a następnie odrysowujemy nasz kształt (prostokąt) w pozycjach podanych przez tablicę.
&ndash; <code>startGame</code> &ndash; ustawiamy cykliczne wykonywanie metody <code>draw </code>(w założeniu 50 klatek/sek. w praktyce będzie to inna wartość). Warto zauważyć, że aby wywołać metodę <strong>draw</strong> z bieżącego obiektu Game, zapisaliśmy uprzednio wartość this (w CoffeScript jej odpowiednikiem jest znak <code>@</code>) do osobnej zmiennej. Dzieje się tak dlatego, ponieważ po wejściu do funkcji obsługiwanej przez <code>setInterval</code>zmienia się kontekst wykonywanego bloku kodu, a co za tym idzie zmienna <code>this</code>/<code>@</code>wskazuje już na inny obiekt (w tym wypadku będzie to bodajże okno przeglądarki). Na koniec zapisujemy uchwyt do wykonywanej metody w zmiennej @loop_id.</p>

<p>W praktyce to wszystko wystarczy, aby uruchomić podstawową scenę uwzględniającą animacje i reagującą na akcje wykonywane przez użytkownika na klawiaturze :) . Przykładowe uruchomienie sceny:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">p1 = </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">50</span><span class="p">]</span>    <span class="c1"># x, y, width, height</span>
</span><span class='line'><span class="nx">$</span> <span class="nf">-&gt;</span>
</span><span class='line'>  <span class="c1"># odpowiednik document.ready, wymaga dołączenia jquery</span>
</span><span class='line'>  <span class="nv">game = </span><span class="k">new</span> <span class="nx">Game</span><span class="p">(</span><span class="s">&quot;arena&quot;</span><span class="p">)</span>   <span class="c1"># arena - canvas id</span>
</span><span class='line'>  <span class="nx">game</span><span class="p">.</span><span class="nx">startGame</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Uwagi:
&ndash; Z nieznanych mi przyczyn (nie ustaliłem jeszcze dokładnego powodu) javascript skompilowany z powyższego kodu może mieć problemy z uruchomieniem na przeglądarce Chrome. Firefox i Opera nie sprawiają tutaj większych problemów.
&ndash; Istnieje sporo gotowych frameworków, które odciążają nas z konieczności konstruowania inteligentnych pętli gry. Jest to temat wart zbadania.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2011-07-31T23:52:00+02:00" data-updated="true" itemprop="datePublished">Jul 31<span>st</span>, 2011</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/programowanie/'>programowanie</a>, <a class='category' href='/blog/categories/wzorce-projektowe/'>wzorce projektowe</a>


</div>
		
			<span class="comments"><a href="/blog/2011/07/31/ninject-i-pierwsze-starcie-z-dependency/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2011/07/31/ninject-i-pierwsze-starcie-z-dependency/" itemprop="url">Ninject I Pierwsze Starcie Z Dependency Injection</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Uwaga: poniższy wpis jest kierowany przede wszystkim do osób, które w tematyce TDD i DI są dość świeże lub &lsquo;nie czują&rsquo; jeszcze niektórych z przedstawianych poniżej pojęć.</p>

<p>Nie dalej jak parę dni temu postanowiłem nieco rozwinąć swoją wiedzę z zakresu TDD (Test Driven Development). Jak pewnie osoby, które są zorientowane w podstawach tej metodyki wiedzą, niezbędnym elementem wymaganym podczas tworzenia takich rozwiązań jest konieczność przetestowania praktycznie każdej metody i klasy za pomocą <strong>wcześniej przygotowanych</strong> testów jednostkowych (tak jest, najpierw piszemy testy, a dopiero potem przygotowujemy implementację, która ma je poprawnie wykonać).</p>

<p>Jak się jednak okazuje dość szybko natykamy się na pewien problem &ndash; w jaki sposób mamy przetestować klasy, które tworzą między sobą głębokie drzewa zależności lub sięgające do zewnętrznych zasobów. Przykładem może być chociażby klasa wykorzystująca zapytania do bazy danych czy operująca na danych przy użyciu obiektów z jakiegoś ORMa. Jak mamy przetestować wyniki zapytań w kosztownym w obsłudze i ciągle zmieniającym się środowisku bazy danych, która nie znajduje się bezpośrednio pod kontrolą klas odpowiedzialnych za testy?</p>

<p>Rozwiązaniem tego problemu jest wzorzec <strong>Dependency Injection</strong>. Główną definicją z nim powiązaną jest pojęcie <em>loose coupling</em>. Zakłada ono, że należy unikać powiązania klas pomiędzy sobą na rzecz zależności klasa-interfejs, konstrukcji klas implementujących odpowiednie interfejsy oraz testowania metod prezentowanych za pośrednictwem interfejsów. Dokładniej przedstawię to na przykładzie poniżej.</p>

<p>Inną ważną cechą związaną z wzorcem DI jest <strong>kontener DI</strong>. W skrócie chodzi o to, aby nie przekazywać ręcznie klas prezentujących dane interfejsy. Zamiast tego dysponujemy fabryką zwracającą na nasze zlecenie odpowiednie obiekty. W tym właśnie miejscu dochodzimy do tematu mojego posta. Mowa tutaj mianowicie o bibliotece Ninject. Jest to w pełni open source&#8217;owy projekt dostępny na githubie (strona główna projektu: <a href="http://ninject.org/">http://ninject.org/</a>). Wprowadza on w świat .Net zestaw klas umożliwiających nam szybkie i sprawne operowanie na kontenerach DI. Dla ciekawskich: innym projektem udostępniającym omawiane kontenery jest wspierany przez Microsoft <a href="http://unity.codeplex.com/">Unity 2.0</a>.</p>

<h2>Projektowanie klas w myśl Dependency Injection</h2>

<p>Ponieważ metodologia TDD znajduje powszechne uznanie w środowisku programistów ASP.Net MVC, za mój przykład posłuży właśnie ta platforma. Zakładam, że czytający mój wpis będzie miał pewne pojęcie odnośnie powodów stosowania wzorca repozytorium (<em>Repository pattern</em>), dlatego też od razu zabiorę się do opisania przypadku.</p>

<p>Przyjmijmy, że dysponujemy klasą kontrolera (nazwijmy ją <strong>ItemsController</strong>), która zajmuje się nadzorowaniem wyświetlanych widoków w oparciu o obiekty klasy <strong>Item</strong>&ndash; w naszym przypadku będzie to docelowo obiekt mapowany na odpowiadający mu rekord w tabeli w bazie danych, jego implementacja jest obecnie nieistotna. W celu stworzenia jednolitego modelu nasz kontroler wykorzystywać będzie obiekt klasy <strong>ItemsRepository</strong>, przy pomocy którego będzie pobierał dane z bazy.</p>

<p>Jest to dość standardowy scenariusz, wszystko powinno więc być dość jasne. Nasz wstępny wygląd klas może wyglądać w następujący sposób:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ItemsController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">ItemsRepository</span> <span class="n">repository</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="n">ViewResult</span> <span class="nf">Index</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="cm">/* ... tutaj pobieramy rekordy</span>
</span><span class='line'><span class="cm">     z bazy i przekazujemy je do widoku */</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ItemsRepository</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// obiekt używany podczas mapowania obiektów z bazy</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">DataContext</span> <span class="n">context</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Item</span><span class="p">&gt;</span> <span class="n">Items</span><span class="p">{</span>
</span><span class='line'>      <span class="k">get</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="cm">/* pobieramy rekordy z bazy i zwracamy</span>
</span><span class='line'><span class="cm">         je jako obiekty klasy Item */</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wszystko wygląda na proste i przejrzyste do momentu, kiedy chcemy napisać testy jednostkowe mające na celu sprawdzenie, czy metoda Index kontrolera faktycznie zwraca porządany widok wypełniony właściwymi danymi.</p>

<p>Tutaj dochodzimy do sedna Dependency Injection. Rozwiązaniem powyższego przypadku może być wydzielenie funkcjonalności repozytorium do postaci interfejsu ( a następnie przekazanie go do jako argumentu lub właściwości do kontrolera. Po takim zabiegu nasz kod wygląda następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IItemsRepository</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Item</span><span class="p">&gt;</span> <span class="n">Items</span><span class="p">{</span><span class="k">get</span><span class="p">;}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ItemsRepository</span> <span class="p">:</span> <span class="n">IItemsRepository</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">DataContext</span> <span class="n">context</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Item</span><span class="p">&gt;</span> <span class="n">Items</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">get</span><span class="p">{...}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ItemsController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">IItemsRepository</span> <span class="n">repository</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">ItemsController</span><span class="p">(</span><span class="n">IItemsRepository</span> <span class="n">repo</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">repository</span> <span class="p">=</span> <span class="n">repo</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="n">ViewResult</span> <span class="nf">Index</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="p">...</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Jak widzimy teraz nie jesteśmy związani na stałe wykorzystywaniem naszego repozytorium wewnątrz kontrolera. Jeżeli chcemy przetestować funkcjonalność kontrolera (bez angażowania w to naszej klasy <strong>ItemsRepository</strong>) wystarczy napisać testową implementację interfejsu <strong>IItemsRepository</strong>, która może zwracać dowolną wybraną przez nas kolekcję obiektów <strong>Item, </strong>nawet jeżeli nie są one w żaden sposób powiązane z bazą danych (a to z kolei zapewnia nam przezroczystość i kontrolę wystarczającą do przeprowadzenia testów oraz umożliwia wsparcie ze strony mocków).</p>

<h2>Pora na Ninject</h2>

<p>Kiedy nasze klasy są już gotowe powinniśmy się zastanowić w jaki sposób będziemy wywoływać konstruktor naszego kontrolera (podejście <em>Constructor Injection</em>). W tym celu wykorzystamy dostępną w ASP.Net MVC opcję umożliwiającą nam samodzielne określenie obiektu fabryki zajmującej się tworzeniem nowych kontrolerów. W tym celu musimy najpierw napisać własną klasę dziedziczącą po <code>System.Web.Mvc.DefaultControllerFactory</code> . Oto przykładowa implementacja fabryki:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">NinjectControllerFactory</span> <span class="p">:</span> <span class="n">DefaultControllerFactory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// nasz DI container, który wykorzystamy do tworzenia powiązań</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">IKernel</span> <span class="n">kernel</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">NinjectControllerFactory</span> <span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">kernel</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StandardKernel</span><span class="p">();</span>
</span><span class='line'>      <span class="n">kernel</span><span class="p">.</span><span class="n">Bind</span><span class="p">&lt;</span><span class="n">IItemRepository</span><span class="p">&gt;().</span><span class="n">To</span><span class="p">&lt;</span><span class="n">ItemRepository</span><span class="p">&gt;();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="n">IController</span> <span class="nf">GetControllerInstance</span><span class="p">(</span><span class="n">RequestContext</span> <span class="n">reqCtx</span><span class="p">,</span> <span class="n">Type</span> <span class="n">controllerType</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">kernel</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">controllerType</span><span class="p">)</span> <span class="k">as</span> <span class="n">IController</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Na co warto zwrócić uwagę to fakt, że wewnątrz konstruktora możemy zauważyć tajemniczą linijkę:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="n">kernel</span><span class="p">.</span><span class="n">Bind</span><span class="p">&lt;</span><span class="n">IItemRepository</span><span class="p">&gt;().</span><span class="n">To</span><span class="p">&lt;</span><span class="n">ItemRepository</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Jej znaczenie jest następujące &ndash; każemy kontenerowi naszej fabryki stworzyć powiązanie polegające na tym, że za każdym razem kiedy wyślemy do kontenera żądanie utworzenia obiektu wymagającego <strong>IItemRepository</strong>, wtedy automatycznie wykonane zostanie mapowanie wiązania i przekazanie obiektu <strong>ItemRepository</strong>. Sytuacja taka zachodzi wewnątrz metody <em>GetControllerInstance</em>, gdzie wywołujemy polecenie <code>kernel.Get()</code>. Jeżeli typ przekazanego kontrolera będzie wymagał przekazania obiektu do konstruktora (jak w przypadku klasy <strong>ItemsController</strong>), zostanie on automatycznie wypełniony. Pozwala to na sprawne i płynne operowanie kodem.</p>

<p><strong>Uwaga</strong>: jeżeli chcemy, aby powyższa fabryka była faktycznie wykorzystywana w naszym projekcie, musimy ją podpiąć. Robimy to w następujący sposób &ndash; wewnątrz pliku <strong>Global.asax.cs</strong> znajdujemy metodę <code>Application_Start</code>i na jej końcu dodajemy następującą linijkę:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="n">ControllerBuilder</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">SetControllerFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">NinjectControllerFactory</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2011-07-13T15:47:00+02:00" data-updated="true" itemprop="datePublished">Jul 13<span>th</span>, 2011</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/bazy-danych/'>bazy danych</a>


</div>
		
			<span class="comments"><a href="/blog/2011/07/13/mssql-date-range-na-tablicach/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2011/07/13/mssql-date-range-na-tablicach/" itemprop="url">[MSSQL] Date Range Na Tablicach Rekurencyjnych</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Ostatnimi czasy dostałem do napisania zadanie związane z koniecznością stworzenia zapytania SQL (na potrzeby projektu budowanego w MSSQL Server 2008), którego jedną z charakterystycznych cech była konieczność sprawdzenia warunku dla wszystkich dat z podanego zakresu. Z początku proste, zadanie to miało jednak kilka dodatkowych warunków:</p>

<ol>
<li>Nie wolno mi było tworzyć w systemie tablic pomocniczych (żadnych poleceń CREATE TABLE ani ALTER TABLE) &ndash; zapytanie miało być w domyśle wykorzystywane w wielu miejscach jednocześnie, a wcześniejsze stworzenie tablicy z danymi uznane było za nadmiarowość danych.</li>
<li>Zapytanie miało zachowywać się właściwie, gdy jeden z parametrów (data końcowa) był NULLem &ndash; w takim przypadku pobieramy datę bieżącą.</li>
<li>Zapytanie miało mieć parametr decydujący o tym, czy sprawdzane daty znajdują się w odstępach dziennych, tygodniowych czy miesięcznych.</li>
<li>Całość miała być skonstruowana tak, aby zapytania można było użyć podczas generowania raportów RDL.</li>
</ol>


<p>Mając do tej pory małe doświadczenia z samym SQL-em zacząłem szybko zgłębiać temat. Ostatecznie powziąłem decyzję o wykorzystaniu ciekawego wynalazku &ndash; tablic rekurencyjnych. Ponieważ było to rozwiązanie dopuszczalne z punktu widzenia wymagań, postanowiłem stworzyć pomocniczą funkcję.</p>

<p>Oto przykładowa implementacja rozwiązania:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">dbo</span><span class="p">.</span><span class="n">DateRange</span>
</span><span class='line'><span class="p">(</span><span class="o">@</span><span class="n">start_date</span> <span class="n">datetime</span><span class="p">,</span>
</span><span class='line'> <span class="o">@</span><span class="n">end_date</span> <span class="n">datetime</span><span class="p">,</span>
</span><span class='line'> <span class="o">@</span><span class="n">unit</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</span><span class='line'><span class="k">RETURNS</span>
</span><span class='line'> <span class="o">@</span><span class="n">Dates</span> <span class="k">TABLE</span><span class="p">(</span><span class="k">data</span> <span class="n">datetime</span><span class="p">)</span>
</span><span class='line'><span class="k">AS</span>
</span><span class='line'><span class="k">BEGIN</span>
</span><span class='line'>  <span class="k">WITH</span> <span class="n">cte</span> <span class="k">AS</span>
</span><span class='line'>  <span class="p">(</span>
</span><span class='line'>      <span class="k">SELECT</span> <span class="mi">1</span> <span class="n">i</span><span class="p">,</span> <span class="o">@</span><span class="n">start_date</span> <span class="k">AS</span> <span class="k">data</span>
</span><span class='line'>      <span class="k">UNION</span> <span class="k">ALL</span>
</span><span class='line'>      <span class="k">SELECT</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">CASE</span> <span class="o">@</span><span class="n">unit</span>
</span><span class='line'>      <span class="k">WHEN</span> <span class="s1">&#39;day&#39;</span> <span class="k">THEN</span> <span class="n">DATEADD</span><span class="p">(</span> <span class="k">day</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">@</span><span class="n">start_date</span> <span class="p">)</span>
</span><span class='line'>      <span class="k">WHEN</span> <span class="s1">&#39;week&#39;</span> <span class="k">THEN</span> <span class="n">DATEADD</span><span class="p">(</span> <span class="n">week</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">@</span><span class="n">start_date</span> <span class="p">)</span>
</span><span class='line'>      <span class="k">WHEN</span> <span class="s1">&#39;month&#39;</span> <span class="k">THEN</span> <span class="n">DATEADD</span><span class="p">(</span> <span class="k">month</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">@</span><span class="n">start_date</span> <span class="p">)</span>
</span><span class='line'>      <span class="k">END</span>
</span><span class='line'>      <span class="k">FROM</span> <span class="n">cte</span>
</span><span class='line'>      <span class="k">WHERE</span>
</span><span class='line'>      <span class="p">(</span><span class="o">@</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;day&#39;</span> <span class="k">AND</span> <span class="p">((</span><span class="o">@</span><span class="n">end_date</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">AND</span>
</span><span class='line'>      <span class="n">DATEADD</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">@</span><span class="n">start_date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">GETDATE</span><span class="p">())</span> <span class="k">OR</span>
</span><span class='line'>          <span class="p">(</span><span class="n">DATEADD</span><span class="p">(</span> <span class="k">day</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">@</span><span class="n">start_date</span> <span class="p">)</span> <span class="o">&lt;=</span> <span class="o">@</span><span class="n">end_date</span><span class="p">)))</span> <span class="k">OR</span>
</span><span class='line'>      <span class="p">(</span><span class="o">@</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;week&#39;</span> <span class="k">AND</span> <span class="p">((</span><span class="o">@</span><span class="n">end_date</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">AND</span>
</span><span class='line'>      <span class="n">DATEADD</span><span class="p">(</span><span class="n">week</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">@</span><span class="n">start_date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">GETDATE</span><span class="p">())</span> <span class="k">OR</span>
</span><span class='line'>          <span class="p">(</span><span class="n">DATEADD</span><span class="p">(</span> <span class="n">week</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">@</span><span class="n">start_date</span> <span class="p">)</span> <span class="o">&lt;=</span> <span class="o">@</span><span class="n">end_date</span><span class="p">)))</span> <span class="k">OR</span>
</span><span class='line'>      <span class="p">(</span><span class="o">@</span><span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;month&#39;</span> <span class="k">AND</span> <span class="p">((</span><span class="o">@</span><span class="n">end_date</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">AND</span>
</span><span class='line'>      <span class="n">DATEADD</span><span class="p">(</span><span class="k">month</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">@</span><span class="n">start_date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">GETDATE</span><span class="p">())</span> <span class="k">OR</span>
</span><span class='line'>          <span class="p">(</span><span class="n">DATEADD</span><span class="p">(</span> <span class="k">month</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">@</span><span class="n">start_date</span> <span class="p">)</span> <span class="o">&lt;=</span> <span class="o">@</span><span class="n">end_date</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="o">@</span><span class="n">Dates</span> <span class="p">(</span><span class="k">data</span><span class="p">)</span>
</span><span class='line'>  <span class="k">SELECT</span> <span class="k">data</span> <span class="k">FROM</span> <span class="n">cte</span>
</span><span class='line'>  <span class="k">OPTION</span> <span class="p">(</span><span class="n">MAXRECURSION</span> <span class="mi">32000</span><span class="p">)</span>
</span><span class='line'>  <span class="k">RETURN</span><span class="p">;</span>
</span><span class='line'><span class="k">END</span>
</span></code></pre></td></tr></table></div></figure>


<p>Jak widać, funkcja przyjmuje 3 parametry:</p>

<ul>
<li>datę początkową &ndash; w przypadku funkcji jest wymagana, lecz w samym zapytaniu można ją dostosować do swoich potrzeb.</li>
<li>datę końcową &ndash; możliwe jest tu podanie wartości NULL, dla takiego przypadku pobieramy bieżącą datę.</li>
<li>jednostkę &ndash; mowa tutaj o typie jednostek w jakich mierzymy przedziały (codziennie, w tygodniach, w miesiącach)</li>
</ul>


<p>Przykładowe wywołanie funkcji:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="k">data</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">DateRange</span><span class="p">(</span><span class="s1">&#39;2011-01-01&#39;</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Dodatkowo warto zwrócić uwagę na opcję określającą maksymalny poziom rekurencji w generowanej tabeli. Nie jest do element obowiązkowy, niemniej warto się w ten sposób zabezpieczyć.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2011-06-22T06:57:00+02:00" data-updated="true" itemprop="datePublished">Jun 22<span>nd</span>, 2011</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/asp/'>asp</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>


</div>
		
			<span class="comments"><a href="/blog/2011/06/22/wyswietlanie-stron-aspx-przy-pomocy/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2011/06/22/wyswietlanie-stron-aspx-przy-pomocy/" itemprop="url">Wyświetlanie Stron Aspx Przy Pomocy Iframe I Jquery Ui Dialog</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Witam, w dzisiejszym poście chciałbym podzielić się rozwiązaniem problemu, który pomimo, że przydarza się dość rzadko, to jednak zdążył napsuć mi trochę nerwów. Zacznijmy od opisania tematu:</p>

<p>Dysponujemy standardową stroną aspx (zawierającą w sobie zarówno kontrolki aspx jak i skrypty jQuery), która docelowo ma zostać wyświetlona wewnątrz okna dialogowego dostępnego poprzez biblioteki jquery i jquery ui.</p>

<p>Zadanie wydaje się banalne, przecież wystarczyłoby w stronie wyświetlającej okno wpisać kilka linijek:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;dialog&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;iframe</span> <span class="na">src=</span><span class="s">&quot;ścieżka do wyświetlonej strony&quot;</span><span class="nt">&gt;&lt;/iframe&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Teraz już tylko wypisanie <code>$(&ldquo;#dialog&rdquo;).dialog()</code> i po sprawie. Ale czy na pewno? Otóż w moim przypadku takie podejście do sprawy skończyło się wyrzuceniem script errorów na stronie wyświetlanej w ramce (mowa tu o błędach typu <em>Object is undefined</em>). Co gorsza błąd ten był nagminny: występował niezależnie od tego, czy strona źródłowa posiadała dodaną informację o odnośnikach do plików jquery czy też nie.</p>

<p>Ostatecznie rozwiązanie tego problemu okazało się stosunkowo proste. Chodzi w nim o to, aby nie dodawać atrybutu src do iframe bezpośrednio z poziomu html, a dopiero po wywołaniu metody dialog() na porządanym elemencie, który ma stać się oknem dialogowym. Przykładowy prawidłowo napisany kod:</p>

<p>Html:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;dialog&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">&quot;frame&quot;</span><span class="nt">&gt;&lt;/iframe&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>JavaScript:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#dialog&quot;</span><span class="p">).</span><span class="nx">dialog</span><span class="p">();</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#frame&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;ścieżka do wyświetlanej strony&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Po takiej operacji nasze okno powinno być gotowe.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2011-04-29T19:32:00+02:00" data-updated="true" itemprop="datePublished">Apr 29<span>th</span>, 2011</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/eksploracja-danych/'>eksploracja danych</a>, <a class='category' href='/blog/categories/programowanie/'>programowanie</a>


</div>
		
			<span class="comments"><a href="/blog/2011/04/29/przeszukiwanie-sieci-i-indeksowanie/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2011/04/29/przeszukiwanie-sieci-i-indeksowanie/" itemprop="url">Przeszukiwanie Sieci I Indeksowanie Stron Internetowych</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Ostatnimi czasy postanowiłem stworzyć prostą aplikację, której zadaniem byłoby przeszukiwanie wszerz stron internetowych. Temat zacznę od omówienia mojego spojżenia na problem:</p>

<ol>
<li>Jeżeli weźmiemy pod uwagę, że sieć można reprezentować pod postacią grafu skierowanego, mamy do dyspozycji bardzo proste rozwiązanie w postaci algorytmu BFS. Każdy nowo zaakceptowany link będzie dorzucany do wspólnej kolejki i każdorazowo z niej zdejmowany, kiedy przyjdzie pora na przetworzenie strony pod wybranym linkiem.</li>
<li>Aby uniknąć zakleszczenia, dodatkowo poza kolejką umieszczamy link w liście &ndash; w ten sposób zaindeksujemy wszystkie odwiedzone strony i będziemy mogli sprawdzić, czy dana strona nie została już poprzednio odwiedzona.</li>
<li>Na sam koniec, aby ograniczyć przestrzeń przeszukiwać ustalimy adres url domeny, do której przeszukiwań będziemy się ograniczać.</li>
</ol>


<p>Podstawowa konstrukcja naszej klasy będzie zatem wyglądać następująco:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">class</span> <span class="nc">Crawler</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">http</span> <span class="p">=</span> <span class="s">&quot;http://&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">Sites</span> <span class="p">{</span> <span class="k">set</span><span class="p">;</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">public</span> <span class="kt">string</span> <span class="n">Url</span> <span class="p">{</span> <span class="k">set</span><span class="p">;</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">queue</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
</span><span class='line'>  <span class="n">Regex</span> <span class="n">anchor</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Regex</span><span class="p">(</span><span class="s">&quot;&lt;a href=\&quot;.*\&quot;&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">private</span> <span class="kt">int</span> <span class="n">id</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">Crawler</span><span class="p">(</span><span class="kt">string</span> <span class="n">domain</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">Url</span> <span class="p">=</span> <span class="n">domain</span><span class="p">;</span>
</span><span class='line'>      <span class="n">Sites</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Chwila na wyjaśnienie:</p>

<ul>
<li>ustawiłem słowo <strong>http</strong> w postaci stałej, aby łatwiej się później nim posługiwać.</li>
<li><strong>anchor</strong> stanowi wyrażenie regularne, po którym będziemy wykrywać wszystkie znaczniki <code>a</code> z atrybutem <code>href</code>, które zawierają linki do innych stron.</li>
<li><strong>id</strong> to nic innego jak licznik stron</li>
</ul>


<p>Teraz należy wyposażyć naszą klasę w możliwość przeglądania stron. W tym celu wewnątrz niej implementujemy następującą metodę:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">queue</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
</span><span class='line'>   <span class="n">WebClient</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WebClient</span><span class="p">();</span>
</span><span class='line'>   <span class="k">do</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">link</span> <span class="p">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">();</span>
</span><span class='line'>      <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>              <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamReader</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">OpenRead</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>                  <span class="n">SearchLinks</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">ReadToEnd</span><span class="p">());</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">catch</span> <span class="p">(</span><span class="n">WebException</span> <span class="n">exc</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;\tError on site {0} : {1}&quot;</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">exc</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">queue</span><span class="p">.</span><span class="n">Count</span> <span class="p">!=</span> <span class="m">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Parametrem metody jest korzeń &ndash; strona startowa, z której rozpoczynamy przeszukiwanie sieci. Do samego pobierania stron wykorzystujemy obiekt <em>WebClient</em>. Przeszukiwanie kolejnych stron będzie odbywać się tak długo, jak długo pozostaje coś do przeszukania (kolejka nie jest pusta). Sam mechanizm wyszukiwania linków ukryty jest pod metodą <em>SearchLinks</em> do której przejdę za chwilę. Przedtem jednak musimy się upewnić, że nasza pętla będzie odporna na występowanie błędów podczas odczytywania stron, jak choćby <em>Error 404</em>, któy może spowodować, że nasz WebClient wyrzuci wyjątek w trakcie próby otworzenia strumienia do strony.</p>

<p>Przejdźmy teraz do implementacji kolejnej metody:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">void</span> <span class="nf">SearchLinks</span><span class="p">(</span><span class="kt">string</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="kt">var</span> <span class="n">matches</span> <span class="p">=</span> <span class="n">anchor</span><span class="p">.</span><span class="n">Matches</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">match</span> <span class="k">in</span> <span class="n">matches</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">r</span> <span class="p">=</span> <span class="n">match</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">site</span> <span class="p">=</span> <span class="n">GetAddress</span><span class="p">(</span><span class="n">Url</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(!</span><span class="n">Sites</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">site</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">site</span><span class="p">))</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;{0}. Found: {1}&quot;</span><span class="p">,</span> <span class="p">++</span><span class="n">id</span><span class="p">,</span> <span class="n">site</span><span class="p">);</span>
</span><span class='line'>          <span class="n">Sites</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">site</span><span class="p">);</span>
</span><span class='line'>          <span class="n">queue</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">site</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>W tym kroku pobieramy w parametrze całą zawartość strony w postaci tekstu. Następnie sprawdzamy dopasowania naszego wyrażenia regularnego metodą Matches. Zwraca ona kolekcję obiektów określających wykryte dopasowania. Następnie dla każdego z dopasowań wyciągamy z niego link do kolejnej strony metodą <strong>GetAddress</strong> (implementacja poniżej).</p>

<p>Końcowym krokiem właściwego algorytmu jest sprawdzenie, czy faktycznie uzyskano jakiś link oraz czy nie został on już wcześniej przeszukany &ndash; jeżeli te warunki zostały spełnione dokonujemy odpowiedniego wpisu, uaktualniamy listę odkrytych stron i dodajemy ją do kolejki stron wymagających przeszukania.</p>

<p>Ostatnim problemem jest wydobycie adresu url z odkrytego wzorca. Oto moje rozwiązanie tego problemu:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">private</span> <span class="kt">string</span> <span class="nf">GetAddress</span><span class="p">(</span><span class="kt">string</span> <span class="n">url</span><span class="p">,</span> <span class="kt">string</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">splits</span> <span class="p">=</span> <span class="n">r</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span><span class="s">&quot;\&quot;&quot;</span><span class="p">},</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">);</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">splits</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">ishttp</span> <span class="p">=</span> <span class="n">splits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Contains</span><span class="p">(</span><span class="n">http</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span> <span class="n">splits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Contains</span><span class="p">(</span><span class="s">&quot;.html&quot;</span><span class="p">)</span> <span class="p">||</span> <span class="n">ishttp</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">ishttp</span> <span class="p">&amp;&amp;</span> <span class="n">splits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Contains</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">result</span> <span class="p">+=</span> <span class="n">splits</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">else</span> <span class="nf">if</span><span class="p">(!</span><span class="n">ishttp</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">result</span> <span class="p">+=</span> <span class="n">http</span> <span class="p">+</span> <span class="n">url</span> <span class="p">+</span> <span class="n">splits</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wykryte wyrażenie rozdzielamy na stringi poprzez znak &ldquo; . Jest to wymagane ponieważ dopasowany wzorzec będzie zawierać nie tylko adres strony, ale również sam atrybut a href (w przypadku podanego przeze mnie wyrażenia będzie to zawsze pierwszy element tablicy powstałej w wyniku pocięcia wzorca) i inne atrybuty (style itd&hellip;). Następnie sprawdzamy czy dany łańcuch znaków zawiera podciąg <em>&#8220;<a href="http://">http://</a>&rdquo;</em> &ndash; będzie to przez nas wykorzystane więcej niż raz, zapisałem więc ten wynik w osobnej zmiennej <em>ishttp</em>.</p>

<p>Dalsze rozdzielenie wynika z dwóch możliwych zachowań:
&ndash; wykryty adres jest absolutny &ndash; zawiera więc zarówno ciąg http jak i nazwę domeny, w której się poruszamy. Warto tutaj zaznaczyć, że ten algorytm wykrywa również strony zapisane w postaci <em><a href="http://xxx.nazwa_domeny.xxx_,">http://xxx.nazwa_domeny.xxx_,</a> gdzie </em>xxx_ są dowolnymi ciągami znaków.
&ndash; adres wskazuje na ścieżkę względną &ndash; w tym przypadku konstruujemy pełny adres strony, kończąc go znalezionym adresem.</p>

<p>Tak stworzona klasa jest w stanie indeksować wszystkie strony .html (można je zmodyfikować, aby sprawdzało również linki o innych rozszerzeniach) w podanej domenie bez ryzyka wejścia w nieskończoną pętlę.</p>

<p>Przykładowe wywołanie rozwiązania:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="n">Crawler</span> <span class="n">crawler</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Crawler</span><span class="p">(</span><span class="s">&quot;pb.edu.pl&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">crawler</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="s">&quot;http://wi.pb.edu.pl/&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2011-04-10T11:19:00+02:00" data-updated="true" itemprop="datePublished">Apr 10<span>th</span>, 2011</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/programowanie/'>programowanie</a>


</div>
		
			<span class="comments"><a href="/blog/2011/04/10/komunikacja-klient-serwer-w/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2011/04/10/komunikacja-klient-serwer-w/" itemprop="url">Biblioteka Miesiąca - Lidgren.Network</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Nie dalej jak miesiąc temu wraz ze znajomym rozpracowywaliśmy koncepcję komunikacji klient-klient oraz klient-serwer na potrzeby projektu który razem wykonujemy. Wtedy właśnie natknął się on na znalezisko, które na pierwszy rzut oka wygląda nadzwyczaj interesująco. Mowa tutaj o <a href="http://code.google.com/p/lidgren-network-gen3/">Lidgren.Network</a>. Co tak naprawdę skrywa się za tą nazwą? Otóż jest to biblioteka stworzona na potrzeby platformy .NET, która dostarcza nam proste i wygodne API do komunikacji klient &ndash; serwer za pomocą UDP.</p>

<p>Dlaczego wybrałem tą bibliotekę? Przedstawię tutaj kilka faktów, które wymieniłbym na jej plus:</p>

<ul>
<li>Otwarty kod. Dodatkową zaletą jest fakt, że wszystkie klasy pakietu są dość dobrze okomentowane.</li>
<li>Implementacja wielkich liczb całkowitych. Na minus tego rozwiązania idzie fakt, że ich konstrukcja przypomina stylem Javę.</li>
<li>Duża konfigurowalność. Podstawowe operacje wymagane do prowadzenia komunikacji są dość proste do nauczenia i szybkie do implementacji, lecz cała biblioteka umożliwia dostosowanie mechanizmu dokładnie do naszych potrzeb.</li>
<li>Przygotowanie mechanizmu do dystrubucji komunikatów na wielu klientów.</li>
<li>Metody umożliwiające wygodne przesyłanie zarówno stringów (wiadomości tekstowe), łańcuchów bajtów (np. przesyłanie obrazu i plików), jak nawet dostęp do pojedyńczych bitów. Nie musimy sami tego implementować, wystarczy że skorzystamy z gotowych rozwiązań.</li>
<li>Duża ilość sampli, z których można się nauczyć obsługi biblioteki.</li>
</ul>


<p>Krótko mówiąc jest to bardzo przyjazna biblioteka, która zrzuca z nas większość ciężaru związanego z ręczną implementacją wielu przydatnych rozwiązań. Proponuję dobrze się jej przyjżeć, a może unikniemy w ten sposób potrzeby wymyślania koła na nowo ;) .</p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
        <a href="/blog/page/3/" class="prev">Prev</a>
    
    
        <a href="/blog/page/5/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2014

    Bartosz Sypytkowski


Design based on: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
</body>
</html>
