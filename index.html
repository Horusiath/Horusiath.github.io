
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Simple Solutions</title>
	<meta name="author" content="Bartosz Sypytkowski">

	
	<meta name="description" content="Aug 6th, 2014 akka.net, fsharp Comments Actor Supervisors in Akka.NET FSharp API This post will describe changes, that will affect a F# API for Akka &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Simple Solutions" type="application/atom+xml">
	
	<link rel="canonical" href="http://bartoszsypytkowski.com/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	

<script type="text/javascript">
      var disqus_shortname = 'bartoszsypytkowski';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-47294845-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><h1 id="profile-name"><a href="/">Bartosz Sypytkowski</a></h1>
<div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("b.sypytkowski@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:b.sypytkowski@gmail.com" title="Email">Email</a>
		
		
		
			<a class="google" href="https://plus.google.com/b.sypytkowski@gmail.com" rel="author" title="Google+">Google+</a>
		
		
			<a class="twitter" href="http://twitter.com/horusiath" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/horusiath" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-08-06T18:49:00+02:00" data-updated="true" itemprop="datePublished">Aug 6<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/akka-dot-net/'>akka.net</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>


</div>
		
			<span class="comments"><a href="/blog/2014/08/06/fsharp-akkadotnet-supervisors/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/08/06/fsharp-akkadotnet-supervisors/" itemprop="url">Actor Supervisors in Akka.NET FSharp API</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>This post will describe changes, that will affect a F# API for Akka.NET in the incoming versions of the framework (>= 0.62) &ndash; mostly those, which concerns supervisioning and manipulating actor hierarchies.</p>

<p>I don&rsquo;t want to overload this post with explaining what Akka supervision is all about, so I&rsquo;ll just recommend a very good article, which could be found <a href="https://github.com/akkadotnet/akka.net/wiki/Supervision">here</a>.</p>

<p>While previous versions of the Akka F# API introduced some nice features such as function-based actor definitions and creations (<code>spawn</code> function), there still was no simple way to handle some core framework concepts. Remember that march towards Akka.NET 1.0 is still in progress, more and more features are implemented. Therefore it&rsquo;s F# API most likely will also be a subject to change.</p>

<p>To give a better description of the new features, lets see an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'> <span class="k">let</span> <span class="n">supervisor</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">spawns</span> <span class="n">system</span> <span class="s2">&quot;master&quot;</span>
</span><span class='line'>        <span class="c1">// below we define OneForOneStrategy to handle specific exceptions incoming from child actors</span>
</span><span class='line'>        <span class="o">&lt;|</span> <span class="o">(</span><span class="nn">Strategy</span><span class="p">.</span><span class="n">oneForOne</span> <span class="o">&lt;|</span> <span class="k">fun</span> <span class="n">e</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="k">match</span> <span class="n">e</span> <span class="k">with</span>
</span><span class='line'>            <span class="o">|</span> <span class="o">:?</span> <span class="nc">ArithmeticException</span> <span class="o">-&gt;</span> <span class="nn">Directive</span><span class="p">.</span><span class="nc">Resume</span>
</span><span class='line'>            <span class="o">|</span> <span class="o">:?</span> <span class="nc">ArgumentException</span>   <span class="o">-&gt;</span> <span class="nn">Directive</span><span class="p">.</span><span class="nc">Stop</span>
</span><span class='line'>            <span class="o">|</span> <span class="o">_</span>                      <span class="o">-&gt;</span> <span class="nn">Directive</span><span class="p">.</span><span class="nc">Escalate</span><span class="o">)</span>
</span><span class='line'>        <span class="o">&lt;|</span> <span class="k">fun</span> <span class="n">mailbox</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="c1">// by using mailbox.spawn we may create a child actors without exiting a F# functional API</span>
</span><span class='line'>            <span class="k">let</span> <span class="n">worker</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="n">spawn</span> <span class="s2">&quot;worker&quot;</span> <span class="o">&lt;|</span> <span class="n">workerFun</span>
</span><span class='line'>            <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span><span class="bp">()</span> <span class="o">=</span> <span class="n">actor</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">let</span><span class="o">!</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Receive</span><span class="bp">()</span>
</span><span class='line'>                <span class="k">match</span> <span class="n">msg</span> <span class="o">:&gt;</span> <span class="n">obj</span> <span class="k">with</span>
</span><span class='line'>                <span class="o">|</span> <span class="o">:?</span> <span class="nc">Respond</span> <span class="o">-&gt;</span> <span class="n">worker</span><span class="o">.</span><span class="nc">Tell</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Sender</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>                <span class="o">|</span> <span class="o">_</span>          <span class="o">-&gt;</span> <span class="n">worker</span> <span class="o">&lt;!</span> <span class="n">msg</span>
</span><span class='line'>                <span class="k">return</span><span class="o">!</span> <span class="n">loop</span><span class="bp">()</span> <span class="o">}</span>
</span><span class='line'>            <span class="n">loop</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>A <a href="https://github.com/akkadotnet/akka.net/blob/dev/src/examples/FSharp.Api/Supervisioning.fs">whole example</a> is available inside Akka.NET project source code, along with other examples.</p>

<p>Unlike standard <code>spawn</code>, <code>spawns</code> function could take a SupervisorStrategy object as an argument. By using F# API you are able to use <code>Strategy</code> module to quickly create a corresponding strategy instance. It supports two types of strategy creators:</p>

<ol>
<li><code>Strategy.oneForOne</code> &ndash; strategy will affect only an exception thrower.</li>
<li><code>Strategy.allForOne</code> &ndash; strategy result will propagate to all children of the actor implementing that strategy.</li>
</ol>


<p>Both functions come in two variants. First one takes only one argument &ndash; <em>decider</em> function, which determines an expected behavior based upon type of exception thrown. Second one (<code>Strategy.oneForOne'</code> and <code>Strategy.allForOne'</code>) precedes decider argument with a timeout and number of possible behavior retries. All of them corresponds directly to standard Akka strategy API, but are wrapped to fit F# functional approach instead of method overrides.</p>

<p>Second change, is the new <code>mailbox.spawn</code> method, which works just like it&rsquo;s standard <code>spawn</code> equivalent with only one difference &ndash; it sets a <code>mailbox</code> Actor instance as current parent/supervisor of created actor. Both of those features combined could be used to bring a full supervision support in classic functional manner.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-08-02T13:21:00+02:00" data-updated="true" itemprop="datePublished">Aug 2<span>nd</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/compilers/'>compilers</a>, <a class='category' href='/blog/categories/programming-languages/'>programming languages</a>


</div>
		
			<span class="comments"><a href="/blog/2014/08/02/simple-vm/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/08/02/simple-vm/" itemprop="url">Simple Virtual Machine</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>In this post I want to present, how to create a simple virtual machine with it&rsquo;s own bytecode interpreter. While it&rsquo;s created using C language, it doesn&rsquo;t use any complex constructs and could be possibly implemented the same with any imperative language.</p>

<p>NOTE: while in this example bytecode instruction set is limited to the simple integer operations, real life virtual machines usually have a lot more complex operands (eg. object creation instruction in VMs with managed memory or dynamic method invocations). Have in mind that even if your Intermediate Representation may look like some BASIC/ASM language, it really could abstract much higher level functionalities.</p>

<h3>Virtual Machine</h3>

<p>Lets start with precising, what our virtual machine should consist of. In this example, we&rsquo;ll create a stack-based virtual machine. What does it mean? There is no notion of registers and all operation are performed through virtual stack. This results in simpler (since our instruction set doesn&rsquo;t have to include virtual registers operations), but also longer bytecode &ndash; because of more operations have to be executed than in alternative option, which may support a virtual register calls.</p>

<p>In this example, our virtual machine will consist of:</p>

<ul>
<li><strong>Executable code pointer</strong> &ndash; in order to execute the program, a VM has to now what program it is ;) Our bytecode contains opcodes (which are integers used to define instructions to be executed by an interpreter) and numbers used for things such as constant values, memory addresses or stack offsets.</li>
<li><strong>Stack</strong> &ndash; virtual stack will work as fragment of memory used for storing intermediate results and additional data of each instruction. When a procedure call will be invoked, it will also save a state of the program at moment, when procedure has been called, to retrieve it back after program will return from that call.</li>
<li><strong>Heap</strong> &ndash; unlike the stack, which uses LIFO (Last-In First-Out) operations, heap may be used as random access memory. It also may change it&rsquo;s size according to program needs. In this example we may use it to store both global and local variables.</li>
<li><strong>Program counter</strong> &ndash; it contains an address of currently executed instruction. Program will be executed by moving PC through instruction set, reading opcodes and executing them.</li>
<li><strong>Stack pointer</strong> &ndash; it contains information about number of elements stored on the stack. It always points on the top of it.</li>
<li><strong>Frame pointer</strong> &ndash; since we need to differentiate a locally and globally scoped values (this includes function arguments), we need to know where our scope is located on the stack. All local variables are assigned relatively to FP position.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// stack will have fixed size</span>
</span><span class='line'><span class="cp">#define STACK_SIZE 100</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span><span class="o">*</span> <span class="n">heap</span><span class="p">;</span>      <span class="c1">// heap</span>
</span><span class='line'>    <span class="kt">int</span><span class="o">*</span> <span class="n">code</span><span class="p">;</span>      <span class="c1">// array od byte codes to be executed</span>
</span><span class='line'>    <span class="kt">int</span><span class="o">*</span> <span class="n">stack</span><span class="p">;</span>     <span class="c1">// virtual stack</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">pc</span><span class="p">;</span>         <span class="c1">// program counter (aka. IP - instruction pointer)</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">sp</span><span class="p">;</span>         <span class="c1">// stack pointer</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">fp</span><span class="p">;</span>         <span class="c1">// frame pointer (for local scope)</span>
</span><span class='line'><span class="p">}</span> <span class="n">VM</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">VM</span><span class="o">*</span> <span class="nf">newVM</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">code</span><span class="p">,</span>    <span class="c1">// pointer to table containing a bytecode to be executed</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">pc</span><span class="p">,</span>             <span class="c1">// address of instruction to be invoked as first one - entrypoint/main func</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">datasize</span><span class="p">){</span>      <span class="c1">// total heap size required to perform a program operations</span>
</span><span class='line'>    <span class="n">VM</span><span class="o">*</span> <span class="n">vm</span> <span class="o">=</span> <span class="p">(</span><span class="n">VM</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">VM</span><span class="p">));</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">heap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">datasize</span><span class="p">);</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">stack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">STACK_SIZE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">vm</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">delVM</span><span class="p">(</span><span class="n">VM</span><span class="o">*</span> <span class="n">vm</span><span class="p">){</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">heap</span><span class="p">);</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">stack</span><span class="p">);</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Bytecode instruction set</h3>

<p>At the begginig we&rsquo;ll start from defining a set of instructions to be handled by our language. For sake of simplicity we&rsquo;ll focus on basic integer operations, printing their result, variable creation and procedure-oriented calls.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">enum</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">ADD_I32</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>    <span class="c1">// int add</span>
</span><span class='line'>    <span class="n">SUB_I32</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>    <span class="c1">// int sub</span>
</span><span class='line'>    <span class="n">MUL_I32</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>    <span class="c1">// int mul</span>
</span><span class='line'>    <span class="n">LT_I32</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>     <span class="c1">// int less than</span>
</span><span class='line'>    <span class="n">EQ_I32</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>     <span class="c1">// int equal</span>
</span><span class='line'>    <span class="n">JMP</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>        <span class="c1">// branch</span>
</span><span class='line'>    <span class="n">JMPT</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>       <span class="c1">// branch if true</span>
</span><span class='line'>    <span class="n">JMPF</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>       <span class="c1">// branch if false</span>
</span><span class='line'>    <span class="n">CONST_I32</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>  <span class="c1">// push constant integer</span>
</span><span class='line'>    <span class="n">LOAD</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>      <span class="c1">// load from local</span>
</span><span class='line'>    <span class="n">GLOAD</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>     <span class="c1">// load from global</span>
</span><span class='line'>    <span class="n">STORE</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>     <span class="c1">// store in local</span>
</span><span class='line'>    <span class="n">GSTORE</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>    <span class="c1">// store in global memory</span>
</span><span class='line'>    <span class="n">PRINT</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>     <span class="c1">// print value on top of the stack</span>
</span><span class='line'>    <span class="n">POP</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>       <span class="c1">// throw away top of the stack</span>
</span><span class='line'>    <span class="n">HALT</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>      <span class="c1">// stop program</span>
</span><span class='line'>    <span class="n">CALL</span> <span class="o">=</span> <span class="mi">17</span><span class="p">,</span>      <span class="c1">// call procedure</span>
</span><span class='line'>    <span class="n">RET</span> <span class="o">=</span> <span class="mi">18</span>        <span class="c1">// return from procedure</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just like in standard assembly code, each instruction is represented by specific byte number. In more realistic virtual machine those numbers may have specific values (for example to perform bitwise masking).</p>

<h3>Main interpreter loop</h3>

<p>It&rsquo;s time to create our code execution loop. How does it work? It&rsquo;s a simple loop with switch statement used to interpret particular operation codes found in our program. While this is not the fastest solution, it gives us a simple understanding of how fetch/decode/execute cycle works.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define PUSH(vm, v) vm-&gt;stack[++vm-&gt;sp] = v </span><span class="c1">// push value on top of the stack</span>
</span><span class='line'><span class="cp">#define POP(vm)     vm-&gt;stack[vm-&gt;sp--]     </span><span class="c1">// pop value from top of the stack</span>
</span><span class='line'><span class="cp">#define NCODE(vm)   vm-&gt;code[vm-&gt;pc++]      </span><span class="c1">// get next bytecode</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">run</span><span class="p">(</span><span class="n">VM</span><span class="o">*</span> <span class="n">vm</span><span class="p">){</span>
</span><span class='line'>    <span class="k">do</span><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>        <span class="c1">// fetch</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">rval</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">// decode</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">HALT</span>: <span class="k">return</span><span class="p">;</span>  <span class="c1">// stop the program</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">CONST_I32</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">ADD_I32</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">SUB_I32</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">MUL_I32</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">LT_I32</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">EQ_I32</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">JMP</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">JMPT</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">JMPF</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">LOAD</span>:  <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">GLOAD</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">GSTORE</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">CALL</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">RET</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">POP</span>:
</span><span class='line'>            <span class="o">--</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">;</span>      <span class="c1">// throw away value at top of the stack</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">PRINT</span>:
</span><span class='line'>            <span class="n">v</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>        <span class="c1">// pop value from top of the stack ...</span>
</span><span class='line'>            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>  <span class="c1">// ... and print it</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="nl">default:</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we&rsquo;ve already defined <code>HALT</code>, <code>POP</code> and <code>PRINT</code> opcodes. In more realistic example, you probably don&rsquo;t want to define value display in form of dedicated instruction, but this will allow us to simply see result of our operations.</p>

<h3>Integer operators</h3>

<p>Now we can define some integer operations. While we&rsquo;re defined a plenty of them, here I&rsquo;ll show only one example for each group: constant initialization, arithmetic and logic operations.</p>

<p>What is worth emphasizing, is that all value swaps are performed through stack (there are no registers), so each instruction takes it&rsquo;s operands from top of the stack and also puts a computed result on top of it. Also, since stacks are LIFO-type collections, all values taken from the stack are in reversed order &ndash; for example look at <code>ADD_I32</code> instruction below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">CONST_I32</span>:
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>   <span class="c1">// get next value from code ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>     <span class="c1">// ... and move it on top of the stack</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">ADD_I32</span>:
</span><span class='line'>    <span class="n">b</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>        <span class="c1">// get second value from top of the stack ...</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>        <span class="c1">// ... then get first value from top of the stack ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">);</span>    <span class="c1">// ... add those two values and put result on top of the stack</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">LT_I32</span>:
</span><span class='line'>    <span class="n">b</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>        <span class="c1">// get second value from top of the stack ...</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>        <span class="c1">// ... then get first value from top of the stack ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="o">&lt;</span><span class="n">b</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// ... compare those two values, and put result on top of the stack</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instructions such as <code>SUB_I32</code>, <code>MUL_I32</code> and <code>EQ_I32</code> won&rsquo;t be defined in scope of this post, but I think when you&rsquo;ll understand example above, they should be easy to implement.</p>

<h3>Jump instructions</h3>

<p>Next, we have to define jump instructions in our code. They are basically equivalent of <code>goto</code> keyword and may be used to implement statements such as loops and if/else conditions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">JMP</span>:
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>  <span class="c1">// unconditionaly jump with program counter to provided address</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">JMPT</span>:
</span><span class='line'>    <span class="n">addr</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>  <span class="c1">// get address pointer from code ...</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">))</span> <span class="p">{</span>      <span class="c1">// ... pop value from top of the stack, and if it&#39;s true ...</span>
</span><span class='line'>        <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span> <span class="c1">// ... jump with program counter to provided address</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, <code>JUMPF</code> (conditional jump if false) implementation should be analogous to <code>JMPT</code>.</p>

<h3>Move memory on the heap globally</h3>

<p>Now, when all basic constructs are defined, we shall provide a way to define a variables in our program. This paragraph will cover problem of globally-scoped ones, while the next one will show how to implement locally-scoped variables.</p>

<p>Unlike stack, a heap is a random access memory of elastic size, so all in/out operations performed on it using memory addresses (aka. pointers). Therefore in our example all load/store opcodes should be followed by number being an address pointer to the heap.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">GLOAD</span>:
</span><span class='line'>    <span class="n">addr</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>             <span class="c1">// get pointer address from code ...</span>
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">heap</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>         <span class="c1">// ... load value from memory of the provided addres ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>                <span class="c1">// ... and put that value on top of the stack</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">GSTORE</span>:
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>                <span class="c1">// get value from top of the stack ...</span>
</span><span class='line'>    <span class="n">addr</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>           <span class="c1">// ... get pointer address from code ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">heap</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>         <span class="c1">// ... and store value at address received</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Manipulate local scope memory</h3>

<p>This is similar to previously defined <code>GLOAD</code> and <code>GSTORE</code> instruction. However there is a one significant difference &ndash; instead of taking an heap address directly from provided value, we compute it relatively to current frame pointer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">LOAD</span>:                  <span class="c1">// load local value or function arg</span>
</span><span class='line'>    <span class="n">offset</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>     <span class="c1">// get next value from code to identify local variables offset start on the stack</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">stack</span><span class="p">[</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span><span class="o">+</span><span class="n">offset</span><span class="p">]);</span> <span class="c1">// ... put on the top of the stack variable stored relatively to frame pointer</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">STORE</span>:                 <span class="c1">// store local value or function arg</span>
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>            <span class="c1">// get value from top of the stack ...</span>
</span><span class='line'>    <span class="n">offset</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>     <span class="c1">// ... get the relative pointer address from code ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">heap</span><span class="p">[</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span><span class="o">+</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>  <span class="c1">// ... and store value at address received relatively to frame pointer</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Procedure calls</h3>

<p>All of previous instructions were fairly simple to execute. Now it&rsquo;s time to do something slightly more complex &ndash; function/procedure calls. Before we begin, lets describe how they works. To perform the call, we have to first save the current state of the program at the moment before the call will be performed &ndash; it will let us freely alter program state in scope of the function. To do so, we have to save three values:</p>

<ul>
<li>Address of the caller instruction &ndash; this is a current value of program counter and it&rsquo;s need to be stored, so that VM will know, where program should return from finished procedure call.</li>
<li>Frame pointer &ndash; this is necessary, since we want to be able to use locally scoped variables when we enter into new procedure (<strong>tl;dr</strong> &ndash; it gives us a function scope feature).</li>
<li>Number of function/procedure arguments &ndash; before call will be performed, all necessary arguments will be put on top of the stack. However returning from function should dispose all of the provided arguments, so that we could retrieve back state of the stack from before the function call. If we want to know how many arguments from the stack should be thrown away, firstly we have to store that count &ndash; it will be also put on top of the stack.</li>
</ul>


<p><code>RET</code> instruction works in reverse order &ndash; it takes value from top of the stack as function return value, rollbacks frame pointers, moves program counter to the caller instruction, disposes all of function call arguments from the stack and replaces all of these with return value.</p>

<p>Because we&rsquo;ve stored all of those values on top of the stack, we&rsquo;re able to store next consecutive calls in the same manner. It means that, we&rsquo;re able to nest our procedure calls. However, since each call stores some portion of data on the stack, at some point we may run out of memory, which cause stack overflow error.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">CALL</span>:
</span><span class='line'>    <span class="c1">// we expect all args to be on the stack</span>
</span><span class='line'>    <span class="n">addr</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span> <span class="c1">// get next instruction as an address of procedure jump ...</span>
</span><span class='line'>    <span class="n">argc</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span> <span class="c1">// ... and next one as number of arguments to load ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">argc</span><span class="p">);</span>   <span class="c1">// ... save num args ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">);</span> <span class="c1">// ... save function pointer ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span> <span class="c1">// ... save instruction pointer ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">=</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">;</span>  <span class="c1">// ... set new frame pointer ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>    <span class="c1">// ... move instruction pointer to target procedure address</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">RET</span>:
</span><span class='line'>    <span class="n">rval</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>     <span class="c1">// pop return value from top of the stack</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">=</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">;</span>    <span class="c1">// ... return from procedure address ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>   <span class="c1">// ... restore instruction pointer ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>   <span class="c1">// ... restore framepointer ...</span>
</span><span class='line'>    <span class="n">argc</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>     <span class="c1">// ... hom many args procedure has ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">-=</span> <span class="n">argc</span><span class="p">;</span>     <span class="c1">// ... discard all of the args left ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>     <span class="c1">// ... leave return value on top of the stack</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Example code</h3>

<p>Now, when our bytecode interpreter is finally complete, we may test it on some example program. Please note numbers in comments on the right &ndash; they show actual opcode instruction address, and will be used for conditional jumps and procedure calls.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">const</span> <span class="kt">int</span> <span class="n">fib</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// address of the fibonacci procedure</span>
</span><span class='line'><span class="kt">int</span> <span class="n">program</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// int fib(n) {</span>
</span><span class='line'>    <span class="c1">//     if(n == 0) return 0;</span>
</span><span class='line'>    <span class="n">LOAD</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>       <span class="c1">// 0 - load last function argument N</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="c1">// 2 - put 0</span>
</span><span class='line'>    <span class="n">EQ_I32</span><span class="p">,</span>         <span class="c1">// 4 - check equality: N == 0</span>
</span><span class='line'>    <span class="n">JMPF</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>       <span class="c1">// 5 - if they are NOT equal, goto 10</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="c1">// 7 - otherwise put 0</span>
</span><span class='line'>    <span class="n">RET</span><span class="p">,</span>            <span class="c1">// 9 - and return it</span>
</span><span class='line'>    <span class="c1">//     if(n &lt; 3) return 1;</span>
</span><span class='line'>    <span class="n">LOAD</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>       <span class="c1">// 10 - load last function argument N</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>   <span class="c1">// 12 - put 3</span>
</span><span class='line'>    <span class="n">LT_I32</span><span class="p">,</span>         <span class="c1">// 14 - check if 3 is less than N</span>
</span><span class='line'>    <span class="n">JMPF</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span>       <span class="c1">// 15 - if 3 is NOT less than N, goto 20</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// 17 - otherwise put 1</span>
</span><span class='line'>    <span class="n">RET</span><span class="p">,</span>            <span class="c1">// 19 - and return it</span>
</span><span class='line'>    <span class="c1">//     else return fib(n-1) + fib(n-2);</span>
</span><span class='line'>    <span class="n">LOAD</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>       <span class="c1">// 20 - load last function argument N</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// 22 - put 1</span>
</span><span class='line'>    <span class="n">SUB_I32</span><span class="p">,</span>        <span class="c1">// 24 - calculate: N-1, result is on the stack</span>
</span><span class='line'>    <span class="n">CALL</span><span class="p">,</span> <span class="n">fib</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// 25 - call fib function with 1 arg. from the stack</span>
</span><span class='line'>    <span class="n">LOAD</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>       <span class="c1">// 28 - load N again</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>   <span class="c1">// 30 - put 2</span>
</span><span class='line'>    <span class="n">SUB_I32</span><span class="p">,</span>        <span class="c1">// 32 - calculate: N-2, result is on the stack</span>
</span><span class='line'>    <span class="n">CALL</span><span class="p">,</span> <span class="n">fib</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// 33 - call fib function with 1 arg. from the stack</span>
</span><span class='line'>    <span class="n">ADD_I32</span><span class="p">,</span>        <span class="c1">// 36 - since 2 fibs pushed their ret values on the stack, just add them</span>
</span><span class='line'>    <span class="n">RET</span><span class="p">,</span>            <span class="c1">// 37 - return from procedure</span>
</span><span class='line'>    <span class="c1">// entrypoint - main function</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>   <span class="c1">// 38 - put 6 </span>
</span><span class='line'>    <span class="n">CALL</span><span class="p">,</span> <span class="n">fib</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// 40 - call function: fib(arg) where arg = 6;</span>
</span><span class='line'>    <span class="n">PRINT</span><span class="p">,</span>          <span class="c1">// 43 - print result</span>
</span><span class='line'>    <span class="n">HALT</span>            <span class="c1">// 44 - stop program</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// initialize virtual machine</span>
</span><span class='line'><span class="n">VM</span><span class="o">*</span> <span class="n">vm</span> <span class="o">=</span> <span class="n">newVM</span><span class="p">(</span><span class="n">program</span><span class="p">,</span>   <span class="c1">// program to execute</span>
</span><span class='line'>                   <span class="mi">38</span><span class="p">,</span>    <span class="c1">// start address of main function</span>
</span><span class='line'>                   <span class="mi">0</span><span class="p">);</span>    <span class="c1">// heap to be reserved, fib doesn&#39;t require heap</span>
</span><span class='line'><span class="n">run</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you may have seen, there is a lot of <code>LOAD, -3</code> operations. Why -3? Again, when we perform a procedure call, we need to store current program state on top of the stack. To do so, we&rsquo;ll put here a 3 values: program counter (as return address), frame pointers before the call, and number of arguments to be used by called procedure. Therefore everything below them (-3 and less) will be an actual function arguments saved on the stack. You could optimize it by adding something like <code>LDARG, x</code> opcode.</p>

<h3>Why?</h3>

<p>There are numerous reasons, why developers may want to use intermediate bytecode representations for their languages:</p>

<ul>
<li><strong>Performance</strong> &ndash; as you&rsquo;ve seen, execution of the bytecode is realized mostly by just moving (mostly incrementing) PC pointer. When interpreter works directly by evaluating and traversing an AST tree, there is a lot of pointer jumping and structure blocks, which is slightly more complex and slower. Bytecode allows you to faster code interpretation as well as it may facilitate some optimizations.</li>
<li><strong>Code size</strong> &ndash; full code operates on human readable strings, which may consume some memory and are harder to interpret. Intermediate program representation uses only a simple integer arrays.</li>
<li><strong>Well-fitting</strong> &ndash; since you may describe your own IR, you may fit it directly to your needs. It&rsquo;s easier to parse, and it could remove some repetitive work, when you&rsquo;ll want to implement your language on the various OSes.</li>
</ul>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-07-09T00:00:00+02:00" data-updated="true" itemprop="datePublished">Jul 9<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/akka-dot-net/'>akka.net</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>


</div>
		
			<span class="comments"><a href="/blog/2014/07/09/fsharp-akka-map-reduce/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/07/09/fsharp-akka-map-reduce/" itemprop="url">Map Reduce With FSharp and Akka.net</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>In my previous post, I&rsquo;ve shown how to create a simple <em>hello world</em> application using Akka.net system leveraged with a F# API. Today, I&rsquo;ll show a slightly more complex example. We&rsquo;ll create a simple Map-Reduce system based on distributed word count algorithm.</p>

<p>Idea of our algorithm is quite simple &ndash; we want to group and count all repetitions of the same words (case-insensitive) in input text. This is a perfect subject to illustrate a map-reduce algorithm as well as Akka.net task distribution mechanism. To realize our objective, we&rsquo;ll need to define three actor types:</p>

<ul>
<li>Master &ndash; it&rsquo;s main job is to spread an input data equally among other actors and forward request for result data.</li>
<li>Mappers &ndash; they will tokenize their text fragments into specific words and send it to reducers.</li>
<li>Reducers &ndash; they are responsible for word grouping and counting.</li>
</ul>


<p>At the beginning, lets define basic message types used by our system:</p>

<ul>
<li>One to propagate chunks of data to mapping nodes.</li>
<li>Next one to forward processed data to reducers.</li>
<li>Last one to invoke collection mechanism, which will concatenate all reduced data to one peace and send it back to the originator.</li>
</ul>


<p>All of them are illustrated by the code below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">MRMsg</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Map</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Reduce</span> <span class="k">of</span> <span class="o">(</span><span class="kt">string</span> <span class="o">*</span> <span class="kt">int</span><span class="o">)</span> <span class="kt">list</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Collect</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you may have seen previously, instead of C#/Scala objective approach, I&rsquo;ve used tail-recursive function to define an actor processing routine. Since a lot of it&rsquo;s code would be repetitive among all of the actor types we want to define, I&rsquo;ve created a simple function factory, which will wrap all varying logic for us.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">actorFor</span> <span class="n">func</span> <span class="o">=</span> <span class="k">fun</span> <span class="o">(</span><span class="n">mailbox</span><span class="o">:</span><span class="nc">Actor</span><span class="o">&lt;</span><span class="nc">MRMsg</span><span class="o">&gt;)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span><span class="bp">()</span> <span class="o">=</span> <span class="n">actor</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">let</span><span class="o">!</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Receive</span><span class="bp">()</span>
</span><span class='line'>        <span class="n">func</span> <span class="n">mailbox</span> <span class="n">msg</span>            <span class="c1">// this line is actor-specific</span>
</span><span class='line'>        <span class="k">return</span><span class="o">!</span> <span class="n">loop</span><span class="bp">()</span> <span class="o">}</span>
</span><span class='line'>    <span class="n">loop</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lets start to defining a map-reduce logic into our application. Firstly we need to create a <strong>map actor</strong>. In this example, all what it needs to do, is to chop provided string into single words, and create from them a simple bag of words with their repetition. However we won&rsquo;t sum them now &ndash; this is the job for reducer actors.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">mapWords</span> <span class="o">(</span><span class="n">line</span><span class="o">:</span><span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">seq</span> <span class="o">{</span> <span class="k">for</span> <span class="n">word</span> <span class="k">in</span> <span class="n">line</span><span class="o">.</span><span class="nc">Split</span><span class="bp">()</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">word</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">map</span> <span class="n">reducer</span> <span class="o">(</span><span class="n">mailbox</span><span class="o">:</span><span class="nc">Actor</span><span class="o">&lt;</span><span class="nc">MRMsg</span><span class="o">&gt;)</span> <span class="o">=</span> <span class="k">function</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Map</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="n">reducer</span> <span class="o">&lt;!</span> <span class="nc">Reduce</span> <span class="o">(</span><span class="n">mapWords</span> <span class="n">line</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">ofSeq</span><span class="o">)</span>
</span><span class='line'>    <span class="o">|</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Unhandled</span> <span class="n">m</span>      <span class="c1">// mapper won&#39;t handle any other messages</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you may see, after finishing it&rsquo;s work, mapper will send list of words directly to reducers. To make this possible, we need to provide reducer reference as one of the function parameters.</p>

<p>Next type is the <strong>reduce actor</strong>. It&rsquo;s task is to group all incoming words, and count their occurrences. In our example we use shared <code>ConcurrentDictionary</code> for gathering data from all of the reducer instances. For more real life example, we should probably use some more sophisticated mechanism, such as <strong>aggregate actor</strong> concatenating all results provided by specific reducers. Here for sake of simplicity, we omit it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">reduceWords</span> <span class="o">(</span><span class="n">dict</span><span class="o">:</span><span class="nc">ConcurrentDictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span><span class="kt">int</span><span class="o">&gt;)</span> <span class="n">iter</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">iter</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">dict</span><span class="o">.</span><span class="nc">AddOrUpdate</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Func</span><span class="o">&lt;_,_,_&gt;(</span><span class="k">fun</span> <span class="n">key</span> <span class="n">old</span> <span class="o">-&gt;</span> <span class="n">old</span> <span class="o">+</span> <span class="n">v</span><span class="o">))</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">reduce</span> <span class="o">(</span><span class="n">dict</span><span class="o">:</span><span class="nc">ConcurrentDictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span><span class="kt">int</span><span class="o">&gt;)</span> <span class="o">(</span><span class="n">mailbox</span><span class="o">:</span><span class="nc">Actor</span><span class="o">&lt;</span><span class="nc">MRMsg</span><span class="o">&gt;)</span> <span class="o">=</span> <span class="k">function</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Reduce</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">reduceWords</span> <span class="n">dict</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Collect</span> <span class="o">-&gt;</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Sender</span><span class="bp">()</span> <span class="o">&lt;!</span> <span class="n">seq</span> <span class="o">{</span> <span class="k">for</span> <span class="n">e</span> <span class="k">in</span> <span class="n">dict</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="nc">Key</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="nc">Value</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">|</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Unhandled</span> <span class="n">m</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since reducer actors have direct access to shared dictionary, they also are able to respond on Collect command, providing all reduced data back to message sender.</p>

<p>The last behavior, is the <strong>master actor</strong>. It&rsquo;s role is to be a proxy between application&rsquo;s in/out data, and the rest of the actors. We use it for two tasks: 1) sending text line by line to be processed by our Map-Reduce application, 2) forwarding request for result of MR operation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">master</span> <span class="n">mapper</span> <span class="o">(</span><span class="n">reducer</span><span class="o">:</span><span class="nc">InternalActorRef</span><span class="o">)</span> <span class="o">(</span><span class="n">mailbox</span><span class="o">:</span><span class="nc">Actor</span><span class="o">&lt;</span><span class="nc">MRMsg</span><span class="o">&gt;)</span> <span class="o">=</span> <span class="k">function</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Map</span> <span class="n">str</span> <span class="o">-&gt;</span> <span class="k">for</span> <span class="n">line</span> <span class="k">in</span> <span class="n">str</span><span class="o">.</span><span class="nc">Split</span> <span class="sc">&#39;\n&#39;</span> <span class="k">do</span> <span class="n">mapper</span> <span class="o">&lt;!</span> <span class="nc">Map</span> <span class="n">line</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Collect</span> <span class="o">-&gt;</span> <span class="n">reducer</span><span class="o">.</span><span class="nc">Tell</span><span class="o">(</span><span class="nc">Collect</span><span class="o">,</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Sender</span><span class="bp">()</span><span class="o">)</span>    <span class="c1">// forward message with info about it&#39;s originator</span>
</span><span class='line'>    <span class="o">|</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Unhandled</span> <span class="n">m</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now when we have all of our actors defined, we may initialize an Akka framework to create our MR system. Now we can use a helper functions, we&rsquo;ve defined before for fast and easy actor definition.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">system</span> <span class="o">=</span> <span class="nn">System</span><span class="p">.</span><span class="n">create</span> <span class="s2">&quot;MapReduceSystem&quot;</span> <span class="o">&lt;|</span> <span class="nn">ConfigurationFactory</span><span class="p">.</span><span class="nc">Default</span><span class="bp">()</span>
</span><span class='line'><span class="k">let</span> <span class="n">dict</span> <span class="o">=</span> <span class="nc">ConcurrentDictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span><span class="kt">int</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class='line'><span class="k">let</span> <span class="n">reducer</span> <span class="o">=</span> <span class="n">spawn</span> <span class="n">system</span> <span class="s2">&quot;reduce&quot;</span> <span class="o">&lt;|</span> <span class="n">actorFor</span> <span class="o">(</span><span class="n">reduce</span> <span class="n">dict</span><span class="o">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">mapper</span> <span class="o">=</span> <span class="n">spawn</span> <span class="n">system</span> <span class="s2">&quot;map&quot;</span> <span class="o">&lt;|</span> <span class="n">actorFor</span> <span class="o">(</span><span class="n">map</span> <span class="n">reducer</span><span class="o">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">master</span> <span class="o">=</span> <span class="n">spawn</span> <span class="n">system</span> <span class="s2">&quot;master&quot;</span> <span class="o">&lt;|</span> <span class="n">actorFor</span> <span class="o">(</span><span class="n">master</span> <span class="n">mapper</span> <span class="n">reducer</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>To finalize, we can pass some data to our system to see, if it returns an expected results. Until now, we&rsquo;ve only used send operator <code>&lt;!</code> to delegate fire-and-forget messages for specific actors, but we&rsquo;ve actually never used any two way request-response mechanism. To do so, we&rsquo;ll use Ask method (shortcut operator <code>&lt;?</code>) to send a request message and receive a handler to be used when a response will be returned in asynchronous manner.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="n">master</span> <span class="o">&lt;!</span> <span class="nc">Map</span> <span class="s2">&quot;Orange orange apple&quot;</span>
</span><span class='line'><span class="n">master</span> <span class="o">&lt;!</span> <span class="nc">Map</span> <span class="s2">&quot;cherry apple orange&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nn">Threading</span><span class="p">.</span><span class="nn">Thread</span><span class="p">.</span><span class="nc">Sleep</span> <span class="mi">500</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// read the result</span>
</span><span class='line'><span class="n">async</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">let</span><span class="o">!</span> <span class="n">res</span> <span class="o">=</span> <span class="n">master</span><span class="o">.</span><span class="nc">Ask</span><span class="o">(</span><span class="nc">Collect</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">AwaitTask</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">in</span> <span class="n">res</span> <span class="o">:?&gt;</span> <span class="o">(</span><span class="kt">string</span><span class="o">*</span><span class="kt">int</span><span class="o">)</span> <span class="n">seq</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">printfn</span> <span class="s2">&quot;%s</span><span class="se">\t</span><span class="s2">%d&quot;</span> <span class="n">k</span> <span class="n">v</span>
</span><span class='line'>    <span class="n">system</span><span class="o">.</span><span class="nc">Shutdown</span><span class="bp">()</span>
</span><span class='line'><span class="o">}</span> <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">RunSynchronously</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-07-05T21:42:00+02:00" data-updated="true" itemprop="datePublished">Jul 5<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/akka-dot-net/'>akka.net</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>


</div>
		
			<span class="comments"><a href="/blog/2014/07/05/fsharp-akka-net/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/07/05/fsharp-akka-net/" itemprop="url">FSharp and Akka.net - the Functional Way</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Actor model is one of the most influential paradigms of dealing with highly concurrent environments in present world. Simplifying, it&rsquo;s based on concept of autonomous thread-safe computation units &ndash; surprisingly called actors &ndash; with no way to directly interfere with each others work. There are no locks or semaphores &ndash; instead of accessing shared resources, they are simply passing messages around &ndash; according to the saying <em>Don&rsquo;t communicate by sharing memory; share memory by communicating</em>.</p>

<p>The first most widespread usage of the actor model was the Erlang Virtual Machine in 1986. While it was for many years closed in it&rsquo;s own niche, programming model itself has been lately forwarded and adopted on the Java Virtual Machine through <a href="http://akka.io/">Akka</a> framework. Until present moment there are actually none mature equivalents on .NET platform. While Microsoft is still developing it&rsquo;s own response in form of <a href="http://research.microsoft.com/en-us/projects/orleans/">Project Orleans</a>, a bunch of developers took the initiative of porting Akka on .NET ground.</p>

<p>I&rsquo;ve decided to try out Akka.NET a little. I&rsquo;ve noticed that it&rsquo;s still a far from completion or production-ready phase, but hopefully since it&rsquo;s based on already existing and mature framework, with help of OSS community missing holes could be patched soon.</p>

<h2>Hello Akka</h2>

<p>You can find an original first step into Akka.NET with F# API <a href="https://github.com/akkadotnet/akka.net/wiki/FSharp-API">here</a>. While I found this sample useful, I&rsquo;ve decided to investigate more about Akka.NET source code and it&rsquo;s F# API. Below you may see my example based on more functional-specific concepts:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">ActorMsg</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Greet</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Hi</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">system</span> <span class="o">=</span> <span class="nn">System</span><span class="p">.</span><span class="n">create</span> <span class="s2">&quot;MySystem&quot;</span> <span class="o">&lt;|</span> <span class="nn">ConfigurationFactory</span><span class="p">.</span><span class="nc">Default</span><span class="bp">()</span>
</span><span class='line'><span class="k">let</span> <span class="n">greeter</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">spawn</span> <span class="n">system</span> <span class="s2">&quot;Greeter&quot;</span>
</span><span class='line'>    <span class="o">&lt;|</span> <span class="k">fun</span> <span class="n">mailbox</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span><span class="bp">()</span> <span class="o">=</span> <span class="n">actor</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">let</span><span class="o">!</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Receive</span><span class="bp">()</span>
</span><span class='line'>            <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
</span><span class='line'>            <span class="o">|</span> <span class="nc">Greet</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s2">&quot;Hello %s&quot;</span> <span class="n">name</span>
</span><span class='line'>            <span class="o">|</span> <span class="nc">Hi</span>         <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s2">&quot;Hi&quot;</span>
</span><span class='line'>            <span class="k">return</span><span class="o">!</span> <span class="n">loop</span><span class="bp">()</span> <span class="o">}</span>
</span><span class='line'>        <span class="n">loop</span><span class="bp">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">greeter</span> <span class="o">&lt;!</span> <span class="nc">Greet</span> <span class="s2">&quot;Alex&quot;</span>
</span><span class='line'><span class="n">greeter</span> <span class="o">&lt;!</span> <span class="nc">Hi</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here are some explanations:</p>

<ul>
<li>We defined a discriminated union of messages <code>ActorMsg</code>, we want to respond to.</li>
<li>The next step is to create an <code>ActorSystem</code>, analogously to C# and original Scala versions.</li>
<li>We need to define and instantiate an <code>Actor</code>. However unlike the object approach &ndash; which required a custom actor type inheriting from one of the Akka actor classes and defining it&rsquo;s own receiving method &ndash; here we define a tail recursive function, which uses an <code>actor { ... }</code> computation expression instead of actor type declaration.</li>
<li>We pass that function through the lambda to <code>spawn</code> method, which attaches that behavior to our system and returns an <code>ActorRef</code> (not to be confused with Actor instance), assigned to our <code>greeter</code> variable. This way we may refer to actors, and pass messages to them, even if they&rsquo;re not present on our local machine (which is also one of the Akka use cases).</li>
<li>Last two lines are about sending messages to actor references using send operator <code>&lt;!</code>.</li>
</ul>


<p>As you can see, this piece of code is not directly translatable to C# or even Scala API equivalent. It&rsquo;s much more Erlangish. We don&rsquo;t have to define any classes and method overrides. Instead, we have a tail-recursive function. For me this seems more natural approach for F#, since it&rsquo;s more functional-first language, while it&rsquo;s syntax for object oriented programming is very verbose and ugly.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-07-03T00:05:00+02:00" data-updated="true" itemprop="datePublished">Jul 3<span>rd</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/fsharp/'>fsharp</a>, <a class='category' href='/blog/categories/programming-languages/'>programming languages</a>


</div>
		
			<span class="comments"><a href="/blog/2014/07/03/fsharp-and-scala-absent-values/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/07/03/fsharp-and-scala-absent-values/" itemprop="url">Value Absence - Why Scala/F# Approach Is Bad?</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Handling an absent values is one of the most common problems in programming languages. Why we consider this so important? It&rsquo;s because data processing is essential task of every program ever made. And one of the main reasons of systems errors and undefined behaviors are values not present in the system. Most of the modern programming languages tries to aim programmers with solution to handle those cases. Lets look at the most common way of dealing with them:</p>

<ol>
<li><strong>Null pointer reference</strong> &ndash; also called a &ldquo;billion-dollar mistake&rdquo;, introduced by Tony Hoare. It allows to represent an absence of the heap allocated values (objects) in form of pointer referring to not a valid instance of represented type. In most of the mainstream programming languages all heap objects are nullable by default &ndash; no matter if you want it or not.</li>
<li><strong>Option/Maybe type</strong> &ndash; this approach is characteristic for most of the functional languages. Instead of creating null pointer, it defines a special generic type (eg. Option), represented by either one of it&rsquo;s subtypes (Some as wrapper for existing underlying value, or None if value is not present).</li>
</ol>


<p>So why we consider a dedicated Option type a better solution? Because it&rsquo;s explicit, propagates type information about value nullability and &ndash; most of all &ndash; it&rsquo;s non-default. By the most of the time, we expect to have a meaningful references to our data. Their absence is not a desired and certainly should not be an expected behavior. Problem in nullable references is that literally any instance in our code could represent a non-existing value. Analogously to functional approach, all of our objects always represent an Option type.</p>

<p>Currently, after decades on living in shadows, functional paradigm is gaining more and more ground of the field of mainstream programming languages. This also reflects in two of the most popular programming environments, JVM and .NET. Their functional representatives, Scala and F#, claims to combine best of both programming paradigms. This way they also introduced and popularized an Option types among object oriented approach.</p>

<p>But something has been missed along the way, and (in my opinion) both Scala and F# had failed in face of the problem of value absence. Why? Because of their dualism. Since they are functional languages, both of them allows you to create an Option types with full support expected from a functional language. But while they also are object oriented and built on top of object oriented VMs, they allow you to use and create a nullable references. This leads to false sense of security, when using Option types. Lets look at the following example (F#):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">value</span><span class="o">:</span> <span class="nc">String</span> <span class="n">option</span> <span class="o">=</span> <span class="nc">Some</span> <span class="n">doSmthAndReturnString</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>How can you be sure that function <code>doSmthAndReturnString</code> won&rsquo;t return a null? Actually you can&rsquo;t until you perform an explicit null check. From the runtime perspective <code>Some null</code> is a perfectly valid record. Does it sound rational? No. So why is this even possible?</p>

<h2>How to combine functional and object oriented worlds?</h2>

<p>From my perspective, the best solution of that problem came with <a href="http://ceylon-lang.org/">Ceylon</a> language. It&rsquo;s based on the concept of <a href="http://ceylon-lang.org/documentation/1.0/tour/types/#union_types">Union Types</a>, one of the key features of Ceylon. For <strong>tl;dr</strong> people &ndash; union type of <code>X|Y</code> is a supertype of both types <code>X</code> and <code>Y</code>. How does it correspond to null/options?</p>

<p>In Ceylon <code>null</code> have it&rsquo;s own unique type <code>Null</code> (just like in Scala). By default all reference types are non-nullable (similarly to functional languages). However they may be nulled if referenced as union type of <code>T|Null</code> (or <code>T?</code> using some syntax suggar). This concept is basically &ndash; however not entirely &ndash; equivalent of Scala <code>Either[T,Null]</code> but without verbose requirement for object wrapping. Moreover, Ceylon compiler is able to optimize this away to standard JVM null references, without any overhead.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="c1">// Scala - Either</span>
</span><span class='line'><span class="n">var</span> <span class="n">m</span><span class="o">:</span> <span class="nc">Either</span><span class="o">[</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Null</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Left</span><span class="o">(</span><span class="s2">&quot;hello&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">var</span> <span class="n">n</span><span class="o">:</span> <span class="nc">Either</span><span class="o">[</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Null</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Right</span><span class="o">(</span><span class="k">null</span><span class="o">)</span>
</span><span class='line'><span class="n">var</span> <span class="n">m</span><span class="o">:</span> <span class="nc">Either</span><span class="o">[</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Null</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Left</span><span class="o">(</span><span class="k">null</span><span class="o">)</span>    <span class="c1">// still valid</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Scala - Option type</span>
</span><span class='line'><span class="n">var</span> <span class="n">m</span><span class="o">:</span> <span class="nc">Option</span><span class="o">[</span><span class="nc">String</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Some</span><span class="o">(</span><span class="s2">&quot;hello&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">var</span> <span class="n">n</span><span class="o">:</span> <span class="nc">Option</span><span class="o">[</span><span class="nc">String</span><span class="o">]</span> <span class="o">=</span> <span class="nc">None</span>
</span><span class='line'><span class="n">var</span> <span class="n">m</span><span class="o">:</span> <span class="nc">Option</span><span class="o">[</span><span class="nc">String</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Some</span><span class="o">(</span><span class="k">null</span><span class="o">)</span>         <span class="c1">// still valid</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Ceylon</span>
</span><span class='line'><span class="nc">String</span><span class="o">|</span><span class="nc">Null</span> <span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="o">;</span>    <span class="c1">// no need for value wrapping</span>
</span><span class='line'><span class="nc">String</span><span class="o">?</span> <span class="n">n</span> <span class="o">=</span> <span class="k">null</span><span class="o">;</span>          <span class="c1">// Integer? -&gt; Integer|Null</span>
</span><span class='line'><span class="nc">String</span> <span class="n">f</span> <span class="o">=</span> <span class="k">null</span><span class="o">;</span>          <span class="c1">// compile time error, references are not nullable by default</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see on the example above, this way we combined advantages of safe, explicitly nullable types with verbosity and performance of null referenced types. In my opinion this is a proper, yet still not widespread, solution of one of the most common problem in languages theory.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-03-24T22:43:00+01:00" data-updated="true" itemprop="datePublished">Mar 24<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/dot-net/'>.net</a>


</div>
		
			<span class="comments"><a href="/blog/2014/03/24/things-you-may-not-know-about-csharp-value-types/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/03/24/things-you-may-not-know-about-csharp-value-types/" itemprop="url">Things You May Not Know About CSharp Value Types</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>In this post I&rsquo;ll try to deal with few of the myths lying beneath common understanding of how C# structures works in reality. Many of new .NET acolytes are thought about differences between structs and classes. For easier understanding many of those concepts are simplified and therefore doesn&rsquo;t necessary tell all truth about underlying mechanism.</p>

<p>Here are some of them.</p>

<h1>Structs may not be stack allocated</h1>

<p>Think about following example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">struct</span> <span class="nc">MyStruct</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">X</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">Example1</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">a</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyStruct</span> <span class="p">{</span> <span class="n">X</span> <span class="p">=</span> <span class="m">3</span> <span class="p">};</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">X</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">++</span><span class="n">a</span><span class="p">.</span><span class="n">X</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you remember, one of the well known side effects of stack-allocated values is that they&rsquo;re destroyed automatically, when we leave scope, where they were created. This remains true in .NET environment &ndash; it assures that no more but one value or pointer may be found on top of the stack when returning from method execution.</p>

<p>But what happens, when we execute <code>Example1</code> method and then call lambda returned? <code>a</code> variable as stack allocated structure, should be already destroyed at that moment (it&rsquo;s out of it&rsquo;s creation scope and has not been returned explicitly). But that&rsquo;s not what really happens. Actually .NET environment performs an <strong>escape analysis</strong> to determine if any references to that structure didn&rsquo;t leave it&rsquo;s scope. In that case it would be rather heap allocated in order to prevent premature destruction.</p>

<p>Other known case, when structs become heap allocated values, are allocations of large amounts of memory dedicated to handle values. Since stack memory is very limited (by default it&rsquo;s about 1MB per thread on Windows OS), massive structure allocations would potentially cause a StackOverflowException. What .NET environment does in that case, is fallback to safer heap-based allocations.</p>

<p><em>NOTE</em>: Unfortunatelly at the present moment C# doesn&rsquo;t provide escape analysis to determine if class instances could be stack allocated. Java, even though hasn&rsquo;t got custom value types yet, can provide that feature for specific conditions.</p>

<h1>Struct and class method calls differs significantly</h1>

<p>Next exercise. Think about two types, struct and a class. Both of them have non-static method with identical signature and implementation. When you create instances of both types and call mentioned methods, which call will be faster? If you&rsquo;d thought, that struct method call will be slightly faster, you&rsquo;re right. But why?</p>

<p>Answer lies in low level difference between CIL instructions <code>call</code> and <code>callvirt</code>. Standard class methods use <code>callvirt</code> (name is misleading &ndash; it&rsquo;s used even for non-virtual methods). Since CLR cannot absolutely guarantee, if instance method is overridden or shadowed, it has to perform explicit check by seeking class VTable for function pointer. Actual VTable pointer is one of the internal members of each object. Therefore it requires null check to be performed.</p>

<p>Since struct cannot be null, we don&rsquo;t have to perform null checking. However it&rsquo;s not necessary. Since value types cannot declare or override virtual methods &ndash; struct have fixed inheritance chain &ndash; we don&rsquo;t have to access their VTables. Actually lack of inheritance is so useful, that structure instances don&rsquo;t need to have any pointers to VTable at all. All of these save time necessary to perform a method call.</p>

<p>From that perspective struct method calls are much closer to static methods &ndash; also invoked through <code>call</code> instruction &ndash; than instantiated ones.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-02-20T22:47:00+01:00" data-updated="true" itemprop="datePublished">Feb 20<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/javascript/'>javascript</a>


</div>
		
			<span class="comments"><a href="/blog/2014/02/20/more-thoughts-on-knockout/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/02/20/more-thoughts-on-knockout/" itemprop="url">More Thoughts on Knockout.js and JavaScript MVVM</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Today I want to share with my reflections on using <a href="http://knockoutjs.com/">Knockout.js</a> and client side MVVM pattern. Some of them refer to my previous post on the same <a href="/blog/2013/03/09/knockoutjs-spostrzezenia/">topic</a> (in Polish language). These are my advices to all entusiasts of JavaScipt rich applications, especially to those, who want to try Knockout in production environment.</p>

<h1>Layered structure</h1>

<p>Most of the frontent application logic, I&rsquo;ve got an occasion to look into, was pretty messy. Simple web pages usually are build of chunks of JavaScript code used to bound existing libraries and perform simple logic tasks. Everything is coupled, any kind of logic and DOM manipulations are mixed together. This is the place, where unicorns live and magic happens. But if you&rsquo;re into rich client side applications and frameworks such as Knockout.js, this is not an option. Why?</p>

<p>Knockout.js, AngularJS, Backbone and other MV* frameworks are dedicated to create a web applications. This literaly means, that your client page is an application rather than an ordinary page, rendered only to display the data. There will be probably a <strong>lot</strong> of code and logic bound to HTML on the page. If you will manage your code in unstructurized manner, you&rsquo;ll soon find yourself in spot, where any further changes will the a depressing, time-consuming nightmare.</p>

<p>To be able to manage a large chunks of code, you will need to decouple your JavaScript logic into layers. Beacuse Knockout doesn&rsquo;t provide any application layers off hand, responsibility of creating them lies on you. In rest of the post bellow I want to share my personal experiences developed during many months spent of using Knockout in production environment. Layers described by me can be exactly mapped onto specific patterns/groups of patterns and are described from top to bottom, beginning from layer used for server communication, through data management, HTML page partitioning to core used to bound everything together.</p>

<h2>Gateway</h2>

<p>The main goal of the Gateway object is to abstract server API to look like an ordinary JavaScript function. We would like to call the service in form of <code>usersApi.getUserById(1)</code> rather than cryptic <code>$.post(''api/users', { id: 1 })</code>. In my opinion this is more natural and gives us an easier way for further refactoring. What else can gateways do?</p>

<p>First of all, they should be able to hide necessity of resolution parametrized URLs from view models. They should be able to resolve them or have some helpers attached (think about eqivalent of UrlHelpers, path methods etc.).</p>

<p>In most of the cases I&rsquo;ve met, server communication is done by traditional ajax requests through jQuery ajax or similar calls. Since those functions always returns jQuery promises as a result, you may find that this is not what you want. Maybe you need a more detailed informations or a custom wrapper around promises. Or if you use <a href="https://github.com/Reactive-Extensions/RxJS">RxJS</a>, you probably may want <code>Rx.Observable</code> objects. For all of these cases Gateway is good place to implement.</p>

<p>Gateways could be also used to perform mapping of JSON into fully qualified JavaScript objects you may want to use. This includes things like serializing/deserializing dates, adding additional computed properties, adding/removing recursive dependencies or even changing entire structure of object to beter fit our needs. From Knockout point of view, we can wrap/unwrap objects into ko.observables directly at this layer.</p>

<p>When your data manipulation and mapping logic become more and more complex, consider using a dedicated Factory/Mapper objects to maintain code decoupling.</p>

<h2>Data source</h2>

<p>Data sources (or Data Access Objects) are alternatives to gateways, since they serve similar purpose, but provide much more complex mechanisms. When we speak about data represented on the page, we&rsquo;ll probably see problems associated with incomplete data representation on client side. Paginated tables, autocomplete suggestions, calendar pages, infinite scrolls etc. When used with remote source, all of these use server side requests to get data to be shown to end users. But on large data volumes we never retrieve all of the informations, instead using only those records, which need te be displayed. One of the roles of data sources is to store and manage data received this way, so the next time user goes back to previously displayed page or gets subset of records already provided, we may restore it from the local cache rather than repeating request to the server.</p>

<p>If you want to see a possible ways to implement this pattern, I would recommend you to look at some of the existing implementations, like:</p>

<ul>
<li><a href="https://github.com/twitter/typeahead.js/blob/master/doc/bloodhound.md">Bloodhound</a> suggestion engine for Twitter&rsquo;s <a href="http://twitter.github.io/typeahead.js/">typeahead.js</a> library</li>
<li>Kendo UI <a href="http://docs.telerik.com/kendo-ui/api/framework/datasource">DataSource</a> prototype</li>
<li><a href="http://www.breezejs.com/">Breeze.js</a> framework</li>
<li><a href="http://pouchdb.com/">PouchDB</a>, which is actually full in-browser database with remote sync option</li>
</ul>


<p>All of them provide interesting point of view of what separated data source managers are capable to.</p>

<p>Among other advantages of data source separation we could mention sharing of common data between view models, which should not reference too each other directly, but also managing data objects lifecycle. Fetching data from the server, and synchronizing changes made localy by the client could be done easily this way.</p>

<p>When it comes to data objects, I&rsquo;ve noticed that for purposes of data manipulation on the client side it&rsquo;s nice to have some kind of universal identifiers to manipulate enities. Those identifiers should uniquely identify single entity among all others on the page &ndash; this means, that database identifiers from the JSON object representing server side entities may not be sufficient, since in many cases the records id&rsquo;s (at least when we speak about relational databases with non-UUID primary keys) are guaranted to be unique only in single table/collection scope.</p>

<p>In my case good solution of this problem seems to be an additional object property &ndash; lets call it <code>$id</code> &ndash; which serves only client side logic (server may ignore that value) and it&rsquo;s combination of unique identifier of the entity type and single entity identifier. Since it&rsquo;s called the same among all data objects in client side application, no matter of their type, we may also definie universal comparison operators and function for fetching and data integration. To do so it&rsquo;s also necessary that <code>$id</code> has to be generated in deterministic way &ndash; no matter how many times we create a JavaScript representation of the same database record, it should allways have the same <code>$id</code> value.</p>

<h2>Partial View Models</h2>

<p>Partial view models are used to separate model-view binding in domains of interests. Instead of unorganized bindings of all observed properties to single God Object, remember to use smaller pieces which actually fits a concrete parts of your page &ndash; menus, navbars, forms, modal windows etc.</p>

<p>Don&rsquo;t ever mix a multiple view models in scope of single view component. The only exception from that rule is when you need to manipulate current view model in it&rsquo;s parent context, but even in that case you shouldn&rsquo;t access higher than direct parrent of current VM. If you do, that usually means, something is wrong.</p>

<p>Avoid referencing between view models, especially when they share the same hierarchy level. View models should be an independent units of work. They don&rsquo;t need to know details of other view models to perform requested operations. Use Knockout contexts or dedicated objects as an inter-communication layer and share them between view models, when some message passing is needed.</p>

<p>Don&rsquo;t create large nested objects inside view models. Inject them through constructors instead. Knockout view models lifetime is much longer than AngularJS controllers, but it&rsquo;s still a better solution to share large objects and &ndash; if they come with a lot of logic &ndash; to decouple them from view model. This also includes objects used to communicate with external world.</p>

<h2>Application root</h2>

<p>Since Knockout allows you to use only one View Model as root for whole page, my advice is to create dedicated view model, which won&rsquo;t be used with any visible parts of the page itself. It&rsquo;s role is to serve as a container for actual view models used to display data on the page and to provide universal features to be used by everyone. For me this option remains true even for small ingerention of Knockout logic into the page, because in the world of changing requirements formally small pages may grow rapidly in very short amount of time.</p>

<p>When comes to integration of partial view models and application root, usually it&rsquo;s sufficient to create <strong>all</strong> partial VMs on root level. View models can be nested in large tree structures, but don&rsquo;t overuse this feature. Try to keep your view models dependency scopes as flat as you can. Application root is a good point to handle inner components creation and lifecycle. That also means, it should be able to access and provide all objects &ndash; gateways, data sources, factories, event buses, AJAX handlers etc. &ndash; directly to view models.</p>

<h2>Appendix: Events and Pub/Sub pattern</h2>

<p>There are few more things I wish to present in this post. One of them is a Publish/Subscribe pattern and event processing. It isn&rsquo;t bound to any specific layer since all of them can get advantage of using it. I also found it the best way of dealing with communication between various Knockout view models.</p>

<p>Below I will show one of the simplest implementation used to handling custom events. If you want to be able to use more advanced techniques, you probably want to look for some dedicated libraries such as <a href="https://github.com/Reactive-Extensions/RxJS">RxJS</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">EventStream</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span> <span class="o">=</span> <span class="p">{};</span>    <span class="c1">// this could be made private</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// subscribe to channel</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">$on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channelName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">callback</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">){</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">[</span><span class="nx">channelName</span><span class="p">];</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">channel</span><span class="p">)</span>
</span><span class='line'>              <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">[</span><span class="nx">channelName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>          <span class="nx">channel</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// unsubscribe from channel</span>
</span><span class='line'>  <span class="c1">// this is tricky since anonymous functions, once subscribed cannot be removed</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">$off</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channelName</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">[</span><span class="nx">channelName</span><span class="p">],</span> <span class="nx">i</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nx">channel</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">callback</span><span class="p">))</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
</span><span class='line'>          <span class="nx">channel</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">channel</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
</span><span class='line'>              <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">[</span><span class="nx">channelName</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// publish an event</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">$trigger</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channelName</span><span class="p">,</span> <span class="nx">event</span><span class="p">){</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_channels</span><span class="p">[</span><span class="nx">channelName</span><span class="p">];</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span>
</span><span class='line'>          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>              <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>                  <span class="nx">channel</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">event</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
</span><span class='line'>                  <span class="c1">// an error occurred in subscriber function</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since we have whole event pub/sub feature in one separate prototype, we can now implement it in any object we wish, either through composition or as a mixin. Additionaly we can use globaly shared instances of <code>EventStream</code> in similar fashion we use an event buses. For Knockout applications there is also an alternative in form of <a href="https://github.com/rniemeyer/knockout-postbox">knockout-postbox</a>.</p>

<h1>Final thoughs</h1>

<p>I want to end with a few short advices:</p>

<ul>
<li>All of my observations are based on observations of using Knockout and MVVM in non-SPA paradigm. As I&rsquo;ve said in previous posts, I wouldn&rsquo;t recommend Knockout for creating single page applications, because there are a lot of alternative frameworks, which suits better for this purpose.</li>
<li><a href="https://github.com/Knockout-Contrib/Knockout-Validation">Knockout-validation</a> library &ndash; I&rsquo;ve found it pain in the ass almost everytime, I&rsquo;ve needed to create anything more complex than basic, flat structure validation. There are a lots of problems when it comes to nested objects validation, nullable objects and dealing with validation results caches &ndash; which btw. cannot be accessed via library API. So if you are determined to use it, consider yourself warned.</li>
<li>Use unit tests any time you can. This not only will allow you to catch more potential errors (which are more likely to exist in language such as JavaScript) but are also a nice way to check if your code blocks are properly separated. And better prepare yourself, because client side logic tests are much more difficult to write than their backend cousins.</li>
<li>Create a common prefix for properties used as helper fields and methods, but not directly responsible for view model page manipulations. I&rsquo;ve already shown examples such as <code>$id</code> field and event stream methods with <code>$</code> prefix. I&rsquo;ve found them quite usefull, but I don&rsquo;t want refer to them from view <code>data-bind</code> attributes or server side. They should remain transparent for both of these.</li>
<li>I didn&rsquo;t mention about any kind of Service layer, used for performin business logic. The reason is simple &ndash; unless you&rsquo;re creating SPA with offline editing capabilities, due to reliability and security reasons you probably never wan&rsquo;t to inject a business logic into frontend.</li>
</ul>


<p>And last but not least. There are no universal rules. Form your own point of view, appropriate to your problems.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-02-02T15:29:00+01:00" data-updated="true" itemprop="datePublished">Feb 2<span>nd</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/programming-languages/'>programming languages</a>


</div>
		
			<span class="comments"><a href="/blog/2014/02/02/uncommon-static-type-feats/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/02/02/uncommon-static-type-feats/" itemprop="url">Top Features Every Statically Typed Language Should Have</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>In this post I want to focus on features of statically typed languages which I consider interesting and usefull, but still uncommon and rare among most popular ones in dev environment. First of all, lets try to answer the question: why static typing? We need to realize, what advantages of static typing do we embrace, so we can look for further improvements.</p>

<ol>
<li>Performance &ndash; of course this is first notable difference. Since static typing gives a compiler much more informations about generated program, we have both much heavier optimizations that could be done at compile time and less need of type checking at runtime.</li>
<li>Better tooling &ndash; if our compiler can reason more about our code, so do other tools we use in application development.</li>
<li>Program correctness &ndash; we don&rsquo;t have to be constantly aware of all application functionalities. Because we have expert system in the form of a compiler, we can maintain larger code bases.</li>
</ol>


<p>In scope of this post I want to notice possible features, which may enhance both programmer productivity, application logic correctness and overal code design.</p>

<h2>Type unions and intersections</h2>

<p>Languages: <a href="http://ceylon-lang.org/">Ceylon</a></p>

<p>This feature gives us a profit of union and intersection operations as we know them in set theory, and apply them to types in our language. Type and set theories are very closely related, and they both can benefit with many of common theorems (for example: roots of Hindley-Milner type inference lies in set theory).</p>

<p>Type unions seems to be more natural way to represent some relations, than inheritance. Example: think about type, which could represent all numbers, lets call it <code>Number</code>. From type theory it looks like the best fit would be (literally) union of integer and floating point numbers, which give us a representiation of most of the domain. If this isn&rsquo;t sufficient, it&rsquo;s even easier to extend our Number type with union of more than two types. Now try to do it only by using inheritance or composition&hellip;</p>

<p>Type unions allows us to do the most important thing, most of the non-functional languages do wrong &ndash; proper null handling. In Ceylon <code>Null</code> have it&rsquo;s own type (however it&rsquo;s optimized away during compilation) and is subject to all mentioned rules. All reference variables and field are non-nullable by default &ndash; thanks to unions this behavior could be changed by using notation <code>T|Null</code> or it&rsquo;s simplified form <code>T?</code> for variable type declaration. It&rsquo;s actually a good thing, since this is what we expect from variables in our code for 90% of the time. So why we have to code in continous risk of null exceptions (unless we perform explicit checking), if we may tell compiler to ensure that for us before our code even run? On the other hand, there are a nullable value types, which are also quite usefull at some times. Many languages allow us to use some kind of built-in nullable wrappers, sorrounded with specific compiler magic for programmer convinience (eg. C#). But in my opinion this is not the right way of doing things. If compiler is allowed to use some nice tricks, then we as the programmers also should be able to do so.</p>

<h2>Type constraints / Value dependent types</h2>

<p>Languages: Ada, Eiffel, (experimentally through extensions) all ML-familly languages including Haskell, F*, <a href="http://www.idris-lang.org/">Idris</a></p>

<p>Since we already have a unions and intersections, it would be nice to allow other operations to be performed directly on types. What about conditions?</p>

<p>Lets say I&rsquo;ve got an <code>int</code> type, so I could verify at compile time, that all of the necessary values are restricted to be integers. Ok. Lets go further. What if I want to narrow those integers to omit negative numbers? Actually this is still easy in most of the languages (Java, you have one job&hellip;), since they already have some kind of <code>unsigned int</code> type. But what when I want to go a step further: I want to ensure that my integers are only positive numbers, that means they&rsquo;re neither negatives nor 0. It should be easy, but it&rsquo;s not. Almost all of the languages fail at that moment, requiring programmer to manually check that condition through code at runtime. And this is where type constraints comes to play.</p>

<p>They allow programmer to define specific constraints on values, they refer to. Let me precise this on some pseudocode examples:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>type Positive = x:int where x &gt; 0
</span><span class='line'>type Even = x:int where x % 2 == 0
</span><span class='line'>type IPv4 = x:unsigned byte[] where x.Length == 4</span></code></pre></td></tr></table></div></figure>


<p>So why I consider this nice and usefull? Some languages (eg. C/C++, Go) already offers fixed length arrays, while equivalent the example <code>Even</code> type could be created as specialized class? First of all it&rsquo;s easier, since you have one way to solve multiple problems. It also could be implemented fast (think about implementing and working with custom Even class in language such as Java), which makes it more likely to be used in real life. Next, it&rsquo;s all available at compiler level, when you can actually verify your code before running it and allow compiler for further optimizations. They also could be potentialy empovered when used with type set-like operations described in previous paragraph. And finally refinement types could also be used for implementing Design by Contract principles in your code, which by itself is a nice feature.</p>

<h2>Implicit interfaces</h2>

<p>Languages: <a href="http://golang.org/">Go</a>, <a href="http://www.typescriptlang.org/">TypeScript</a></p>

<p>This one is quite controversial, especially when compared to previously mentioned features. There are many programmers considering implicit interfaces as potentially unsafe, for example by weakening type safety in static typing by creating risk of accidential interface implementation. There are many examples provided to support this thesis, but actually I found most of them is result of bad design decision and broken conventions, or simply explicit interfaces are not solution to presented problems either.</p>

<p>So in what cases implicit interfaces could be usefull:</p>

<ol>
<li>Just like in case of monkey patching it&rsquo;s a way to provide additional features to existing types, that we have no access to. This may be especially usefull to patching holes in stdlib implementations (no matter how hard you try, you never foresee all of them). Example: lack of IParseable interface in .NET common lib.</li>
<li>It makes easier to work with various external libs, minimazing need of constructing adapters to bypass incompatibilities.</li>
<li>It also makes very simple to create mocks.</li>
</ol>


<p>They also encourage some good practices when working with interfaces. Since they&rsquo;re implicit, you will naturally try to keep them as simple and decoupled as possible. It&rsquo;s easy to maintain implementation of interface having dozens of methods, when they are explicit, it&rsquo;s harder to do so in implicit way. And since the purpose of interface is to abstract and describe contract between parts of your application, interfaces with numerous methods are often symphoms of a God Objects in your code. On the other hand it&rsquo;s easier to create a class implementing dozens of interfaces, when they&rsquo;re implicit rather than explicit. This also promotes decoupling.</p>

<h2>Great absent</h2>

<p>Actually I didn&rsquo;t mentioned some of most core features, which benefit all statically typed languages, such as types as first-class citizens, type inference or language macros/templates. The reason of this is, that those thing are well known and more or less present in many of the popular languages we have today. My goal was to describe some potential advantages of powerfull, yet less known features we may see with hope they would be more often met and used in the future.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-01-12T23:03:00+01:00" data-updated="true" itemprop="datePublished">Jan 12<span>th</span>, 2014</time></div>
		<div class="tags">

</div>
		
			<span class="comments"><a href="/blog/2014/01/12/przenosiny/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/01/12/przenosiny/" itemprop="url">Przenosiny</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Od ostatniego posta mino troch czasu, byo to jednak zwizane z ambitnymi zmianami jakie od dawna planowaem wobec bloga. <a href="http://horusiath.blogspot.com">Mj poprzedni blog</a> naprawd dawa si ju we znaki, gwnie przez rozronity i archaiczny silnik, ktry sprawia naprawd sporo kopotw kiedy przychodzio do odrobiny bardziej zaawansowanej konfiguracji.</p>

<p>Chciaem zamieni swojego bloga w co prostego w obsudze, a jednoczenie dajcego moliwoci sporej personalizacji. Po drodze szukaem rnych rozwiza. W praktyce wziem pod uwag 3 z nich:</p>

<ol>
<li>Wordpress &ndash; ta opcja odpada relatywnie szybko, z podobnych przyczyn dla jakich nie lubiem bloggera. Dodatkowym argumentem byy znalezione w Internecie opinie innych programistw, ktrzy okrelali WP jako silnik zbyt rozdmuchany wzgldem swoich nowszych konkurentw.</li>
<li><a href="https://ghost.org/">Ghost</a> &ndash; pocztkowo by to do powany kandydat. Projekt ufundowany przez Kickstarter, w momencie kiedy zwrciem na niego swoj uwag, dobija wanie wersji 0.3.3. Oparty o platform node.js, z do aktywn spoecznoci jak na tak mode rodowisko, gotowym forum dla szukajcych pomocy oraz kilkoma drobniejszymi smaczkami, jak chociaby obsug Markdown jako domylnego formatu pisania postw &ndash; ktrego to i tak uywam przy codziennym pisaniu dokumentw. Niestety we znaki daa si zna jego niedojao, zwaszcza w momencie, gdy musiaem wykorzysta inne ni domylna kompozycje, dorzuci kilka wasnych skryptw, czy postawi cao na <a href="https://www.heroku.com/">heroku</a> (bo wanie takiego hosta zamierzaem uy). Ostatecznie uznaem, e nie potrzebuj wbudowanego edytora z funkcj life preview i do tej pory nie rozumiem dlaczego silnik blogowy &ndash; ktry mona w uproszeniu sprowadzi do generatora statycznych stron WWW &ndash; wymaga obowizkowej bazy danych.</li>
<li><a href="http://octopress.org/">Octopress</a> &ndash; mj ostateczny wybr pad na chyba najprostsz dostpn opcj na rynku. Statyczny generator stron, z domyln obsug formatowania dokumentw w markdown, wietnym wbudowanym kolorowaniem pisowni skryptw, oraz moliwoci update&#8217;w bezporednio z Gita. Do tego hosting bezporednio przez <a href="http://pages.github.com/">Github Pages</a>, bez adnych specjalnych ceremonii, tak jakby byo to dowolne inne repozytorium. adnych baz danych, uwierzytelniania dla strony obsugiwanej przez 1 osob, czy wbudowanych edytorw. Po prostu KISS ;)</li>
</ol>


<h2>Co dalej?</h2>

<p>Postanowiem, e wraz z pozostaymi zmianami zmieni nieco sam ide bloga. O ile przeniosem wikszo starych wpisw, o tyle <strong>chciaem aby wszystkie kolejne posty byy umieszczane po angielsku</strong>. Jest to decyzja ze wzgldw praktycznych &ndash; wikszo programistw (w tym ja), kiedy napotyka jaki problem, nie traci czasu na informacji w polskiej blogosferze, zamiast tego od razu sigajc do anglojzycznych rde. Dodatkowo jest to dla mnie pewnego rodzaju wyzwanie oraz szansa na popracowanie nad jzykiem. Co do pozostaych problemw (statystyki, komentarze, itp.), wiele rzeczy wci czeka na dokoczenie i moe min nieco czasu, eby postawi wszystko na nogi.</p>

<p>Podsumowujc, witam na moim odwieonym blogu w nowej formule.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-10-20T09:49:00+02:00" data-updated="true" itemprop="datePublished">Oct 20<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/dot-net/'>.net</a>, <a class='category' href='/blog/categories/asp/'>asp</a>, <a class='category' href='/blog/categories/programowanie/'>programowanie</a>, <a class='category' href='/blog/categories/wzorce-projektowe/'>wzorce projektowe</a>


</div>
		
			<span class="comments"><a href="/blog/2013/10/20/o-pomykach-i-wnioskach-z-pracy-w-aspnet/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/10/20/o-pomykach-i-wnioskach-z-pracy-w-aspnet/" itemprop="url">O Pomykach I Wnioskach Z Pracy W ASP.NET MVC</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>O wzorcach projektowych w ASP.NET MVC sysza chyba kady. Wikszo z nas przynajmniej raz widziaa jaki filmik instruktaowy bd wideokonferencj promujc stosowanie waciwych wzorcw na tej platformie. Jednake po opanowaniu teorii przychodzi wreszcie pora na to, aby wcieli j w ycie. Co si wtedy okazuje? Bardzo czsto wychodzi na jaw, e zastosowanie poznanych praktyk w prawdziwym yciu sprawia problem, a kolejne miesice programowania w myl jakiej metodyki prowadz do ostatecznej refleksji bdcej zgub programistw: <em>zrobi cokolwiek byle zadziaao</em>.</p>

<p>W tym pocie sprbuj opisa najczstsze bdy, z ktrymi przyszo mi si zmierzy &ndash; rwnie te wynikajce z ogranicze technologii, ale przede wszystkim bdce skutkiem niewaciwego podejcia do problemu.</p>

<h2>Twoja encja  Twj model</h2>

<p>Zasadniczym bdem (lub raczej skrtem mylowym) jest zaoenie, e kada klasa mapowana przez ORM na tabele moe suy jako model przekazywany bezporednio do widoku. Nie znaczy to, e jest to nie moliwe, jednak opcja ta jest z reguy naduywana. Wynika to poniekd ze stylu programowania wyuczonego z tutoriali z cyklu &ldquo;wyklep CRUDa w 5 min.&rdquo;. Pikne i proste, jednak nie majce wiele wsplnego z problemami dnia codziennego. Z drugiej strony jest to wina samego lenistwa programistw oraz przewiadczenia, e faza projektowania z rozpisk architektury chociaby na kartce papieru jest tylko dla kobiet i leszczy ;)</p>

<p>Pytanie brzmi: kiedy naleaoby porzuci modelowanie z encji na rzecz dedykowanych klas POCO? Prawda jest taka, e zaley to od przypadku i wymaga odrobiny dowiadczenia.</p>

<ul>
<li>Jedn z podpowiedzi moe by poziom zagbienia zalenoci. Im jest on gbszy, tym bardziej wykorzystywana przez nas klasa odbiega struktur od modelu wymaganego przez widok. Przykadowo ju 2 poziom zagbienia np. <code>Model.Products.SelectMany(p => p.Orders)</code> moe wiadczy o tym, e dana encja nie jest waciwym kandydatem i powinna zosta zmapowana na dedykowan do tego celu klas.</li>
<li>Innym przykadem moe by sytuacja, w ktrej nasz model wykazuje pewien zwizek z reguami biznesowymi. Przykadowo czstym sposobem reprezentacji okresu czasu powizanego z danym obiektem jest dodanie do modelu dwch pl okrelajcych granice czasowe. W tym momencie pojawia si jednak pewien dysonans midzy definicj biznesow (okres czasu jest pojedynczym obiektem) a rzeczywist implementacj (okres czasu to dwa generyczne pola dat). Jeeli logika biznesowa silnie bazuje na danej definicji np. przedzia czasowy czsto pojawia si w kontekcie wykonywanych operacji, wtedy moliwe, e lepiej byoby wyodrbni j do osobnej klasy.</li>
<li>Jak powszechnie wiadomo, we wspczesnym wiecie aplikacji WWW wymagania klientw s jednymi z najbardziej zmiennych elementw systemu. Moliwo oddzielenia modeli od encji wspiera ten trend, poniewa o ile encje s powizane ze schematem bazy danych (przez co s znacznie mniej podatne na zmiany ze wzgldu na konieczno utrzymania spjnoci z istniejcymi danymi), o tyle modele wykorzystywane przez nas w aplikacji mog by swobodnie modelowane do naszych potrzeb.</li>
</ul>


<h2>Twj ViewData = Twj Model</h2>

<p>W przypadku niektrych frameworkw model jest zdefiniowany w sposb jasny i jednoznaczny. W przypadku ASP.NET MVC nie jest jednak tak atwo, poniewa otrzymujemy tutaj wicej ni jeden sposb dostarczenia danych do widoku. Mowa tu oczywicie o ViewData. Wg. mnie obiekt ten, jakkolwiek przydatny, jest podstawowym zamaniem wzorca MVC w ASP.NET MVC. Dlaczego? Poniewa &nbsp;prawda wyglda tak, e niezalenie od zdefiniowanych przez ciebie klas, prawdziwy model ma zawsze tylko jeden typ: <a href="http://msdn.microsoft.com/en-us/library/system.web.mvc.viewdatadictionary(v=vs.108">ViewDataDictionary</a>.aspx).</p>

<p>Czy to le? Niekoniecznie, zaley od przyjtego podejcia. Co z tego wynika? W przypadku modeli zwracanych przez formularze zazwyczaj przyjmuje si, e generyczny model powinien zawiera tylko te dane, ktre zostay wprowadzone przez uytkownika. Tzn. e informacje takie jak opcja wybrana przez uytkownika z listy powinna by czci modelu podczas gdy sama lista dostpnych opcji powinna by przekazywana za porednictwem ViewBag/ViewData. Naturalnie w przypadku, gdy parsujemy model do postaci JSON przekazywanej do klienta, ta zasada nie dotyczy.</p>

<h2>Nic nie znaczce Error Messages</h2>

<p>Jednymi ze gorszych chwil w yciu programisty, s sytuacje, kiedy trzeba obsuy zgoszenie o bdzie w aplikacji. Zdarza si, e zagldamy wtedy do logw (o ile tak informacj zalogowalimy ;) ), aby odnale jakie przydatne informacje, ktre pozwol nam zidentyfikowa natur problemu. Jake wielkie jest rozczarowanie, gdy jedynym hintem jaki wtedy otrzymujemy jest: <code>Object reference not set to an instance of an object.</code> Bardzo rzeczowa i jednoznaczna informacja wrd kilkuset linii kodu wymagajcych zbadania.</p>

<p>Innym cikim przypadkiem jest logowanie niewystarczajcej iloci informacji. Przykad (blok try-catch jest czysto pogldowy):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">try</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">product</span> <span class="p">=</span> <span class="n">productRepository</span><span class="p">.</span><span class="n">GetById</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="n">Status</span> <span class="p">!=</span> <span class="n">ProductStatus</span><span class="p">.</span><span class="n">Finished</span><span class="p">)</span>
</span><span class='line'>      <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidStatusException</span><span class="p">(</span><span class="s">&quot;Provided product has invalid status&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">logger</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Co jest zego w tym przypadku? Wyobramy sobie, e dostajemy zgoszenienie, o bdzie a w logach jedyn informacj jest: <code>Provided product has invalid status</code>. Czy wiemy o jakim statusie mowa? Czy wiemy o jaki produkt chodzi? Nie mamy adnych informacji pozwalajcych zidentyfikowa dany przypadek, mimo e wszystko co potrzebne mamy 2 linijki wyej w kodzie rdowym naszej aplikacji.</p>

<p>Std mj apel: nie bd leniwcem, minuta pracy teraz pozwoli ci zaoszczdzi godziny problemw pniej.</p>

<h2>Too thin controllers, too fat services</h2>

<p><em>Fat models, thin controllers</em> jest zwrotem czsto uywanym w wiecie MVC. Czsto jednak wynikiem utrzymania tej reguy jest zjawisko, ktre sam okrelam jako papierowe kontrolery. Wemy na przykad nastpujc akcj MVC:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[HttpPost]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">ToggleUserBan</span><span class="p">(</span><span class="kt">bool</span> <span class="n">activate</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="n">userService</span><span class="p">.</span><span class="n">ToggleUserBan</span><span class="p">(</span><span class="n">activate</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Na czym polega bd? Prawdopodobnie metoda ToggleUserBan w serwisie jest przypadkiem zbyt szczegowym. Daje to podstawy do przypuszczenia, e architektura aplikacji w ktrym momencie si posypaa. Zajrzyjmy wic do naszego hipotetycznego IUserService:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">interface</span> <span class="n">IUserService</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">ToggleUserBan</span><span class="p">(</span><span class="kt">bool</span> <span class="n">flag</span><span class="p">);</span>
</span><span class='line'>  <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">GetAllUsers</span><span class="p">();</span>
</span><span class='line'>  <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">GetActiveUsers</span><span class="p">();</span>
</span><span class='line'>  <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">GetBannedUsers</span><span class="p">();</span>
</span><span class='line'>  <span class="c1">// ...kolejne 70 metod</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Jeeli widzisz taki interfejs, wiedz e co si dzieje. To z czym mamy do czynienia to nic innego, jak zwyke zamiatanie brudu pod dywan. Pseudorozwizanie polegajce na przeniesieniu proceduralnego makaronu w miejsce, w ktre rzadziej si zaglda. Jest to czsty rezultat braku rewizji kodu i testw jednostkowych, oraz samowoli programistw.</p>

<h2>Gar innych porad</h2>

<ul>
<li>unikaj static classes &ndash; utrudniaj one modularyzacj systemu i wprowadzaj twarde powizania, z ktrych bardzo ciko jest potem zrezygnowa. Extension methods s w zasadzie jedynym zastosowaniem dla statycznych klas, dla jakich sam znajduj uytek.</li>
<li>unikaj partial classes &ndash; dopuszczalne tylko w wypadku, gdy rozszerzasz klas generowan przez zewntrzne narzdzia (co swoj drog samo w sobie jest zym pomysem ale o tym moe kiedy indziej ;) )</li>
<li>w przypadku zmiennych uywaj nazw, ktre pozwalaj okreli ich typ i przeznaczenie &ndash; rnego rodzaju skrty oszczdzaj dosownie kilka sekund podczas pisania tylko po to, aby w przyszoci przeduy rozszyfrowywanie kodu przez kogo innego o kilka minut. Pamitaj, e w yciu programisty kod czyta si czciej ni pisze.</li>
<li>podczas zwracania kolekcji zwracaj najmniejszy interface, ktry umoliwia wykonanie zadania &ndash; nie ma sensu wymaga aby argument by list, jeeli jedynym wykonywanym na nim dziaaniem jest foreach</li>
<li>jeeli zwracasz string lub kolekcje nigdy nie zwracaj nulli &ndash; zawsze uywaj string.Empty lub Enumerable.Empty&lt;></li>
<li>nie sprawdzaj czy enumerator jest pusty przy pomocy Count() &ndash; uywaj Any(). W przypadkach kiedy potrzebujesz porwna ilo argumentw w enumeratorze z konkretn liczb np. list.Count() > 3, warto zastanowi si nad uyciem wzorca <a href="http://twistedoakstudios.com/blog/Post4425_counting-iterators-lazily">LazyCounter</a></li>
</ul>


		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2014

    Bartosz Sypytkowski


Design based on: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
</body>
</html>
