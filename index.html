
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Simple Solutions</title>
	<meta name="author" content="Bartosz Sypytkowski">

	
	<meta name="description" content="Mar 8th, 2015 design patterns Comments Design Patterns: Circuit Breaker Today I want to introduce a CircuitBreaker &ndash; one of the reactive &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="Simple Solutions" type="application/atom+xml">
	
	<link rel="canonical" href="http://bartoszsypytkowski.com/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	

<script type="text/javascript">
      var disqus_shortname = 'bartoszsypytkowski';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-47294845-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><h1 id="profile-name"><a href="/">Bartosz Sypytkowski</a></h1>
<div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("b.sypytkowski@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:b.sypytkowski@gmail.com" title="Email">Email</a>
		
		
		
			<a class="google" href="https://plus.google.com/b.sypytkowski@gmail.com" rel="author" title="Google+">Google+</a>
		
		
			<a class="twitter" href="http://twitter.com/horusiath" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/horusiath" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-03-08T16:08:00+01:00" data-updated="true" itemprop="datePublished">Mar 8<span>th</span>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/design-patterns/'>design patterns</a>


</div>
		
			<span class="comments"><a href="/blog/2015/03/08/circuit-breaker/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/03/08/circuit-breaker/" itemprop="url">Design Patterns: Circuit Breaker</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Today I want to introduce a <code>CircuitBreaker</code> &ndash; one of the reactive design patterns, especially usefull in areas such as web services interop. To get you better understand on it&rsquo;s concepts, lets consider following scenario:</p>

<blockquote><p>You&rsquo;ve built a successful web service, making use of another external services in order to handle user requests. During the big churn of end users requesting your site, one of them became overloaded, starting to respond with increasing delays. Ultimately while trying to satisfy all incomming requests, it has exhausted all resources and gone down, entailing your service with it.</p></blockquote>

<p>I think it&rsquo;s a well-known example and a good one to show a nature of the problem. Because of RPC nature, it&rsquo;s characteristics differ from in-proc calls:</p>

<ul>
<li>They operate on separate resources pool and might be used by more than one remote caller at the time.</li>
<li>Their internal state, available resources and performance may be hard to predict. In most cases, they neither can be controlled nor monitored by the caller.</li>
<li>Their life cycle is not bound to your local host. They may be reset/shut down while your service is still running and serving requests.</li>
</ul>


<p>What reactive applications have to do with that? One of the key principles governing the <a href="http://www.reactivemanifesto.org/#responsive">Reactive Manifesto</a> stands for quick responsiveness of the system, no matter if this response is possitive or not. Nowadays users are impatient. When they take action, they want a response, and they want it now.</p>

<p>This is when Circuit Breakers kicks in. They main role is to act as a decorator around your code to ensure, that you can quickly respond on any reliability problems:</p>

<ul>
<li>First, Circuit Breaker defines a safe time delay given to the action to respond. Service which won&rsquo;t fit specified timeout is considered to be unresponsive or working incorrectly. It&rsquo;s better to inform your user about possible problems after a reasonable delay than to show him/her a smoke screen and spinner for the next 2 minutes.</li>
<li>Secondly it&rsquo;s able to cut out the service in any sign of problems and give it a time to self repair. If you already know, that external service is not working properly, what is the point of calling it any way?</li>
</ul>


<p>Most of the circuit breaker are realized as a state machines. Picture below presents a simple one:</p>

<p><img src="http://i57.tinypic.com/wrj3ft.png" width=600 style="display: block; margin-left: auto; margin-right: auto" /></p>

<p>where:</p>

<ul>
<li><strong>Closed</strong> &ndash; this is initial state. While closed, Circuit Breaker will simply pass any request to underlying function. However it also checks if response will met a specified timeout criteria or ended with failure i.e. due to external service overload or crash. Any of these will trigger Circuit Breaker to come into open state.</li>
<li><strong>Open</strong> &ndash; while in this state, any request send through Circuit Breaker will follow <em>fail fast</em> semantic. Instead of forwarding request to the underlying function, CB will immediately throw an exception informing that it&rsquo;s closed. Open state is not permanent &ndash; CB should automatically switch to half-open state after a specified time delay.</li>
<li><strong>HalfOpen</strong> &ndash; this is a kind of the probing state, signing that CB is checking if undrelying function is responsive again. While in it, CB will pass first request call as if it was in <em>Closed</em> state, to eventually get the response. All subsequent calls will fail fast just like in <em>Open</em> state. If request failed again or response didn&rsquo;t came in specified timeout, CB switches back to <em>Open</em> state. If response was successful, CB becomes <em>Closed</em>.</li>
</ul>


<p>I&rsquo;ve created a simplistic implementation of the CircruitBreaker pattern in C# (<a href="https://gist.github.com/Horusiath/a3236c61ed2da8b17a25">source code</a>). It allows to perform multiple asynchronous calls through one CB instance in non-blocking, thread-safe manner. It has also attached a complete test suite describing it&rsquo;s behavior. Feel free to use it and to modify as you wish.</p>

<p>Example usage:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// this service could be a singleton, and could be called concurrently</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">CurrencyExchangeProxy</span> <span class="p">:</span> <span class="n">ICurrencyExchangeProxy</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">CircuitBreaker</span><span class="p">&lt;</span><span class="n">ExchangeCurrencies</span><span class="p">,</span> <span class="n">ExchangeRate</span><span class="p">&gt;</span> <span class="n">exchangeRates</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">CurrencyExchangeProxy</span><span class="p">(</span><span class="n">Configuration</span> <span class="n">config</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">exchangeRates</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CircuitBreaker</span><span class="p">&lt;</span><span class="n">ExchangeCurrencies</span><span class="p">,</span> <span class="n">ExchangeRate</span><span class="p">&gt;(</span>
</span><span class='line'>          <span class="k">async</span> <span class="n">req</span> <span class="p">=&gt;</span> <span class="n">HttpGetAsync</span><span class="p">&lt;</span><span class="n">ExchangeRate</span><span class="p">&gt;(</span><span class="n">config</span><span class="p">.</span><span class="n">ExchangeServiceUrl</span><span class="p">,</span> <span class="n">req</span><span class="p">),</span>    <span class="c1">// async function, CB should take care of</span>
</span><span class='line'>          <span class="n">config</span><span class="p">.</span><span class="n">GetServiceTimeout</span><span class="p">(),</span>         <span class="c1">// time given to function to finish</span>
</span><span class='line'>          <span class="n">config</span><span class="p">.</span><span class="n">OpenTimeout</span><span class="p">());</span>              <span class="c1">// time given to function dependent component to restore in case of failure</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ExchangeRate</span><span class="p">&gt;</span> <span class="n">GetExchangeRate</span><span class="p">(</span><span class="n">Currency</span> <span class="k">from</span><span class="p">,</span> <span class="n">Currency</span> <span class="n">to</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">await</span> <span class="n">exchangeRates</span><span class="p">.</span><span class="n">Call</span><span class="p">(</span><span class="k">new</span> <span class="n">ExchangeCurrencies</span><span class="p">(</span><span class="k">from</span><span class="p">,</span> <span class="n">to</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">InvoiceController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">ICurrencyExchangeProxy</span> <span class="n">currencyExchange</span><span class="p">;</span>
</span><span class='line'><span class="na"> </span>
</span><span class='line'><span class="na"> [HandleError(ExceptionType=typeof(CircuitBreakerOpenException), View=&quot;UnresponsiveExternalService&quot;)]</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionView</span><span class="p">&gt;</span> <span class="n">DisplayInvoice</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="p">...</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">exchangeRate</span> <span class="p">=</span> <span class="k">await</span> <span class="n">currencyExchange</span><span class="p">.</span><span class="n">GetExchangeRate</span><span class="p">(</span><span class="n">invoice</span><span class="p">.</span><span class="n">Balance</span><span class="p">.</span><span class="n">Currency</span><span class="p">,</span> <span class="n">localization</span><span class="p">.</span><span class="n">Currency</span><span class="p">);</span>
</span><span class='line'>      <span class="p">...</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-02-23T00:13:00+01:00" data-updated="true" itemprop="datePublished">Feb 23<span>rd</span>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/dot-net/'>.net</a>, <a class='category' href='/blog/categories/design-patterns/'>design patterns</a>


</div>
		
			<span class="comments"><a href="/blog/2015/02/23/functional-csharp/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/02/23/functional-csharp/" itemprop="url">[C#] a Different Look at Service Design</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Today I want to present a different point of view on C# applications design. If you are programming in that language most of the time, it&rsquo;s probably not what you&rsquo;re used to see. However I found it interesting, because it allows to achieve a few important goals:</p>

<ul>
<li>Decompose various, complex interfaces into few simpler, well build components.</li>
<li>Seriously reduce risk of common OO anti-patterns in your application i.e. <a href="http://en.wikipedia.org/wiki/God_object">God Object</a>.</li>
<li>Make your code shorter and methods simpler.</li>
<li>Replace a lot of external assembly dependencies in your code with some simple design patterns.</li>
</ul>


<p>If you&rsquo;re ready, prepare to step down to the Wonderland. Let the Catepillar be our guide.</p>

<h3>The basics</h3>

<h4>Step 1 &ndash; define an interface</h4>

<p>Lets start with twisting our mindsets a little bit. Take the following example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IAuthService</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Task</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">SignUp</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">,</span> <span class="kt">string</span> <span class="n">password</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Task</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">SignIn</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">,</span> <span class="kt">string</span> <span class="n">password</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Task</span> <span class="nf">ResetPassword</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is our new trendy-looking, non-blocking service interface. What&rsquo;s also important here, it follows a <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibility Principle</a>.</p>

<h4>Step 2 &ndash; separate responsibilities</h4>

<p>Since SRP has no well-defined bounds and it is a matter of a personal taste, we could stretch it a little further:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">ISignInService</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Task</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">Handle</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">,</span> <span class="kt">string</span> <span class="n">password</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">ISingUpService</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Task</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">Handle</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">,</span> <span class="kt">string</span> <span class="n">password</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IResetPasswordService</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Task</span> <span class="nf">Handle</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now instead of one service responsible for three possible operations, we have a three atomic services, each one having only one operation to take care off. If you&rsquo;re thinking, it&rsquo;s overly complicated, you&rsquo;re probably right. But right now we&rsquo;re still in Objective Oriented world and the Wonderland awaits ahead.</p>

<h4>Step 3 &ndash; more simplification</h4>

<p>Now, when we have a three single-member services, take a look into the mirror. If you do, you&rsquo;ll notice an important characteristic &ndash; interface with single method is almost indistinguishable from a delegate. It looks better now, see?:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">delegate</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">SignUpService</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">,</span> <span class="kt">string</span> <span class="n">password</span><span class="p">);</span>
</span><span class='line'><span class="k">public</span> <span class="k">delegate</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">SignInService</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">,</span> <span class="kt">string</span> <span class="n">password</span><span class="p">);</span>
</span><span class='line'><span class="k">public</span> <span class="k">delegate</span> <span class="n">Task</span> <span class="nf">ResetPasswordService</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point you may want to turn back. This design is problematic. For example, it isn&rsquo;t as easily composable with Dependency Injection frameworks as interfaces. Don&rsquo;t worry. We will cover this up later. Now step in.</p>

<h4>Step 4 &ndash; final generalization</h4>

<p>Our service signatures are now almost ready. But to reach behind the mirror, we must apply two more rules:</p>

<ul>
<li>Each service takes no more than one parameter.</li>
<li>Each service should always return a value.</li>
</ul>


<p>Why does it matter? If each service will satisfy one input / one output rule, we may compose them together with ease.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">delegate</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">SignUpService</span><span class="p">(</span><span class="n">SignUpRequest</span> <span class="n">request</span><span class="p">);</span>
</span><span class='line'><span class="k">public</span> <span class="k">delegate</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">SignInService</span><span class="p">(</span><span class="n">SignInRequest</span> <span class="n">request</span><span class="p">);</span>
</span><span class='line'><span class="k">public</span> <span class="k">delegate</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">ResetPasswordService</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, all of our delegates could be abstracted away to a single generic definition:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">delegate</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TRep</span><span class="p">&gt;</span> <span class="n">Service</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">TReq</span><span class="p">,</span> <span class="n">TRep</span><span class="p">&gt;(</span><span class="n">TReq</span> <span class="n">request</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>where:</p>

<ul>
<li><code>TReq</code> is type of request object passed to service.</li>
<li><code>TRep</code> is type of service reply.</li>
</ul>


<p>What we end up with is a highly abstracted &ndash; in Wonderland things looks different &ndash; and universal service signature.</p>

<h3>Dependency Injection vs partial application</h3>

<p>Walking down the object oriented road, often you could passed a view similar to this one:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">TransportationService</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILocalizationService</span> <span class="n">_localizationService</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IOrdersRepository</span> <span class="n">_ordersRepository</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">ICustomersRepository</span> <span class="n">_customersRepository</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IConfigurationProvider</span> <span class="n">_configuration</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="nf">TransportationService</span> <span class="p">(</span>
</span><span class='line'>      <span class="n">ILocalizationService</span> <span class="n">localizationService</span><span class="p">,</span>
</span><span class='line'>      <span class="n">IOrdersRepository</span> <span class="n">ordersRepository</span><span class="p">,</span>
</span><span class='line'>      <span class="n">ICustomersRepository</span> <span class="n">customersRepository</span><span class="p">,</span>
</span><span class='line'>      <span class="n">IConfigurationProvider</span> <span class="n">configuration</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">_localizationService</span> <span class="p">=</span> <span class="n">localizationService</span><span class="p">;</span>
</span><span class='line'>      <span class="n">_ordersRepository</span> <span class="p">=</span> <span class="n">ordersRepository</span><span class="p">;</span>
</span><span class='line'>      <span class="n">_customersRepository</span> <span class="p">=</span> <span class="n">customersRepository</span><span class="p">;</span>
</span><span class='line'>      <span class="n">_configuration</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TransportationDetails</span><span class="p">&gt;</span> <span class="n">PrepareTransportation</span><span class="p">(</span><span class="kt">int</span> <span class="n">orderId</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="p">...</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>But now when you&rsquo;re on the other side of the mirror, it looks more like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">TransportationServices</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="n">Service</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">TransportationDetails</span><span class="p">&gt;</span> <span class="n">PrepareTransportationService</span> <span class="p">(</span>
</span><span class='line'>      <span class="n">ILocalizationService</span> <span class="n">localizationService</span><span class="p">,</span>
</span><span class='line'>      <span class="n">IOrdersRepository</span> <span class="n">ordersRepository</span><span class="p">,</span>
</span><span class='line'>      <span class="n">ICustomersRepository</span> <span class="n">customersRepository</span><span class="p">,</span>
</span><span class='line'>      <span class="n">IConfigurationProvider</span> <span class="n">configuration</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">async</span> <span class="n">orderId</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">};</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we simply return an asynchronous lambda. And because it&rsquo;s nested inside, it can use all of the provided parameters directly in it&rsquo;s scope.</p>

<p>Of course, there is still a matter of lifetime scopes. In case of singleton scopes, we simply may pass shared instance directly. But when more universal lifetimes are required, we can slide down the road along with the delegates to reach even higher abstractions &ndash; it&rsquo;s twisted, but we&rsquo;re in Wonderland, remember?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">Service</span><span class="p">&lt;</span><span class="n">LocalizationRequest</span><span class="p">,</span> <span class="n">LocalizationReply</span><span class="p">&gt;</span> <span class="n">LocalizationService</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">Service</span><span class="p">&lt;</span><span class="n">MyRequest</span><span class="p">,</span> <span class="n">MyReply</span><span class="p">&gt;</span> <span class="n">MyService</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Service</span><span class="p">&lt;</span><span class="n">LocalizationRequest</span><span class="p">,</span> <span class="n">LocalizationReply</span><span class="p">&gt;&gt;</span> <span class="n">localizationServiceProvider</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// transient scope</span>
</span><span class='line'><span class="kt">var</span> <span class="n">myService</span> <span class="p">=</span> <span class="n">MyService</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">LocalizationService</span><span class="p">());</span>
</span><span class='line'><span class="c1">// or even shorter</span>
</span><span class='line'><span class="kt">var</span> <span class="n">myService2</span> <span class="p">=</span> <span class="n">MyService</span><span class="p">(</span><span class="n">LocalizationService</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// singleton scope</span>
</span><span class='line'><span class="kt">var</span> <span class="n">localizator</span> <span class="p">=</span> <span class="n">LocalizationService</span><span class="p">();</span>
</span><span class='line'><span class="kt">var</span> <span class="n">myService</span> <span class="p">=</span> <span class="n">MyService</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">localizator</span><span class="p">);</span>
</span><span class='line'><span class="kt">var</span> <span class="n">myService2</span> <span class="p">=</span> <span class="n">MyService</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">localizator</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is a one simple but powerful idea visible on the example above &ndash; an input parameter type has been changed from interface to another delegate. Now it&rsquo;s delegates all the way down. This way we may start from the most atomic services and combine them into more complex ones without limitations.</p>

<p>Instead of complex, reflection-based DI frameworks we have one simple universal abstraction. You may find this more verbose, but it&rsquo;s actually simpler, faster and more error-proof solution than any of IoC libraries. You don&rsquo;t need to learn next DI framework or use StackOverflow guide to travel through the Wonderland.</p>

<p>There are other problems solved automatically:</p>

<ul>
<li>No need to worry about cyclic references.</li>
<li>There is no risk, that our DI framework won&rsquo;t know how to bind parameters to construct object. You&rsquo;ll never get a runtime errors when walking this way.</li>
<li>Your application won&rsquo;t inject bad interface implementation by mistake.</li>
</ul>


<h3>Repositories and testing</h3>

<p>Another popular OO desing pattern is a repository and it&rsquo;s most corrupted (and misunderstood) version &ndash; generic repository.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IGenericRepository</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Task</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">GetAll</span><span class="p">();</span>
</span><span class='line'>  <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetById</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Create</span><span class="p">(</span><span class="n">T</span> <span class="n">entity</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Update</span><span class="p">(</span><span class="n">T</span> <span class="n">entity</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">Delete</span><span class="p">(</span><span class="n">T</span> <span class="n">entity</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IUserRepository</span> <span class="p">:</span> <span class="n">IGenericRepository</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">Task</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">GetByEmail</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lets be honest &ndash; you&rsquo;ll probably never use all of those methods at once. If you think it&rsquo;s good abstraction, it&rsquo;s not. It isn&rsquo;t a good SRP example either. After we had stepped into the mirror, we&rsquo;ve surely taken something from our world with us. So lets take a one of the things we&rsquo;ve hidden in the pocket &ndash; changing user password.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">UserService</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IUserRepository</span> <span class="n">_userRepository</span><span class="p">;</span>
</span><span class='line'>  <span class="k">public</span> <span class="nf">UserService</span><span class="p">(</span><span class="n">IUserRepository</span> <span class="n">userRepository</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">_userRepository</span> <span class="p">=</span> <span class="n">userRepository</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">PasswordChanged</span><span class="p">&gt;</span> <span class="n">ChangePassword</span><span class="p">(</span><span class="n">ChangePassword</span> <span class="n">request</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">user</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_userRepository</span><span class="p">.</span><span class="n">FindByEmail</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Email</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">IsValid</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">OldPassword</span><span class="p">))</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">user</span><span class="p">.</span><span class="n">PasswordHash</span> <span class="p">=</span> <span class="n">ComputePasswordHash</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">NewPassword</span><span class="p">);</span>
</span><span class='line'>          <span class="k">await</span> <span class="nf">userUpdater</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">new</span> <span class="nf">PasswordChanged</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnauthorizedException</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">private</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">ComputePasswordHash</span><span class="p">(</span><span class="kt">string</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">private</span> <span class="kt">bool</span> <span class="nf">IsValid</span><span class="p">(</span><span class="n">User</span> <span class="n">user</span><span class="p">,</span> <span class="kt">string</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Basically changing password would require only two out of six methods provided by <code>IUserRepository</code> &ndash; matching user and saving his/her state after changing. Now smoke the Catepillar&rsquo;s hookah and take a look again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">Service</span><span class="p">&lt;</span><span class="n">ChangePassword</span><span class="p">,</span> <span class="n">PasswordChanged</span><span class="p">&gt;</span> <span class="n">ChangePasswordService</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">Service</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;&gt;</span> <span class="n">userFinderProvider</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Service</span><span class="p">&lt;</span><span class="n">User</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;&gt;</span> <span class="n">userUpdaterProvider</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">userFinder</span> <span class="p">=</span> <span class="n">userFinderProvider</span><span class="p">();</span>
</span><span class='line'>  <span class="kt">var</span> <span class="n">userUpdater</span> <span class="p">=</span> <span class="n">userUpdaterProvider</span><span class="p">();</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">return</span> <span class="k">async</span> <span class="n">request</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">var</span> <span class="n">user</span> <span class="p">=</span> <span class="k">await</span> <span class="n">userFinder</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Email</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">IsValid</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">OldPassword</span><span class="p">))</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">user</span><span class="p">.</span><span class="n">PasswordHash</span> <span class="p">=</span> <span class="n">ComputePasswordHash</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">NewPassword</span><span class="p">);</span>
</span><span class='line'>          <span class="k">await</span> <span class="nf">userUpdater</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">new</span> <span class="nf">PasswordChanged</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnauthorizedException</span><span class="p">();</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">ComputePasswordHash</span><span class="p">(</span><span class="kt">string</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsValid</span><span class="p">(</span><span class="n">User</span> <span class="n">user</span><span class="p">,</span> <span class="kt">string</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We totally dealt with repository interface, introducing two service providers presented before.</p>

<p>Hint:</p>

<blockquote><p>You can turn <code>ComputePasswordHash</code> (or even <code>IsValid</code>) into service on it&rsquo;s own. All hail the modularity!</p></blockquote>

<h4>From testing perspective &hellip;</h4>

<p>In traditional OO world, to test this feature, you&rsquo;d probably include some mocking library, mock repository&rsquo;s interface and check if correct method was called with correct arguments. You may also mock underlying database directly with something like <a href="http://effort.codeplex.com/">Effort</a>.</p>

<p>In Wonderland mocklibs are quite rare creatures. They are even harder to catch. We must find another way. Can we simply test it without <strong>any</strong> mocking library? Lets see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// Arrange:</span>
</span><span class='line'><span class="c1">// if you abstracted ComputePasswordHash earlier, it&#39;ll be easier at this point</span>
</span><span class='line'><span class="kt">var</span> <span class="n">testUser</span> <span class="p">=</span> <span class="k">new</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">passwordHash</span><span class="p">);</span>
</span><span class='line'><span class="kt">var</span> <span class="n">db</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;</span> <span class="p">{</span> <span class="p">{</span> <span class="n">testUser</span><span class="p">.</span><span class="n">Email</span><span class="p">,</span> <span class="n">testUser</span> <span class="p">}</span> <span class="p">};</span>
</span><span class='line'><span class="n">Service</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;</span> <span class="n">userFinder</span> <span class="p">=</span> <span class="k">async</span> <span class="n">email</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">User</span> <span class="n">user</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">db</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="k">out</span> <span class="n">user</span><span class="p">)</span> <span class="p">?</span> <span class="n">user</span> <span class="p">:</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="n">Service</span><span class="p">&lt;</span><span class="n">User</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;</span> <span class="n">userUpdater</span> <span class="p">=</span> <span class="k">async</span> <span class="n">user</span> <span class="p">=&gt;</span> <span class="n">user</span><span class="p">;</span>
</span><span class='line'><span class="kt">var</span> <span class="n">changePasswordService</span> <span class="p">=</span> <span class="n">ChangePasswordService</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">userFinder</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">userUpdater</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Act:</span>
</span><span class='line'><span class="k">await</span> <span class="nf">changePasswordService</span><span class="p">(</span><span class="k">new</span> <span class="n">ChangePassword</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">oldPassword</span><span class="p">,</span> <span class="n">newPassword</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Assert:</span>
</span><span class='line'><span class="n">Assert</span><span class="p">.</span><span class="n">NotEqual</span><span class="p">(</span><span class="n">passwordHash</span><span class="p">,</span> <span class="n">testUser</span><span class="p">.</span><span class="n">PasswordHash</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Actually, that&rsquo;s all. Including mock initialization and result verification. No mocklib was harmed in the making of this test.</p>

<h3>Aspect Oriented Programming vs lambda combinators</h3>

<p>If you&rsquo;re still interested in miracles of the Wonderland, we can go further. Next question: how can we bend reflection-based Aspect Oriented Programming to our will? There are possibly many ways, but I&rsquo;ll focus only on the one.</p>

<p>Just like we used services to replace all of our interfaces, we replace aspects / attributes with filters:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">delegate</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TOut</span><span class="p">&gt;</span> <span class="n">Filter</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">TIn</span><span class="p">,</span> <span class="n">TOut</span><span class="p">,</span> <span class="k">out</span> <span class="n">TReq</span><span class="p">,</span> <span class="n">TRep</span><span class="p">&gt;(</span><span class="n">TIn</span> <span class="n">request</span><span class="p">,</span> <span class="n">Service</span><span class="p">&lt;</span><span class="n">TReq</span><span class="p">,</span> <span class="n">TRep</span><span class="p">&gt;</span> <span class="n">service</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>where:</p>

<ul>
<li><code>TIn</code> is filter&rsquo;s input type.</li>
<li><code>TOut</code> is filter&rsquo;s output type.</li>
</ul>


<p>Filter is actually a wrapper around specific service, which may apply additional code before or after it, modify it&rsquo;s input or output or even decide not to call it at all. In case when filter don&rsquo;t change service&rsquo;s in / out parameters, it&rsquo;s signature is basically equal to <code>public delegate Task&lt;TRep&gt; Filter&lt;TReq, TRep&gt;(TReq request, Service&lt;TReq, TRep&gt; service);</code>.</p>

<p>Now, having those two types defines, lets create some utility methods, which can make our travel easier. Lets start with filter composer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">Filter</span><span class="p">&lt;</span><span class="n">TIn</span><span class="p">,</span> <span class="n">TOut</span><span class="p">,</span> <span class="n">TReq2</span><span class="p">,</span> <span class="n">TRep2</span><span class="p">&gt;</span> <span class="n">Then</span><span class="p">&lt;</span><span class="n">TIn</span><span class="p">,</span> <span class="n">TOut</span><span class="p">,</span> <span class="n">TReq1</span><span class="p">,</span> <span class="n">TRep1</span><span class="p">,</span> <span class="n">TReq2</span><span class="p">,</span> <span class="n">TRep2</span><span class="p">&gt;(</span>
</span><span class='line'>    <span class="k">this</span> <span class="n">Filter</span><span class="p">&lt;</span><span class="n">TIn</span><span class="p">,</span> <span class="n">TOut</span><span class="p">,</span> <span class="n">TReq1</span><span class="p">,</span> <span class="n">TRep1</span><span class="p">&gt;</span> <span class="n">self</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Filter</span><span class="p">&lt;</span><span class="n">TReq1</span><span class="p">,</span> <span class="n">TRep1</span><span class="p">,</span> <span class="n">TReq2</span><span class="p">,</span> <span class="n">TRep2</span><span class="p">&gt;</span> <span class="n">next</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">self</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">req</span> <span class="p">=&gt;</span> <span class="n">next</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">service</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we omit the method signature, this method is a pretty straightforward one liner which combines two filters together and gives another filter in return. As you can guess, with this trick we can join a whole chains of filters into one piece.</p>

<p>There is a second part of the puzzle missing. We still don&rsquo;t have a well defined methods to work with both filters and services. This is the one:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">Service</span><span class="p">&lt;</span><span class="n">TReqIn</span><span class="p">,</span> <span class="n">TRepOut</span><span class="p">&gt;</span> <span class="n">ApplyTo</span><span class="p">&lt;</span><span class="n">TReqIn</span><span class="p">,</span> <span class="n">TRepOut</span><span class="p">,</span> <span class="n">TReqOut</span><span class="p">,</span> <span class="n">TRepIn</span><span class="p">&gt;(</span>
</span><span class='line'>    <span class="k">this</span> <span class="n">Filter</span><span class="p">&lt;</span><span class="n">TReqIn</span><span class="p">,</span> <span class="n">TRepOut</span><span class="p">,</span> <span class="n">TReqOut</span><span class="p">,</span> <span class="n">TRepIn</span><span class="p">&gt;</span> <span class="n">filter</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Service</span><span class="p">&lt;</span><span class="n">TReqOut</span><span class="p">,</span> <span class="n">TRepIn</span><span class="p">&gt;</span> <span class="n">service</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">request</span> <span class="p">=&gt;</span> <span class="n">filter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just like we were combining filters, now we combine a filter with a service to get service in return.</p>

<p>With this two methods (and basically two lines of code!) we can easily interop between filters and services. How will this weapon examine against aspects?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// logging example</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">Filter</span><span class="p">&lt;</span><span class="n">TReq</span><span class="p">,</span> <span class="n">TRep</span><span class="p">,</span> <span class="n">TReq</span><span class="p">,</span> <span class="n">TRep</span><span class="p">&gt;</span> <span class="n">LogFilter</span><span class="p">&lt;</span><span class="n">TReq</span><span class="p">,</span> <span class="n">TRep</span><span class="p">&gt;(</span><span class="n">Action</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">async</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">logger</span><span class="p">(</span><span class="s">&quot;Log before: &quot;</span> <span class="p">+</span> <span class="n">request</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">reply</span> <span class="p">=</span> <span class="k">await</span> <span class="n">service</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span class='line'>        <span class="n">logger</span><span class="p">(</span><span class="s">&quot;Log after: &quot;</span> <span class="p">+</span> <span class="n">reply</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">reply</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// authorization example</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">Filter</span><span class="p">&lt;</span><span class="n">UnauthorizedRequest</span><span class="p">,</span> <span class="n">TReply</span><span class="p">,</span> <span class="n">AuthorizedRequest</span><span class="p">,</span> <span class="n">TReply</span><span class="p">&gt;</span> <span class="n">AuthorizeFilter</span><span class="p">&lt;</span><span class="n">TReply</span><span class="p">&gt;(</span>
</span><span class='line'>    <span class="n">Func</span><span class="p">&lt;</span><span class="n">Service</span><span class="p">&lt;</span><span class="n">UnauthorizedRequest</span><span class="p">,</span> <span class="n">Identity</span><span class="p">&gt;&gt;</span> <span class="n">authorizationServiceProvider</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">async</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">authService</span> <span class="p">=</span> <span class="n">authorizationServiceProvider</span><span class="p">();</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">authorizedIdentity</span> <span class="p">=</span> <span class="k">await</span> <span class="n">authService</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">authorizedIdentity</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">await</span> <span class="nf">service</span><span class="p">(</span><span class="k">new</span> <span class="n">AuthorizedRequest</span><span class="p">(</span><span class="n">authorizedIdentity</span><span class="p">,</span> <span class="n">request</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnauthorizedAccessException</span><span class="p">();</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// combine various filters together</span>
</span><span class='line'><span class="kt">var</span> <span class="n">filters</span> <span class="p">=</span> <span class="n">AuthorizeFilter</span><span class="p">(</span><span class="n">AuthorizationService</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Then</span><span class="p">(</span><span class="n">LogFilter</span><span class="p">(</span><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">))</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Then</span><span class="p">(</span><span class="n">MonitorFilter</span><span class="p">(</span><span class="n">MonitorService</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Then</span><span class="p">(</span><span class="n">UnitOfWorkFilter</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// apply all filters at once to the service</span>
</span><span class='line'><span class="kt">var</span> <span class="n">enchancedService</span> <span class="p">=</span> <span class="n">filters</span><span class="p">.</span><span class="n">ApplyTo</span><span class="p">(</span><span class="n">myService</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, thankfully to the power of composability we can join multiple filters into one and apply them to any number of services we wish to. Basically two simple types and two lines of code compiled upfront!</p>

<p>We ripped off (or seriously reduced) any runtime uncertainties, AOP, DI and mock libraries out of our code, as well as whole bunch of interfaces and abstraction layers. Did you enjoy the travel? Welcome in the Wonderland. Land of functional programming.</p>

<p><strong>PS</strong>: presented concept is heavily inspired by <a href="http://twitter.github.io/finagle/guide/">Finagle</a> library, originally written in Scala on a Twitter&rsquo;s purposes.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-12-14T13:43:00+01:00" data-updated="true" itemprop="datePublished">Dec 14<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/akka-dot-net/'>akka.net</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>


</div>
		
			<span class="comments"><a href="/blog/2014/12/14/fsharp-akka-remote-deploy/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/12/14/fsharp-akka-remote-deploy/" itemprop="url">Akka.NET Remote Deployment With F#</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Today I want to present how Akka.NET can be used to leverage distributed computing and discuss some of the changes in the latest F# package (Akka.FSharp 0.7.1). If you are not interested in explanation of how Akka.NET internals actually allow us to create distributed actor-based application, just skip the next part and dive directly into examples.</p>

<h3>How Akka.NET remote deployment works</h3>

<p>When a new actor should be created, it&rsquo;s actor system deployer have to figure out if deployment should occur on local machine or on the remote node. Second option requires a network connection to be established between local/remote nodes participating in the communication. To be able to do so, each participating node needs to know a localization of the others. In Akka, this is done by using actor paths.</p>

<p>Actor path allows us to identify actors in scope of their systems actor hierarhies as well as localize them over the network. There are two formats of actor paths, both of them uses standard URI convention:</p>

<ol>
<li>Local paths (eg. <code>akka://local-system/user/parent/child</code>) may be used to identify actors deployed (remotely or not) by our local actor system, we are referring to. In provided example actor path refers to actor with name <code>child</code>, which parent/supervisor actor is called <code>parent</code>, which resides under <code>user</code> guardian (which is a specialized actor supervisor existing inside actor system kernel). All of them exists in actor system named <code>local-system</code>.</li>
<li>Remote paths (eg. <code>akka.tcp://remote-system@localhost:9001/</code>) are similar to local ones, but a few differences occur. First we need to rename <code>akka</code> protocol to either <code>akka.tcp</code> or <code>akka.udp</code> to show what kind of underlying network connection we want to target. Second we have to suffix actor system name with it&rsquo;s localization. This is done by providing address and port, remote node is expected to listening on.</li>
</ol>


<p>Image below shows how actually actors refer to each other in remote deployment scenario.</p>

<p><img src="http://i61.tinypic.com/vpknkh.png" width=840 style="display: block; margin-left: auto; margin-right: auto" /></p>

<p>When an actor is deployed remotely, a remote node is responsible for creating it&rsquo;s instances, but we still refer to it using it&rsquo;s actor reference and our local system context. Local/remote coordination is done by remote daemon &ndash; specialized system actor, which resides directly under <code>/remote</code> path of the system root. With example above we may refer to remotely deployed child using <code>akka.tcp://sys@A:2552/user/parent/child</code> address, while it&rsquo;s true hierarchy lays under <code>akka.tcp://sys@B:2552/remote/sys@A:2552/user/parent/child</code> path. This allows us to preserve location transparency, hiding true underlying actor. References returned this way all almost indistinguishable from their local counterparts, allowing use of features such as monitoring, supervising and so on.</p>

<h3>Remote deployment</h3>

<h4>Hocon configuration</h4>

<p>To start playing with remote deployment, we should configure both endpoints to be able to maintain network communication. This is achievable through the <a href="https://github.com/typesafehub/config/blob/master/HOCON.md">HOCON</a> configuration, which is the default format for both JVM and .NET Akka implementations. While you may be a little irritated by need of learning new format only to use Akka, remember:</p>

<ol>
<li>It&rsquo;s actually very easy to learn</li>
<li>It&rsquo;s not XML ;)</li>
</ol>


<p>Before continue, I encourage you to get yourself familiar with it.</p>

<p>To enable remote deployment feature, this would be a minimal Akka.NET configuration setup:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>akka {  
</span><span class='line'>    actor {
</span><span class='line'>        provider = "Akka.Remote.RemoteActorRefProvider, Akka.Remote"
</span><span class='line'>    }
</span><span class='line'>    remote.helios.tcp {
</span><span class='line'>      port = 9001
</span><span class='line'>      hostname = localhost
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>First, every configuration node resides under common root called <code>akka</code>. Since remoting is not default feature of Akka.NET, we have to inform our actor system how to couple remotely deployed actors with our local actor system. This setup is done through <code>RemoteActorRefProvider</code> defined under <code>akka.actor.provider</code> config node. It will allow us to associate references to spawned actors on both local and remote systems.</p>

<p>Next one is <code>remote</code> node which defines configuration specific to remoting feature. There, we need to inform how our system will communicate with others. At the present moment it&rsquo;s achievable using <a href="https://github.com/Aaronontheweb/helios">Helios</a> server by default, which is lightweight and highly-concurrent TCP/UDP server developed by Aaron Stannard, one of the Akka.NET core developers &ndash; don&rsquo;t confuse it with Microsoft Helios, which is totally different project. Akka.Remote will use it automatically under the hood &ndash; the only thing we have to define is address and port, under which it will listen for incoming messages. If you want port to be resolved automatically, just set 0 as the port number.</p>

<p>Excluding differences in system nodes localization, this configuration string may be shared by both local and remote node. You may use this configuration simply by parsing it using <code>Configuration.parse</code> function.</p>

<h3>Let&rsquo;s get to the point</h3>

<p>Unlike the C#, F# API is able to construct actors using expressions compiled directly at the runtime (while still providing type safety, F# programmers are used to have). It&rsquo;s achievable by leveraging <a href="http://msdn.microsoft.com/en-us/library/dd233212.aspx">F# quotations</a>, which can be serialized and compiled on demand on other machine.</p>

<p>For the sample we don&rsquo;t need to have two separate machines, instead we may mock them by running two Akka applications. What is necessary for the most basic example, is that both of them have to share at least Akka.FSharp and Akka.Remote assemblies as well as all of their dependencies.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="n">install-package</span> <span class="n">Akka</span><span class="p">.</span><span class="n">FSharp</span> <span class="n">-version</span> <span class="n">0</span><span class="p">.</span><span class="n">7</span><span class="p">.</span><span class="n">1</span>
</span><span class='line'><span class="n">install-package</span> <span class="n">Akka</span><span class="p">.</span><span class="n">Remote</span> <span class="n">-version</span> <span class="n">0</span><span class="p">.</span><span class="n">7</span><span class="p">.</span><span class="n">1</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Remote node</h4>

<p>The only job of the remote system is to listen for incoming actor deployment requests and execute them. Therefore implementation is very simplistic:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">config</span> <span class="o">=</span>
</span><span class='line'>    <span class="nn">Configuration</span><span class="p">.</span><span class="n">parse</span>
</span><span class='line'>        <span class="o">@</span><span class="s2">&quot;akka {</span>
</span><span class='line'><span class="s2">            actor.provider = &quot;&quot;Akka.Remote.RemoteActorRefProvider, Akka.Remote&quot;&quot;</span>
</span><span class='line'><span class="s2">            remote.helios.tcp {</span>
</span><span class='line'><span class="s2">                hostname = localhost</span>
</span><span class='line'><span class="s2">                port = 9001</span>
</span><span class='line'><span class="s2">            }</span>
</span><span class='line'><span class="s2">        }&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="o">[&lt;</span><span class="nc">EntryPoint</span><span class="o">&gt;]</span>
</span><span class='line'><span class="k">let</span> <span class="n">main</span> <span class="n">args</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">use</span> <span class="n">system</span> <span class="o">=</span> <span class="nn">System</span><span class="p">.</span><span class="n">create</span> <span class="s2">&quot;remote-system&quot;</span> <span class="n">config</span>
</span><span class='line'>    <span class="nn">System</span><span class="p">.</span><span class="nn">Console</span><span class="p">.</span><span class="nc">ReadLine</span><span class="bp">()</span>
</span><span class='line'>    <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>After running it our remote system should be listening on localhost on port 9001 and be ready to instantiate remotely deployed actors.</p>

<h4>Local actor system instance</h4>

<p>Second application will be used for defining actors and sending deployment requests to remote node. To do so it has to know it&rsquo;s address.</p>

<p>To deploy our actors remotely, lets build some helper functions. To begin with, write some logic to inform our local system, that deployment should occur on the remote machine. Remember that we need to provide full address to the remote system including it&rsquo;s network localization and protocol type used for communication.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">open</span> <span class="nn">Akka</span><span class="p">.</span><span class="nc">Actor</span>
</span><span class='line'><span class="c1">// return Deploy instance able to operate in remote scope</span>
</span><span class='line'><span class="k">let</span> <span class="n">deployRemotely</span> <span class="n">address</span> <span class="o">=</span> <span class="nc">Deploy</span><span class="o">(</span><span class="nc">RemoteScope</span> <span class="o">(</span><span class="nn">Address</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">address</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remote deployment in Akka F# is done through <code>spawne</code> function and it requires deployed code to be wrapped into F# quotation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">spawnRemote</span> <span class="n">systemOrContext</span> <span class="n">remoteSystemAddress</span> <span class="n">actorName</span> <span class="n">expr</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">spawne</span> <span class="n">systemOrContext</span> <span class="n">actorName</span> <span class="n">expr</span> <span class="o">[</span><span class="nn">SpawnOption</span><span class="p">.</span><span class="nc">Deploy</span> <span class="o">(</span><span class="n">deployRemotely</span> <span class="n">remoteSystemAddress</span><span class="o">)]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Quotations give us a few nice features, but also have some limitations:</p>

<ol>
<li>Unlike the C# approach, here we don&rsquo;t define actors in shared libraries, which have to be bound to both endpoints. Actor logic is compiled in the runtime, while remote actor system is operating. That means, there is no need to stop your remote nodes to reload shared actor assemblies when updated.</li>
<li>Code embedded inside quotation must use only functions, types and variables known to both endpoints. There are limited ways to define functions inside quotation expression (and no way to define types), but generally speaking in most cases it&rsquo;s better to define them in separate library and share between nodes.</li>
</ol>


<p>Last line of the <code>spawne</code> function is list of options used to configure actor. We used <code>SpawnOption.Deploy</code> to specify what deployment specifics are meant to occur. Other options may describe specifics such as message mailboxes, actor routers or failure handling strategies.</p>

<p>Because Akka actor system is required to negotiate deployment specifics with external nodes, it&rsquo;s local instance has to be provided even thou we want to deploy our actors on the remote machines.</p>

<p>Finally when everything is set, we can run our example (remember that remote node must be up and running):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">system</span> <span class="o">=</span> <span class="nn">System</span><span class="p">.</span><span class="n">create</span> <span class="s2">&quot;local-system&quot;</span> <span class="n">config</span>
</span><span class='line'><span class="k">let</span> <span class="n">aref</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">spawnRemote</span> <span class="n">system</span> <span class="s2">&quot;akka.tcp://remote-system@localhost:9001/&quot;</span> <span class="s2">&quot;hello&quot;</span>
</span><span class='line'>      <span class="c1">// actorOf wraps custom handling function with message receiver logic</span>
</span><span class='line'>      <span class="o">&lt;@</span> <span class="n">actorOf</span> <span class="o">(</span><span class="k">fun</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s2">&quot;received &#39;%s&#39;&quot;</span> <span class="n">msg</span><span class="o">)</span> <span class="o">@&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// send example message to remotely deployed actor</span>
</span><span class='line'><span class="n">aref</span> <span class="o">&lt;!</span> <span class="s2">&quot;Hello world&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// thanks to location transparency, we can select </span>
</span><span class='line'><span class="c1">// remote actors as if they where existing on local node</span>
</span><span class='line'><span class="k">let</span> <span class="n">sref</span> <span class="o">=</span> <span class="n">select</span> <span class="s2">&quot;akka://local-system/user/hello&quot;</span> <span class="n">system</span>
</span><span class='line'><span class="n">sref</span> <span class="o">&lt;!</span> <span class="s2">&quot;Hello again&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// we can still create actors in local system context</span>
</span><span class='line'><span class="k">let</span> <span class="n">lref</span> <span class="o">=</span> <span class="n">spawn</span> <span class="n">system</span> <span class="s2">&quot;local&quot;</span> <span class="o">(</span><span class="n">actorOf</span> <span class="o">(</span><span class="k">fun</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s2">&quot;local &#39;%s&#39;&quot;</span> <span class="n">msg</span><span class="o">))</span>
</span><span class='line'><span class="c1">// this message should be printed in local application console</span>
</span><span class='line'><span class="n">lref</span> <span class="o">&lt;!</span> <span class="s2">&quot;Hello locally&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As a result, you should receive two messages printed in <strong>remote application console</strong> and one locally. See?</p>

<p><img src="http://www.reactiongifs.com/r/mgc.gif" style="display: block; margin-left: auto; margin-right: auto" /></p>

<h3>Final thoughts</h3>

<p>Remember that Akka.NET is still in beta and all of the F# API functions are subject to change. If you have some concepts or interesting ideas, or want to help and become part of the family, you may share them on <a href="https://groups.google.com/forum/?utm_medium=email&amp;utm_source=footer#!forum/akkadotnet-user-list">Akka.NET discussion group</a> or directly on <a href="https://github.com/akkadotnet/akka.net">Github</a>.</p>

<h3>Appendix A: set your configuration string in application config file</h3>

<p>While you may define configuration strings in code, the better idea is to actually store them in .config files. To be able to do so, we must simply extend configuration file with custom Akka config section:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;configSections&gt;</span>
</span><span class='line'>    <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">&quot;akka&quot;</span> <span class="na">type=</span><span class="s">&quot;Akka.Configuration.Hocon.AkkaConfigurationSection, Akka&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/configSections&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we can embed our Hocon-formated configuration string directly into configuration file by using <code>&lt;![CDATA[]]&gt;</code> marker (directly under main <code>&lt;configuration&gt;</code> root node):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;akka&gt;</span>
</span><span class='line'>    <span class="nt">&lt;hocon&gt;</span>
</span><span class='line'>      <span class="cp">&lt;![CDATA[</span>
</span><span class='line'><span class="cp">        ... paste your config string here</span>
</span><span class='line'><span class="cp">      ]]&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/hocon&gt;</span>
</span><span class='line'><span class="nt">&lt;/akka&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>To load the configuration, simply call <code>Akka.Configuration.ConfigurationFactory.Load()</code> method.</p>

<h3>Appendix B: Share-nothing</h3>

<p>Since keeping actual assemblies in sync over all of the remote nodes may feel cumbersome for some people, I decided to show a little trick, which may be used to replace some of the complex data structures in your F# code. Lets look how data structure problem may be simply solved in Akka predecessor, Erlang:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">go</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nv">Pid</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="nv">RemoteNode</span><span class="p">,</span> <span class="n">loop</span><span class="p">),</span>
</span><span class='line'>  <span class="nv">Pid</span> <span class="o">!</span> <span class="p">{</span><span class="n">hello</span><span class="p">,</span> <span class="s">&quot;world&quot;</span><span class="p">},</span>
</span><span class='line'>  <span class="nv">Pid</span> <span class="o">!</span> <span class="p">{</span><span class="n">hi</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">loop</span><span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="k">receive</span>
</span><span class='line'>      <span class="p">{</span><span class="n">hello</span><span class="p">,</span> <span class="nv">Msg</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="nn">io</span><span class="p">:</span><span class="nf">fwrite</span><span class="p">(</span><span class="s">&quot;hello </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Msg</span><span class="p">]),</span>
</span><span class='line'>          <span class="n">loop</span><span class="p">();</span>
</span><span class='line'>      <span class="p">{</span><span class="n">hi</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="nn">io</span><span class="p">:</span><span class="nf">fwrite</span><span class="p">(</span><span class="s">&quot;hi</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">),</span>
</span><span class='line'>          <span class="n">loop</span><span class="p">()</span>
</span><span class='line'>  <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>I think, that based on your knowledge about functional programming, most of it should be at least familiar if not self-explanatory. Crux is the <code>{hello, Msg}</code> and <code>{hi}</code> syntax &ndash; these are actually instances of tuples (nested into pattern matched message receiver construct). Standard Erlang convention precises them as so called tagged tuples, which first argument is an <strong>atom</strong> &ndash; also known as symbol in other languages. Since Erlang is a dynamic language, this way we may differentiate tuples of the same size from each other.</p>

<p>Example below shows how usage of the Erlang&rsquo;s tagged tuples could be moved into F#. The big difference is that F# has no Erlang <strong>atom</strong> equivalent. Therefore they has been replaced by F# literal integers, which gives us an advantage of human readable tags, while still counted as integers inside quotation expressions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="o">[&lt;</span><span class="nc">Literal</span><span class="o">&gt;]</span><span class="k">let</span> <span class="nc">Hello</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="o">[&lt;</span><span class="nc">Literal</span><span class="o">&gt;]</span><span class="k">let</span> <span class="nc">Hi</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">spawne</span> <span class="n">system</span> <span class="s2">&quot;remote&quot;</span> <span class="o">(&lt;@</span> <span class="k">fun</span> <span class="n">mailbox</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span><span class="bp">()</span> <span class="o">:</span> <span class="nc">Cont</span><span class="o">&lt;</span><span class="n">obj</span><span class="o">,</span> <span class="n">obj</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">actor</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">let</span><span class="o">!</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Receive</span><span class="bp">()</span>
</span><span class='line'>            <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
</span><span class='line'>            <span class="o">|</span> <span class="o">(</span><span class="nc">Hello</span><span class="o">,</span> <span class="n">str</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s2">&quot;hello %A&quot;</span> <span class="n">str</span>
</span><span class='line'>            <span class="o">|</span> <span class="o">(</span><span class="nc">Hi</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">print</span> <span class="s2">&quot;hi</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>            <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Unhandled</span><span class="bp">()</span>
</span><span class='line'>            <span class="k">return</span><span class="o">!</span> <span class="n">loop</span><span class="bp">()</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">loop</span><span class="bp">()</span> <span class="o">@&gt;)</span> <span class="o">[</span><span class="nn">SpawnOption</span><span class="p">.</span><span class="nc">Deploy</span> <span class="nc">Deploy</span><span class="o">(</span><span class="nc">RemoteScope</span><span class="o">(</span><span class="nn">Address</span><span class="p">.</span><span class="nc">Parse</span> <span class="n">remoteAddr</span><span class="o">))]</span>
</span><span class='line'>
</span><span class='line'><span class="n">pid</span> <span class="o">&lt;!</span> <span class="o">(</span><span class="nc">Hello</span><span class="o">,</span> <span class="s2">&quot;world&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">pid</span> <span class="o">&lt;!</span> <span class="o">(</span><span class="nc">Hi</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-10-26T22:54:00+01:00" data-updated="true" itemprop="datePublished">Oct 26<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/akka-dot-net/'>akka.net</a>, <a class='category' href='/blog/categories/ddd/'>ddd</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>


</div>
		
			<span class="comments"><a href="/blog/2014/10/26/akka-fsharp-ddd/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/10/26/akka-fsharp-ddd/" itemprop="url">Hipsterize Your Backend for the Greater Good With Akka.NET, F# and Some DDD Flavor</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Initially this post was supposed to cover concepts of implementing an example DDD (Domain Driven Design) architecture using F# and Akka.NET. But the more I&rsquo;ve written, the more I&rsquo;ve realized that whole idea won&rsquo;t fit into a single blog post. Therefore I&rsquo;ve decided for now to focus on some basic example covering command/event handlers. To make this more interesting I want to show how Akka.NET and F# features can be used to leverage design established this way.</p>

<h3>Before we begin&hellip;</h3>

<p>I want to notice, that all examples in this post are made mostly to learning purposes. There are some things missing, but I&rsquo;ve decided to leave them since they don&rsquo;t have direct impact on the overall design or current state of the application. If I will continue this thread, I will probably try to extend them and provide some more meaningful context. So please don&rsquo;t treat this code as a real-life reference of DDD implementation.</p>

<p>What is clearly missing in example below? I didn&rsquo;t describe aggregate roots, because boundary context is very simplistic &ndash; to make this post clearer I&rsquo;ve focused more on command-handler-event pattern. Sample doesn&rsquo;t enforce any specific database, using simple dictionary as abstraction. Also it doesn&rsquo;t provide any form of data validation or bindings to existing HTTP server frameworks. They are outside of scope of this post but are very simple to integrate.</p>

<h4>Step 1: Define our domain data structures</h4>

<p>Lets start with domain model. As a boundary context I&rsquo;ve chosen one of the most generic ones &ndash; user account&rsquo;s space. Our simplified business logic in this example will cover two actions &ndash; user registration and sign in. Users will be identified by their email and will use the most basic security features.</p>

<p>But before we move there, lets use some of the features, F# could give us, to shape a type system for our advantage.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">Email</span> <span class="o">=</span> <span class="kt">string</span>
</span><span class='line'><span class="k">type</span> <span class="nc">PasswordHash</span> <span class="o">=</span> <span class="kt">byte</span> <span class="kt">array</span>
</span></code></pre></td></tr></table></div></figure>


<p>These are examples of type aliases. You may consider using them, if you&rsquo;ve found that usage of some primitive type in given context may be defined as subtype/supertype relation. In this example Email can be considered as a specialization of string &ndash; that means, each email is string, but not each string is a valid email. This kind of granularity can be stretched quite far. Just think about any primary/foreign key field in any entity as it&rsquo;s own unique type. This will automatically disallow mistakes such as assigning keys from entities of incompatible type eg. assigning <code>UserId</code> value to <code>ProductId</code> field! F# expressiveness promotes this behavior.</p>

<p>Now use these types to define our User entity. It&rsquo;s very straightforward:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">User</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">{</span> <span class="n">email</span> <span class="o">:</span> <span class="nc">Email</span>
</span><span class='line'>      <span class="n">phash</span> <span class="o">:</span> <span class="nc">PasswordHash</span>
</span><span class='line'>      <span class="n">salt</span>  <span class="o">:</span> <span class="kt">byte</span> <span class="kt">array</span> <span class="o">}</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">member</span> <span class="n">empty</span> <span class="o">=</span>  <span class="o">{</span> <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">;</span> <span class="n">phash</span> <span class="o">=</span> <span class="o">[||];</span> <span class="n">salt</span> <span class="o">=</span> <span class="o">[||]</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next I&rsquo;m going to describe data models for our domain commands and events. It&rsquo;s important to understand purpose of both. Commands are produced to describe tasks to be executed by the system and contains all data necessary to perform it. Events are describing diffs in general application state as a results of performed tasks. What is wort mentioning, events should be described in way, that will allow us to recreate current application state by replaying all events timeline stream. And because events describe changes, that already occurred, they should be immutable by nature &ndash; don&rsquo;t try to change your past if you not wish to mess with your future.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">UserCommand</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">RegisterUser</span> <span class="k">of</span> <span class="n">email</span> <span class="o">:</span> <span class="nc">Email</span> <span class="o">*</span> <span class="n">password</span> <span class="o">:</span> <span class="kt">string</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">LoginUser</span> <span class="k">of</span> <span class="n">email</span> <span class="o">:</span> <span class="nc">Email</span> <span class="o">*</span> <span class="n">password</span> <span class="o">:</span> <span class="kt">string</span>
</span></code></pre></td></tr></table></div></figure>


<p>NOTE: If you want to use F# records to describe your commands/events, that&rsquo;s perfectly fine. I&rsquo;ve chosen discriminated unions for their expressiveness.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">UserEvent</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">UserRegistered</span> <span class="k">of</span> <span class="n">email</span> <span class="o">:</span> <span class="nc">Email</span> <span class="o">*</span> <span class="n">salt</span><span class="o">:</span> <span class="kt">byte</span> <span class="kt">array</span> <span class="o">*</span> <span class="n">phash</span> <span class="o">:</span> <span class="kt">byte</span> <span class="kt">array</span> <span class="o">*</span> <span class="n">timestamp</span> <span class="o">:</span> <span class="nc">DateTime</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">UserLogged</span> <span class="k">of</span> <span class="n">email</span> <span class="o">:</span> <span class="nc">Email</span> <span class="o">*</span> <span class="n">timestamp</span> <span class="o">:</span> <span class="nc">DateTime</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see there are few things worth of emphasizing:</p>

<ul>
<li>We didn&rsquo;t store user password provided directly from command, using salt + password hash instead. Reason behind is that in DDD events usually could be serialized and stored in some kind of event database. Therefore it&rsquo;s not secure to provide them any sensitive data. However events should contain enough information to give us ability to recreate current database state based on provided stream of events, assuming that it&rsquo;s complete.</li>
<li>Each of our event&rsquo;s contain a timestamp field. Events give us a historical change set of the application. And because they contain only diffs between database states rather than snapshot of entities, they have to be ordered by their creation date. Without it we couldn&rsquo;t recreate them.</li>
</ul>


<p>What other fields may be useful when working with events? Consider attaching current API version number &ndash; this will allow you to endure breaking changes in your code responsible for handling events. Other handy field is unique event id, when you may need functionality associated with generating cascading event chains in response to some other events. In that case having some kind of pointer to originating event may be useful.</p>

<h3>Step 2: describe application behavior in functional manner</h3>

<p>This may be a little controversial statement, but I must say it &ndash; exceptions are bad. They leaves the leaks in your type system and fucks with your application logic flow in the way, that many programmers and almost all compilers cannot understand.</p>

<p>The alternative conception of error handling is old and well-known. It&rsquo;s based on returning error codes. To start with &ndash; if you already know <a href="http://www.rust-lang.org/">Rust</a>, this may look familiar to you:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">Result</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">ok</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">err</span><span class="o">&gt;</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Ok</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">ok</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Error</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">err</span>
</span></code></pre></td></tr></table></div></figure>


<p>You may ask: why the hell do we return error values instead of just throwing exceptions? Are these some archaeological excavations and we&rsquo;re gone back to the C era? Actually no. There is very good reason behind this.</p>

<p>Think about exceptions as a side effects of the application state behavior. You cannot be 100% sure about flow of your application process. Since information about exceptions is not part of any function/method signature, they actually act as a dynamically typed cascading return values anyway &ndash; both compiler and programmers will ignore them until they will occur at runtime.</p>

<p>This time instead of cryptic error codes returned by C, we use F# power to provide type-safe and expressive way for this solution. If you&rsquo;re interested more about interesting ways to utilize return-based error handling using higher-level concepts, I recommend you <a href="http://fsharpforfunandprofit.com/posts/recipe-part2/">Railway Oriented Programming</a> blogpost and video presented on NDC Oslo 2014. Here, I&rsquo;ll use a greatly simplified version, exposing operator which chain two input functions together and call second one only if result from the first was <code>Ok</code>, and forwarding an <code>Error</code> result otherwise:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="o">(&gt;=&gt;)</span> <span class="n">f1</span> <span class="n">f2</span> <span class="n">arg</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">f1</span> <span class="n">arg</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Ok</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">f2</span> <span class="n">data</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Error</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="nc">Error</span> <span class="n">e</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve also decided to use more discriminated unions to describe each specific business logic error in actual bounded context scope. I&rsquo;ve found that returning a string-based messages back to programmers in error logs are not better in any way than creating a specialized error type for each case. The only disadvantage is amount of code you need to write, to declare new type, but again &ndash; it&rsquo;s not a problem with F#.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">UserError</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">UserAlreadyExists</span> <span class="k">of</span> <span class="n">userEmail</span> <span class="o">:</span> <span class="nc">Email</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">UserNotFound</span> <span class="k">of</span> <span class="n">userEmail</span> <span class="o">:</span> <span class="nc">Email</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">WrongPassword</span> <span class="k">of</span> <span class="n">userEmail</span> <span class="o">:</span> <span class="nc">Email</span> <span class="o">*</span> <span class="n">hashedInput</span> <span class="o">:</span> <span class="nc">PasswordHash</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Step 3: handle user registration</h3>

<p>How does F# command handling differs from it&rsquo;s more objective oriented counterpart? Since we deal with functional oriented language, most of our logic is composed into functions instead of objects. You&rsquo;ve used to execute your logic with services, here you&rsquo;ve got a function. Wanna some Dependency Injection? Here, you have some currying.</p>

<p>I&rsquo;ll describe our service as <code>handle</code> function which takes some <code>UserCommand</code> as an input and produces <code>Result&lt;UserEvent, UserError&gt;</code> as output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">handle</span> <span class="n">clock</span> <span class="n">findUser</span> <span class="n">saveUser</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">function</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">RegisterUser</span><span class="o">(</span><span class="n">email</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">findUser</span> <span class="n">email</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">Some</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Error</span><span class="o">(</span><span class="nc">UserAlreadyExists</span> <span class="n">email</span><span class="o">)</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="k">let</span> <span class="n">salt</span><span class="o">,</span> <span class="n">phash</span> <span class="o">=</span> <span class="n">defaultGeneratePassword</span> <span class="n">password</span>
</span><span class='line'>            <span class="k">let</span> <span class="n">user</span> <span class="o">=</span>
</span><span class='line'>                <span class="o">{</span> <span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
</span><span class='line'>                  <span class="n">salt</span> <span class="o">=</span> <span class="n">salt</span>
</span><span class='line'>                  <span class="n">phash</span> <span class="o">=</span> <span class="n">phash</span> <span class="o">}</span>
</span><span class='line'>            <span class="n">saveUser</span> <span class="n">user</span>
</span><span class='line'>            <span class="nc">Ok</span> <span class="o">(</span><span class="nc">UserRegistered</span><span class="o">(</span><span class="n">email</span><span class="o">,</span> <span class="n">salt</span><span class="o">,</span> <span class="n">phash</span><span class="o">,</span> <span class="n">clock</span><span class="bp">()</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you&rsquo;ve seen, this function actually takes 4 parameters (clock, findUser, saveUser and command as implicit argument of calling <strong>function</strong> keyword). But as I&rsquo;ve said, our handle function should take only one input argument. That&rsquo;s because we&rsquo;ll provide three first arguments through partial function application later &ndash; now you can think about them as constructor arguments injected by your IoC container when resolving new service.</p>

<p>While most of the parameters are quite understandable, one of them may be confusing &ndash; the <code>clock</code> parameter. It&rsquo;s only functionality is to provide current DateTime value. If so, why didn&rsquo;t I just used <code>DateTime.Now</code> directly inside the code? In this example it&rsquo;s actually not so important, but I&rsquo;ve used it to expose simple problem &ndash; things such as date/configuration/environment providers or random number generators could make our handler behavior non-deterministic. That means, if we call this function two times with the same input, we couldn&rsquo;t count on the same output. It&rsquo;s actually problem for logic predictability and in some cases is especially cumbersome when writing tests to verify application behavior. Therefore I think that it&rsquo;s better to separate them as injectable arguments.</p>

<h4>Password hashing and generation</h4>

<p>While you may find some good libraries providing real life hashing features out of hand, I&rsquo;ve decided to leave my example free on unnecessary dependencies and use a standard library instead.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="k">private</span> <span class="n">saltWith</span> <span class="n">salt</span> <span class="o">(</span><span class="n">p</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">passBytes</span> <span class="o">=</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Text</span><span class="p">.</span><span class="nn">Encoding</span><span class="p">.</span><span class="nn">UTF8</span><span class="p">.</span><span class="nc">GetBytes</span> <span class="n">p</span>
</span><span class='line'>    <span class="nn">Array</span><span class="p">.</span><span class="n">append</span> <span class="n">passBytes</span> <span class="n">salt</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">sha512</span> <span class="o">(</span><span class="n">bytes</span> <span class="o">:</span> <span class="kt">byte</span> <span class="kt">array</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">use</span> <span class="n">sha</span> <span class="o">=</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Security</span><span class="p">.</span><span class="nn">Cryptography</span><span class="p">.</span><span class="nn">SHA512</span><span class="p">.</span><span class="nc">Create</span><span class="bp">()</span>
</span><span class='line'>    <span class="n">sha</span><span class="o">.</span><span class="nc">ComputeHash</span> <span class="n">bytes</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">hashPassword</span> <span class="n">hashFn</span> <span class="n">salt</span> <span class="n">password</span> <span class="o">=</span> <span class="n">hashFn</span> <span class="o">(</span><span class="n">saltWith</span> <span class="n">salt</span> <span class="n">password</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">generatePassword</span> <span class="n">hashFn</span> <span class="n">saltSize</span> <span class="n">password</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">use</span> <span class="n">saltGen</span> <span class="o">=</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Security</span><span class="p">.</span><span class="nn">Cryptography</span><span class="p">.</span><span class="nn">RandomNumberGenerator</span><span class="p">.</span><span class="nc">Create</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">salt</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">zeroCreate</span> <span class="n">saltSize</span>
</span><span class='line'>    <span class="n">saltGen</span><span class="o">.</span><span class="nc">GetBytes</span> <span class="n">salt</span>
</span><span class='line'>    <span class="o">(</span><span class="n">salt</span><span class="o">,</span> <span class="n">hashPassword</span> <span class="n">hashFn</span> <span class="n">salt</span> <span class="n">password</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">inline</span> <span class="n">defaultGeneratePassword</span> <span class="n">pass</span> <span class="o">=</span> <span class="n">generatePassword</span> <span class="n">sha512</span> <span class="mi">64</span> <span class="n">pass</span>
</span><span class='line'><span class="k">let</span> <span class="k">inline</span> <span class="n">defaultHashPassword</span> <span class="n">salt</span> <span class="n">pass</span> <span class="o">=</span> <span class="n">hashPassword</span> <span class="n">sha512</span> <span class="n">salt</span> <span class="n">pass</span>
</span></code></pre></td></tr></table></div></figure>


<p>I hope this code doesn&rsquo;t need any explanations.</p>

<h3>Step 4: handle user logging</h3>

<p>Once we already described nuances of the function-based services, this one shouldn&rsquo;t be a problem. This case was created to give our example more diversity.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">handle</span> <span class="n">clock</span> <span class="n">findUser</span> <span class="n">saveUser</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">function</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">RegisterUser</span><span class="o">(</span><span class="n">email</span><span class="o">,</span> <span class="n">password</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">...</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">LoginUser</span><span class="o">(</span><span class="n">email</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">remember</span><span class="o">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">findUser</span> <span class="n">email</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">Error</span><span class="o">(</span><span class="nc">UserNotFound</span> <span class="n">email</span><span class="o">)</span>
</span><span class='line'>        <span class="o">|</span> <span class="nc">Some</span> <span class="n">user</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="k">let</span> <span class="n">computedPasswordHash</span> <span class="o">=</span> <span class="n">defaultHashPassword</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">salt</span><span class="o">)</span> <span class="n">password</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">computedPasswordHash</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">phash</span> <span class="k">then</span>
</span><span class='line'>                <span class="nc">Ok</span> <span class="o">(</span><span class="nc">UserLogged</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">,</span> <span class="n">clock</span><span class="bp">()</span><span class="o">))</span>
</span><span class='line'>            <span class="k">else</span> <span class="nc">Error</span><span class="o">(</span><span class="nc">WrongPassword</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">,</span> <span class="n">computedPasswordHash</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Mock database access</h4>

<p>As I&rsquo;ve said in the introduction, I won&rsquo;t use any real-life database provider, mocking it with concurrent dictionary instead. However if you want to use a normal database, nothing stands in your way.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">userStore</span> <span class="o">=</span> <span class="nc">ConcurrentDictionary</span><span class="bp">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="k">inline</span> <span class="n">flip</span> <span class="n">f</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span> <span class="n">f</span> <span class="n">y</span> <span class="n">x</span>
</span><span class='line'><span class="k">let</span> <span class="n">findInUserStore</span> <span class="n">email</span> <span class="o">(</span><span class="n">store</span> <span class="o">:</span> <span class="nc">ConcurrentDictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="nc">User</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">match</span> <span class="n">store</span><span class="o">.</span><span class="nc">TryGetValue</span> <span class="n">email</span> <span class="k">with</span>
</span><span class='line'>    <span class="o">|</span> <span class="o">(</span><span class="bp">false</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="nc">None</span>
</span><span class='line'>    <span class="o">|</span> <span class="o">(</span><span class="bp">true</span><span class="o">,</span> <span class="n">user</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="n">user</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">saveInUserStore</span> <span class="n">user</span> <span class="o">(</span><span class="n">store</span> <span class="o">:</span> <span class="nc">ConcurrentDictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span> <span class="nc">User</span><span class="o">&gt;)</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">store</span><span class="o">.</span><span class="nc">AddOrUpdate</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">,</span> <span class="n">user</span><span class="o">,</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Func</span><span class="o">&lt;_,</span> <span class="o">_,</span> <span class="o">_&gt;(</span><span class="k">fun</span> <span class="n">key</span> <span class="n">old</span> <span class="o">-&gt;</span> <span class="n">user</span><span class="o">))</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span></code></pre></td></tr></table></div></figure>


<p>F# is heavily function-oriented and this also corresponds to arguments precedence. While in OOP subject (<strong>this</strong>) usually precedes method invocation, in functional languages it&rsquo;s better to use it as last argument of the function. Argumentation for this is currying and partial function application, which allows us to define functions with only part of all necessary arguments provided. The more specific argument, the later it could be applied. Therefore common convention is to provide more detailed parameters at the end of the function parameters list. It&rsquo;s a very useful feature, especially when combined with pipeline operators.</p>

<p>On the other side <code>flip</code> function may be used to reverse parameters precedence in case when, for example, we want to partially apply second argument to the function without providing first one (because it may be yet unknown in this moment). This option will be presented later.</p>

<h4>Handle event subscribers</h4>

<p>One of the nice things in Akka is that it provides a Publish/Subscribe pattern offhand. As an actor-based framework, the only necessary task to do is to subscribe an <code>ActorRef</code> of desired observer directly to Akka system&rsquo;s event stream.</p>

<p>As a lazy person I don&rsquo;t want to be forced to explicitly create new actor each time I want to subscribe some behavior to react for events I&rsquo;ve produced somewhere else. Therefore I&rsquo;ve created simple subscribe helper, which will handle subscriber actor creation for me.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="c1">// automatic unique concurrent name generator</span>
</span><span class='line'><span class="k">let</span> <span class="k">mutable</span> <span class="n">subscriptionNr</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="k">let</span> <span class="k">inline</span> <span class="n">getSubNr</span><span class="bp">()</span> <span class="o">=</span> <span class="nn">System</span><span class="p">.</span><span class="nn">Threading</span><span class="p">.</span><span class="nn">Interlocked</span><span class="p">.</span><span class="nc">Increment</span><span class="o">(&amp;</span><span class="n">subscriptionNr</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">subscribe</span> <span class="n">system</span> <span class="o">(</span><span class="n">fn</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">subId</span> <span class="o">=</span> <span class="n">getSubNr</span><span class="bp">()</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">subscriber</span> <span class="o">=</span> <span class="n">spawn</span> <span class="n">system</span> <span class="o">(</span><span class="s2">&quot;subscriber-&quot;</span> <span class="o">+</span> <span class="o">(</span><span class="kt">string</span> <span class="n">subId</span><span class="o">))</span> <span class="o">&lt;|</span> <span class="n">actAs</span> <span class="n">fn</span>
</span><span class='line'>    <span class="n">system</span><span class="o">.</span><span class="nn">EventStream</span><span class="p">.</span><span class="nc">Subscribe</span><span class="o">(</span><span class="n">subscriber</span><span class="o">,</span> <span class="n">typeof</span><span class="o">&lt;</span><span class="k">&#39;</span><span class="n">a</span><span class="o">&gt;)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class='line'>    <span class="n">subscriber</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">publish</span> <span class="o">(</span><span class="n">bus</span> <span class="o">:</span> <span class="nn">Akka</span><span class="p">.</span><span class="nn">Event</span><span class="p">.</span><span class="nc">EventStream</span><span class="o">)</span> <span class="n">evt</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">bus</span><span class="o">.</span><span class="nc">Publish</span> <span class="n">evt</span>
</span><span class='line'>    <span class="nc">Ok</span> <span class="n">evt</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Bind everything together</h3>

<p>Now when all logic has been defined, it&rsquo;s time to show it in some example code. It will initialize a new Akka system, setup console logging and show features of successful and unsuccessful registering and signing in of the user.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="k">inline</span> <span class="n">defaultClock</span><span class="bp">()</span> <span class="o">=</span> <span class="nn">DateTime</span><span class="p">.</span><span class="nc">Now</span>
</span><span class='line'><span class="c1">// display any errors returned by command handler</span>
</span><span class='line'><span class="k">let</span> <span class="n">handleErrors</span> <span class="o">=</span> <span class="k">function</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Ok</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Error</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;User error: %A</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">data</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">system</span> <span class="o">=</span> <span class="nn">System</span><span class="p">.</span><span class="n">create</span> <span class="s2">&quot;system&quot;</span> <span class="o">&lt;|</span> <span class="nn">Akka</span><span class="p">.</span><span class="nn">Configuration</span><span class="p">.</span><span class="nn">ConfigurationFactory</span><span class="p">.</span><span class="nc">Default</span><span class="bp">()</span>
</span><span class='line'><span class="k">let</span> <span class="n">userHandler</span> <span class="o">=</span>
</span><span class='line'>  <span class="c1">// inject &quot;dependencies&quot; into handle function</span>
</span><span class='line'>    <span class="n">handle</span>
</span><span class='line'>    <span class="o">&lt;|</span> <span class="n">defaultClock</span>
</span><span class='line'>    <span class="o">&lt;|</span> <span class="n">flip</span> <span class="n">findInUserStore</span> <span class="n">userStore</span>
</span><span class='line'>    <span class="o">&lt;|</span> <span class="n">flip</span> <span class="n">saveInUserStore</span> <span class="n">userStore</span>
</span><span class='line'><span class="k">let</span> <span class="n">subscriber</span> <span class="o">=</span> <span class="n">subscribe</span> <span class="n">system</span> <span class="o">&lt;|</span> <span class="n">printf</span> <span class="s2">&quot;User event: %A</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">let</span> <span class="n">userActor</span> <span class="o">=</span> <span class="n">spawn</span> <span class="n">system</span> <span class="s2">&quot;users&quot;</span> <span class="o">&lt;|</span> <span class="n">actorOf</span> <span class="o">(</span><span class="n">userHandler</span> <span class="o">&gt;=&gt;</span> <span class="o">(</span><span class="n">publish</span> <span class="n">system</span><span class="o">.</span><span class="nc">EventStream</span><span class="o">)</span> <span class="o">&gt;&gt;</span> <span class="n">handleErrors</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">userActor</span> <span class="o">&lt;!</span> <span class="nc">RegisterUser</span><span class="o">(</span><span class="s2">&quot;j.doe@testmail.co&quot;</span><span class="o">,</span> <span class="s2">&quot;pass&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">userActor</span> <span class="o">&lt;!</span> <span class="nc">RegisterUser</span><span class="o">(</span><span class="s2">&quot;j.doe@testmail.co&quot;</span><span class="o">,</span> <span class="s2">&quot;pass&quot;</span><span class="o">)</span>  <span class="c1">// UserAlreadyExists error</span>
</span><span class='line'><span class="nn">System</span><span class="p">.</span><span class="nn">Threading</span><span class="p">.</span><span class="nn">Thread</span><span class="p">.</span><span class="nc">Sleep</span> <span class="mi">100</span>
</span><span class='line'>
</span><span class='line'><span class="n">userActor</span> <span class="o">&lt;!</span> <span class="nc">LoginUser</span><span class="o">(</span><span class="s2">&quot;j.doe@testmail.co&quot;</span><span class="o">,</span> <span class="s2">&quot;pass&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">userActor</span> <span class="o">&lt;!</span> <span class="nc">LoginUser</span><span class="o">(</span><span class="s2">&quot;j.doe@testmail.co&quot;</span><span class="o">,</span> <span class="s2">&quot;fails&quot;</span><span class="o">)</span>     <span class="c1">// WrongPassword error</span>
</span><span class='line'>
</span><span class='line'><span class="nn">System</span><span class="p">.</span><span class="nn">Threading</span><span class="p">.</span><span class="nn">Thread</span><span class="p">.</span><span class="nc">Sleep</span> <span class="mi">100</span>
</span><span class='line'><span class="n">system</span><span class="o">.</span><span class="nc">Shutdown</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s all. Whole example took about 130 lines of F# code to create. I hope this would give you some insights about embedding your business logic into F# function composition model.</p>

<p>PS: If you&rsquo;re interested in more details about DDD and F# programming, at the present moment I can recommend you following other exploring lecture of the other developers, such as Lev Gorodinski (<a href="https://twitter.com/eulerfx">@eulerfx</a>) and his blog for more advanced concepts.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-08-06T18:49:00+02:00" data-updated="true" itemprop="datePublished">Aug 6<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/akka-dot-net/'>akka.net</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>


</div>
		
			<span class="comments"><a href="/blog/2014/08/06/fsharp-akkadotnet-supervisors/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/08/06/fsharp-akkadotnet-supervisors/" itemprop="url">Actor Supervisors in Akka.NET FSharp API</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>This post will describe changes, that will affect a F# API for Akka.NET in the incoming versions of the framework (>= 0.62) &ndash; mostly those, which concerns supervisioning and manipulating actor hierarchies.</p>

<p>I don&rsquo;t want to overload this post with explaining what Akka supervision is all about, so I&rsquo;ll just recommend a very good article, which could be found <a href="https://github.com/akkadotnet/akka.net/wiki/Supervision">here</a>.</p>

<p>While previous versions of the Akka F# API introduced some nice features such as function-based actor definitions and creations (<code>spawn</code> function), there still was no simple way to handle some core framework concepts. Remember that march towards Akka.NET 1.0 is still in progress, more and more features are implemented. Therefore it&rsquo;s F# API most likely will also be a subject to change.</p>

<p>To give a better description of the new features, lets see an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">strategy</span> <span class="o">=</span>
</span><span class='line'>    <span class="nn">Strategy</span><span class="p">.</span><span class="n">oneForOne</span> <span class="o">(</span><span class="k">fun</span> <span class="n">e</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">e</span> <span class="k">with</span>
</span><span class='line'>        <span class="o">|</span> <span class="o">:?</span> <span class="nc">ArithmeticException</span> <span class="o">-&gt;</span> <span class="nn">Directive</span><span class="p">.</span><span class="nc">Resume</span>
</span><span class='line'>        <span class="o">|</span> <span class="o">:?</span> <span class="nc">ArgumentException</span> <span class="o">-&gt;</span> <span class="nn">Directive</span><span class="p">.</span><span class="nc">Stop</span>
</span><span class='line'>        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Directive</span><span class="p">.</span><span class="nc">Escalate</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">supervisor</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">spawnOpt</span> <span class="n">system</span> <span class="s2">&quot;master&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="n">mailbox</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="c1">// by using spawn we may create a child actors without exiting a F# functional API</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">worker</span> <span class="o">=</span> <span class="n">spawn</span> <span class="n">mailbox</span> <span class="s2">&quot;worker&quot;</span> <span class="n">workerFun</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span><span class="bp">()</span> <span class="o">=</span>
</span><span class='line'>            <span class="n">actor</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">let</span><span class="o">!</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Receive</span><span class="bp">()</span>
</span><span class='line'>                <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
</span><span class='line'>                <span class="o">|</span> <span class="nc">Respond</span> <span class="o">-&gt;</span> <span class="n">worker</span><span class="o">.</span><span class="nc">Tell</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Sender</span><span class="bp">()</span><span class="o">)</span>
</span><span class='line'>                <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">worker</span> <span class="o">&lt;!</span> <span class="n">msg</span>
</span><span class='line'>                <span class="k">return</span><span class="o">!</span> <span class="n">loop</span><span class="bp">()</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="n">loop</span><span class="bp">()</span><span class="o">)</span> <span class="o">[</span> <span class="nc">SupervisorStrategy</span><span class="o">(</span><span class="n">strategy</span><span class="o">)</span> <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>A <a href="https://github.com/akkadotnet/akka.net/blob/dev/src/examples/FSharp.Api/Supervisioning.fs">whole example</a> is available inside Akka.NET project source code, along with other examples.</p>

<p>Unlike standard <code>spawn</code>, <code>spawnOpt</code> function could take a list of options used to configure spawned actor internals. SupervisorStrategy is one of them. By using F# API you are able to use <code>Strategy</code> module to quickly create a corresponding strategy instance. It supports two types of strategy creators:</p>

<ol>
<li><code>Strategy.oneForOne</code> &ndash; strategy will affect only an exception thrower.</li>
<li><code>Strategy.allForOne</code> &ndash; strategy result will propagate to all children of the actor implementing that strategy.</li>
</ol>


<p>Both functions come in two variants. First one takes only one argument &ndash; <em>decider</em> function, which determines an expected behavior based upon type of exception thrown. Second one (<code>Strategy.oneForOne2</code> and <code>Strategy.allForOne2</code>) precedes decider argument with a timeout and number of possible behavior retries. All of them corresponds directly to standard Akka strategy API, but are wrapped to fit F# functional approach instead of method overrides.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-08-02T13:21:00+02:00" data-updated="true" itemprop="datePublished">Aug 2<span>nd</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/compilers/'>compilers</a>, <a class='category' href='/blog/categories/programming-languages/'>programming languages</a>


</div>
		
			<span class="comments"><a href="/blog/2014/08/02/simple-vm/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/08/02/simple-vm/" itemprop="url">Simple Virtual Machine</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>In this post I want to present, how to create a simple virtual machine with it&rsquo;s own bytecode interpreter. While it&rsquo;s created using C language, it doesn&rsquo;t use any complex constructs and could be possibly implemented the same with any imperative language.</p>

<p>NOTE: while in this example bytecode instruction set is limited to the simple integer operations, real life virtual machines usually have a lot more complex operands (eg. object creation instruction in VMs with managed memory or dynamic method invocations). Have in mind that even if your Intermediate Representation may look like some BASIC/ASM language, it really could abstract much higher level functionalities.</p>

<h3>Virtual Machine</h3>

<p>Lets start with precising, what our virtual machine should consist of. In this example, we&rsquo;ll create a stack-based virtual machine. What does it mean? There is no notion of registers and all operation are performed through virtual stack. This results in simpler (since our instruction set doesn&rsquo;t have to include virtual registers operations), but also longer bytecode &ndash; because of more operations have to be executed than in alternative option, which may support a virtual register calls.</p>

<p>In this example, our virtual machine will consist of:</p>

<ul>
<li><strong>Executable code pointer</strong> &ndash; in order to execute the program, a VM has to now what program it is ;) Our bytecode contains opcodes (which are integers used to define instructions to be executed by an interpreter) and numbers used for things such as constant values, memory addresses or stack offsets.</li>
<li><strong>Stack</strong> &ndash; virtual stack will work as fragment of memory used for storing intermediate results and additional data of each instruction. When a procedure call will be invoked, it will also save a state of the program at moment, when procedure has been called, to retrieve it back after program will return from that call.</li>
<li><strong>Local data</strong> &ndash; unlike the stack, which uses LIFO (Last-In First-Out) operations, local data may be used as random access memory. It also may change it&rsquo;s size according to program needs. In this example we may use it to store both global and local variables.</li>
<li><strong>Program counter</strong> &ndash; it contains an address of currently executed instruction. Program will be executed by moving PC through instruction set, reading opcodes and executing them.</li>
<li><strong>Stack pointer</strong> &ndash; it contains information about number of elements stored on the stack. It always points on the top of it.</li>
<li><strong>Frame pointer</strong> &ndash; since we need to differentiate a locally and globally scoped values (this includes function arguments), we need to know where our scope is located on the stack. All local variables are assigned relatively to FP position.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// stack will have fixed size</span>
</span><span class='line'><span class="cp">#define STACK_SIZE 100</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span><span class="o">*</span> <span class="n">locals</span><span class="p">;</span>    <span class="c1">// local scoped data</span>
</span><span class='line'>    <span class="kt">int</span><span class="o">*</span> <span class="n">code</span><span class="p">;</span>      <span class="c1">// array od byte codes to be executed</span>
</span><span class='line'>    <span class="kt">int</span><span class="o">*</span> <span class="n">stack</span><span class="p">;</span>     <span class="c1">// virtual stack</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">pc</span><span class="p">;</span>         <span class="c1">// program counter (aka. IP - instruction pointer)</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">sp</span><span class="p">;</span>         <span class="c1">// stack pointer</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">fp</span><span class="p">;</span>         <span class="c1">// frame pointer (for local scope)</span>
</span><span class='line'><span class="p">}</span> <span class="n">VM</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">VM</span><span class="o">*</span> <span class="nf">newVM</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">code</span><span class="p">,</span>    <span class="c1">// pointer to table containing a bytecode to be executed</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">pc</span><span class="p">,</span>             <span class="c1">// address of instruction to be invoked as first one - entrypoint/main func</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">datasize</span><span class="p">){</span>      <span class="c1">// total locals size required to perform a program operations</span>
</span><span class='line'>    <span class="n">VM</span><span class="o">*</span> <span class="n">vm</span> <span class="o">=</span> <span class="p">(</span><span class="n">VM</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">VM</span><span class="p">));</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">locals</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">datasize</span><span class="p">);</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">stack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">STACK_SIZE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">vm</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">delVM</span><span class="p">(</span><span class="n">VM</span><span class="o">*</span> <span class="n">vm</span><span class="p">){</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">locals</span><span class="p">);</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">stack</span><span class="p">);</span>
</span><span class='line'>    <span class="n">free</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Bytecode instruction set</h3>

<p>At the begginig we&rsquo;ll start from defining a set of instructions to be handled by our language. For sake of simplicity we&rsquo;ll focus on basic integer operations, printing their result, variable creation and procedure-oriented calls.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">enum</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">ADD_I32</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>    <span class="c1">// int add</span>
</span><span class='line'>    <span class="n">SUB_I32</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>    <span class="c1">// int sub</span>
</span><span class='line'>    <span class="n">MUL_I32</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>    <span class="c1">// int mul</span>
</span><span class='line'>    <span class="n">LT_I32</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>     <span class="c1">// int less than</span>
</span><span class='line'>    <span class="n">EQ_I32</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>     <span class="c1">// int equal</span>
</span><span class='line'>    <span class="n">JMP</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>        <span class="c1">// branch</span>
</span><span class='line'>    <span class="n">JMPT</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>       <span class="c1">// branch if true</span>
</span><span class='line'>    <span class="n">JMPF</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>       <span class="c1">// branch if false</span>
</span><span class='line'>    <span class="n">CONST_I32</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>  <span class="c1">// push constant integer</span>
</span><span class='line'>    <span class="n">LOAD</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>      <span class="c1">// load from local</span>
</span><span class='line'>    <span class="n">GLOAD</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>     <span class="c1">// load from global</span>
</span><span class='line'>    <span class="n">STORE</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>     <span class="c1">// store in local</span>
</span><span class='line'>    <span class="n">GSTORE</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>    <span class="c1">// store in global memory</span>
</span><span class='line'>    <span class="n">PRINT</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>     <span class="c1">// print value on top of the stack</span>
</span><span class='line'>    <span class="n">POP</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>       <span class="c1">// throw away top of the stack</span>
</span><span class='line'>    <span class="n">HALT</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>      <span class="c1">// stop program</span>
</span><span class='line'>    <span class="n">CALL</span> <span class="o">=</span> <span class="mi">17</span><span class="p">,</span>      <span class="c1">// call procedure</span>
</span><span class='line'>    <span class="n">RET</span> <span class="o">=</span> <span class="mi">18</span>        <span class="c1">// return from procedure</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just like in standard assembly code, each instruction is represented by specific byte number. In more realistic virtual machine those numbers may have specific values (for example to perform bitwise masking).</p>

<h3>Main interpreter loop</h3>

<p>It&rsquo;s time to create our code execution loop. How does it work? It&rsquo;s a simple loop with switch statement used to interpret particular operation codes found in our program. While this is not the fastest solution, it gives us a simple understanding of how fetch/decode/execute cycle works.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define PUSH(vm, v) vm-&gt;stack[++vm-&gt;sp] = v </span><span class="c1">// push value on top of the stack</span>
</span><span class='line'><span class="cp">#define POP(vm)     vm-&gt;stack[vm-&gt;sp--]     </span><span class="c1">// pop value from top of the stack</span>
</span><span class='line'><span class="cp">#define NCODE(vm)   vm-&gt;code[vm-&gt;pc++]      </span><span class="c1">// get next bytecode</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">run</span><span class="p">(</span><span class="n">VM</span><span class="o">*</span> <span class="n">vm</span><span class="p">){</span>
</span><span class='line'>    <span class="k">do</span><span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>        <span class="c1">// fetch</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">rval</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">// decode</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">HALT</span>: <span class="k">return</span><span class="p">;</span>  <span class="c1">// stop the program</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">CONST_I32</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">ADD_I32</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">SUB_I32</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">MUL_I32</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">LT_I32</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">EQ_I32</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">JMP</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">JMPT</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">JMPF</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">LOAD</span>:  <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">GLOAD</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">GSTORE</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">CALL</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">RET</span>: <span class="p">...</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">POP</span>:
</span><span class='line'>            <span class="o">--</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">;</span>      <span class="c1">// throw away value at top of the stack</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">PRINT</span>:
</span><span class='line'>            <span class="n">v</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>        <span class="c1">// pop value from top of the stack ...</span>
</span><span class='line'>            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>  <span class="c1">// ... and print it</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="nl">default:</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we&rsquo;ve already defined <code>HALT</code>, <code>POP</code> and <code>PRINT</code> opcodes. In more realistic example, you probably don&rsquo;t want to define value display in form of dedicated instruction, but this will allow us to simply see result of our operations.</p>

<h3>Integer operators</h3>

<p>Now we can define some integer operations. While we&rsquo;re defined a plenty of them, here I&rsquo;ll show only one example for each group: constant initialization, arithmetic and logic operations.</p>

<p>What is worth emphasizing, is that all value swaps are performed through stack (there are no registers), so each instruction takes it&rsquo;s operands from top of the stack and also puts a computed result on top of it. Also, since stacks are LIFO-type collections, all values taken from the stack are in reversed order &ndash; for example look at <code>ADD_I32</code> instruction below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">CONST_I32</span>:
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>   <span class="c1">// get next value from code ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>     <span class="c1">// ... and move it on top of the stack</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">ADD_I32</span>:
</span><span class='line'>    <span class="n">b</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>        <span class="c1">// get second value from top of the stack ...</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>        <span class="c1">// ... then get first value from top of the stack ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">);</span>    <span class="c1">// ... add those two values and put result on top of the stack</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">LT_I32</span>:
</span><span class='line'>    <span class="n">b</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>        <span class="c1">// get second value from top of the stack ...</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>        <span class="c1">// ... then get first value from top of the stack ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="o">&lt;</span><span class="n">b</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// ... compare those two values, and put result on top of the stack</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instructions such as <code>SUB_I32</code>, <code>MUL_I32</code> and <code>EQ_I32</code> won&rsquo;t be defined in scope of this post, but I think when you&rsquo;ll understand example above, they should be easy to implement.</p>

<h3>Jump instructions</h3>

<p>Next, we have to define jump instructions in our code. They are basically equivalent of <code>goto</code> keyword and may be used to implement statements such as loops and if/else conditions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">JMP</span>:
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>  <span class="c1">// unconditionaly jump with program counter to provided address</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">JMPT</span>:
</span><span class='line'>    <span class="n">addr</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>  <span class="c1">// get address pointer from code ...</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">))</span> <span class="p">{</span>      <span class="c1">// ... pop value from top of the stack, and if it&#39;s true ...</span>
</span><span class='line'>        <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span> <span class="c1">// ... jump with program counter to provided address</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, <code>JUMPF</code> (conditional jump if false) implementation should be analogous to <code>JMPT</code>.</p>

<h3>Move memory globally</h3>

<p>Now, when all basic constructs are defined, we shall provide a way to define a variables in our program. This paragraph will cover problem of globally-scoped ones, while the next one will show how to implement locally-scoped variables.</p>

<p>Unlike stack, a local data is a random access memory of elastic size, so all in/out operations performed on it using memory addresses (aka. pointers). Therefore in our example all load/store opcodes should be followed by number being an address pointer to the local data.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">GLOAD</span>:
</span><span class='line'>    <span class="n">addr</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>             <span class="c1">// get pointer address from code ...</span>
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">locals</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>         <span class="c1">// ... load value from memory of the provided addres ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>                <span class="c1">// ... and put that value on top of the stack</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">GSTORE</span>:
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>                <span class="c1">// get value from top of the stack ...</span>
</span><span class='line'>    <span class="n">addr</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>           <span class="c1">// ... get pointer address from code ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">locals</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>         <span class="c1">// ... and store value at address received</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Manipulate local scope memory</h3>

<p>This is similar to previously defined <code>GLOAD</code> and <code>GSTORE</code> instruction. However there is a one significant difference &ndash; instead of taking an locals address directly from provided value, we compute it relatively to current frame pointer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">LOAD</span>:                  <span class="c1">// load local value or function arg</span>
</span><span class='line'>    <span class="n">offset</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>     <span class="c1">// get next value from code to identify local variables offset start on the stack</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">stack</span><span class="p">[</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span><span class="o">+</span><span class="n">offset</span><span class="p">]);</span> <span class="c1">// ... put on the top of the stack variable stored relatively to frame pointer</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">STORE</span>:                 <span class="c1">// store local value or function arg</span>
</span><span class='line'>    <span class="n">v</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>            <span class="c1">// get value from top of the stack ...</span>
</span><span class='line'>    <span class="n">offset</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>     <span class="c1">// ... get the relative pointer address from code ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">locals</span><span class="p">[</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span><span class="o">+</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>  <span class="c1">// ... and store value at address received relatively to frame pointer</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Procedure calls</h3>

<p>All of previous instructions were fairly simple to execute. Now it&rsquo;s time to do something slightly more complex &ndash; function/procedure calls. Before we begin, lets describe how they works. To perform the call, we have to first save the current state of the program at the moment before the call will be performed &ndash; it will let us freely alter program state in scope of the function. To do so, we have to save three values:</p>

<ul>
<li>Address of the caller instruction &ndash; this is a current value of program counter and it&rsquo;s need to be stored, so that VM will know, where program should return from finished procedure call.</li>
<li>Frame pointer &ndash; this is necessary, since we want to be able to use locally scoped variables when we enter into new procedure (<strong>tl;dr</strong> &ndash; it gives us a function scope feature).</li>
<li>Number of function/procedure arguments &ndash; before call will be performed, all necessary arguments will be put on top of the stack. However returning from function should dispose all of the provided arguments, so that we could retrieve back state of the stack from before the function call. If we want to know how many arguments from the stack should be thrown away, firstly we have to store that count &ndash; it will be also put on top of the stack.</li>
</ul>


<p><code>RET</code> instruction works in reverse order &ndash; it takes value from top of the stack as function return value, rollbacks frame pointers, moves program counter to the caller instruction, disposes all of function call arguments from the stack and replaces all of these with return value.</p>

<p>Because we&rsquo;ve stored all of those values on top of the stack, we&rsquo;re able to store next consecutive calls in the same manner. It means that, we&rsquo;re able to nest our procedure calls. However, since each call stores some portion of data on the stack, at some point we may run out of memory, which cause stack overflow error.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">case</span> <span class="n">CALL</span>:
</span><span class='line'>    <span class="c1">// we expect all args to be on the stack</span>
</span><span class='line'>    <span class="n">addr</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span> <span class="c1">// get next instruction as an address of procedure jump ...</span>
</span><span class='line'>    <span class="n">argc</span> <span class="o">=</span> <span class="n">NCODE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span> <span class="c1">// ... and next one as number of arguments to load ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">argc</span><span class="p">);</span>   <span class="c1">// ... save num args ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">);</span> <span class="c1">// ... save function pointer ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span> <span class="c1">// ... save instruction pointer ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">=</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">;</span>  <span class="c1">// ... set new frame pointer ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>    <span class="c1">// ... move instruction pointer to target procedure address</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="k">case</span> <span class="n">RET</span>:
</span><span class='line'>    <span class="n">rval</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>     <span class="c1">// pop return value from top of the stack</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">=</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">;</span>    <span class="c1">// ... return from procedure address ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>   <span class="c1">// ... restore instruction pointer ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>   <span class="c1">// ... restore framepointer ...</span>
</span><span class='line'>    <span class="n">argc</span> <span class="o">=</span> <span class="n">POP</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>     <span class="c1">// ... hom many args procedure has ...</span>
</span><span class='line'>    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">-=</span> <span class="n">argc</span><span class="p">;</span>     <span class="c1">// ... discard all of the args left ...</span>
</span><span class='line'>    <span class="n">PUSH</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>     <span class="c1">// ... leave return value on top of the stack</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Example code</h3>

<p>Now, when our bytecode interpreter is finally complete, we may test it on some example program. Please note numbers in comments on the right &ndash; they show actual opcode instruction address, and will be used for conditional jumps and procedure calls.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">const</span> <span class="kt">int</span> <span class="n">fib</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// address of the fibonacci procedure</span>
</span><span class='line'><span class="kt">int</span> <span class="n">program</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// int fib(n) {</span>
</span><span class='line'>    <span class="c1">//     if(n == 0) return 0;</span>
</span><span class='line'>    <span class="n">LOAD</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>       <span class="c1">// 0 - load last function argument N</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="c1">// 2 - put 0</span>
</span><span class='line'>    <span class="n">EQ_I32</span><span class="p">,</span>         <span class="c1">// 4 - check equality: N == 0</span>
</span><span class='line'>    <span class="n">JMPF</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>       <span class="c1">// 5 - if they are NOT equal, goto 10</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="c1">// 7 - otherwise put 0</span>
</span><span class='line'>    <span class="n">RET</span><span class="p">,</span>            <span class="c1">// 9 - and return it</span>
</span><span class='line'>    <span class="c1">//     if(n &lt; 3) return 1;</span>
</span><span class='line'>    <span class="n">LOAD</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>       <span class="c1">// 10 - load last function argument N</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>   <span class="c1">// 12 - put 3</span>
</span><span class='line'>    <span class="n">LT_I32</span><span class="p">,</span>         <span class="c1">// 14 - check if 3 is less than N</span>
</span><span class='line'>    <span class="n">JMPF</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span>       <span class="c1">// 15 - if 3 is NOT less than N, goto 20</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// 17 - otherwise put 1</span>
</span><span class='line'>    <span class="n">RET</span><span class="p">,</span>            <span class="c1">// 19 - and return it</span>
</span><span class='line'>    <span class="c1">//     else return fib(n-1) + fib(n-2);</span>
</span><span class='line'>    <span class="n">LOAD</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>       <span class="c1">// 20 - load last function argument N</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// 22 - put 1</span>
</span><span class='line'>    <span class="n">SUB_I32</span><span class="p">,</span>        <span class="c1">// 24 - calculate: N-1, result is on the stack</span>
</span><span class='line'>    <span class="n">CALL</span><span class="p">,</span> <span class="n">fib</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// 25 - call fib function with 1 arg. from the stack</span>
</span><span class='line'>    <span class="n">LOAD</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>       <span class="c1">// 28 - load N again</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>   <span class="c1">// 30 - put 2</span>
</span><span class='line'>    <span class="n">SUB_I32</span><span class="p">,</span>        <span class="c1">// 32 - calculate: N-2, result is on the stack</span>
</span><span class='line'>    <span class="n">CALL</span><span class="p">,</span> <span class="n">fib</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// 33 - call fib function with 1 arg. from the stack</span>
</span><span class='line'>    <span class="n">ADD_I32</span><span class="p">,</span>        <span class="c1">// 36 - since 2 fibs pushed their ret values on the stack, just add them</span>
</span><span class='line'>    <span class="n">RET</span><span class="p">,</span>            <span class="c1">// 37 - return from procedure</span>
</span><span class='line'>    <span class="c1">// entrypoint - main function</span>
</span><span class='line'>    <span class="n">CONST_I32</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>   <span class="c1">// 38 - put 6 </span>
</span><span class='line'>    <span class="n">CALL</span><span class="p">,</span> <span class="n">fib</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// 40 - call function: fib(arg) where arg = 6;</span>
</span><span class='line'>    <span class="n">PRINT</span><span class="p">,</span>          <span class="c1">// 43 - print result</span>
</span><span class='line'>    <span class="n">HALT</span>            <span class="c1">// 44 - stop program</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// initialize virtual machine</span>
</span><span class='line'><span class="n">VM</span><span class="o">*</span> <span class="n">vm</span> <span class="o">=</span> <span class="n">newVM</span><span class="p">(</span><span class="n">program</span><span class="p">,</span>   <span class="c1">// program to execute</span>
</span><span class='line'>                   <span class="mi">38</span><span class="p">,</span>    <span class="c1">// start address of main function</span>
</span><span class='line'>                   <span class="mi">0</span><span class="p">);</span>    <span class="c1">// locals to be reserved, fib doesn&#39;t require them</span>
</span><span class='line'><span class="n">run</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you may have seen, there is a lot of <code>LOAD, -3</code> operations. Why -3? Again, when we perform a procedure call, we need to store current program state on top of the stack. To do so, we&rsquo;ll put here a 3 values: program counter (as return address), frame pointers before the call, and number of arguments to be used by called procedure. Therefore everything below them (-3 and less) will be an actual function arguments saved on the stack. You could optimize it by adding something like <code>LDARG, x</code> opcode.</p>

<h3>Why?</h3>

<p>There are numerous reasons, why developers may want to use intermediate bytecode representations for their languages:</p>

<ul>
<li><strong>Performance</strong> &ndash; as you&rsquo;ve seen, execution of the bytecode is realized mostly by just moving (mostly incrementing) PC pointer. When interpreter works directly by evaluating and traversing an AST tree, there is a lot of pointer jumping and structure blocks, which is slightly more complex and slower. Bytecode allows you to faster code interpretation as well as it may facilitate some optimizations.</li>
<li><strong>Code size</strong> &ndash; full code operates on human readable strings, which may consume some memory and are harder to interpret. Intermediate program representation uses only a simple integer arrays.</li>
<li><strong>Well-fitting</strong> &ndash; since you may describe your own IR, you may fit it directly to your needs. It&rsquo;s easier to parse, and it could remove some repetitive work, when you&rsquo;ll want to implement your language on the various OSes.</li>
</ul>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-07-09T00:00:00+02:00" data-updated="true" itemprop="datePublished">Jul 9<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/akka-dot-net/'>akka.net</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>


</div>
		
			<span class="comments"><a href="/blog/2014/07/09/fsharp-akka-map-reduce/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/07/09/fsharp-akka-map-reduce/" itemprop="url">Map Reduce With FSharp and Akka.net</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>In my previous post, I&rsquo;ve shown how to create a simple <em>hello world</em> application using Akka.net system leveraged with a F# API. Today, I&rsquo;ll show a slightly more complex example. We&rsquo;ll create a simple Map-Reduce system based on distributed word count algorithm.</p>

<p>Idea of our algorithm is quite simple &ndash; we want to group and count all repetitions of the same words (case-insensitive) in input text. This is a perfect subject to illustrate a map-reduce algorithm as well as Akka.net task distribution mechanism. To realize our objective, we&rsquo;ll need to define three actor types:</p>

<ul>
<li>Master &ndash; it&rsquo;s main job is to spread an input data equally among other actors and forward request for result data.</li>
<li>Mappers &ndash; they will tokenize their text fragments into specific words and send it to reducers.</li>
<li>Reducers &ndash; they are responsible for word grouping and counting.</li>
</ul>


<p>At the beginning, lets define basic message types used by our system:</p>

<ul>
<li>One to propagate chunks of data to mapping nodes.</li>
<li>Next one to forward processed data to reducers.</li>
<li>Last one to invoke collection mechanism, which will concatenate all reduced data to one peace and send it back to the originator.</li>
</ul>


<p>All of them are illustrated by the code below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">MRMsg</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Map</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Reduce</span> <span class="k">of</span> <span class="o">(</span><span class="kt">string</span> <span class="o">*</span> <span class="kt">int</span><span class="o">)</span> <span class="kt">list</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Collect</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you may have seen previously, instead of C#/Scala objective approach, I&rsquo;ve used tail-recursive function to define an actor processing routine. Since a lot of it&rsquo;s code would be repetitive among all of the actor types we want to define we can wrap actor behavior using <code>actorOf</code> and <code>actorOf2</code> functions.</p>

<p>Lets start to defining a map-reduce logic into our application. Firstly we need to create a <strong>map actor</strong>. In this example, all what it needs to do, is to chop provided string into single words, and create from them a simple bag of words with their repetition. However we won&rsquo;t sum them now &ndash; this is the job for reducer actors.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">mapWords</span> <span class="o">(</span><span class="n">line</span><span class="o">:</span><span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="n">seq</span> <span class="o">{</span> <span class="k">for</span> <span class="n">word</span> <span class="k">in</span> <span class="n">line</span><span class="o">.</span><span class="nc">Split</span><span class="bp">()</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">word</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">map</span> <span class="n">reducer</span> <span class="o">(</span><span class="n">mailbox</span><span class="o">:</span><span class="nc">Actor</span><span class="o">&lt;</span><span class="nc">MRMsg</span><span class="o">&gt;)</span> <span class="o">=</span> <span class="k">function</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Map</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="n">reducer</span> <span class="o">&lt;!</span> <span class="nc">Reduce</span> <span class="o">(</span><span class="n">mapWords</span> <span class="n">line</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">ofSeq</span><span class="o">)</span>
</span><span class='line'>    <span class="o">|</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Unhandled</span> <span class="n">m</span>      <span class="c1">// mapper won&#39;t handle any other messages</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you may see, after finishing it&rsquo;s work, mapper will send list of words directly to reducers. To make this possible, we need to provide reducer reference as one of the function parameters.</p>

<p>Next type is the <strong>reduce actor</strong>. It&rsquo;s task is to group all incoming words, and count their occurrences. In our example we use shared <code>ConcurrentDictionary</code> for gathering data from all of the reducer instances. For more real life example, we should probably use some more sophisticated mechanism, such as <strong>aggregate actor</strong> concatenating all results provided by specific reducers. Here for sake of simplicity, we omit it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">reduceWords</span> <span class="o">(</span><span class="n">dict</span><span class="o">:</span><span class="nc">ConcurrentDictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span><span class="kt">int</span><span class="o">&gt;)</span> <span class="n">iter</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">iter</span>
</span><span class='line'>    <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">dict</span><span class="o">.</span><span class="nc">AddOrUpdate</span><span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="nn">System</span><span class="p">.</span><span class="nc">Func</span><span class="o">&lt;_,_,_&gt;(</span><span class="k">fun</span> <span class="n">key</span> <span class="n">old</span> <span class="o">-&gt;</span> <span class="n">old</span> <span class="o">+</span> <span class="n">v</span><span class="o">))</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">reduce</span> <span class="o">(</span><span class="n">dict</span><span class="o">:</span><span class="nc">ConcurrentDictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span><span class="kt">int</span><span class="o">&gt;)</span> <span class="o">(</span><span class="n">mailbox</span><span class="o">:</span><span class="nc">Actor</span><span class="o">&lt;</span><span class="nc">MRMsg</span><span class="o">&gt;)</span> <span class="o">=</span> <span class="k">function</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Reduce</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">reduceWords</span> <span class="n">dict</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Collect</span> <span class="o">-&gt;</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Sender</span><span class="bp">()</span> <span class="o">&lt;!</span> <span class="n">seq</span> <span class="o">{</span> <span class="k">for</span> <span class="n">e</span> <span class="k">in</span> <span class="n">dict</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="nc">Key</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="nc">Value</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">|</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Unhandled</span> <span class="n">m</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since reducer actors have direct access to shared dictionary, they also are able to respond on Collect command, providing all reduced data back to message sender.</p>

<p>The last behavior, is the <strong>master actor</strong>. It&rsquo;s role is to be a proxy between application&rsquo;s in/out data, and the rest of the actors. We use it for two tasks: 1) sending text line by line to be processed by our Map-Reduce application, 2) forwarding request for result of MR operation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">master</span> <span class="n">mapper</span> <span class="o">(</span><span class="n">reducer</span><span class="o">:</span><span class="nc">InternalActorRef</span><span class="o">)</span> <span class="o">(</span><span class="n">mailbox</span><span class="o">:</span><span class="nc">Actor</span><span class="o">&lt;</span><span class="nc">MRMsg</span><span class="o">&gt;)</span> <span class="o">=</span> <span class="k">function</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Map</span> <span class="n">str</span> <span class="o">-&gt;</span> <span class="k">for</span> <span class="n">line</span> <span class="k">in</span> <span class="n">str</span><span class="o">.</span><span class="nc">Split</span> <span class="sc">&#39;\n&#39;</span> <span class="k">do</span> <span class="n">mapper</span> <span class="o">&lt;!</span> <span class="nc">Map</span> <span class="n">line</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Collect</span> <span class="o">-&gt;</span> <span class="n">reducer</span><span class="o">.</span><span class="nc">Tell</span><span class="o">(</span><span class="nc">Collect</span><span class="o">,</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Sender</span><span class="bp">()</span><span class="o">)</span>    <span class="c1">// forward message with info about it&#39;s originator</span>
</span><span class='line'>    <span class="o">|</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Unhandled</span> <span class="n">m</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now when we have all of our actors defined, we may initialize an Akka framework to create our MR system. Now we can use a helper functions, we&rsquo;ve defined before for fast and easy actor definition.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">system</span> <span class="o">=</span> <span class="nn">System</span><span class="p">.</span><span class="n">create</span> <span class="s2">&quot;MapReduceSystem&quot;</span> <span class="o">&lt;|</span> <span class="nn">ConfigurationFactory</span><span class="p">.</span><span class="nc">Default</span><span class="bp">()</span>
</span><span class='line'><span class="k">let</span> <span class="n">dict</span> <span class="o">=</span> <span class="nc">ConcurrentDictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">,</span><span class="kt">int</span><span class="o">&gt;</span><span class="bp">()</span>
</span><span class='line'><span class="k">let</span> <span class="n">reducer</span> <span class="o">=</span> <span class="n">spawn</span> <span class="n">system</span> <span class="s2">&quot;reduce&quot;</span> <span class="o">&lt;|</span> <span class="n">actorOf2</span> <span class="o">(</span><span class="n">reduce</span> <span class="n">dict</span><span class="o">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">mapper</span> <span class="o">=</span> <span class="n">spawn</span> <span class="n">system</span> <span class="s2">&quot;map&quot;</span> <span class="o">&lt;|</span> <span class="n">actorOf2</span> <span class="o">(</span><span class="n">map</span> <span class="n">reducer</span><span class="o">)</span>
</span><span class='line'><span class="k">let</span> <span class="n">master</span> <span class="o">=</span> <span class="n">spawn</span> <span class="n">system</span> <span class="s2">&quot;master&quot;</span> <span class="o">&lt;|</span> <span class="n">actorOf2</span> <span class="o">(</span><span class="n">master</span> <span class="n">mapper</span> <span class="n">reducer</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>To finalize, we can pass some data to our system to see, if it returns an expected results. Until now, we&rsquo;ve only used send operator <code>&lt;!</code> to delegate fire-and-forget messages for specific actors, but we&rsquo;ve actually never used any two way request-response mechanism. To do so, we&rsquo;ll use Ask method (shortcut operator <code>&lt;?</code>) to send a request message and receive a handler to be used when a response will be returned in asynchronous manner.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="n">master</span> <span class="o">&lt;!</span> <span class="nc">Map</span> <span class="s2">&quot;Orange orange apple&quot;</span>
</span><span class='line'><span class="n">master</span> <span class="o">&lt;!</span> <span class="nc">Map</span> <span class="s2">&quot;cherry apple orange&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nn">Threading</span><span class="p">.</span><span class="nn">Thread</span><span class="p">.</span><span class="nc">Sleep</span> <span class="mi">500</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// read the result</span>
</span><span class='line'><span class="n">async</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">let</span><span class="o">!</span> <span class="n">res</span> <span class="o">=</span> <span class="n">master</span> <span class="o">&lt;?</span> <span class="nc">Collect</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">in</span> <span class="n">res</span> <span class="o">:?&gt;</span> <span class="o">(</span><span class="kt">string</span><span class="o">*</span><span class="kt">int</span><span class="o">)</span> <span class="n">seq</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">printfn</span> <span class="s2">&quot;%s</span><span class="se">\t</span><span class="s2">%d&quot;</span> <span class="n">k</span> <span class="n">v</span>
</span><span class='line'>    <span class="n">system</span><span class="o">.</span><span class="nc">Shutdown</span><span class="bp">()</span>
</span><span class='line'><span class="o">}</span> <span class="o">|&gt;</span> <span class="nn">Async</span><span class="p">.</span><span class="nc">RunSynchronously</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-07-05T21:42:00+02:00" data-updated="true" itemprop="datePublished">Jul 5<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/akka-dot-net/'>akka.net</a>, <a class='category' href='/blog/categories/fsharp/'>fsharp</a>


</div>
		
			<span class="comments"><a href="/blog/2014/07/05/fsharp-akka-net/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/07/05/fsharp-akka-net/" itemprop="url">FSharp and Akka.net - the Functional Way</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Actor model is one of the most influential paradigms of dealing with highly concurrent environments in present world. Simplifying, it&rsquo;s based on concept of autonomous thread-safe computation units &ndash; surprisingly called actors &ndash; with no way to directly interfere with each others work. There are no locks or semaphores &ndash; instead of accessing shared resources, they are simply passing messages around &ndash; according to the saying <em>Don&rsquo;t communicate by sharing memory; share memory by communicating</em>.</p>

<p>The first most widespread usage of the actor model was the Erlang Virtual Machine in 1986. While it was for many years closed in it&rsquo;s own niche, programming model itself has been lately forwarded and adopted on the Java Virtual Machine through <a href="http://akka.io/">Akka</a> framework. Until present moment there are actually none mature equivalents on .NET platform. While Microsoft is still developing it&rsquo;s own response in form of <a href="http://research.microsoft.com/en-us/projects/orleans/">Project Orleans</a>, a bunch of developers took the initiative of porting Akka on .NET ground.</p>

<p>I&rsquo;ve decided to try out Akka.NET a little. I&rsquo;ve noticed that it&rsquo;s still a far from completion or production-ready phase, but hopefully since it&rsquo;s based on already existing and mature framework, with help of OSS community missing holes could be patched soon.</p>

<h2>Hello Akka</h2>

<p>You can find an original first step into Akka.NET with F# API <a href="https://github.com/akkadotnet/akka.net/wiki/FSharp-API">here</a>. While I found this sample useful, I&rsquo;ve decided to investigate more about Akka.NET source code and it&rsquo;s F# API. Below you may see my example based on more functional-specific concepts:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">type</span> <span class="nc">ActorMsg</span> <span class="o">=</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Greet</span> <span class="k">of</span> <span class="kt">string</span>
</span><span class='line'>    <span class="o">|</span> <span class="nc">Hi</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">system</span> <span class="o">=</span> <span class="nn">System</span><span class="p">.</span><span class="n">create</span> <span class="s2">&quot;MySystem&quot;</span> <span class="o">&lt;|</span> <span class="nn">ConfigurationFactory</span><span class="p">.</span><span class="nc">Default</span><span class="bp">()</span>
</span><span class='line'><span class="k">let</span> <span class="n">greeter</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">spawn</span> <span class="n">system</span> <span class="s2">&quot;Greeter&quot;</span>
</span><span class='line'>    <span class="o">&lt;|</span> <span class="k">fun</span> <span class="n">mailbox</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span><span class="bp">()</span> <span class="o">=</span> <span class="n">actor</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">let</span><span class="o">!</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mailbox</span><span class="o">.</span><span class="nc">Receive</span><span class="bp">()</span>
</span><span class='line'>            <span class="k">match</span> <span class="n">msg</span> <span class="k">with</span>
</span><span class='line'>            <span class="o">|</span> <span class="nc">Greet</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s2">&quot;Hello %s&quot;</span> <span class="n">name</span>
</span><span class='line'>            <span class="o">|</span> <span class="nc">Hi</span>         <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s2">&quot;Hi&quot;</span>
</span><span class='line'>            <span class="k">return</span><span class="o">!</span> <span class="n">loop</span><span class="bp">()</span> <span class="o">}</span>
</span><span class='line'>        <span class="n">loop</span><span class="bp">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">greeter</span> <span class="o">&lt;!</span> <span class="nc">Greet</span> <span class="s2">&quot;Alex&quot;</span>
</span><span class='line'><span class="n">greeter</span> <span class="o">&lt;!</span> <span class="nc">Hi</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here are some explanations:</p>

<ul>
<li>We defined a discriminated union of messages <code>ActorMsg</code>, we want to respond to.</li>
<li>The next step is to create an <code>ActorSystem</code>, analogously to C# and original Scala versions.</li>
<li>We need to define and instantiate an <code>Actor</code>. However unlike the object approach &ndash; which required a custom actor type inheriting from one of the Akka actor classes and defining it&rsquo;s own receiving method &ndash; here we define a tail recursive function, which uses an <code>actor { ... }</code> computation expression instead of actor type declaration.</li>
<li>We pass that function through the lambda to <code>spawn</code> method, which attaches that behavior to our system and returns an <code>ActorRef</code> (not to be confused with Actor instance), assigned to our <code>greeter</code> variable. This way we may refer to actors, and pass messages to them, even if they&rsquo;re not present on our local machine (which is also one of the Akka use cases).</li>
<li>In the last to lines we simply send two messages to actor reference using tell operator <code>&lt;!</code>.</li>
</ul>


<p>As you can see, this piece of code is not directly translatable to C# or even Scala API equivalent. It&rsquo;s much more Erlangish. We don&rsquo;t have to define any classes and method overrides. Instead, we have a tail-recursive function. For me this seems more natural approach for F#, since it&rsquo;s more functional-first language, while it&rsquo;s syntax for object oriented programming is very verbose and ugly.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-07-03T00:05:00+02:00" data-updated="true" itemprop="datePublished">Jul 3<span>rd</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/fsharp/'>fsharp</a>, <a class='category' href='/blog/categories/programming-languages/'>programming languages</a>


</div>
		
			<span class="comments"><a href="/blog/2014/07/03/fsharp-and-scala-absent-values/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/07/03/fsharp-and-scala-absent-values/" itemprop="url">Value Absence - Why Scala/F# Approach Is Bad?</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Handling an absent values is one of the most common problems in programming languages. Why we consider this so important? It&rsquo;s because data processing is essential task of every program ever made. And one of the main reasons of systems errors and undefined behaviors are values not present in the system. Most of the modern programming languages tries to aim programmers with solution to handle those cases. Lets look at the most common way of dealing with them:</p>

<ol>
<li><strong>Null pointer reference</strong> &ndash; also called a &ldquo;billion-dollar mistake&rdquo;, introduced by Tony Hoare. It allows to represent an absence of the heap allocated values (objects) in form of pointer referring to not a valid instance of represented type. In most of the mainstream programming languages all heap objects are nullable by default &ndash; no matter if you want it or not.</li>
<li><strong>Option/Maybe type</strong> &ndash; this approach is characteristic for most of the functional languages. Instead of creating null pointer, it defines a special generic type (eg. Option), represented by either one of it&rsquo;s subtypes (Some as wrapper for existing underlying value, or None if value is not present).</li>
</ol>


<p>So why we consider a dedicated Option type a better solution? Because it&rsquo;s explicit, propagates type information about value nullability and &ndash; most of all &ndash; it&rsquo;s non-default. By the most of the time, we expect to have a meaningful references to our data. Their absence is not a desired and certainly should not be an expected behavior. Problem in nullable references is that literally any instance in our code could represent a non-existing value. Analogously to functional approach, all of our objects always represent an Option type.</p>

<p>Currently, after decades on living in shadows, functional paradigm is gaining more and more ground of the field of mainstream programming languages. This also reflects in two of the most popular programming environments, JVM and .NET. Their functional representatives, Scala and F#, claims to combine best of both programming paradigms. This way they also introduced and popularized an Option types among object oriented approach.</p>

<p>But something has been missed along the way, and (in my opinion) both Scala and F# had failed in face of the problem of value absence. Why? Because of their dualism. Since they are functional languages, both of them allows you to create an Option types with full support expected from a functional language. But while they also are object oriented and built on top of object oriented VMs, they allow you to use and create a nullable references. This leads to false sense of security, when using Option types. Lets look at the following example (F#):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="k">let</span> <span class="n">value</span><span class="o">:</span> <span class="nc">String</span> <span class="n">option</span> <span class="o">=</span> <span class="nc">Some</span> <span class="n">doSmthAndReturnString</span><span class="bp">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>How can you be sure that function <code>doSmthAndReturnString</code> won&rsquo;t return a null? Actually you can&rsquo;t until you perform an explicit null check. From the runtime perspective <code>Some null</code> is a perfectly valid record. Does it sound rational? No. So why is this even possible?</p>

<h2>How to combine functional and object oriented worlds?</h2>

<p>From my perspective, the best solution of that problem came with <a href="http://ceylon-lang.org/">Ceylon</a> language. It&rsquo;s based on the concept of <a href="http://ceylon-lang.org/documentation/1.0/tour/types/#union_types">Union Types</a>, one of the key features of Ceylon. For <strong>tl;dr</strong> people &ndash; union type of <code>X|Y</code> is a supertype of both types <code>X</code> and <code>Y</code>. How does it correspond to null/options?</p>

<p>In Ceylon <code>null</code> have it&rsquo;s own unique type <code>Null</code> (just like in Scala). By default all reference types are non-nullable (similarly to functional languages). However they may be nulled if referenced as union type of <code>T|Null</code> (or <code>T?</code> using some syntax suggar). This concept is basically &ndash; however not entirely &ndash; equivalent of Scala <code>Either[T,Null]</code> but without verbose requirement for object wrapping. Moreover, Ceylon compiler is able to optimize this away to standard JVM null references, without any overhead.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='fsharp'><span class='line'><span class="c1">// Scala - Either</span>
</span><span class='line'><span class="n">var</span> <span class="n">m</span><span class="o">:</span> <span class="nc">Either</span><span class="o">[</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Null</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Left</span><span class="o">(</span><span class="s2">&quot;hello&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">var</span> <span class="n">n</span><span class="o">:</span> <span class="nc">Either</span><span class="o">[</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Null</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Right</span><span class="o">(</span><span class="k">null</span><span class="o">)</span>
</span><span class='line'><span class="n">var</span> <span class="n">m</span><span class="o">:</span> <span class="nc">Either</span><span class="o">[</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Null</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Left</span><span class="o">(</span><span class="k">null</span><span class="o">)</span>    <span class="c1">// still valid</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Scala - Option type</span>
</span><span class='line'><span class="n">var</span> <span class="n">m</span><span class="o">:</span> <span class="nc">Option</span><span class="o">[</span><span class="nc">String</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Some</span><span class="o">(</span><span class="s2">&quot;hello&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">var</span> <span class="n">n</span><span class="o">:</span> <span class="nc">Option</span><span class="o">[</span><span class="nc">String</span><span class="o">]</span> <span class="o">=</span> <span class="nc">None</span>
</span><span class='line'><span class="n">var</span> <span class="n">m</span><span class="o">:</span> <span class="nc">Option</span><span class="o">[</span><span class="nc">String</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Some</span><span class="o">(</span><span class="k">null</span><span class="o">)</span>         <span class="c1">// still valid</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Ceylon</span>
</span><span class='line'><span class="nc">String</span><span class="o">|</span><span class="nc">Null</span> <span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="o">;</span>    <span class="c1">// no need for value wrapping</span>
</span><span class='line'><span class="nc">String</span><span class="o">?</span> <span class="n">n</span> <span class="o">=</span> <span class="k">null</span><span class="o">;</span>          <span class="c1">// Integer? -&gt; Integer|Null</span>
</span><span class='line'><span class="nc">String</span> <span class="n">f</span> <span class="o">=</span> <span class="k">null</span><span class="o">;</span>          <span class="c1">// compile time error, references are not nullable by default</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see on the example above, this way we combined advantages of safe, explicitly nullable types with verbosity and performance of null referenced types. In my opinion this is a proper, yet still not widespread, solution of one of the most common problem in languages theory.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-03-24T22:43:00+01:00" data-updated="true" itemprop="datePublished">Mar 24<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/dot-net/'>.net</a>


</div>
		
			<span class="comments"><a href="/blog/2014/03/24/things-you-may-not-know-about-csharp-value-types/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/03/24/things-you-may-not-know-about-csharp-value-types/" itemprop="url">Things You May Not Know About CSharp Value Types</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>In this post I&rsquo;ll try to deal with few of the myths lying beneath common understanding of how C# structures works in reality. Many of new .NET acolytes are thought about differences between structs and classes. For easier understanding many of those concepts are simplified and therefore doesn&rsquo;t necessary tell all truth about underlying mechanism.</p>

<p>Here are some of them.</p>

<h1>Structs may not be stack allocated</h1>

<p>Think about following example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">struct</span> <span class="nc">MyStruct</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">X</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">Example1</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">a</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyStruct</span> <span class="p">{</span> <span class="n">X</span> <span class="p">=</span> <span class="m">3</span> <span class="p">};</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">X</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">++</span><span class="n">a</span><span class="p">.</span><span class="n">X</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you remember, one of the well known side effects of stack-allocated values is that they&rsquo;re destroyed automatically, when we leave scope, where they were created. This remains true in .NET environment &ndash; it assures that no more but one value or pointer may be found on top of the stack when returning from method execution.</p>

<p>But what happens, when we execute <code>Example1</code> method and then call lambda returned? <code>a</code> variable as stack allocated structure, should be already destroyed at that moment (it&rsquo;s out of it&rsquo;s creation scope and has not been returned explicitly). But that&rsquo;s not what really happens. Actually .NET environment performs an <strong>escape analysis</strong> to determine if any references to that structure didn&rsquo;t leave it&rsquo;s scope. In that case it would be rather heap allocated in order to prevent premature destruction.</p>

<p>Other known case, when structs become heap allocated values, are allocations of large amounts of memory dedicated to handle values. Since stack memory is very limited (by default it&rsquo;s about 1MB per thread on Windows OS), massive structure allocations would potentially cause a StackOverflowException. What .NET environment does in that case, is fallback to safer heap-based allocations.</p>

<p><em>NOTE</em>: Unfortunatelly at the present moment C# doesn&rsquo;t provide escape analysis to determine if class instances could be stack allocated. Java, even though hasn&rsquo;t got custom value types yet, can provide that feature for specific conditions.</p>

<h1>Struct and class method calls differs significantly</h1>

<p>Next exercise. Think about two types, struct and a class. Both of them have non-static method with identical signature and implementation. When you create instances of both types and call mentioned methods, which call will be faster? If you&rsquo;d thought, that struct method call will be slightly faster, you&rsquo;re right. But why?</p>

<p>Answer lies in low level difference between CIL instructions <code>call</code> and <code>callvirt</code>. Standard class methods use <code>callvirt</code> (name is misleading &ndash; it&rsquo;s used even for non-virtual methods). Since CLR cannot absolutely guarantee, if instance method is overridden or shadowed, it has to perform explicit check by seeking class VTable for function pointer. Actual VTable pointer is one of the internal members of each object. Therefore it requires null check to be performed.</p>

<p>Since struct cannot be null, we don&rsquo;t have to perform null checking. However it&rsquo;s not necessary. Since value types cannot declare or override virtual methods &ndash; struct have fixed inheritance chain &ndash; we don&rsquo;t have to access their VTables. Actually lack of inheritance is so useful, that structure instances don&rsquo;t need to have any pointers to VTable at all. All of these save time necessary to perform a method call.</p>

<p>From that perspective struct method calls are much closer to static methods &ndash; also invoked through <code>call</code> instruction &ndash; than instantiated ones.</p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2015

    Bartosz Sypytkowski


Design based on: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
</body>
</html>
